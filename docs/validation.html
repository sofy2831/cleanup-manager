<!-- docs/validation.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp — Validation qualité</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px 14px 26px;
      padding-bottom:40px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:8px;
      margin-bottom:4px;
      text-align:center;
    }
    .logo-icon{
      width:42px;height:42px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:800;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:22px; font-weight:800; letter-spacing:-0.2px; }
    .subtitle{ margin-top:2px; font-size:13px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:800; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .card{
      width:100%;
      max-width:980px;
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:15px;
      font-weight:900;
      color:#111;
    }
    .tiny{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .i-main{ min-width:0; }
    .i-top{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:3px 9px;
      border-radius:999px;
      background: rgba(122,92,255,0.12);
      color:#5b45c8;
      white-space:nowrap;
    }
    .badge.ok{ background: rgba(27,143,77,0.16); color:#1b8f4d; }
    .badge.bad{ background: rgba(179,38,30,0.14); color:#b3261e; }
    .i-title{
      font-size:13px;
      font-weight:900;
      color:#222;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 640px;
    }
    .i-sub{
      margin-top:3px;
      font-size:12px;
      font-weight:800;
      color:#666;
      white-space:pre-wrap;
      max-width: 640px;
    }

    .btnbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }
    .btn.danger{
      border-color: rgba(179,38,30,0.25);
      color: var(--bad);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #D3C7FF;
      padding:10px;
      font-size:13px;
      font-weight:800;
      outline:none;
      resize:vertical;
      min-height:70px;
    }

    .divider{ height:1px; width:100%; background:rgba(122,92,255,0.18); margin:4px 0; }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.28);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding:16px;
    }
    .modal{
      width:100%;
      max-width:560px;
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(122,92,255,0.18);
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .modal h3{ margin:0; font-size:16px; font-weight:900; }
    .modal-actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="prestations.html">← Prestations</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill primary" href="planning.html">Planning</a>
        <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Validation qualité</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="alert" id="alertBox"></div>

    <section class="card">
      <div class="card-title">
        <span>Missions à valider</span>
        <span class="tiny" id="countLabel">—</span>
      </div>

      <div class="btnbar" style="justify-content:flex-start;">
        <button class="btn" id="refreshBtn" type="button">Rafraîchir</button>
      </div>

      <div class="list" id="list"></div>
    </section>
  </div>

  <!-- MODAL A_REPRENDRE -->
  <div class="modal-backdrop" id="redoBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>À reprendre</h3>
      <div class="tiny">Commentaire qualité (visible conciergerie, et réutilisable pour renvoyer à l’agent si tu veux).</div>
      <textarea id="redoText" placeholder="Ex. photos floues, salle de bain à refaire, manque preuve…"></textarea>
      <div class="modal-actions">
        <button class="btn" id="redoCancelBtn" type="button">Annuler</button>
        <button class="btn primary" id="redoSaveBtn" type="button">Enregistrer</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collectionGroup, query, where, orderBy, getDocs,
      doc, updateDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // UI
    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");
    const refreshBtn = document.getElementById("refreshBtn");
    const listEl = document.getElementById("list");
    const countLabel = document.getElementById("countLabel");

    // modal
    const redoBackdrop = document.getElementById("redoBackdrop");
    const redoText = document.getElementById("redoText");
    const redoCancelBtn = document.getElementById("redoCancelBtn");
    const redoSaveBtn = document.getElementById("redoSaveBtn");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function typeLabel(t){
      const x = (t||"").toUpperCase();
      if(x === "CHECKIN") return "Check-in";
      if(x === "MENAGE") return "Ménage";
      if(x === "CHECKOUT") return "Check-out";
      return x || "Mission";
    }

    let currentUser = null;
    let rows = [];
    let redoTarget = null; // {eventId, missionId}

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    function openRedoModal(eventId, missionId){
      redoTarget = { eventId, missionId };
      redoText.value = "";
      redoBackdrop.style.display = "flex";
      redoText.focus();
    }
    function closeRedoModal(){
      redoBackdrop.style.display = "none";
      redoTarget = null;
    }
    redoBackdrop.addEventListener("click", (e)=>{ if(e.target === redoBackdrop) closeRedoModal(); });
    redoCancelBtn.addEventListener("click", closeRedoModal);

    async function load(){
      hideAlert();
      listEl.innerHTML = "";
      rows = [];

      // Simple: collectionGroup missions (client-side filter after)
      // NB: si tu as BEAUCOUP de missions, on optimisera plus tard.
      const q = query(
        collectionGroup(db, "missions"),
        where("conciergerieUid","==", currentUser.uid),
        orderBy("updatedAt","desc")
      );

      const snap = await getDocs(q);

      rows = snap.docs.map(d=>{
        const x = d.data() || {};
        // path: events/{eventId}/missions/{missionId}
        const parts = d.ref.path.split("/");
        const eventId = parts[1];
        const missionId = parts[3];
        return {
          eventId, missionId,
          type: (x.type || "").toUpperCase(),
          status: (x.status || "").toUpperCase(),
          homeName: x.homeName || "",
          homeCity: x.homeCity || "",
          homeAddress: x.homeAddress || "",
          dateKey: x.dateKey || "",
          time: x.time || "",
          assignedToName: x.assignedToName || "",
          assignedToEmail: x.assignedToEmail || "",
          photos: Array.isArray(x.photos) ? x.photos : [],
          incident: x.incident || null,
          qcComment: x.qcComment || ""
        };
      }).filter(r => r.status === "A_VALIDER"); // ou TERMINEE_AGENT si tu changes

      countLabel.textContent = `${rows.length} mission(s)`;

      if(!rows.length){
        listEl.innerHTML = `<div style="padding:12px; border-radius:14px; background:#fff; box-shadow:0 3px 10px rgba(0,0,0,.06); color:#666; font-weight:900; font-size:12px;">
          Aucune mission à valider.
        </div>`;
        return;
      }

      for(const r of rows){
        const home = `${r.homeName || "Logement"}${r.homeCity ? " — " + r.homeCity : ""}`;
        const dt = `${r.dateKey || "—"}${r.time ? " à " + r.time : ""}${r.homeAddress ? " • " + r.homeAddress : ""}`;
        const tl = typeLabel(r.type);

        const hasIncident = !!(r.incident && r.incident.isIncident);
        const photoCount = r.photos.length;

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="i-main">
            <div class="i-top">
              <span class="badge">${esc(tl)}</span>
              <span class="badge ${photoCount>=2 ? "ok":"bad"}">${esc(photoCount)} photo(s)</span>
              ${hasIncident ? `<span class="badge bad">INCIDENT</span>` : ``}
            </div>
            <div class="i-title">${esc(home)}</div>
            <div class="i-sub">${esc(dt)}
Agent : ${esc(r.assignedToName || "—")}${r.assignedToEmail ? " • " + esc(r.assignedToEmail) : ""}</div>
          </div>
          <div class="btnbar" style="flex-direction:column; align-items:flex-end;">
            <button class="btn primary" type="button" data-validate="${esc(r.eventId)}||${esc(r.missionId)}">Valider</button>
            <button class="btn danger" type="button" data-redo="${esc(r.eventId)}||${esc(r.missionId)}">À reprendre</button>
            <button class="btn" type="button" data-replan="${esc(r.eventId)}">Replanifier</button>
          </div>
        `;
        listEl.appendChild(div);

        div.querySelector(`[data-validate]`)?.addEventListener("click", async ()=>{
          hideAlert();
          const [eventId, missionId] = div.querySelector(`[data-validate]`).getAttribute("data-validate").split("||");
          try{
            const mRef = doc(db, "events", eventId, "missions", missionId);
            await updateDoc(mRef, {
              status: "VALIDEE",
              bonAFacturer: true,
              validatedAt: serverTimestamp(),
              qcComment: "",
              updatedAt: serverTimestamp()
            });

            // Option : si toutes missions du même event sont VALIDEE -> event.status BON_A_FACTURER
            await tryPromoteEventToBonAFacturer(eventId);

            showAlert("✅ Mission validée.", true);
            await load();
          }catch(err){
            console.error(err);
            showAlert("Erreur validation : " + (err?.message || "inconnue"));
          }
        });

        div.querySelector(`[data-redo]`)?.addEventListener("click", ()=>{
          const [eventId, missionId] = div.querySelector(`[data-redo]`).getAttribute("data-redo").split("||");
          openRedoModal(eventId, missionId);
        });

        div.querySelector(`[data-replan]`)?.addEventListener("click", ()=>{
          const eventId = div.querySelector(`[data-replan]`).getAttribute("data-replan");
          location.href = `intervention.html?prestationId=${encodeURIComponent(eventId)}`;
        });
      }
    }

    async function tryPromoteEventToBonAFacturer(eventId){
      // On relit les 3 missions de l'event et si toutes VALIDEE => event.status = BON_A_FACTURER
      try{
        const eRef = doc(db, "events", eventId);
        const eSnap = await getDoc(eRef);
        if(!eSnap.exists()) return;
        const e = eSnap.data() || {};
        if(e.conciergerieUid !== currentUser.uid) return;

        // on lit les missions via getDoc direct sur IDs connus (CHECKIN/MENAGE/CHECKOUT)
        const ids = ["CHECKIN","MENAGE","CHECKOUT"];
        let allOk = true;
        for(const mid of ids){
          const mSnap = await getDoc(doc(db, "events", eventId, "missions", mid));
          if(!mSnap.exists()){ allOk = false; break; }
          const m = mSnap.data() || {};
          if((m.status||"") !== "VALIDEE"){ allOk = false; break; }
        }
        if(allOk){
          await updateDoc(eRef, {
            status: "BON_A_FACTURER",
            statusUpdatedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }
      }catch{
        // silencieux volontaire
      }
    }

    redoSaveBtn.addEventListener("click", async ()=>{
      hideAlert();
      if(!redoTarget) return;

      const txt = (redoText.value || "").trim();
      if(!txt){
        showAlert("Commentaire obligatoire pour “À reprendre”.");
        return;
      }

      try{
        const mRef = doc(db, "events", redoTarget.eventId, "missions", redoTarget.missionId);
        await updateDoc(mRef, {
          status: "A_REPRENDRE",
          qcComment: txt,
          locked: false,            // tu peux décider de laisser lock=true si tu veux empêcher l’agent
          updatedAt: serverTimestamp()
        });

        // Option : le statut global event repasse EN_COURS
        await updateDoc(doc(db, "events", redoTarget.eventId), {
          status: "EN_COURS",
          statusUpdatedAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        closeRedoModal();
        showAlert("✅ Marqué À reprendre.", true);
        await load();
      }catch(err){
        console.error(err);
        showAlert("Erreur : " + (err?.message || "inconnue"));
      }
    });

    refreshBtn.addEventListener("click", ()=> load().catch(err=>{
      console.error(err);
      showAlert("Erreur rafraîchir : " + (err?.message || "inconnue"));
    }));

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      try{
        await load();
      }catch(err){
        console.error(err);
        showAlert("Erreur initialisation : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
