<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Abonnement</title>

  <!-- Police pro -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after{ box-sizing: border-box; }

    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --grey:#666;
      --bad:#b3261e;
    }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
      cursor:pointer;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
      max-width:900px;
      line-height:1.35;
    }

    .plan-grid{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .plan-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:14px;
      border:2px solid transparent;
    }
    .plan-card.active{
      border-color: rgba(122,92,255,.55);
    }

    .plan-card .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .plan-card .name{
      font-weight:900;
      font-size:16px;
      margin:0;
    }

    .plan-card .range{
      margin:4px 0 0;
      font-size:12px;
      color:#555;
      font-weight:800;
    }

    .plan-card .p{
      font-weight:900;
      font-size:22px;
      margin:0;
      line-height:1.1;
      white-space:nowrap;
    }

    .plan-card .p small{
      font-size:12px;
      color:#555;
      font-weight:900;
    }

    .plan-card .mini{
      margin:10px 0 10px;
      font-size:12px;
      color:#444;
      line-height:1.35;
    }

    .plan-card .choose{
      display:block;
      width:100%;
      text-align:center;
      text-decoration:none;
      font-weight:900;
      padding:10px 14px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
    }
    .plan-card .choose:hover{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }

    .card{
      width:100%;
      max-width:720px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }

    .plan-badge{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(122,92,255,.25);
      font-weight:900;
      color:#5b45c8;
      font-size:12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .plan-title{
      margin:10px 0 2px;
      font-size:18px;
      font-weight:900;
      color:#111;
    }
    .price{
      font-size:34px;
      font-weight:900;
      color:#111;
      margin:6px 0;
      line-height:1;
    }
    .price small{ font-size:14px; color:#555; font-weight:900; }

    .small{
      font-size:11px;
      color:var(--grey);
      line-height:1.35;
      margin-top:10px;
    }

    .features{
      margin:10px 0 0;
      padding-left:16px;
      color:#444;
      font-size:13px;
      line-height:1.35;
    }
    .features li{ margin:6px 0; }

    .cta{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .cta-btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      flex:1;
      min-width:220px;
      text-decoration:none;
      text-align:center;
      display:inline-block;
    }

    .msg{
      margin-top:10px;
      font-size:12px;
      font-weight:900;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      border-left:5px solid var(--bad);
      color:#7a1d16;
      display:none;
      white-space:pre-wrap;
    }

    @media (min-width:700px){
      .plan-grid{ grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>

<body>
  <div class="page" id="top">

    <div class="topbar">
      <a class="pill-link" href="index.html">← Accueil</a>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">
      Choisis ton abonnement conciergerie. Paiement sécurisé via Stripe.
    </div>

    <div class="plan-grid" id="planGrid"></div>

    <div class="card">
      <div class="plan-badge" id="planBadge">Abonnement</div>

      <div class="plan-title" id="planName">—</div>
      <div class="price" id="planPrice">— <small>/ mois</small></div>
      <div class="small" id="planDesc">—</div>

      <ul class="features" id="planFeatures"></ul>

      <div class="cta">
        <a class="cta-btn" id="payNowLink" href="#">Payer en ligne</a>
      </div>

      <div class="msg" id="msgBox"></div>

      <div class="small">
        Propriétaires : accès gratuit. Paiement uniquement des prestations/kits.
      </div>
    </div>

  </div>

  <script>
    // ✅ Ton endpoint Functions (projet cleanup-manager-d9301-a44f1)
    const FUNCTIONS_BASE = "https://europe-west1-cleanup-manager-d9301-a44f1.cloudfunctions.net/api";

    const PLANS = {
      starter: {
        key: "starter",
        name: "Starter",
        range: "1–5 logements",
        price: 49.90,
        desc: "Pour démarrer et structurer votre conciergerie.",
        features: [
          "Planning • Logements • Prestations",
          "Paiements + relances (V1)",
          "Messagerie (V1) • Boutique • Import iCal",
          "Historique + export comptable (CSV/PDF)"
        ],
        // ✅ mets ton vrai priceId :
        priceId: "price_1SkPlYAMMazMXNc11Ir93REb"
      },
      pro: {
        key: "pro",
        name: "Pro",
        range: "6–10 logements",
        price: 69.90,
        desc: "Pour une conciergerie en rythme de croisière.",
        features: [
          "Planning • Logements • Prestations",
          "Paiements + relances (V1)",
          "Messagerie (V1) • Boutique • Import iCal",
          "Historique + export comptable (CSV/PDF)"
        ],
        priceId: "price_1SkPlYAMMazMXNc18UmaCuYW"
      },
      business: {
        key: "business",
        name: "Business",
        range: "11–20 logements",
        price: 89.90,
        desc: "Pour scaler avec une vue claire sur l’opérationnel.",
        features: [
          "Planning • Logements • Prestations",
          "Paiements + relances (V1)",
          "Messagerie (V1) • Boutique • Import iCal",
          "Historique + export comptable (CSV/PDF)"
        ],
        priceId: "price_1SkPlYAMMazMXNc1ucUQzaaf"
      },
      illimite: {
        key: "illimite",
        name: "Illimité",
        range: "Logements illimités",
        price: 139.00,
        desc: "Pour conciergeries à fort volume et multi-équipes.",
        features: [
          "Accès illimité",
          "Tous les modules inclus",
          "Historique + exports",
          "Priorité support (à venir)"
        ],
        priceId: "price_1SkPlYAMMazMXNc1SQH9vRAS"
      }
    };

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return (p.get(name) || "").trim();
    }

    function formatPrice(n){
      const v = Number(n || 0);
      return v.toFixed(2).replace(".", ",") + " €";
    }

    function showMsg(text){
      const box = document.getElementById("msgBox");
      box.style.display = "block";
      box.textContent = text;
    }

    function getSession(){
      try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
      catch(e){ return null; }
    }

    async function startCheckout(planKey){
      const s = getSession();
      if(!s || !s.uid || !s.email){
        showMsg("Session absente. Reconnecte-toi.");
        location.href = "login.html";
        return;
      }

      const plan = PLANS[planKey];
      if(!plan || !plan.priceId || !plan.priceId.startsWith("price_")){
        showMsg("Price ID manquant/incorrect pour ce plan.");
        return;
      }

      try{
        const res = await fetch(FUNCTIONS_BASE + "/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            uid: s.uid,
            email: s.email,
            role: s.role || "conciergerie",
            plan: plan.key,
            priceId: plan.priceId
          })
        });

        const data = await res.json();
        if(!res.ok || !data.url){
          console.error(data);
          showMsg("Erreur création paiement : " + (data.error || "inconnue"));
          return;
        }

        // redirection Stripe checkout
        location.href = data.url;

      }catch(err){
        console.error(err);
        showMsg("Erreur réseau : " + err.message);
      }
    }

    const selectedKey = (getParam("plan") || "starter").toLowerCase();
    const plan = PLANS[selectedKey] || PLANS.starter;

    // Render grid
    const grid = document.getElementById("planGrid");
    grid.innerHTML = Object.values(PLANS).map(p => {
      const active = p.key === plan.key ? "active" : "";
      return `
        <div class="plan-card ${active}">
          <div class="row">
            <div>
              <p class="name">${p.name}</p>
              <p class="range">${p.range}</p>
            </div>
            <div class="p">${formatPrice(p.price)} <small>/ mois</small></div>
          </div>
          <p class="mini">${p.desc}</p>
          <a class="choose" href="abonnement.html?plan=${p.key}">Choisir</a>
        </div>
      `;
    }).join("");

    // Render selected plan details
    document.getElementById("planBadge").textContent = "Abonnement • " + plan.name;
    document.getElementById("planName").textContent = plan.name;
    document.getElementById("planPrice").innerHTML = `${formatPrice(plan.price)} <small>/ mois</small>`;
    document.getElementById("planDesc").textContent = plan.desc;
    document.getElementById("planFeatures").innerHTML = plan.features.map(x => `<li>${x}</li>`).join("");

    // Button checkout
    const payLink = document.getElementById("payNowLink");
    payLink.href = "#";
    payLink.addEventListener("click", (e)=>{
      e.preventDefault();
      startCheckout(plan.key);
    });
  </script>
</body>
</html>