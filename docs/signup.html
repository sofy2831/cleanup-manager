<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Créer un compte</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --border: rgba(122,92,255,0.18);
      --bad:#b3261e;
      --ok:#1b8f4d;
    }

    *, *::before, *::after{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
      background: linear-gradient(180deg, #F8F4FF 0%, #EDE6FF 80%);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      text-align:center;
    }

    .container{
      width:100%;
      max-width:460px;
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      padding: 26px 22px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      gap:10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
    }

    .logo-title{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin: 10px 0 8px;
    }

    .logo-icon{
      width:42px;height:42px;
      border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--violet-main);
      font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px;
      right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{
      margin:0;
      font-size:22px;
      font-weight:900;
      letter-spacing:-0.2px;
    }

    .subtitle{
      margin:8px 0 16px;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }

    form{ text-align:left; margin-top:8px; }

    .field{ margin-bottom:12px; }
    label{
      display:block;
      font-size:13px;
      font-weight:800;
      margin: 0 0 6px;
      color:#222;
    }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid #e7e7e7;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    input:focus{
      border-color: rgba(122,92,255,0.45);
      box-shadow: 0 0 0 4px rgba(122,92,255,0.12);
    }

    .hint{
      margin:6px 0 0;
      font-size:12px;
      color:#777;
      line-height:1.35;
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(90deg, var(--violet-main), var(--violet-dark));
      box-shadow: 0 12px 24px rgba(0,0,0,0.10);
      transition: transform .18s ease;
      margin-top:6px;
    }
    .btn:hover{ transform: translateY(-1px); }

    .below{
      margin-top:12px;
      font-size:12px;
      color:#777;
      line-height:1.35;
    }

    .link{
      color: var(--violet-main);
      font-weight:900;
      text-decoration:none;
    }

    .msg{
      display:none;
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:#fff;
      border-left:5px solid var(--bad);
      color:#7a1d16;
      font-size:12px;
      font-weight:900;
      text-align:left;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <main class="container">

    <div class="topbar">
      <a class="pill" href="index.html">← Accueil</a>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>Créer un compte</h1>
    </div>

    <p class="subtitle">
      Création de compte conciergerie. Aucune info administrative requise à l’inscription.
    </p>

    <form id="signupForm" novalidate>
      <div class="field">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" autocomplete="email" required placeholder="ex: contact@maconciergerie.fr">
      </div>

      <div class="field">
        <label for="password">Mot de passe</label>
        <input id="password" name="password" type="password" autocomplete="new-password" required minlength="8" placeholder="8 caractères minimum">
        <div class="hint">Conseil : 8+ caractères, avec une majuscule et un chiffre.</div>
      </div>

      <div class="field">
        <label for="company">Nom de la conciergerie</label>
        <input id="company" name="company" type="text" required placeholder="ex: Riviera Clean Conciergerie">
      </div>

      <div class="field">
        <label for="phone">Téléphone (optionnel)</label>
        <input id="phone" name="phone" type="tel" autocomplete="tel" placeholder="ex: 06 12 34 56 78">
      </div>

      <button class="btn" type="submit" id="submitBtn">Créer mon compte conciergerie</button>

      <div class="msg" id="msgBox"></div>

      <div class="below">
        Déjà un compte ? <a class="link" href="login.html">Se connecter</a><br>
        En créant un compte, vous acceptez les conditions d’utilisation.
      </div>
    </form>

  </main>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const form = document.getElementById("signupForm");
    const msgBox = document.getElementById("msgBox");
    const submitBtn = document.getElementById("submitBtn");

    // Mets ici tes mails admin gratuits
    const FREE_EMAILS = new Set([
      "mathilde.debout31@gmail.com",
      "s.dumas974@gmail.com"
    ]);

    function normalizeEmail(e){
      return String(e || "").trim().toLowerCase();
    }

    function showMsg(text, kind="bad"){
      msgBox.style.display = "block";
      msgBox.style.borderLeftColor = (kind==="ok") ? "#1b8f4d" : "#b3261e";
      msgBox.style.color = (kind==="ok") ? "#1b8f4d" : "#7a1d16";
      msgBox.textContent = text;
    }

    function lockUI(locked){
      submitBtn.disabled = !!locked;
      submitBtn.style.opacity = locked ? "0.7" : "1";
      submitBtn.style.cursor = locked ? "not-allowed" : "pointer";
    }

    function setLocalSession({ uid, email, role, plan, planActive }){
      localStorage.setItem("cm_auth", JSON.stringify({
        uid,
        email,
        role,
        plan: plan || "",
        planActive: !!planActive
      }));
    }

    let isSubmitting = false;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if(isSubmitting) return;
      isSubmitting = true;

      msgBox.style.display = "none";
      msgBox.textContent = "";

      const email = normalizeEmail(document.getElementById("email").value);
      const password = document.getElementById("password").value;
      const company = document.getElementById("company").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if(!email) { showMsg("Email requis."); lockUI(false); isSubmitting=false; return; }
      if(!email.includes("@")) { showMsg("Email invalide."); lockUI(false); isSubmitting=false; return; }
      if(!password || password.length < 8) { showMsg("Mot de passe : 8 caractères minimum."); lockUI(false); isSubmitting=false; return; }
      if(!company) { showMsg("Nom de la conciergerie requis."); lockUI(false); isSubmitting=false; return; }

      lockUI(true);

      try{
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        const isFree = FREE_EMAILS.has(email);

        // Firestore: profil utilisateur
        await setDoc(doc(db, "users", uid), {
          uid,
          role: "conciergerie",
          email,
          company,
          phone: phone || "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          subscriptionStatus: isFree ? "active" : "inactive",
          plan: isFree ? "free-admin" : ""
        });

        // Session locale (c’est ça que conciergerie.html lit)
        setLocalSession({
          uid,
          email,
          role: "conciergerie",
          plan: isFree ? "free-admin" : "",
          planActive: isFree ? true : false
        });

        // Redirection
        if(isFree){
          window.location.href = "conciergerie.html";
        }else{
          window.location.href = "abonnement.html?plan=starter";
        }

      }catch(err){
        const code = err?.code || "";
        if(code.includes("email-already-in-use")) showMsg("Cet email est déjà utilisé. Connecte-toi.");
        else if(code.includes("weak-password")) showMsg("Mot de passe trop faible.");
        else if(code.includes("invalid-email")) showMsg("Email invalide.");
        else showMsg("Erreur création : " + (err?.message || "inconnue"));
        lockUI(false);
        isSubmitting = false;
      }
    });
  </script>
</body>
</html>



