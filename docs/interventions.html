<!-- docs/intervention.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager — Intervention agent</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
      --bg1:#F8F4FF;
      --bg2:#EDE6FF;
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px 14px 26px;
      padding-bottom:32px;
    }

    .top{
      width:100%;
      max-width:860px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0 4px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px; height:40px; border-radius:50%;
      background:#fff; border:2px solid var(--violet-main);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:var(--violet-main);
      position:relative;
      flex-shrink:0;
    }
    .logo::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-6px;
      font-size:12px;
      color:var(--violet-main);
    }
    .title{
      display:flex; flex-direction:column;
      line-height:1.05;
    }
    .title b{ font-size:15px; letter-spacing:-0.2px; }
    .title span{ font-size:12px; color:#444; font-weight:800; }

    .card{
      width:100%;
      max-width:860px;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .alert{
      display:none;
      width:100%;
      max-width:860px;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color:var(--ok); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; }
    .row > div{ flex:1; min-width:220px; }

    label{ display:block; font-size:11px; font-weight:900; color:#444; margin:0 0 4px; }
    input, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      background:#fff;
      font-size:14px;
      font-weight:800;
      color:#222;
      outline:none;
    }
    textarea{ min-height:84px; resize:vertical; font-weight:700; }
    input:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .divider{ height:1px; width:100%; background:rgba(122,92,255,0.18); margin:4px 0; }

    .kv{
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
      font-size:13px;
      color:#333;
      font-weight:800;
    }
    .kv b{ font-weight:900; color:#111; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      border:2px solid rgba(122,92,255,0.22);
      color:#5b45c8;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(27,143,77,0.30); color:var(--ok); }
    .pill.bad{ border-color: rgba(179,38,30,0.30); color:var(--bad); }

    .checklist{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .chk{
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .chk input[type="checkbox"]{
      width:18px; height:18px;
      margin-top:2px;
      accent-color: var(--violet-main);
      flex-shrink:0;
    }
    .chk .txt{
      display:flex; flex-direction:column; gap:3px;
      min-width:0;
    }
    .chk .txt .t{
      font-weight:900;
      font-size:13px;
      color:#222;
    }
    .chk .txt .s{
      font-weight:800;
      font-size:12px;
      color:#666;
    }
    .small{ font-size:12px; font-weight:800; color:#666; }
    .muted{ color:var(--muted); }

    .photos{
      display:flex; flex-direction:column; gap:8px;
    }
    .photoList{
      display:flex; flex-direction:column; gap:8px;
    }
    .photoItem{
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      font-weight:900;
      color:#333;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    .center{
      text-align:center;
      padding:18px 10px;
    }
    .big{
      font-size:18px;
      font-weight:900;
      margin:0 0 6px;
      letter-spacing:-0.2px;
    }
    .hint{
      font-size:12px;
      font-weight:800;
      color:#666;
      margin:0;
      line-height:1.35;
    }

    .loading{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:12px;
      color:#444;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--violet-main);
      animation:pulse 1s infinite ease-in-out;
    }
    .dot:nth-child(2){ animation-delay:.15s; opacity:.7; }
    .dot:nth-child(3){ animation-delay:.3s; opacity:.5; }

    @keyframes pulse{
      0%{ transform:scale(1); }
      50%{ transform:scale(1.45); }
      100%{ transform:scale(1); }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <div class="brand">
        <div class="logo">✓</div>
        <div class="title">
          <b>CleanUp Manager</b>
          <span>Intervention agent</span>
        </div>
      </div>
      <span class="pill" id="authPill">Connexion…</span>
    </div>

    <div class="alert" id="alertBox"></div>

    <!-- SCREEN 1: CODE -->
    <section class="card screen active" id="screenCode">
      <div class="center">
        <p class="big">Entrer votre code</p>
        <p class="hint">1 code = 1 mission. Le code expire automatiquement.</p>
      </div>

      <div class="row">
        <div>
          <label for="codeInput">Code (6 caractères)</label>
          <input id="codeInput" placeholder="Ex. A9K2QF" maxlength="12" autocomplete="one-time-code" />
        </div>
        <div style="flex:0; min-width:auto;">
          <button class="btn primary" id="accessBtn" type="button">Accéder</button>
        </div>
      </div>

      <div class="small muted">Astuce : copiez/collez le code reçu par email.</div>
    </section>

    <!-- SCREEN 2: CONFIRM -->
    <section class="card screen" id="screenConfirm">
      <div class="center">
        <p class="big">Confirmer la mission</p>
        <p class="hint">Vérifiez logement et horaire avant de continuer.</p>
      </div>

      <div class="kv" id="confirmKv"></div>

      <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:6px;">
        <button class="btn" id="backBtn" type="button">Retour</button>
        <button class="btn primary" id="confirmBtn" type="button">Confirmer</button>
      </div>
    </section>

    <!-- SCREEN 3: MISSION -->
    <section class="card screen" id="screenMission">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <span class="pill" id="missionTypePill">—</span>
          <span class="pill" id="missionStatusPill">—</span>
        </div>
        <span class="small muted" id="expiresLine">—</span>
      </div>

      <div class="kv" id="missionKv"></div>

      <div class="divider"></div>

      <h3 style="margin:0; font-size:14px; font-weight:900;">Checklist</h3>
      <div class="small muted">Cochez les éléments obligatoires. Certaines photos peuvent être requises.</div>

      <div class="checklist" id="checklistEl"></div>

      <div class="divider"></div>

      <h3 style="margin:0; font-size:14px; font-weight:900;">Photos (max 3)</h3>
      <div class="small muted">Les photos sont sauvegardées dans CleanUp (pas sur votre téléphone).</div>

      <div class="photos">
        <div class="row">
          <div>
            <label for="photoInput">Ajouter une photo</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
          </div>
          <div style="flex:0; min-width:auto;">
            <button class="btn" id="uploadBtn" type="button">Uploader</button>
          </div>
        </div>

        <div class="photoList" id="photoList"></div>
      </div>

      <div class="divider"></div>

      <h3 style="margin:0; font-size:14px; font-weight:900;">Commentaire (optionnel)</h3>
      <textarea id="commentInput" placeholder="Ex. Anomalie cuisine, manque une serviette…"></textarea>

      <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap;">
        <button class="btn primary" id="finishBtn" type="button">Terminer l’intervention</button>
      </div>
    </section>

    <!-- SCREEN 4: DONE -->
    <section class="card screen" id="screenDone">
      <div class="center">
        <p class="big">Mission terminée ✅</p>
        <p class="hint">Merci, votre intervention a bien été enregistrée.<br>Vous pouvez fermer cette page.</p>
      </div>
      <div class="kv" id="doneKv"></div>
    </section>
  </div>

  <script type="module">
    import { auth, db, storage } from "./firebase-init.js";
    import {
      onAuthStateChanged,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      doc, getDoc, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    import {
      ref as sRef,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ===== UI =====
    const alertBox = document.getElementById("alertBox");
    const authPill = document.getElementById("authPill");

    const screenCode = document.getElementById("screenCode");
    const screenConfirm = document.getElementById("screenConfirm");
    const screenMission = document.getElementById("screenMission");
    const screenDone = document.getElementById("screenDone");

    const codeInput = document.getElementById("codeInput");
    const accessBtn = document.getElementById("accessBtn");

    const confirmKv = document.getElementById("confirmKv");
    const backBtn = document.getElementById("backBtn");
    const confirmBtn = document.getElementById("confirmBtn");

    const missionTypePill = document.getElementById("missionTypePill");
    const missionStatusPill = document.getElementById("missionStatusPill");
    const expiresLine = document.getElementById("expiresLine");
    const missionKv = document.getElementById("missionKv");

    const checklistEl = document.getElementById("checklistEl");

    const photoInput = document.getElementById("photoInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const photoList = document.getElementById("photoList");

    const commentInput = document.getElementById("commentInput");
    const finishBtn = document.getElementById("finishBtn");

    const doneKv = document.getElementById("doneKv");

    // ===== helpers =====
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }
    function setScreen(which){
      [screenCode, screenConfirm, screenMission, screenDone].forEach(s => s.classList.remove("active"));
      which.classList.add("active");
      window.scrollTo({ top:0, behavior:"smooth" });
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function fmtDate(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d) return "—";
        return d.toLocaleString("fr-FR", { weekday:"long", year:"numeric", month:"long", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      }catch{ return "—"; }
    }
    function nowMs(){ return Date.now(); }
    function tsToMs(ts){
      try{
        if(!ts) return 0;
        if(ts.toDate) return ts.toDate().getTime();
        return new Date(ts).getTime();
      }catch{ return 0; }
    }
    function normalizeCode(raw){
      return (raw || "")
        .toString()
        .trim()
        .replace(/\s+/g,"")
        .toUpperCase();
    }

    // ===== checklist templates (simple + pro) =====
    const CHECKLISTS = {
      MENAGE: [
        { key:"SOL", label:"Sols faits (aspirateur + serpillière)", required:true },
        { key:"SDB", label:"Salle de bain (lavabo / douche / WC / miroir)", required:true },
        { key:"CUISINE", label:"Cuisine (plan de travail / évier / plaques)", required:true },
        { key:"POUBELLES", label:"Poubelles vidées + sac remis", required:true },
        { key:"LINGE", label:"Linge en place (si applicable)", required:true },
        { key:"PHOTO_PIECE", label:"Photo pièce principale", required:true, requiresPhoto:true },
        { key:"PHOTO_SDB", label:"Photo salle de bain", required:true, requiresPhoto:true }
      ],
      CHECKIN: [
        { key:"MSG", label:"Message d’arrivée envoyé / confirmé", required:true },
        { key:"CLES", label:"Boîte à clés / code OK", required:true },
        { key:"KIT", label:"Kit / consommables OK (si inclus)", required:true },
        { key:"CHECK", label:"Contrôle rapide (eau/élec/chauffage)", required:true }
      ],
      CHECKOUT: [
        { key:"SORTIE", label:"Confirmation sortie / clés récupérées", required:true },
        { key:"PHOTOS", label:"Photos état général (entrée + pièce principale)", required:true, requiresPhoto:true },
        { key:"ANOM", label:"Vérification casse / anomalies", required:true },
        { key:"LINGE", label:"Linge récupéré / mis en sac (si prévu)", required:true }
      ]
    };

    function guessTypeFromEvent(ev){
      const s = (ev?.summary || ev?.meta || "").toString().toLowerCase();
      const lines = Array.isArray(ev?.lines) ? ev.lines.map(x => (x?.label||"").toLowerCase()).join(" ") : "";
      const blob = (s + " " + lines);
      if(blob.includes("check-in") || blob.includes("checkin")) return "CHECKIN";
      if(blob.includes("check-out") || blob.includes("checkout")) return "CHECKOUT";
      if(blob.includes("ménage") || blob.includes("menage")) return "MENAGE";
      return "MENAGE";
    }

    // ===== State =====
    let currentUser = null;
    let currentCode = "";
    let accessDoc = null;     // { eventId, expiresAt, active, ... }
    let eventId = "";
    let eventData = null;

    let checklist = [];       // [{key,label,required,checked}]
    let photoUrls = [];       // up to 3

    function locked(){
      return !!eventData?.locked;
    }

    function renderConfirm(){
      const type = guessTypeFromEvent(eventData);
      const home = `${eventData?.homeName || "Logement"}${eventData?.homeCity ? " — " + eventData.homeCity : ""}`;
      const when = `${eventData?.dateKey || "—"}${eventData?.time ? " à " + eventData.time : ""}`;
      confirmKv.innerHTML = [
        `<div><b>Mission</b> : ${esc(type)}</div>`,
        `<div><b>Logement</b> : ${esc(home)}</div>`,
        `<div><b>Date/heure</b> : ${esc(when)}</div>`,
        `<div><b>Agent</b> : ${esc(eventData?.assignedToName || "—")}</div>`
      ].join("");
    }

    function renderMission(){
      const type = guessTypeFromEvent(eventData);
      const home = `${eventData?.homeName || "Logement"}${eventData?.homeCity ? " — " + eventData.homeCity : ""}`;
      const when = `${eventData?.dateKey || "—"}${eventData?.time ? " à " + eventData.time : ""}`;

      missionTypePill.textContent = type;
      missionStatusPill.textContent = locked() ? "VERROUILLÉ" : "À FAIRE";
      missionStatusPill.className = "pill " + (locked() ? "ok" : "");

      const exp = accessDoc?.expiresAt ? fmtDate(accessDoc.expiresAt) : "—";
      expiresLine.textContent = `Code expire : ${exp}`;

      missionKv.innerHTML = [
        `<div><b>Logement</b> : ${esc(home)}</div>`,
        `<div><b>Date/heure</b> : ${esc(when)}</div>`,
        `<div><b>Agent</b> : ${esc(eventData?.assignedToName || "—")}</div>`
      ].join("");

      // checklist
      checklistEl.innerHTML = "";
      if(!checklist.length){
        const div = document.createElement("div");
        div.className = "small muted";
        div.textContent = "Aucune checklist.";
        checklistEl.appendChild(div);
      }else{
        checklist.forEach((it, idx)=>{
          const wrap = document.createElement("div");
          wrap.className = "chk";
          wrap.innerHTML = `
            <input type="checkbox" ${it.checked ? "checked" : ""} ${locked() ? "disabled" : ""} data-idx="${idx}">
            <div class="txt">
              <div class="t">${esc(it.label)} ${it.required ? "• obligatoire" : ""}</div>
              ${it.requiresPhoto ? `<div class="s">Photo requise</div>` : `<div class="s">—</div>`}
            </div>
          `;
          checklistEl.appendChild(wrap);

          const cb = wrap.querySelector("input[type='checkbox']");
          cb?.addEventListener("change", (e)=>{
            const i = Number(e.target.getAttribute("data-idx"));
            checklist[i].checked = !!e.target.checked;
          });
        });
      }

      // photos
      renderPhotoList();

      // lock UI
      const isLocked = locked();
      photoInput.disabled = isLocked;
      uploadBtn.disabled = isLocked;
      commentInput.disabled = isLocked;
      finishBtn.disabled = isLocked;
      if(isLocked){
        showAlert("✅ Mission déjà terminée (verrouillée). Vous pouvez fermer la page.", true);
      }
    }

    function renderPhotoList(){
      photoList.innerHTML = "";
      if(!photoUrls.length){
        const div = document.createElement("div");
        div.className = "small muted";
        div.textContent = "Aucune photo envoyée.";
        photoList.appendChild(div);
        return;
      }
      photoUrls.forEach((url, idx)=>{
        const item = document.createElement("div");
        item.className = "photoItem";
        item.innerHTML = `
          <div>Photo ${idx+1} envoyée</div>
          <a href="${esc(url)}" target="_blank" rel="noopener noreferrer" class="small" style="font-weight:900; color:var(--violet-main); text-decoration:none;">Voir</a>
        `;
        photoList.appendChild(item);
      });
    }

    function renderDone(){
      const type = guessTypeFromEvent(eventData);
      const home = `${eventData?.homeName || "Logement"}${eventData?.homeCity ? " — " + eventData.homeCity : ""}`;
      const when = `${eventData?.dateKey || "—"}${eventData?.time ? " à " + eventData.time : ""}`;
      doneKv.innerHTML = [
        `<div><b>Mission</b> : ${esc(type)}</div>`,
        `<div><b>Logement</b> : ${esc(home)}</div>`,
        `<div><b>Date/heure</b> : ${esc(when)}</div>`,
        `<div><b>Statut</b> : En attente de validation par la conciergerie</div>`
      ].join("");
    }

    function validateBeforeFinish(){
      if(locked()){
        showAlert("Mission déjà verrouillée.", true);
        return false;
      }
      // required checklist
      const missing = checklist.filter(x => x.required && !x.checked);
      if(missing.length){
        showAlert("Checklist incomplète : coche les éléments obligatoires.");
        return false;
      }
      // photo-required items
      const needPhoto = checklist.some(x => x.required && x.requiresPhoto);
      if(needPhoto && photoUrls.length < 1){
        showAlert("Au moins 1 photo est requise pour cette mission.");
        return false;
      }
      return true;
    }

    // ===== load mission via code =====
    async function loadByCode(code){
      hideAlert();
      accessBtn.disabled = true;
      accessBtn.textContent = "Chargement…";

      try{
        const accessRef = doc(db, "agentAccess", code);
        const accessSnap = await getDoc(accessRef);
        if(!accessSnap.exists()){
          showAlert("Code invalide.");
          return;
        }
        const acc = accessSnap.data() || {};
        if(acc.active === false){
          showAlert("Code déjà utilisé ou désactivé.");
          return;
        }
        if(!acc.eventId){
          showAlert("Code mal configuré (eventId manquant).");
          return;
        }
        if(acc.expiresAt){
          const expMs = tsToMs(acc.expiresAt);
          if(expMs && nowMs() > expMs){
            showAlert("Code expiré.");
            return;
          }
        }

        // read event
        const evRef = doc(db, "events", acc.eventId);
        const evSnap = await getDoc(evRef);
        if(!evSnap.exists()){
          showAlert("Mission introuvable.");
          return;
        }

        currentCode = code;
        accessDoc = { id: accessSnap.id, ...acc };
        eventId = acc.eventId;
        eventData = { id: evSnap.id, ...(evSnap.data() || {}) };

        // prepare checklist:
        // - if eventData.agentChecklist exists: use it
        // - else: create from template (based on guess type)
        const existing = Array.isArray(eventData.agentChecklist) ? eventData.agentChecklist : null;
        if(existing && existing.length){
          checklist = existing.map(x => ({
            key: x.key || "",
            label: x.label || "",
            required: !!x.required,
            requiresPhoto: !!x.requiresPhoto,
            checked: !!x.checked
          }));
        }else{
          const t = guessTypeFromEvent(eventData);
          checklist = (CHECKLISTS[t] || CHECKLISTS.MENAGE).map(x => ({ ...x, checked:false }));
        }

        // photos already stored?
        photoUrls = Array.isArray(eventData.agentPhotos) ? eventData.agentPhotos.slice(0,3) : [];

        renderConfirm();
        setScreen(screenConfirm);

      }catch(err){
        console.error(err);
        showAlert("Erreur : " + (err?.message || "inconnue"));
      }finally{
        accessBtn.disabled = false;
        accessBtn.textContent = "Accéder";
      }
    }

    // ===== upload photo =====
    async function uploadPhoto(){
      hideAlert();
      if(locked()){
        showAlert("Mission verrouillée : impossible d’ajouter des photos.", true);
        return;
      }
      if(photoUrls.length >= 3){
        showAlert("Maximum 3 photos.");
        return;
      }
      const file = photoInput.files && photoInput.files[0];
      if(!file){
        showAlert("Choisis une photo.");
        return;
      }
      if(!file.type.startsWith("image/")){
        showAlert("Fichier invalide (image uniquement).");
        return;
      }

      uploadBtn.disabled = true;
      uploadBtn.textContent = "Upload…";

      try{
        // storage path
        const safeCode = currentCode || "CODE";
        const ts = Date.now();
        const path = `agent-photos/${eventId}/${safeCode}_${ts}_${Math.floor(Math.random()*1000)}.jpg`;
        const fileRef = sRef(storage, path);

        await uploadBytes(fileRef, file, { contentType: file.type });
        const url = await getDownloadURL(fileRef);

        photoUrls.push(url);
        photoInput.value = "";
        renderPhotoList();

        showAlert("✅ Photo envoyée.", true);
      }catch(err){
        console.error(err);
        showAlert("Erreur upload : " + (err?.message || "inconnue"));
      }finally{
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Uploader";
      }
    }

    // ===== finish mission (transaction) =====
    async function finishMission(){
      hideAlert();
      if(!validateBeforeFinish()) return;

      finishBtn.disabled = true;
      finishBtn.textContent = "Envoi en cours…";

      try{
        const accessRef = doc(db, "agentAccess", currentCode);
        const evRef = doc(db, "events", eventId);

        const comment = (commentInput.value || "").trim();

        await runTransaction(db, async (tx)=>{
          const aSnap = await tx.get(accessRef);
          if(!aSnap.exists()) throw new Error("Code introuvable.");
          const a = aSnap.data() || {};
          if(a.active === false) throw new Error("Code déjà utilisé.");
          if(a.expiresAt){
            const expMs = tsToMs(a.expiresAt);
            if(expMs && nowMs() > expMs) throw new Error("Code expiré.");
          }
          if(a.eventId !== eventId) throw new Error("Code invalide (mauvaise mission).");

          const eSnap = await tx.get(evRef);
          if(!eSnap.exists()) throw new Error("Mission introuvable.");
          const ev = eSnap.data() || {};
          if(ev.locked === true) throw new Error("Mission déjà verrouillée.");

          // write mission fields
          tx.update(evRef, {
            // agent
            statusAgent: "TERMINEE",
            statusConciergerie: "A_VALIDER",
            locked: true,
            completedAt: serverTimestamp(),
            completedByAgent: true,

            agentChecklist: checklist.map(x => ({
              key: x.key || "",
              label: x.label || "",
              required: !!x.required,
              requiresPhoto: !!x.requiresPhoto,
              checked: !!x.checked
            })),
            agentPhotos: photoUrls.slice(0,3),
            agentComment: comment,
            agentCompletedCode: currentCode,
            agentCompletedAt: serverTimestamp()
          });

          // invalidate code
          tx.update(accessRef, {
            active: false,
            usedAt: serverTimestamp()
          });
        });

        // refresh local state
        eventData.locked = true;

        // micro feedback 1s then show done
        showAlert("Envoi OK. Merci ✅", true);

        setTimeout(()=>{
          renderDone();
          setScreen(screenDone);
        }, 800);

      }catch(err){
        console.error(err);
        showAlert("Erreur finalisation : " + (err?.message || "inconnue"));
      }finally{
        finishBtn.disabled = false;
        finishBtn.textContent = "Terminer l’intervention";
      }
    }

    // ===== events =====
    accessBtn.addEventListener("click", ()=>{
      const code = normalizeCode(codeInput.value);
      if(!code){
        showAlert("Entre un code.");
        return;
      }
      loadByCode(code);
    });

    codeInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        accessBtn.click();
      }
    });

    backBtn.addEventListener("click", ()=>{
      hideAlert();
      setScreen(screenCode);
    });

    confirmBtn.addEventListener("click", ()=>{
      hideAlert();
      // show mission
      renderMission();
      setScreen(screenMission);
    });

    uploadBtn.addEventListener("click", uploadPhoto);
    finishBtn.addEventListener("click", finishMission);

    // ===== boot auth: anonymous =====
    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          await signInAnonymously(auth);
          return;
        }
        currentUser = user;
        authPill.textContent = "Accès agent";
        authPill.className = "pill ok";

        // optional: allow code in URL ?code=XXXXXX
        const url = new URL(location.href);
        const pre = normalizeCode(url.searchParams.get("code") || "");
        if(pre){
          codeInput.value = pre;
          loadByCode(pre);
        }
      }catch(err){
        console.error(err);
        authPill.textContent = "Erreur accès";
        authPill.className = "pill bad";
        showAlert("Erreur auth : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
