<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Catalogue</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-top:10px; margin-bottom:6px; text-align:center;
    }
    .logo-icon{
      width:44px;height:44px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);font-size:22px;font-weight:900;
      position:relative;flex-shrink:0;
    }
    .logo-icon::after{ content:"✦"; position:absolute; top:-6px; right:-5px; font-size:12px; color:var(--violet-main); }
    h1{ margin:0; font-size:26px; font-weight:900; }
    .subtitle{ margin-top:2px; font-size:14px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:700; text-align:center; }

    .navstrip{
      margin-top:12px;
      display:inline-flex;
      flex-wrap:wrap;
      gap:4px;
      background:#fff;
      border-radius:999px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      padding:3px;
      max-width:980px;
      justify-content:center;
    }
    .navstrip a{
      text-decoration:none;
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      color:#555;
      font-weight:800;
    }
    .navstrip a.active{
      background:var(--violet-main);
      color:#fff;
      font-weight:900;
    }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    @media(min-width:860px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }
    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      padding: 14px;
    }
    .list-card{ flex:1.35; }
    .form-card{ flex:1; }

    .card-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-weight:900; font-size:15px;
      margin-bottom:10px;
    }
    .card-sub{ font-size:12px; color:var(--muted); font-weight:800; }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .filter{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      background:#fff;
      color:#555;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      font-weight:900;
    }
    .filter.active{
      background:var(--violet-main);
      color:#fff;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:520px;
      overflow:auto;
      padding-right:2px;
    }
    .item{
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 3px 10px rgba(0,0,0,.05);
      border:2px solid transparent;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item:hover{ border-color: rgba(122,92,255,.35); }

    .row1{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
    .name{ font-weight:900; color:#333; }
    .chip{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }
    .chip.c-menage{ background:#E9F7EF; color:#1E7A3A; }
    .chip.c-checkin{ background:#E8F0FE; color:#1A5FD0; }
    .chip.c-reassort{ background:#FFF4E5; color:#A15C00; }
    .chip.c-autre{ background:#EFEAFB; color:#5B45C8; }

    .meta{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; color:#555; }
    .price{ font-weight:900; color:var(--violet-dark); }
    .kits{
      font-size:11px;
      color:#2e7b32;
      background:#e1f5e4;
      padding:2px 8px;
      border-radius:999px;
      font-weight:900;
      white-space:nowrap;
    }
    .desc{ font-size:12px; color:#666; }

    form{ display:flex; flex-direction:column; gap:10px; }
    label{ font-size:12px; font-weight:900; color:#333; text-align:left; }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }
    .inline{ display:flex; gap:10px; }
    .inline > div{ flex:1; }

    .check{
      display:flex; gap:8px; align-items:center;
      font-size:12px; color:#444; font-weight:800;
    }
    .check input{ width:auto; }

    .btnrow{ display:flex; gap:10px; }
    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn.ghost{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.danger{
      background:linear-gradient(90deg,#d64c4c,#b3261e);
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,0.10);
      display:none;
    }

    .tiny{ font-size:11px; color:#666; line-height:1.3; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="conciergerie.html">← Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill primary" href="planning.html">Planning</a>
        <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Catalogue de prestations</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="navstrip">
      <a href="planning.html">Planning</a>
      <a href="logements.html">Logements</a>
      <a href="prestations.html" class="active">Catalogue</a>
      <a href="import-ical.html">Import iCal</a>
      <a href="messagerie.html">Messagerie</a>
      <a href="historique.html">Historique</a>
      <a href="paiements.html">Paiements</a>
    </div>

    <div class="alert" id="alertBox"></div>

    <div class="layout">
      <div class="card list-card">
        <div class="card-title">
          <span>Prestations</span>
          <span class="card-sub" id="countLabel">—</span>
        </div>

        <div class="filters">
          <button class="filter active" data-filter="all">Tous</button>
          <button class="filter" data-filter="menage">Ménage</button>
          <button class="filter" data-filter="checkin">Check-in / out</button>
          <button class="filter" data-filter="reassort">Réassort & kits</button>
          <button class="filter" data-filter="autre">Autres</button>
        </div>

        <div class="list" id="list"></div>
        <div class="tiny" style="margin-top:10px;">Clique une prestation pour la modifier / supprimer.</div>
      </div>

      <div class="card form-card">
        <div class="card-title">
          <span id="formTitle">Nouvelle prestation</span>
          <span class="card-sub" id="formSub">Catalogue</span>
        </div>

        <form id="form">
          <input type="hidden" id="svcId">

          <div>
            <label for="name">Nom</label>
            <input id="name" required placeholder="Ex. Ménage complet T2">
          </div>

          <div class="inline">
            <div>
              <label for="category">Catégorie</label>
              <select id="category" required>
                <option value="menage">Ménage</option>
                <option value="checkin">Check-in / out</option>
                <option value="reassort">Réassort & kits</option>
                <option value="autre">Autre</option>
              </select>
            </div>
            <div>
              <label for="duration">Durée (optionnel)</label>
              <input id="duration" placeholder="Ex. 1 h 30">
            </div>
          </div>

          <div class="inline">
            <div>
              <label for="price">Tarif (optionnel)</label>
              <input id="price" type="number" min="0" step="1" placeholder="Ex. 45">
            </div>
            <div>
              <label for="unit">Unité</label>
              <select id="unit">
                <option value="€/prestation">€/prestation</option>
                <option value="€/heure">€/heure</option>
                <option value="€/séjour">€/séjour</option>
              </select>
            </div>
          </div>

          <div class="check">
            <input id="kits" type="checkbox" checked>
            <label for="kits" style="margin:0;">Inclut des kits</label>
          </div>

          <div>
            <label for="desc">Description (optionnel)</label>
            <textarea id="desc" rows="3" placeholder="Détails..."></textarea>
          </div>

          <div class="btnrow">
            <button class="btn primary" type="submit" id="saveBtn">Ajouter</button>
            <button class="btn ghost" type="button" id="resetBtn">Annuler</button>
          </div>

          <button class="btn danger" type="button" id="deleteBtn">Supprimer</button>

          <div class="tiny">
            Le catalogue sert à proposer des choix quand tu crées une prestation depuis le planning.
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, onSnapshot,
      addDoc, updateDoc, deleteDoc, doc,
      serverTimestamp, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");

    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    const FREE_EMAILS = new Set(["mathilde.debout31@gmail.com","s.dumas974@gmail.com"]);
    async function guardConciergerie(user){
      const email = (user.email || "").toLowerCase();
      if(FREE_EMAILS.has(email)) return true;
      try{
        const snap = await getDoc(doc(db,"users",user.uid));
        if(!snap.exists()) return false;
        const d = snap.data() || {};
        return (d.role === "conciergerie" || d.role === "admin") && d.subscriptionStatus === "active";
      }catch(e){ return false; }
    }

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // ===== Catalogue logic =====
    const listEl = document.getElementById("list");
    const countLabel = document.getElementById("countLabel");
    const filterBtns = document.querySelectorAll(".filter");

    const form = document.getElementById("form");
    const formTitle = document.getElementById("formTitle");
    const formSub = document.getElementById("formSub");
    const svcId = document.getElementById("svcId");
    const nameEl = document.getElementById("name");
    const categoryEl = document.getElementById("category");
    const durationEl = document.getElementById("duration");
    const priceEl = document.getElementById("price");
    const unitEl = document.getElementById("unit");
    const kitsEl = document.getElementById("kits");
    const descEl = document.getElementById("desc");
    const saveBtn = document.getElementById("saveBtn");
    const resetBtn = document.getElementById("resetBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    let currentUser = null;
    let currentFilter = "all";
    let allServices = [];
    let unsub = null;

    function categoryLabel(cat){
      switch(cat){
        case "menage": return "Ménage";
        case "checkin": return "Check-in / out";
        case "reassort": return "Réassort & kits";
        default: return "Autre";
      }
    }
    function categoryClass(cat){
      if(cat==="menage") return "c-menage";
      if(cat==="checkin") return "c-checkin";
      if(cat==="reassort") return "c-reassort";
      return "c-autre";
    }
    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function resetForm(){
      svcId.value = "";
      form.reset();
      kitsEl.checked = true;
      categoryEl.value = "menage";
      unitEl.value = "€/prestation";
      formTitle.textContent = "Nouvelle prestation";
      formSub.textContent = "Catalogue";
      saveBtn.textContent = "Ajouter";
      deleteBtn.style.display = "none";
    }

    function loadIntoForm(id){
      const svc = allServices.find(s => s.id === id);
      if(!svc) return;

      svcId.value = svc.id;
      nameEl.value = svc.name || "";
      categoryEl.value = svc.category || "menage";
      durationEl.value = svc.duration || "";
      priceEl.value = (svc.price == null) ? "" : String(svc.price);
      unitEl.value = svc.unit || "€/prestation";
      kitsEl.checked = !!svc.kits;
      descEl.value = svc.desc || "";

      formTitle.textContent = "Modifier prestation";
      formSub.textContent = "Catalogue";
      saveBtn.textContent = "Enregistrer";
      deleteBtn.style.display = "block";
      window.scrollTo({ top: 0, behavior:"smooth" });
    }

    function getFiltered(){
      const list = allServices.slice();
      return list.filter(s => currentFilter === "all" ? true : s.category === currentFilter);
    }

    function render(){
      const filtered = getFiltered();
      countLabel.textContent = `${filtered.length} prestation${filtered.length>1?"s":""}`;

      listEl.innerHTML = "";
      if(!filtered.length){
        const d = document.createElement("div");
        d.className = "item";
        d.style.cursor = "default";
        d.textContent = "Aucune prestation. Ajoute-en une à droite.";
        listEl.appendChild(d);
        return;
      }

      filtered.forEach(svc=>{
        const item = document.createElement("div");
        item.className = "item";
        item.addEventListener("click", ()=> loadIntoForm(svc.id));

        const priceTxt = (svc.price != null && svc.unit) ? `${svc.price} ${svc.unit}` : "—";
        item.innerHTML = `
          <div class="row1">
            <div>
              <div class="name">${esc(svc.name || "(sans nom)")}</div>
              <div class="chip ${categoryClass(svc.category)}">${esc(categoryLabel(svc.category))}</div>
            </div>
            <div style="font-size:11px;font-weight:900;color:${(svc.active!==false)?"#1b8f4d":"#b3261e"};">
              ${(svc.active!==false)?"Actif":"Inactif"}
            </div>
          </div>
          <div class="meta">
            <span class="price">${esc(priceTxt)}</span>
            <span>${esc(svc.duration || "Durée —")}</span>
            ${svc.kits ? `<span class="kits">Kits</span>` : ``}
          </div>
          <div class="desc">${esc(svc.desc || "")}</div>
        `;
        listEl.appendChild(item);
      });
    }

    async function saveService(e){
      e.preventDefault();
      hideAlert();
      if(!currentUser) return showAlert("Pas connecté Firebase.");

      const id = svcId.value.trim();
      const payload = {
        conciergerieUid: currentUser.uid,
        name: nameEl.value.trim(),
        category: categoryEl.value,
        duration: durationEl.value.trim(),
        price: priceEl.value ? Number(priceEl.value) : null,
        unit: unitEl.value,
        kits: !!kitsEl.checked,
        desc: descEl.value.trim(),
        active: true,
        updatedAt: serverTimestamp()
      };
      if(!payload.name) return showAlert("Nom obligatoire.");

      try{
        if(id){
          await updateDoc(doc(db,"services",id), payload);
          showAlert("✅ Prestation mise à jour.", true);
        }else{
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,"services"), payload);
          showAlert("✅ Prestation ajoutée.", true);
        }
        resetForm();
      }catch(err){
        console.error(err);
        showAlert("Erreur sauvegarde : " + (err?.message || "inconnue"));
      }
    }

    async function deleteSelected(){
      hideAlert();
      if(!currentUser) return showAlert("Pas connecté Firebase.");
      const id = svcId.value.trim();
      if(!id) return;

      const svc = allServices.find(s=>s.id===id);
      if(!svc) return;

      if(!confirm(`Supprimer "${svc.name || "cette prestation"}" ?`)) return;

      try{
        await deleteDoc(doc(db,"services",id));
        showAlert("✅ Supprimé.", true);
        resetForm();
      }catch(err){
        console.error(err);
        showAlert("Erreur suppression : " + (err?.message || "inconnue"));
      }
    }

    function startListener(){
      if(unsub) unsub();
      const q = query(collection(db,"services"), where("conciergerieUid","==", currentUser.uid));
      unsub = onSnapshot(q, (snap)=>{
        allServices = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        allServices.sort((a,b)=>{
          const ta = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const tb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return tb - ta;
        });
        render();
      }, (err)=>{
        console.error(err);
        showAlert("Erreur lecture catalogue : " + (err?.message || "inconnue"));
      });
    }

    filterBtns.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        filterBtns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter || "all";
        render();
      });
    });

    form.addEventListener("submit", saveService);
    resetBtn.addEventListener("click", resetForm);
    deleteBtn.addEventListener("click", deleteSelected);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }

      const ok = await guardConciergerie(user);
      if(!ok){
        location.href = "abonnement.html?plan=starter";
        return;
      }

      currentUser = user;
      emailLine.textContent = user.email || user.uid;
      resetForm();
      startListener();
    });
  </script>
</body>
</html>
