<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Prestations</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --muted:#666;
      --ok:#1b8f4d;
      --bad:#b3261e;
      --border: rgba(122,92,255,0.18);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background: rgba(248,244,255,.85);
      backdrop-filter: blur(6px);
    }
    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:8px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"‚ú¶";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{ font-size:24px; margin:0; font-weight:900; color:#111; }
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
      max-width:980px;
      line-height:1.35;
    }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    /* Context card (arriv√©e depuis planning) */
    .context{
      width:100%;
      max-width:980px;
      margin-top:12px;
      display:none;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.08);
      backdrop-filter: blur(8px);
      padding:14px 14px 12px;
    }
    .context-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .context-title{
      font-weight:900;
      font-size:14px;
      color:#111;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .context-sub{
      font-size:12px;
      color:#555;
      margin-top:4px;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .context-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .mini-btn{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .mini-btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .context-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    @media(min-width:760px){
      .context-grid{ grid-template-columns: 1fr 1fr; }
    }
    .context-box{
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      border:1px solid rgba(0,0,0,0.06);
      box-shadow:0 3px 10px rgba(0,0,0,.05);
    }
    .context-label{
      font-size:11px;
      font-weight:900;
      color:#666;
      margin-bottom:6px;
    }
    .context-value{
      font-size:13px;
      font-weight:900;
      color:#222;
    }
    .context-note{
      margin-top:6px;
      font-size:12px;
      color:#555;
      line-height:1.35;
      white-space:pre-wrap;
    }
    .context-edit{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .context-edit .field{
      flex:1;
      min-width:160px;
      text-align:left;
    }
    .context-edit label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:#666;
      margin:0 0 4px;
    }
    .context-edit input{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    .context-help{
      margin-top:10px;
      font-size:12px;
      color:#444;
      line-height:1.35;
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      border-left:5px solid var(--ok);
      box-shadow:0 3px 10px rgba(0,0,0,.05);
    }

    /* Layout */
    .services-layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media(min-width:860px){
      .services-layout{ flex-direction:row; align-items:flex-start; }
    }

    .services-card, .edit-card{
      background: linear-gradient(180deg,#fff 0%, #EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }
    .services-card{ flex:1.35; }
    .edit-card{ flex:1; }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .sub{
      font-size:12px;
      font-weight:800;
      color:#666;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .filter-btn{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      background:#fff;
      color:#555;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      font-weight:900;
    }
    .filter-btn.active{
      background:var(--violet-main);
      color:#fff;
    }

    .services-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:520px;
      overflow-y:auto;
    }
    .service-item{
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      box-shadow:0 3px 10px rgba(0,0,0,.05);
      font-size:13px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      border:2px solid transparent;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .service-item:hover{
      border-color: rgba(122,92,255,.35);
      transform: translateY(-1px);
      box-shadow:0 6px 14px rgba(0,0,0,.08);
    }

    .service-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .service-name{ font-weight:900; color:#333; }
    .service-chip{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      white-space:nowrap;
      font-weight:900;
    }
    .service-chip.c-menage{ background:#E9F7EF; color:#1E7A3A; }
    .service-chip.c-checkin{ background:#E8F0FE; color:#1A5FD0; }
    .service-chip.c-reassort{ background:#FFF4E5; color:#A15C00; }
    .service-chip.c-autre{ background:#EFEAFB; color:#5B45C8; }

    .service-mainline{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:#555;
      flex-wrap:wrap;
    }
    .service-meta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .price-tag{ font-weight:900; color:var(--violet-dark); }
    .duration-tag{ font-size:11px; color:#666; }
    .kits-tag{
      font-size:11px;
      color:#2e7b32;
      background:#e1f5e4;
      padding:2px 8px;
      border-radius:999px;
      white-space:nowrap;
      font-weight:900;
    }
    .desc{ font-size:12px; color:#666; }

    /* Form */
    .edit-card form{ display:flex; flex-direction:column; gap:8px; }
    .form-group{ text-align:left; }
    .form-group label{
      display:block;
      font-size:12px;
      font-weight:900;
      margin-bottom:4px;
      color:#333;
    }
    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    .inline-fields{ display:flex; gap:8px; }
    .inline-fields .form-group{ flex:1; }
    .small-hint{ font-size:10px; color:#777; margin-top:2px; line-height:1.25; }
    .checkbox-row{ display:flex; align-items:center; gap:6px; font-size:11px; color:#444; }

    .btn-row{ display:flex; gap:8px; margin-top:8px; }
    .cta-btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }
    .ghost-btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .danger-btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(90deg,#d64c4c,#b3261e);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
      display:none;
    }
    .note{ margin-top:8px; font-size:11px; color:#666; line-height:1.25; }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill-link primary" id="planningLink" href="planning.html">Planning</a>
        <button class="pill-link" id="logoutBtn" type="button">D√©connexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">‚úì</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">
      Catalogue des prestations (dur√©es / tarifs).<br>
      Si tu arrives depuis une r√©servation, tu peux cr√©er une prestation en 1 clic.
    </div>

    <div class="alert" id="alertBox"></div>

    <!-- CONTEXTE (si arriv√© depuis planning) -->
    <section class="context" id="contextCard">
      <div class="context-head">
        <div>
          <p class="context-title">üß© Contexte r√©servation</p>
          <div class="context-sub" id="contextSub">‚Äî</div>
        </div>
        <div class="context-actions">
          <button class="mini-btn" type="button" id="clearContextBtn">Retirer le contexte</button>
          <button class="mini-btn primary" type="button" id="goPlanningBtn">Retour planning</button>
        </div>
      </div>

      <div class="context-grid">
        <div class="context-box">
          <div class="context-label">Logement</div>
          <div class="context-value" id="ctxHomeLabel">‚Äî</div>
          <div class="context-note" id="ctxHomeNote"></div>
        </div>

        <div class="context-box">
          <div class="context-label">Date / heure (modifiable)</div>
          <div class="context-edit">
            <div class="field">
              <label for="ctxDateKey">Date</label>
              <input id="ctxDateKey" type="text" placeholder="YYYY-MM-DD">
            </div>
            <div class="field">
              <label for="ctxTime">Heure</label>
              <input id="ctxTime" type="text" placeholder="HH:MM">
            </div>
          </div>
          <div class="context-note" id="ctxSummary">‚Äî</div>
        </div>
      </div>

      <div class="context-help" id="ctxHelp">
        üëâ Clique une prestation dans la liste √† gauche pour la cr√©er pour ce logement + date/heure.
      </div>
    </section>

    <div class="services-layout">
      <div class="services-card">
        <div class="card-title">
          <span>Prestations</span>
          <span class="sub" id="servicesCountLabel">‚Äî</span>
        </div>

        <div class="filters">
          <button class="filter-btn active" data-filter="all">Tous</button>
          <button class="filter-btn" data-filter="menage">M√©nage</button>
          <button class="filter-btn" data-filter="checkin">Check-in / Check-out</button>
          <button class="filter-btn" data-filter="reassort">R√©assort & kits</button>
          <button class="filter-btn" data-filter="autre">Autres</button>
        </div>

        <div class="services-list" id="servicesList"></div>

        <div class="note">
          Astuce : clic = <b>modifier</b> (sans contexte) ‚Ä¢ clic = <b>cr√©er une presta</b> (avec contexte).
        </div>
      </div>

      <div class="edit-card">
        <div class="card-title">
          <span id="formTitle">Nouvelle prestation</span>
          <span class="sub" id="formSub">Catalogue</span>
        </div>

        <form id="serviceForm">
          <input type="hidden" id="svc-id">

          <div class="form-group">
            <label for="svc-name">Nom</label>
            <input id="svc-name" type="text" placeholder="Ex. M√©nage complet T2" required>
          </div>

          <div class="inline-fields">
            <div class="form-group">
              <label for="svc-category">Cat√©gorie</label>
              <select id="svc-category" required>
                <option value="menage">M√©nage</option>
                <option value="checkin">Check-in / Check-out</option>
                <option value="reassort">R√©assort & kits</option>
                <option value="autre">Autre</option>
              </select>
            </div>
            <div class="form-group">
              <label for="svc-duration">Dur√©e</label>
              <input id="svc-duration" type="text" placeholder="Ex. 1 h 30">
              <div class="small-hint">Indicatif pour la planification.</div>
            </div>
          </div>

          <div class="inline-fields">
            <div class="form-group">
              <label for="svc-price">Tarif</label>
              <input id="svc-price" type="number" min="0" step="1" placeholder="Ex. 45">
            </div>
            <div class="form-group">
              <label for="svc-unit">Unit√©</label>
              <select id="svc-unit">
                <option value="‚Ç¨/prestation">‚Ç¨/prestation</option>
                <option value="‚Ç¨/heure">‚Ç¨/heure</option>
                <option value="‚Ç¨/s√©jour">‚Ç¨/s√©jour</option>
              </select>
            </div>
          </div>

          <div class="checkbox-row">
            <input id="svc-kits" type="checkbox" checked>
            <label for="svc-kits">Inclut un ou plusieurs kits CleanUp.</label>
          </div>

          <div class="form-group">
            <label for="svc-desc">Description</label>
            <textarea id="svc-desc" rows="3"
              placeholder="Ex. M√©nage int√©gral, sols, surfaces, sanitaires, draps, kit accueil‚Ä¶"></textarea>
          </div>

          <div class="btn-row">
            <button class="cta-btn" type="submit" id="btnSave">Ajouter</button>
            <button class="ghost-btn" type="button" id="btnReset">Annuler</button>
          </div>

          <button class="danger-btn" type="button" id="btnDelete">
            Supprimer
          </button>

          <div class="note">
            Le catalogue sert √† cr√©er des prestations sur le planning.
          </div>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, onSnapshot,
      addDoc, updateDoc, deleteDoc, doc, getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI =====
    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    const planningLink = document.getElementById("planningLink");

    const servicesListEl = document.getElementById("servicesList");
    const servicesCountLabel = document.getElementById("servicesCountLabel");
    const filterButtons = document.querySelectorAll(".filter-btn");

    const form = document.getElementById("serviceForm");
    const formTitle = document.getElementById("formTitle");
    const formSub = document.getElementById("formSub");
    const btnSave = document.getElementById("btnSave");
    const btnDelete = document.getElementById("btnDelete");
    const btnReset = document.getElementById("btnReset");

    const f_id = document.getElementById("svc-id");
    const f_name = document.getElementById("svc-name");
    const f_category = document.getElementById("svc-category");
    const f_duration = document.getElementById("svc-duration");
    const f_price = document.getElementById("svc-price");
    const f_unit = document.getElementById("svc-unit");
    const f_kits = document.getElementById("svc-kits");
    const f_desc = document.getElementById("svc-desc");

    // Context UI
    const contextCard = document.getElementById("contextCard");
    const contextSub = document.getElementById("contextSub");
    const ctxHomeLabel = document.getElementById("ctxHomeLabel");
    const ctxHomeNote = document.getElementById("ctxHomeNote");
    const ctxSummary = document.getElementById("ctxSummary");
    const ctxDateKey = document.getElementById("ctxDateKey");
    const ctxTime = document.getElementById("ctxTime");
    const clearContextBtn = document.getElementById("clearContextBtn");
    const goPlanningBtn = document.getElementById("goPlanningBtn");

    // ===== Helpers =====
    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return (p.get(name) || "").trim();
    }

    function categoryLabel(cat){
      switch(cat){
        case "menage": return "M√©nage";
        case "checkin": return "Check-in / Check-out";
        case "reassort": return "R√©assort & kits";
        default: return "Autre";
      }
    }
    function categoryClass(cat){
      if(cat==="menage") return "c-menage";
      if(cat==="checkin") return "c-checkin";
      if(cat==="reassort") return "c-reassort";
      return "c-autre";
    }

    function isValidDateKey(s){
      return /^\d{4}-\d{2}-\d{2}$/.test(String(s||"").trim());
    }
    function isValidTime(s){
      return /^\d{2}:\d{2}$/.test(String(s||"").trim());
    }

    // ===== State =====
    let currentUser = null;
    let currentFilter = "all";
    let allServices = [];
    let unsub = null;

    // Context (arriv√©e depuis planning)
    const ctx = {
      enabled: false,
      homeId: "",
      dateKey: "",
      time: "",
      summary: "",
      icalEventId: "",
      homeName: "",
      homeCity: "",
      ownerName: "",
      ownerEmail: "",
    };

    function loadContextFromUrl(){
      const homeId = getParam("homeId");
      const dateKey = getParam("dateKey");
      const time = getParam("time");
      const summary = getParam("summary");
      const icalEventId = getParam("icalEventId");

      if(!homeId) return false;

      ctx.enabled = true;
      ctx.homeId = homeId;
      ctx.dateKey = isValidDateKey(dateKey) ? dateKey : "";
      ctx.time = isValidTime(time) ? time : "";
      ctx.summary = summary || "";
      ctx.icalEventId = icalEventId || "";
      return true;
    }

    async function hydrateHome(homeId){
      try{
        const snap = await getDoc(doc(db, "homes", homeId));
        if(!snap.exists()) return false;
        const h = snap.data() || {};
        ctx.homeName = h.name || "";
        ctx.homeCity = h.city || "";
        ctx.ownerName = h.ownerName || "";
        ctx.ownerEmail = h.ownerEmail || "";
        return true;
      }catch(e){
        console.warn("home read failed:", e);
        return false;
      }
    }

    function renderContextCard(){
      if(!ctx.enabled){
        contextCard.style.display = "none";
        return;
      }
      contextCard.style.display = "block";

      const hLabel = (ctx.homeName || ctx.homeCity)
        ? `${ctx.homeName || "Logement"}${ctx.homeCity ? " ‚Äî " + ctx.homeCity : ""}`
        : `Logement: ${ctx.homeId}`;

      ctxHomeLabel.textContent = hLabel;

      const ownerLine = ctx.ownerName ? ctx.ownerName : (ctx.ownerEmail ? ctx.ownerEmail : "");
      ctxHomeNote.textContent = ownerLine ? ("Propri√©taire : " + ownerLine) : "";

      // champs √©ditables
      ctxDateKey.value = ctx.dateKey || "";
      ctxTime.value = ctx.time || "";

      // summary
      ctxSummary.textContent = ctx.summary ? ("R√©sum√© : " + ctx.summary) : "R√©sum√© : ‚Äî";

      // sub
      const parts = [];
      if(ctx.dateKey) parts.push("Date : " + ctx.dateKey);
      if(ctx.time) parts.push("Heure : " + ctx.time);
      if(ctx.icalEventId) parts.push("iCal : " + ctx.icalEventId);
      contextSub.textContent = parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî";

      // planning link (filtr√© logement)
      planningLink.href = ctx.homeId ? ("planning.html?homeId=" + encodeURIComponent(ctx.homeId)) : "planning.html";
    }

    function getFiltered(){
      const list = allServices.slice();
      return list.filter(s => currentFilter === "all" ? true : s.category === currentFilter);
    }

    function renderServices(){
      servicesListEl.innerHTML = "";
      const filtered = getFiltered();

      servicesCountLabel.textContent =
        filtered.length + " prestation" + (filtered.length > 1 ? "s" : "");

      if(!filtered.length){
        const empty = document.createElement("div");
        empty.className = "service-item";
        empty.style.cursor = "default";
        empty.textContent = "Aucune prestation. Ajoute-en une √† droite.";
        servicesListEl.appendChild(empty);
        return;
      }

      filtered.forEach(svc=>{
        const item = document.createElement("div");
        item.className = "service-item";

        // üëâ Comportement:
        // - si contexte actif => clic = cr√©er une prestation (events)
        // - sinon => clic = √©diter la prestation (catalogue)
        item.addEventListener("click", async ()=>{
          if(ctx.enabled){
            await createEventFromService(svc);
          }else{
            loadIntoForm(svc.id);
          }
        });

        const active = (svc.active !== false);

        item.innerHTML = `
          <div class="service-header">
            <div style="display:flex; flex-direction:column; gap:2px;">
              <div class="service-name">${esc(svc.name || "(sans nom)")}</div>
              <div class="service-chip ${categoryClass(svc.category)}">${esc(categoryLabel(svc.category))}</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:11px; font-weight:900; color:${active ? "#1b8f4d" : "#b3261e"};">
                ${active ? "Actif" : "Inactif"}
              </span>
            </div>
          </div>

          <div class="service-mainline">
            <div class="service-meta">
              <span class="price-tag">${(svc.price != null && svc.unit) ? esc(svc.price + " " + svc.unit) : "‚Äî"}</span>
              <span class="duration-tag">${esc(svc.duration || "Dur√©e ‚Äî")}</span>
              ${svc.kits ? `<span class="kits-tag">Kits inclus</span>` : ``}
            </div>
          </div>

          <div class="desc">${esc(svc.desc || "")}</div>
        `;

        servicesListEl.appendChild(item);
      });
    }

    function resetForm(){
      f_id.value = "";
      form.reset();
      f_kits.checked = true;
      f_category.value = "menage";
      f_unit.value = "‚Ç¨/prestation";
      formTitle.textContent = "Nouvelle prestation";
      formSub.textContent = "Catalogue";
      btnSave.textContent = "Ajouter";
      btnDelete.style.display = "none";
    }

    function loadIntoForm(id){
      const svc = allServices.find(s=>s.id===id);
      if(!svc) return;

      f_id.value = svc.id;
      f_name.value = svc.name || "";
      f_category.value = svc.category || "menage";
      f_duration.value = svc.duration || "";
      f_price.value = (svc.price == null) ? "" : String(svc.price);
      f_unit.value = svc.unit || "‚Ç¨/prestation";
      f_kits.checked = !!svc.kits;
      f_desc.value = svc.desc || "";

      formTitle.textContent = "Modifier prestation";
      formSub.textContent = "Catalogue";
      btnSave.textContent = "Enregistrer";
      btnDelete.style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function saveService(e){
      e.preventDefault();
      hideAlert();

      if(!currentUser) return showAlert("Pas connect√© Firebase.");
      const id = f_id.value.trim();

      const payload = {
        conciergerieUid: currentUser.uid,
        name: f_name.value.trim(),
        category: f_category.value,
        duration: f_duration.value.trim(),
        unit: f_unit.value,
        kits: !!f_kits.checked,
        desc: f_desc.value.trim(),
        active: true,
        updatedAt: serverTimestamp()
      };

      if(!payload.name) return showAlert("Nom obligatoire.");

      const priceVal = f_price.value;
      payload.price = priceVal ? Number(priceVal) : null;

      try{
        if(id){
          await updateDoc(doc(db,"services",id), payload);
          showAlert("‚úÖ Prestation mise √† jour.", true);
        }else{
          payload.createdAt = serverTimestamp();
          await addDoc(collection(db,"services"), payload);
          showAlert("‚úÖ Prestation ajout√©e.", true);
        }
        resetForm();
      }catch(err){
        console.error(err);
        showAlert("Erreur sauvegarde : " + (err?.message || "inconnue"));
      }
    }

    async function deleteSelected(){
      hideAlert();
      if(!currentUser) return showAlert("Pas connect√© Firebase.");
      const id = f_id.value.trim();
      if(!id) return;

      const svc = allServices.find(s=>s.id===id);
      if(!svc) return;

      if(!confirm("Supprimer '" + (svc.name||"cette prestation") + "' ?")) return;

      try{
        await deleteDoc(doc(db,"services",id));
        showAlert("‚úÖ Supprim√©.", true);
        resetForm();
      }catch(err){
        console.error(err);
        showAlert("Erreur suppression : " + (err?.message || "inconnue"));
      }
    }

    function startListener(){
      if(unsub) unsub();

      const q = query(
        collection(db,"services"),
        where("conciergerieUid","==", currentUser.uid)
      );

      unsub = onSnapshot(q, (snap)=>{
        allServices = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        allServices.sort((a,b)=>{
          const ta = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const tb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return tb - ta;
        });
        renderServices();
      }, (err)=>{
        console.error(err);
        showAlert("Erreur lecture services : " + (err?.message || "inconnue"));
      });
    }

    async function createEventFromService(service){
      hideAlert();
      if(!currentUser) return showAlert("Pas connect√© Firebase.");

      const dateKey = (ctxDateKey.value || "").trim();
      const time = (ctxTime.value || "").trim();

      if(!ctx.homeId) return showAlert("Contexte incomplet : homeId manquant.");
      if(!isValidDateKey(dateKey)) return showAlert("Date invalide. Format attendu : YYYY-MM-DD");
      if(time && !isValidTime(time)) return showAlert("Heure invalide. Format attendu : HH:MM (ou vide)");

      // Meta = r√©sum√© r√©servation (si dispo)
      const metaParts = [];
      if(ctx.summary) metaParts.push("R√©servation: " + ctx.summary);
      if(service.desc) metaParts.push("Service: " + service.desc);
      const meta = metaParts.join(" ‚Ä¢ ").trim();

      const payload = {
        conciergerieUid: currentUser.uid,
        date: dateKey,
        time: time || "10:00",
        type: service.name || "Prestation",
        homeId: ctx.homeId,
        homeName: ctx.homeName || "",
        meta,
        team: "",
        source: ctx.icalEventId ? "ical->service" : "service",
        icalEventId: ctx.icalEventId || null,
        createdAt: serverTimestamp(),
        isBlocked: false,
        blockReason: "",
        paymentId: null
      };

      try{
        await addDoc(collection(db, "events"), payload);
        showAlert("‚úÖ Prestation cr√©√©e pour " + dateKey + " ‚Ä¢ " + (time || "10:00") + ".", true);

        // Option : retour planning filtr√© logement
        setTimeout(()=>{
          const url = "planning.html?homeId=" + encodeURIComponent(ctx.homeId);
          location.href = url;
        }, 500);

      }catch(err){
        console.error(err);
        showAlert("Erreur cr√©ation prestation : " + (err?.message || "inconnue"));
      }
    }

    function clearContext(){
      const url = new URL(location.href);
      ["homeId","dateKey","time","summary","icalEventId"].forEach(k=>url.searchParams.delete(k));
      location.href = url.toString();
    }

    // ===== Events =====
    filterButtons.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        filterButtons.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.filter || "all";
        renderServices();
      });
    });

    form.addEventListener("submit", saveService);
    btnReset.addEventListener("click", resetForm);
    btnDelete.addEventListener("click", deleteSelected);

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      location.href = "index.html";
    });

    clearContextBtn.addEventListener("click", clearContext);
    goPlanningBtn.addEventListener("click", ()=>{
      if(ctx.homeId) location.href = "planning.html?homeId=" + encodeURIComponent(ctx.homeId);
      else location.href = "planning.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;

      // Charger contexte (si pr√©sent)
      const hasCtx = loadContextFromUrl();
      if(hasCtx){
        await hydrateHome(ctx.homeId);
        renderContextCard();
      }else{
        contextCard.style.display = "none";
      }

      resetForm();
      startListener();
    });
  </script>
</body>
</html>
