<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Prestations</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --ok:#1b8f4d;
      --bad:#b3261e;
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,Arial,sans-serif; }
    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      position:sticky;
      top:0;
      z-index:10;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }
    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:8px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);font-weight:900;
    }
    h1{margin:0;font-size:24px;font-weight:900;}
    .subtitle{font-size:15px;color:#444;text-align:center;}
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .top-nav{
      margin-top:14px;
      display:flex;
      gap:4px;
      background:#fff;
      border-radius:999px;
      padding:3px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }
    .top-nav a{
      font-size:12px;
      padding:6px 12px;
      border-radius:999px;
      color:#555;
      text-decoration:none;
    }
    .top-nav a.active{
      background:var(--violet-main);
      color:#fff;
      font-weight:900;
    }

    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    @media(min-width:768px){ .kpis{grid-template-columns:repeat(4,1fr);} }
    .kpi{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      padding:10px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .kpi-title{font-size:12px;color:#666;font-weight:900;}
    .kpi-value{font-size:18px;font-weight:900;}

    .layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      gap:16px;
      flex-direction:column;
    }
    @media(min-width:768px){ .layout{flex-direction:row;} }

    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
    }
    .list{flex:1.4;max-height:520px;overflow:auto;display:flex;flex-direction:column;gap:8px;}
    .item{
      background:#fff;
      border-radius:14px;
      padding:10px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .item:hover{outline:2px solid rgba(122,92,255,.25);}
    .item-title{font-weight:900;}
    .chip{
      display:inline-block;
      margin-top:4px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      font-weight:900;
    }

    .form{flex:1;}
    label{font-size:12px;font-weight:900;margin-top:8px;display:block;}
    input,select,textarea{
      width:100%;
      padding:8px;
      border-radius:10px;
      border:1px solid #D3C7FF;
      font-size:13px;
    }
    textarea{resize:vertical;}
    .btn{
      margin-top:10px;
      border:none;
      border-radius:999px;
      padding:10px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
    }
    .btn.danger{
      background:linear-gradient(90deg,#d64c4c,#b3261e);
      color:#fff;
    }
  </style>
</head>

<body>



<div class="page">

  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div>
      <a class="pill-link primary" href="planning.html">Planning</a>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Catalogue de prestations</div>
  <div class="badge">Firestore • collection <b>services</b></div>

  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a class="active" href="prestations.html">Prestations</a>
    <a href="messagerie.html">Messagerie</a>
  </div>

  <div class="kpis">
    <div class="kpi"><div class="kpi-title">Prestations</div><div class="kpi-value" id="kpiCount">—</div></div>
    <div class="kpi"><div class="kpi-title">Catégorie</div><div class="kpi-value" id="kpiFilter">Tous</div></div>
    <div class="kpi"><div class="kpi-title">Tarif moyen</div><div class="kpi-value" id="kpiAvg">—</div></div>
    <div class="kpi"><div class="kpi-title">Kits inclus</div><div class="kpi-value" id="kpiKits">—</div></div>
  </div>

  <div class="layout">

    <div class="card list" id="servicesList"></div>

    <div class="card form">
      <h3 id="formTitle">Nouvelle prestation</h3>

      <input type="hidden" id="svc-id">

      <label>Nom</label>
      <input id="svc-name" required>

      <label>Catégorie</label>
      <select id="svc-category">
        <option value="menage">Ménage</option>
        <option value="checkin">Check-in / Check-out</option>
        <option value="reassort">Réassort</option>
        <option value="autre">Autre</option>
      </select>

      <label>Durée</label>
      <input id="svc-duration">

      <label>Tarif</label>
      <input id="svc-price" type="number">

      <label>Unité</label>
      <select id="svc-unit">
        <option>€/prestation</option>
        <option>€/heure</option>
      </select>

      <label>
        <input type="checkbox" id="svc-kits" checked> Kits inclus
      </label>

      <label>Description</label>
      <textarea id="svc-desc"></textarea>

      <button class="btn primary" id="saveBtn">Enregistrer</button>
      <button class="btn danger" id="deleteBtn" style="display:none;">Supprimer</button>
    </div>

  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, query, where, orderBy, onSnapshot,
    addDoc, updateDoc, deleteDoc, doc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const listEl = document.getElementById("servicesList");
  const kpiCount = document.getElementById("kpiCount");
  const kpiFilter = document.getElementById("kpiFilter");
  const kpiAvg = document.getElementById("kpiAvg");
  const kpiKits = document.getElementById("kpiKits");

  const fId = document.getElementById("svc-id");
  const fName = document.getElementById("svc-name");
  const fCat = document.getElementById("svc-category");
  const fDur = document.getElementById("svc-duration");
  const fPrice = document.getElementById("svc-price");
  const fUnit = document.getElementById("svc-unit");
  const fKits = document.getElementById("svc-kits");
  const fDesc = document.getElementById("svc-desc");

  const saveBtn = document.getElementById("saveBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const formTitle = document.getElementById("formTitle");

  let user=null, services=[];

  function render(){
    listEl.innerHTML="";
    kpiCount.textContent=services.length;
    const prices=services.map(s=>s.price).filter(p=>typeof p==="number");
    kpiAvg.textContent=prices.length?Math.round(prices.reduce((a,b)=>a+b,0)/prices.length)+" €":"—";
    kpiKits.textContent=services.filter(s=>s.kits).length+"/"+services.length;

    services.forEach(s=>{
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<div class="item-title">${s.name}</div>
                   <div class="chip">${s.category}</div>`;
      d.onclick=()=>load(s);
      listEl.appendChild(d);
    });
  }

  function load(s){
    fId.value=s.id;
    fName.value=s.name;
    fCat.value=s.category;
    fDur.value=s.duration||"";
    fPrice.value=s.price||"";
    fUnit.value=s.unit||"€/prestation";
    fKits.checked=!!s.kits;
    fDesc.value=s.desc||"";
    formTitle.textContent="Modifier prestation";
    deleteBtn.style.display="block";
  }

  function reset(){
    fId.value="";
    fName.value="";
    fDur.value="";
    fPrice.value="";
    fDesc.value="";
    fKits.checked=true;
    formTitle.textContent="Nouvelle prestation";
    deleteBtn.style.display="none";
  }

  saveBtn.onclick=async()=>{
    const payload={
      conciergerieUid:user.uid,
      name:fName.value,
      category:fCat.value,
      duration:fDur.value,
      price:fPrice.value?Number(fPrice.value):null,
      unit:fUnit.value,
      kits:fKits.checked,
      desc:fDesc.value,
      updatedAt:serverTimestamp()
    };
    if(fId.value){
      await updateDoc(doc(db,"services",fId.value),payload);
    }else{
      payload.createdAt=serverTimestamp();
      await addDoc(collection(db,"services"),payload);
    }
    reset();
  };

  deleteBtn.onclick=async()=>{
    if(confirm("Supprimer ?")){
      await deleteDoc(doc(db,"services",fId.value));
      reset();
    }
  };

  onAuthStateChanged(auth,u=>{
    if(!u){location.href="login.html?role=conciergerie";return;}
    user=u;
    const q=query(
      collection(db,"services"),
      where("conciergerieUid","==",u.uid),
      orderBy("createdAt","desc")
    );
    onSnapshot(q,snap=>{
      services=snap.docs.map(d=>({id:d.id,...d.data()}));
      render();
    });
  });
</script>

</body>
</html>
