<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CleanUp Manager – Import iCal</title>

<style>
:root{
  --violet-light:#F3ECFF;
  --violet-main:#7A5CFF;
  --violet-dark:#6238FF;
  --text-dark:#111;
  --grey:#666;
  --green:#1E7A3A;
  --orange:#B37400;
  --red:#A61E4D;
}

body{
  margin:0;
  font-family:"Comic Sans MS", sans-serif;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}
.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
}

/* TOPBAR */
.topbar{
  width:100%;
  max-width:980px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:10;
  padding:10px 0;
  background:rgba(248,244,255,.85);
  backdrop-filter:blur(6px);
}
.pill-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:#fff;
  border:2px solid var(--violet-main);
  color:var(--violet-main);
  text-decoration:none;
  font-weight:900;
  font-size:13px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  white-space:nowrap;
  cursor:pointer;
}

/* TITRE */
.logo-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.logo-icon{
  width:36px;height:36px;border-radius:50%;
  border:2px solid var(--violet-main);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--violet-main);
  background:#fff;
  position:relative;
}
.logo-icon::after{
  content:"✦";
  position:absolute;
  top:-6px; right:-4px;
  font-size:12px;
  color:var(--violet-main);
}
h1{margin:0;font-size:24px;}
.subtitle{font-size:15px;color:#444;text-align:center;margin-top:4px;}
.badge{
  margin-top:8px;
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#555;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}

/* NAV */
.top-nav{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  padding:4px;
  border-radius:999px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.top-nav a{
  text-decoration:none;
  font-size:12px;
  padding:6px 12px;
  border-radius:999px;
  color:#555;
}
.top-nav a.active{
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
}

/* CARD */
.content{width:100%;max-width:980px;margin-top:12px;display:flex;flex-direction:column;gap:12px;}
.card{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  padding:16px;
}
h2{margin:0 0 8px;font-size:16px;}
.small{font-size:12px;color:#666;line-height:1.3;}

label{display:block;font-size:12px;font-weight:900;margin:10px 0 4px;color:#333;}
input,select,textarea{
  width:100%;box-sizing:border-box;
  padding:9px 10px;border-radius:10px;border:1px solid #D3C7FF;
  font-size:13px;outline:none;background:#fff;
  font-family:"Comic Sans MS", sans-serif;
}
textarea{min-height:80px;resize:vertical;}

.row{display:flex;gap:10px;flex-wrap:wrap;}
.col{flex:1;min-width:220px;}

.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;justify-content:flex-end;}
.btn{
  border:none;border-radius:999px;
  padding:9px 12px;font-size:13px;font-weight:900;
  cursor:pointer;background:#fff;color:var(--violet-main);
  border:2px solid var(--violet-main);
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.btn.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
.btn.danger{border-color:var(--red);color:var(--red);}

.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  font-size:12px;
}
.table thead th{
  text-align:left;
  padding:6px 8px;
  color:#555;
  font-weight:900;
}
.table tbody tr{
  background:#fff;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.table tbody td{
  padding:10px 8px;
  vertical-align:middle;
}
.table tbody tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px;}
.table tbody tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px;}
.badge-status{
  font-size:11px;padding:2px 8px;border-radius:999px;font-weight:900;white-space:nowrap;
  background:#eee;color:#666;
}
.badge-status.ok{background:#E9F7EF;color:var(--green);}
.badge-status.warn{background:#FFF4DA;color:var(--orange);}
.badge-status.bad{background:#FFE3EC;color:var(--red);}
</style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Import iCal</div>
  <div class="badge">Ajouter une source • synchroniser • alimenter le planning</div>

  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="messagerie.html">Messagerie</a>
    <a class="active" href="import-ical.html">Import iCal</a>
  </div>

  <div class="content">

    <div class="card">
      <h2>Ajouter une source iCal</h2>
      <p class="small">
        V1 : on importe les événements du flux iCal et on les transforme en prestations “Réservation / Check-in / Check-out”.
        <br>⚠️ Certaines plateformes bloquent le CORS : si ça ne marche pas, c’est le flux qui refuse le navigateur (pas ton code).
      </p>

      <div class="row">
        <div class="col">
          <label for="srcName">Nom source</label>
          <input id="srcName" type="text" placeholder="Ex. Airbnb – T2 Centre" />
        </div>
        <div class="col">
          <label for="srcHome">Logement associé</label>
          <select id="srcHome"></select>
        </div>
      </div>

      <label for="srcUrl">URL iCal</label>
      <input id="srcUrl" type="url" placeholder="https://.../calendar.ics" />

      <div class="actions">
        <button class="btn" type="button" onclick="testFetch()">Tester le flux</button>
        <button class="btn primary" type="button" onclick="addSource()">Ajouter</button>
      </div>
    </div>

    <div class="card">
      <h2>Sources enregistrées</h2>

      <div class="actions" style="justify-content:flex-start;margin-top:0;">
        <button class="btn primary" type="button" onclick="syncAll()">Synchroniser tout</button>
        <button class="btn" type="button" onclick="purgeAllIcalEvents()">Purger TOUS les événements iCal</button>
      </div>

      <table class="table" aria-label="Sources iCal">
        <thead>
          <tr>
            <th>Source</th>
            <th>Logement</th>
            <th>Dernière sync</th>
            <th>Événements</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="sourcesBody"></tbody>
      </table>

      <p class="small" style="margin:8px 0 0;">
        Astuce : après sync, va sur <b>Planning</b>. Les événements importés ont <b>source: iCal</b>.
      </p>
    </div>

    <div class="card">
      <h2>Console (débug)</h2>
      <textarea id="logBox" readonly></textarea>
    </div>

  </div>
</div>

<script>
/* ===== BASE ===== */
const DATA_KEY = "cm_conciergerie_data_v1";

function uid(prefix){
  return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function loadData(){
  try{
    const raw = localStorage.getItem(DATA_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return null;
}
function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
function ensureData(){
  const existing = loadData();
  if(existing) return existing;

  const seeded = {
    homes:[],
    events:[],
    services:[],
    threads:[],
    payments:[],
    icalSources:[],
    kits:[],
    requests:[]   // ✅ obligatoire maintenant
  };

  saveData(seeded);
  return seeded;
}

const app = ensureData();
app.homes = Array.isArray(app.homes) ? app.homes : [];
app.events = Array.isArray(app.events) ? app.events : [];
app.icalSources = Array.isArray(app.icalSources) ? app.icalSources : [];
app.kits = Array.isArray(app.kits) ? app.kits : [];
app.requests = Array.isArray(app.requests) ? app.requests : [];

/* migration events */
(function migrateEvents(){
  let changed = false;
  app.events.forEach(e=>{
    if(!e.id){ e.id = uid("e"); changed = true; }
    if(typeof e.isBlocked !== "boolean"){ e.isBlocked = false; changed = true; }
    if(typeof e.blockReason !== "string"){ e.blockReason = ""; changed = true; }
    if(typeof e.paymentId === "undefined"){ e.paymentId = null; changed = true; }
    if(typeof e.isDone !== "boolean"){ e.isDone = false; changed = true; }
  });
  if(changed) saveData(app);
})();

const logBox = document.getElementById("logBox");
function log(msg){
  const line = `[${new Date().toLocaleTimeString("fr-FR")}] ${msg}`;
  logBox.value = line + "\n" + logBox.value;
}

const srcName = document.getElementById("srcName");
const srcUrl  = document.getElementById("srcUrl");
const srcHome = document.getElementById("srcHome");
const sourcesBody = document.getElementById("sourcesBody");

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtTs(ts){
  if(!ts) return "—";
  try{ return new Date(ts).toLocaleString("fr-FR"); }catch(e){ return "—"; }
}

function homeLabelById(id){
  const h = app.homes.find(x=>x.id===id);
  return h ? `${h.name||"Logement"} • ${h.city||""}`.trim() : "—";
}

function buildHomeSelect(){
  if(!app.homes.length){
    srcHome.innerHTML = `<option value="">(Ajoute un logement d’abord)</option>`;
    return;
  }
  srcHome.innerHTML = app.homes.map(h=>{
    const label = `${h.name||"Logement"} • ${h.city||""}`.trim();
    return `<option value="${escapeHtml(h.id)}">${escapeHtml(label)}</option>`;
  }).join("");
}

/* ===== iCal parsing ===== */
/* unfold lines (RFC) */
function unfoldIcs(text){
  return text.replace(/\r?\n[ \t]/g, "");
}

function parseIcsDateToParts(v){
  // v can be: YYYYMMDD or YYYYMMDDTHHMMSSZ or YYYYMMDDTHHMMSS
  const s = String(v||"").trim();
  if(/^\d{8}$/.test(s)){
    const y = Number(s.slice(0,4));
    const m = Number(s.slice(4,6));
    const d = Number(s.slice(6,8));
    return { dateKey: `${y}-${String(m).padStart(2,"0")}-${String(d).padStart(2,"0")}`, time: "" , allDay:true };
  }
  const m = s.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
  if(!m) return null;
  const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
  const hh = Number(m[4]), mm = Number(m[5]);
  // On affiche juste HH:MM. On ne gère pas TZ finement en V1.
  return { dateKey:`${y}-${String(mo).padStart(2,"0")}-${String(d).padStart(2,"0")}`, time:`${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`, allDay:false };
}

function parseIcsEvents(icsText){
  const t = unfoldIcs(icsText);
  const blocks = t.split("BEGIN:VEVENT").slice(1).map(x => x.split("END:VEVENT")[0]);
  const events = [];

  for(const b of blocks){
    const lines = b.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    const obj = { raw:{} };

    for(const line of lines){
      const idx = line.indexOf(":");
      if(idx === -1) continue;
      const left = line.slice(0, idx);
      const val  = line.slice(idx+1);

      const key = left.split(";")[0].toUpperCase();
      obj.raw[key] = val;
    }

    const uidVal = obj.raw["UID"] || uid("ical");
    const summary = obj.raw["SUMMARY"] || "Réservation";
    const dtStart = obj.raw["DTSTART"] || "";
    const dtEnd   = obj.raw["DTEND"] || "";
    const pStart = parseIcsDateToParts(dtStart);
    if(!pStart) continue;

    const pEnd = dtEnd ? parseIcsDateToParts(dtEnd) : null;

    events.push({
      uid: uidVal,
      summary,
      dateKey: pStart.dateKey,
      time: pStart.time || "—",
      allDay: !!pStart.allDay,
      endDateKey: pEnd?.dateKey || null
    });
  }

  return events;
}

function mapSummaryToType(summary){
  const s = (summary||"").toLowerCase();
  if(s.includes("check-in") || s.includes("check in") || s.includes("arrivée")) return "Check-in";
  if(s.includes("check-out") || s.includes("check out") || s.includes("départ")) return "Check-out";
  return "Réservation";
}

function countIcalEventsBySourceId(srcId){
  return app.events.filter(e=>e.source==="ical" && e.icalSourceId===srcId).length;
}

function upsertImportedEvent(src, icalEv){
  // clé = source + UID + dateKey (sécurité)
  const keyUid = String(icalEv.uid||"");
  const dateKey = icalEv.dateKey;

  let existing = app.events.find(e =>
    e.source==="ical" &&
    e.icalSourceId === src.id &&
    String(e.icalUid||"") === keyUid &&
    String(e.date||"") === dateKey
  );

  const home = app.homes.find(h=>h.id===src.homeId) || null;

  const base = {
    id: existing?.id || uid("e"),
    source: "ical",
    icalSourceId: src.id,
    icalUid: keyUid,

    date: dateKey,
    time: icalEv.time || "—",
    type: mapSummaryToType(icalEv.summary),
    meta: icalEv.summary || "",
    team: (home && home.team) ? home.team : "",

    homeId: src.homeId || "",
    homeName: home?.name || "",

    createdAt: existing?.createdAt || Date.now(),
    updatedAt: Date.now(),

    isDone: existing?.isDone ?? false,
    isBlocked: existing?.isBlocked ?? false,
    blockReason: existing?.blockReason ?? "",
    paymentId: existing?.paymentId ?? null
  };

  if(existing){
    Object.assign(existing, base);
  }else{
    app.events.push(base);
  }
}

async function fetchIcs(url){
  const res = await fetch(url, { method:"GET" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  return await res.text();
}

/* ===== UI actions ===== */
async function testFetch(){
  const url = (srcUrl.value||"").trim();
  if(!url){ alert("URL iCal manquante."); return; }
  log("Test fetch : " + url);
  try{
    const txt = await fetchIcs(url);
    const evs = parseIcsEvents(txt);
    log(`OK : ${evs.length} événements détectés.`);
    alert(`OK : ${evs.length} événements détectés dans le flux.`);
  }catch(e){
    log("ERREUR : " + e.message);
    alert("Impossible de récupérer le flux (souvent CORS). Détails : " + e.message);
  }
}

function addSource(){
  if(!app.homes.length){
    alert("Ajoute un logement d’abord.");
    location.href = "logements.html";
    return;
  }

  const name = (srcName.value||"").trim() || "Source iCal";
  const url  = (srcUrl.value||"").trim();
  const homeId = (srcHome.value||"").trim();

  if(!url){ alert("URL iCal manquante."); return; }
  if(!homeId){ alert("Choisis un logement."); return; }

  const src = {
    id: uid("ics"),
    name,
    url,
    homeId,
    createdAt: Date.now(),
    lastSyncAt: null,
    lastSyncCount: 0
  };

  app.icalSources.unshift(src);
  saveData(app);

  srcName.value = "";
  srcUrl.value = "";

  renderSources();
  log("Source ajoutée : " + name);
}

async function syncSource(srcId){
  const src = app.icalSources.find(s=>s.id===srcId);
  if(!src){ alert("Source introuvable."); return; }

  log("Sync : " + src.name);

  try{
    const txt = await fetchIcs(src.url);
    const evs = parseIcsEvents(txt);

    // purge events existing for source before upsert? (non : on upsert)
    evs.forEach(ev => upsertImportedEvent(src, ev));

    src.lastSyncAt = Date.now();
    src.lastSyncCount = evs.length;

    saveData(app);
    renderSources();

    log(`Sync OK : ${evs.length} événements importés/mis à jour.`);
    alert(`Sync OK : ${evs.length} événements importés/mis à jour.`);
  }catch(e){
    log("Sync ERREUR : " + e.message);
    alert("Sync impossible (souvent CORS) : " + e.message);
  }
}

async function syncAll(){
  if(!app.icalSources.length){
    alert("Aucune source iCal.");
    return;
  }
  for(const s of app.icalSources){
    // séquentiel = simple (et plus lisible)
    await syncSource(s.id);
  }
}

function purgeSourceEvents(srcId){
  const nBefore = app.events.length;
  app.events = app.events.filter(e => !(e.source==="ical" && e.icalSourceId===srcId));
  saveData(app);
  const removed = nBefore - app.events.length;
  renderSources();
  log("Purge events source : " + removed + " supprimés");
  alert("Événements iCal supprimés : " + removed);
}

function deleteSource(srcId){
  const src = app.icalSources.find(s=>s.id===srcId);
  const ok = confirm(`Supprimer la source "${src?.name||"?"}" ?`);
  if(!ok) return;

  // on garde les events ? -> NON, on purge aussi pour éviter le bordel
  purgeSourceEvents(srcId);
  app.icalSources = app.icalSources.filter(s=>s.id!==srcId);
  saveData(app);

  renderSources();
  log("Source supprimée.");
}

function purgeAllIcalEvents(){
  const ok = confirm("Purger TOUS les événements iCal ? (pas d’annulation)");
  if(!ok) return;
  const nBefore = app.events.length;
  app.events = app.events.filter(e => e.source !== "ical");
  saveData(app);
  alert("Supprimés : " + (nBefore - app.events.length));
  renderSources();
}

function renderSources(){
  sourcesBody.innerHTML = "";

  if(!app.icalSources.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" style="padding:14px 10px;color:#666;">Aucune source. Ajoute une URL iCal ci-dessus.</td>`;
    sourcesBody.appendChild(tr);
    return;
  }

  app.icalSources.forEach(s=>{
    const count = countIcalEventsBySourceId(s.id);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <strong>${escapeHtml(s.name||"Source iCal")}</strong>
        <div class="small">${escapeHtml(s.url||"")}</div>
      </td>
      <td>${escapeHtml(homeLabelById(s.homeId))}</td>
      <td>${escapeHtml(fmtTs(s.lastSyncAt))}</td>
      <td>
        <span class="badge-status ${count? "ok":"warn"}">${count} ev</span>
        <div class="small">dernier flux : ${escapeHtml(String(s.lastSyncCount||0))}</div>
      </td>
      <td>
        <div class="actions" style="justify-content:flex-start;">
          <button class="btn primary" type="button" data-sync="${escapeHtml(s.id)}">Sync</button>
          <button class="btn" type="button" data-purge="${escapeHtml(s.id)}">Purger events</button>
          <button class="btn danger" type="button" data-del="${escapeHtml(s.id)}">Supprimer</button>
        </div>
      </td>
    `;
    sourcesBody.appendChild(tr);
  });

  document.querySelectorAll("[data-sync]").forEach(b=>{
    b.addEventListener("click", ()=> syncSource(b.getAttribute("data-sync")));
  });
  document.querySelectorAll("[data-purge]").forEach(b=>{
    b.addEventListener("click", ()=> purgeSourceEvents(b.getAttribute("data-purge")));
  });
  document.querySelectorAll("[data-del]").forEach(b=>{
    b.addEventListener("click", ()=> deleteSource(b.getAttribute("data-del")));
  });
}

/* init */
buildHomeSelect();
renderSources();
log("Prêt.");
</script>
</body>
</html>
