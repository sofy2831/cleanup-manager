<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Import iCal</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{font-size:15px;color:#444;margin-top:4px;text-align:center;}

    .card{
      width:100%;
      max-width:720px;
      margin-top:14px;
      background:rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      backdrop-filter: blur(10px);
    }
    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    select, input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    select:focus, input:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > div{ flex:1; min-width:220px; }

    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.danger{
      border-color:#ffd2d2;
      background:#FFE3EC;
      color:var(--bad);
    }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#333;
      display:none;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .small{
      font-size:12px;
      color:#666;
      line-height:1.35;
      margin-top:8px;
    }

    .preview{
      margin-top:10px;
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#333;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill-link" href="planning.html">← Planning</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="pill-link" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">Import iCal (réservations)</div>

    <div class="card">
      <div class="small">
        Objectif : importer les réservations (Airbnb/Booking/Google Calendar) pour alimenter le planning.
        <br>Les données sont stockées dans <b>icalEvents</b> et visibles dans le Planning.
      </div>

      <div class="alert" id="alertBox"></div>

      <div class="row">
        <div>
          <label for="homeSelect">Logement</label>
          <select id="homeSelect">
            <option value="">Chargement…</option>
          </select>
        </div>
        <div>
          <label for="icalUrl">Lien iCal</label>
          <input id="icalUrl" type="url" placeholder="https://..." />
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="testBtn" type="button">Tester</button>
        <button class="btn primary" id="syncBtn" type="button">Sync</button>
        <button class="btn danger" id="clearBtn" type="button">Effacer</button>
      </div>

      <div class="preview" id="previewBox"></div>

      <div class="small">
        Astuce test : <span style="font-weight:900;">ton iCal de test</span> est pré-rempli.
      </div>
    </div>
  </div>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, onSnapshot, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const alertBox = document.getElementById("alertBox");
  const previewBox = document.getElementById("previewBox");
  function showAlert(msg, ok=false){
    alertBox.style.display = "block";
    alertBox.classList.toggle("ok", !!ok);
    alertBox.textContent = msg;
  }
  function hideAlert(){
    alertBox.style.display = "none";
    alertBox.classList.remove("ok");
    alertBox.textContent = "";
  }
  function showPreview(text){
    previewBox.style.display = "block";
    previewBox.textContent = text;
  }
  function hidePreview(){
    previewBox.style.display = "none";
    previewBox.textContent = "";
  }

  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await signOut(auth);
    location.href = "index.html";
  });

  const homeSelect = document.getElementById("homeSelect");
  const icalUrlEl = document.getElementById("icalUrl");
  const testBtn = document.getElementById("testBtn");
  const syncBtn = document.getElementById("syncBtn");
  const clearBtn = document.getElementById("clearBtn");

  // Ton ics test
  const DEFAULT_ICAL = "https://sofy2831.github.io/cleanup-manager/test.ics";
  if(!icalUrlEl.value) icalUrlEl.value = DEFAULT_ICAL;

  // ===== Utils =====
  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function dateKeyFromDate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
  function timeFromDate(d){ return pad2(d.getHours()) + ":" + pad2(d.getMinutes()); }

  function unfoldIcs(text){
    // RFC5545: lignes repliées commencent par espace/tab
    const lines = text.replace(/\r\n/g,"\n").split("\n");
    const out = [];
    for(const line of lines){
      if(!line) continue;
      if(/^[ \t]/.test(line) && out.length){
        out[out.length-1] += line.slice(1);
      }else{
        out.push(line);
      }
    }
    return out;
  }

  function parseIcsDate(value){
    // value: YYYYMMDD or YYYYMMDDTHHMMSSZ or YYYYMMDDTHHMMSS
    const v = String(value || "").trim();
    if(!v) return null;

    // date only
    if(/^\d{8}$/.test(v)){
      const y = Number(v.slice(0,4));
      const m = Number(v.slice(4,6))-1;
      const d = Number(v.slice(6,8));
      return new Date(y,m,d,0,0,0,0);
    }

    // datetime
    const m = v.match(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/);
    if(!m) return null;

    const y = Number(m[1]);
    const mo = Number(m[2])-1;
    const da = Number(m[3]);
    const hh = Number(m[4]);
    const mi = Number(m[5]);
    const ss = Number(m[6]);
    const isUtc = !!m[7];

    if(isUtc){
      return new Date(Date.UTC(y,mo,da,hh,mi,ss));
    }
    return new Date(y,mo,da,hh,mi,ss);
  }

  function sanitizeId(s){
    return String(s || "")
      .replace(/[^a-zA-Z0-9_-]/g, "_")
      .slice(0, 120);
  }

  function makeDocId(homeId, icalUid, startKey){
    return sanitizeId(homeId) + "__" + sanitizeId(icalUid || "no_uid") + "__" + sanitizeId(startKey || "no_date");
  }

  function parseIcs(text){
    const lines = unfoldIcs(text);
    const events = [];
    let cur = null;

    for(const line of lines){
      if(line === "BEGIN:VEVENT"){
        cur = {};
        continue;
      }
      if(line === "END:VEVENT"){
        if(cur) events.push(cur);
        cur = null;
        continue;
      }
      if(!cur) continue;

      const idx = line.indexOf(":");
      if(idx === -1) continue;

      const left = line.slice(0, idx);
      const val = line.slice(idx+1);

      const key = left.split(";")[0].toUpperCase();

      if(key === "UID") cur.uid = val.trim();
      if(key === "SUMMARY") cur.summary = val.trim();
      if(key === "LOCATION") cur.location = val.trim();

      if(key === "DTSTART"){
        cur.dtstartRaw = val.trim();
        cur.start = parseIcsDate(val.trim());
      }
      if(key === "DTEND"){
        cur.dtendRaw = val.trim();
        cur.end = parseIcsDate(val.trim());
      }
    }

    // nettoie + garde seulement ceux avec start
    return events.filter(e => e.start instanceof Date && !isNaN(e.start));
  }

  async function fetchIcs(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return await res.text();
  }

  function lockButtons(locked){
    [testBtn, syncBtn].forEach(b=>{
      b.disabled = !!locked;
      b.style.opacity = locked ? "0.7" : "1";
      b.style.cursor = locked ? "not-allowed" : "pointer";
    });
  }

  // ===== Data =====
  let currentUser = null;
  let homes = [];
  let homesById = new Map();
  let unsubHomes = null;

  function getSelectedHome(){
    const id = homeSelect.value;
    return homesById.get(id) || null;
  }

  function fillHomesSelect(){
    homeSelect.innerHTML = "";
    if(!homes.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Aucun logement";
      homeSelect.appendChild(opt);
      homeSelect.disabled = true;
      return;
    }
    homeSelect.disabled = false;

    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "Choisir un logement…";
    homeSelect.appendChild(opt0);

    for(const h of homes){
      const opt = document.createElement("option");
      opt.value = h.id;
      opt.textContent = `${h.name || "Logement"} (${h.city || "—"})`;
      homeSelect.appendChild(opt);
    }
  }

  function startHomesListener(uid){
    if(unsubHomes) unsubHomes();
    unsubHomes = onSnapshot(
      query(collection(db, "homes"), where("conciergerieUid","==", uid)),
      (snap)=>{
        homes = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        homes.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        homesById = new Map(homes.map(h=>[h.id, h]));
        fillHomesSelect();
      },
      (err)=> showAlert("Erreur logements : " + (err?.message || "inconnue"))
    );
  }

  onAuthStateChanged(auth, (user)=>{
    if(!user){
      location.href = "login.html?role=conciergerie";
      return;
    }
    currentUser = user;
    startHomesListener(user.uid);
    hideAlert();
  });

  // ===== Actions =====
  testBtn.addEventListener("click", async ()=>{
    hideAlert(); hidePreview();
    const home = getSelectedHome();
    const url = (icalUrlEl.value || "").trim();

    if(!home) return showAlert("Choisis un logement.");
    if(!url) return showAlert("Colle un lien iCal.");

    lockButtons(true);
    try{
      const text = await fetchIcs(url);
      const evs = parseIcs(text);

      // petite preview
      const head = `✅ iCal OK\nLogement: ${home.name}\nÉvénements trouvés: ${evs.length}\n`;
      const sample = evs.slice(0,5).map(e=>{
        const dk = dateKeyFromDate(e.start);
        const tm = timeFromDate(e.start);
        return `• ${dk} ${tm} — ${e.summary || "Réservation"}`;
      }).join("\n");
      showPreview(head + (sample ? ("\nAperçu:\n" + sample) : "\n(Aucun événement)"));

      showAlert("Test OK. Si l’aperçu est bon, clique Sync.", true);
    }catch(err){
      console.error(err);
      showAlert("Erreur iCal : " + (err?.message || "inconnue"));
    }finally{
      lockButtons(false);
    }
  });

  syncBtn.addEventListener("click", async ()=>{
    hideAlert(); hidePreview();
    const home = getSelectedHome();
    const url = (icalUrlEl.value || "").trim();

    if(!currentUser) return showAlert("Pas connecté.");
    if(!home) return showAlert("Choisis un logement.");
    if(!url) return showAlert("Colle un lien iCal.");

    lockButtons(true);

    try{
      const text = await fetchIcs(url);
      const evs = parseIcs(text);

      if(!evs.length){
        showAlert("iCal vide : aucun événement à importer.", false);
        lockButtons(false);
        return;
      }

      // écrit dans icalEvents
      let written = 0;
      for(const e of evs){
        const dk = dateKeyFromDate(e.start);
        const tm = timeFromDate(e.start);
        const uid = e.uid || (e.summary || "no_summary") + "_" + dk + "_" + tm;

        const docId = makeDocId(home.id, uid, dk + "_" + tm);

        await setDoc(doc(db, "icalEvents", docId), {
          conciergerieUid: currentUser.uid,
          homeId: home.id,
          homeName: home.name || "",
          dateKey: dk,
          time: tm,
          summary: e.summary || "Réservation",
          location: e.location || "",
          source: "ical",
          icalUid: e.uid || "",
          icalUrl: url,
          startIso: e.start.toISOString(),
          endIso: (e.end instanceof Date && !isNaN(e.end)) ? e.end.toISOString() : "",
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp()
        }, { merge: true });

        written++;
      }

      showAlert(`✅ Sync terminé : ${written} réservations importées (ou mises à jour).`, true);
      showPreview("Va voir le Planning : les points gris + “Réservation” apparaissent.");
    }catch(err){
      console.error(err);
      showAlert("Erreur sync : " + (err?.message || "inconnue"));
    }finally{
      lockButtons(false);
    }
  });

  clearBtn.addEventListener("click", ()=>{
    hideAlert(); hidePreview();
    homeSelect.value = "";
    icalUrlEl.value = DEFAULT_ICAL;
    showAlert("OK. Choisis un logement et relance un test.", true);
  });
</script>
</body>
</html>
