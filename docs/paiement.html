<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CleanUp Manager ‚Äì Paiements</title>

<style>
:root{
  --violet-light:#F3ECFF;
  --violet-main:#7A5CFF;
  --violet-dark:#6238FF;
  --text-dark:#111;
  --grey:#666;
  --green:#1E7A3A;
  --orange:#B37400;
  --red:#A61E4D;
  --bad:#b3261e;
}

body{
  margin:0;
  font-family:"Comic Sans MS", sans-serif;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}

.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
}

/* TOPBAR */
.topbar{
  width:100%;
  max-width:980px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:10;
  padding:10px 0;
  background:rgba(248,244,255,.85);
  backdrop-filter:blur(6px);
}
.pill-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:#fff;
  border:2px solid var(--violet-main);
  color:var(--violet-main);
  text-decoration:none;
  font-weight:900;
  font-size:13px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  white-space:nowrap;
  cursor:pointer;
}
.pill-link.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

/* LOGO + TITRE */
.logo-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.logo-icon{
  width:36px;height:36px;border-radius:50%;
  border:2px solid var(--violet-main);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--violet-main);
  background:#fff;
  position:relative;
}
.logo-icon::after{
  content:"‚ú¶";
  position:absolute;
  top:-6px; right:-4px;
  font-size:12px;
  color:var(--violet-main);
}
h1{margin:0;font-size:24px;}
.subtitle{font-size:15px;color:#444;text-align:center;margin-top:4px;}
.badge{
  margin-top:8px;
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#555;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}

/* NAV */
.top-nav{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  padding:4px;
  border-radius:999px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.top-nav a{
  text-decoration:none;
  font-size:12px;
  padding:6px 12px;
  border-radius:999px;
  color:#555;
}
.top-nav a.active{
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
}

/* EXPLAIN */
.explain{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  padding:14px 14px 14px;
  box-sizing:border-box;
  text-align:left;
  border-left:5px solid var(--violet-main);
}
.explain h2{ margin:0 0 6px; font-size:15px; }
.explain p{
  margin:6px 0 0;
  font-size:13px;
  line-height:1.35;
  color:#444;
}

/* KPI */
.kpis{
  width:100%;
  max-width:980px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
  margin-top:12px;
}
@media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr); } }
.kpi{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.08);
  padding:10px 10px 12px;
  text-align:left;
}
.kpi-title{ font-size:12px; color:#666; font-weight:900; margin-bottom:4px; }
.kpi-value{ font-size:18px; font-weight:900; color:#222; }
.kpi-note{ font-size:11px; color:#666; margin-top:2px; }

/* FILTERS + ADD */
.filters{
  width:100%;
  max-width:980px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:12px 0;
}
.filters select,.filters input,.filters button{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #D3C7FF;
  font-size:12px;
  background:#fff;
  outline:none;
}
.filters input{ flex:1; min-width:180px; }
.filters button{
  border:none;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  font-weight:900;
  cursor:pointer;
}

/* CARD + TABLE */
.content{ width:100%; max-width:980px; }
.card{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  padding:16px;
}
.table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  font-size:12px;
}
.table thead th{
  text-align:left;
  padding:6px 8px;
  color:#555;
  font-weight:900;
}
.table tbody tr{
  background:#fff;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.table tbody td{ padding:10px 8px; vertical-align:middle; }
.table tbody tr td:first-child{
  border-top-left-radius:12px;
  border-bottom-left-radius:12px;
}
.table tbody tr td:last-child{
  border-top-right-radius:12px;
  border-bottom-right-radius:12px;
}

.badge-status{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  font-weight:900;
  white-space:nowrap;
  background:#eee;
  color:#666;
}
.badge-status.paye{ background:#E9F7EF; color:var(--green); }
.badge-status.attente{ background:#FFF4DA; color:var(--orange); }
.badge-status.retard{ background:#FFE3EC; color:var(--red); }
.badge-status.bloque{ background:#EFEAFB; color:#5B45C8; }

.actions{ display:flex; gap:6px; flex-wrap:wrap; }
.action-btn{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  background:#eee;
  color:#777;
  cursor:pointer;
}
.action-btn.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
}
.action-btn.danger{ background:#FFE3EC; color:var(--red); }

.note{ margin-top:10px; font-size:12px; color:#666; text-align:center; }
.small{ font-size:11px; color:#666; }

/* Modal */
.modal-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.25);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:50;
}
.modal{
  width:100%;
  max-width:560px;
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.20);
  padding:16px 14px 18px;
  box-sizing:border-box;
}
.modal h2{ margin:0 0 6px; font-size:16px; font-weight:900; color:#111; }
.modal p{ margin:0 0 10px; font-size:12px; color:#666; line-height:1.25; }

label{ display:block; font-size:12px; font-weight:900; color:#333; margin:8px 0 4px; text-align:left; }
input, select, textarea{
  width:100%; box-sizing:border-box; padding:9px 10px;
  border-radius:10px; border:1px solid #D3C7FF; font-size:13px; outline:none; background:#fff;
  font-family:"Comic Sans MS", sans-serif;
}
textarea{ resize:vertical; min-height:80px; }

.modal-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:12px;
}

.btn{
  border:none;
  border-radius:999px;
  padding:9px 12px;
  font-size:13px;
  font-weight:900;
  cursor:pointer;
  background:#fff;
  color:var(--violet-main);
  border:2px solid var(--violet-main);
  white-space:nowrap;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.btn.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
.btn.danger{
  border-color:var(--bad);
  color:var(--bad);
}
/* ===== Abonnement conciergerie (V1) ===== */
.plan-card{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  padding:14px 14px 16px;
  box-sizing:border-box;
  border-left:5px solid var(--violet-main);
}
.plan-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}
.plan-title{
  font-size:15px;
  font-weight:900;
  margin:0;
}
.plan-sub{
  margin:4px 0 0;
  font-size:12px;
  color:#555;
  line-height:1.25;
}
.plan-pill{
  font-size:11px;
  padding:3px 9px;
  border-radius:999px;
  background:#fff;
  border:1px solid rgba(122,92,255,.35);
  color:#5b45c8;
  font-weight:900;
  white-space:nowrap;
}
.plan-line{
  margin-top:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  background:#fff;
  border-radius:14px;
  padding:10px 12px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.plan-name{
  font-weight:900;
}
.plan-price{
  font-weight:900;
}
.plan-actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top:10px;
}
.plan-actions .btn{
  min-width:220px;
}
.plan-msg{
  margin-top:8px;
  font-size:12px;
  font-weight:900;
  padding:10px 12px;
  border-radius:14px;
  background:#fff;
  border-left:5px solid #ddd;
  display:none;
}
.plan-msg.ok{display:block;border-left-color:var(--green);color:#0f5f31;}
.plan-msg.bad{display:block;border-left-color:var(--bad);color:#7a1d16;}


</style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");

</script>

<div class="page">

  <!-- TOPBAR -->
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="messagerie.html">Messagerie</a>
      <button class="pill-link" type="button" onclick="logout()">D√©connexion</button>
    </div>
  </div>

  <!-- TITRE -->
  <div class="logo-title">
    <div class="logo-icon">‚úì</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Paiements propri√©taires</div>
  <div class="badge">Pr√©-paiement ‚Ä¢ relance ‚Ä¢ blocage</div>

  <!-- NAV -->
  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="messagerie.html">Messagerie</a>
    <a class="active" href="paiement.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="boutique.html">Boutique</a>
  </div>

  <!-- EXPLICATION -->
  <div class="explain">
    <h2>R√®gle m√©tier</h2>
    <p><b>Le propri√©taire paie avant toute prestation.</b> Tant que le r√®glement n‚Äôest pas re√ßu : la prestation peut rester <b>bloqu√©e</b>.</p>
    <p class="small">V1 : stockage local (localStorage). Plus tard : factures, liens de paiement, relances auto, export comptable.</p>
  </div>

  <!-- ‚úÖ ABONNEMENT CONCIERGERIE (arriv√©e depuis index.html?plan=...) -->
  <div class="plan-card" id="planCard" style="display:none;">
    <div class="plan-top">
      <div>
        <h2 class="plan-title">Abonnement conciergerie</h2>
        <p class="plan-sub" id="planDesc">‚Äî</p>
      </div>
      <span class="plan-pill" id="planPill">Plan</span>
    </div>

    <div class="plan-line">
      <div>
        <div class="plan-name" id="planName">‚Äî</div>
        <div class="small" id="planRange">‚Äî</div>
      </div>
      <div class="plan-price" id="planPrice">‚Äî</div>
    </div>

    <div class="plan-actions">
      <button class="btn" type="button" id="planBackBtn">Changer de plan</button>
      <button class="btn primary" type="button" id="planActivateBtn">Activer (V1)</button>
    </div>

    <div class="plan-msg" id="planMsg"></div>
  </div>


  <!-- KPI -->
  <div class="kpis">
    <div class="kpi">
      <div class="kpi-title">En attente</div>
      <div class="kpi-value" id="kpiPending">‚Äî</div>
      <div class="kpi-note">paiements</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">En retard</div>
      <div class="kpi-value" id="kpiLate">‚Äî</div>
      <div class="kpi-note">√† relancer</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">Pay√©s</div>
      <div class="kpi-value" id="kpiPaid">‚Äî</div>
      <div class="kpi-note">OK pour ex√©cution</div>
    </div>
    <div class="kpi">
      <div class="kpi-title">Bloqu√©s</div>
      <div class="kpi-value" id="kpiBlocked">‚Äî</div>
      <div class="kpi-note">pas d‚Äôintervention</div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <select id="filterOwner">
      <option value="">Tous propri√©taires</option>
    </select>

    <select id="filterLogement">
      <option value="">Tous logements</option>
    </select>

    <select id="filterStatus">
      <option value="">Tous statuts</option>
      <option value="paye">Pay√©</option>
      <option value="en_attente">En attente</option>
      <option value="en_retard">En retard</option>
    </select>

    <input id="searchInput" type="text" placeholder="Recherche (proprio, logement, ref, objet‚Ä¶)">

    <button type="button" id="addBtn">+ Ajouter</button>
  </div>

  <!-- LISTE -->
  <div class="content">
    <div class="card">
      <table class="table" aria-label="Paiements propri√©taires">
        <thead>
          <tr>
            <th>√âch√©ance</th>
            <th>Propri√©taire</th>
            <th>Logement</th>
            <th>Objet</th>
            <th>Statut</th>
            <th>Montant</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rowsBody"></tbody>
      </table>

      <div class="note">
        Astuce : ‚ÄúRelancer‚Äù note la date. ‚ÄúMarquer pay√©‚Äù d√©bloque. ‚ÄúConversation‚Äù ouvre la messagerie.
      </div>
    </div>
  </div>

</div>

<!-- MODAL AJOUT -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Ajouter un paiement</h2>
    <p>V1 propre : une ligne = une demande de r√®glement (pour un logement + proprio).</p>

    <form id="payForm">
      <label for="payHome">Logement</label>
      <select id="payHome" required></select>

      <label for="payOwner">Propri√©taire</label>
      <input id="payOwner" type="text" placeholder="Ex. Mme Dupont" required />

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <label for="payDue">√âch√©ance</label>
          <input id="payDue" type="date" required />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="payAmount">Montant (‚Ç¨)</label>
          <input id="payAmount" type="number" min="0" step="1" placeholder="Ex. 45" required />
        </div>
      </div>

      <label for="payEvent">Lier √† une prestation (optionnel)</label>
      <select id="payEvent">
        <option value="">‚Äî Ne pas lier ‚Äî</option>
      </select>

      <label for="payObjet">Objet</label>
      <input id="payObjet" type="text" placeholder="Ex. M√©nage + check-out" required />

      <label for="payRef">R√©f√©rence (optionnel)</label>
      <input id="payRef" type="text" placeholder="Ex. REQ-8F21" />

      <label for="payBlocked">
        <input id="payBlocked" type="checkbox" />
        Bloquer tant que non pay√©
      </label>

      <label for="payNote">Note interne (optionnel)</label>
      <textarea id="payNote" placeholder="Ex. Proprio veut r√©gler par virement avant 18h."></textarea>

      <div class="modal-actions">
        <button class="btn" type="button" id="cancelBtn">Annuler</button>
        <button class="btn primary" type="submit">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ===== BASE ===== */
const DATA_KEY = "cm_conciergerie_data_v1";

/* ===== Abonnements conciergerie (V1) ===== */
function getParam(name){
  const p = new URLSearchParams(location.search);
  return (p.get(name) || "").trim();
}

const PLAN_CATALOG = {
  starter:  { label:"Starter",  price:"49.90 ‚Ç¨ / mois",  range:"1‚Äì5 logements",  desc:"Pour d√©marrer propre et rentable." },
  pro:      { label:"Pro",      price:"69.90 ‚Ç¨ / mois",  range:"6‚Äì10 logements", desc:"Pour une conciergerie qui tourne." },
  business: { label:"Business", price:"89.90 ‚Ç¨ / mois",  range:"11‚Äì20 logements",desc:"Pour scaler sans se noyer." },
  illimite: { label:"Illimit√©", price:"139 ‚Ç¨ / mois",    range:"Logements illimit√©s", desc:"Pour les grosses machines." }
};

function updateSessionPatch(patch){
  const s = getSession() || {};
  const merged = { ...s, ...patch, ts: Date.now() };
  localStorage.setItem("cm_auth", JSON.stringify(merged));
  return merged;
}

function showPlanMsg(type, text){
  const box = document.getElementById("planMsg");
  if(!box) return;
  if(!text){
    box.className = "plan-msg";
    box.textContent = "";
    box.style.display = "none";
    return;
  }
  box.className = "plan-msg " + type;
  box.textContent = text;
  box.style.display = "block";
}

function renderPlanCardIfAny(){
  const planKey = (getParam("plan") || "").toLowerCase();
  const card = document.getElementById("planCard");
  if(!card) return;

  const plan = PLAN_CATALOG[planKey];
  if(!plan){
    // si pas de plan dans l‚ÄôURL ‚Üí on cache (page reste ‚Äúpaiements propri√©taires‚Äù)
    card.style.display = "none";
    return;
  }

  card.style.display = "block";
  document.getElementById("planPill").textContent = "Plan choisi";
  document.getElementById("planName").textContent = plan.label;
  document.getElementById("planPrice").textContent = plan.price;
  document.getElementById("planRange").textContent = plan.range;
  document.getElementById("planDesc").textContent = plan.desc;

  // boutons
  const backBtn = document.getElementById("planBackBtn");
  const actBtn = document.getElementById("planActivateBtn");

  if(backBtn){
    backBtn.onclick = ()=> location.href = "index.html#tarifs";
  }

  if(actBtn){
    actBtn.onclick = ()=>{
      const s = getSession();
      if(!s || s.role !== "conciergerie"){
        showPlanMsg("bad", "Session conciergerie introuvable. Connecte-toi d‚Äôabord.");
        location.href = "login.html?role=conciergerie&step=plan";
        return;
      }

      // ‚úÖ Activation V1 : on √©crit ce que ta barri√®re attend
      updateSessionPatch({
        plan: planKey,
        planActive: true,
        planActivatedAt: Date.now()
      });

      showPlanMsg("ok", "Abonnement activ√© (V1). Retour tableau de bord‚Ä¶");
      setTimeout(()=> location.href = "conciergerie.html", 500);
    };
  }
}


function uid(prefix){
  return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function loadData(){
  try{
    const raw = localStorage.getItem(DATA_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return null;
}
function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
function ensureData(){
  const existing = loadData();
  if(existing) return existing;
  const seeded = { homes:[], events:[], services:[], threads:[], payments:[], icalSources:[], kits:[], requests:[] };
  saveData(seeded);
  return seeded;
}
const app = ensureData();
app.homes = Array.isArray(app.homes) ? app.homes : [];
app.events = Array.isArray(app.events) ? app.events : [];          // ‚úÖ important
app.threads = Array.isArray(app.threads) ? app.threads : [];
app.payments = Array.isArray(app.payments) ? app.payments : [];
app.requests = Array.isArray(app.requests) ? app.requests : [];

/* ===== SEED si vide (optionnel) ===== */
(function seedIfEmpty(){
  if(app.payments.length) return;
  if(!app.homes.length){ saveData(app); return; }
  const h = app.homes[0];
  app.payments.push({
    id: uid("p"),
    due: new Date().toISOString().slice(0,10),
    owner: h.owner || "Propri√©taire",
    homeId: h.id,
    homeLabel: `${h.name||"Logement"} ‚Ä¢ ${h.city||""}`.trim(),
    objet: "Exemple : M√©nage + check-out",
    ref: "REQ-" + Math.random().toString(16).slice(2,6).toUpperCase(),
    amount: 45,
    status: "en_attente",
    blocked: true,
    note: "",
    lastRemindedAt: null,
    createdAt: Date.now(),
    paidAt: null,
    eventId: "" // ‚úÖ lien optionnel vers un event
  });
  saveData(app);
})();

/* ===== UI ===== */
const rowsBody = document.getElementById("rowsBody");
const fOwner = document.getElementById("filterOwner");
const fLog = document.getElementById("filterLogement");
const fStatus = document.getElementById("filterStatus");
const searchInput = document.getElementById("searchInput");

const kpiPending = document.getElementById("kpiPending");
const kpiLate = document.getElementById("kpiLate");
const kpiPaid = document.getElementById("kpiPaid");
const kpiBlocked = document.getElementById("kpiBlocked");

const modalBackdrop = document.getElementById("modalBackdrop");
const addBtn = document.getElementById("addBtn");
const cancelBtn = document.getElementById("cancelBtn");
const payForm = document.getElementById("payForm");

const payHome = document.getElementById("payHome");
const payOwner = document.getElementById("payOwner");
const payDue = document.getElementById("payDue");
const payAmount = document.getElementById("payAmount");
const payObjet = document.getElementById("payObjet");
const payRef = document.getElementById("payRef");
const payBlocked = document.getElementById("payBlocked");
const payNote = document.getElementById("payNote");
const payEvent = document.getElementById("payEvent");  // ‚úÖ

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function parseISODate(s){
  const m = String(s||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
  return isNaN(d.getTime()) ? null : d;
}

function computeStatusAuto(p){
  if(p.status === "paye") return;
  const dueDate = parseISODate(p.due);
  if(!dueDate) return;
  const today = new Date();
  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const d0 = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
  if(d0 < t0){
    p.status = "en_retard";
  }else{
    if(p.status !== "en_attente") p.status = "en_attente";
  }
}

function statusBadge(p){
  const blocked = !!p.blocked && p.status !== "paye";
  if(p.status === "paye") return `<span class="badge-status paye">Pay√©</span>`;
  if(blocked) return `<span class="badge-status bloque">Bloqu√©</span>`;
  if(p.status === "en_retard") return `<span class="badge-status retard">En retard</span>`;
  return `<span class="badge-status attente">En attente</span>`;
}

function fmtDue(p){
  const d = parseISODate(p.due);
  if(!d) return escapeHtml(p.due || "‚Äî");
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}/${mm}/${yy}`;
}

function ensureThreadsForPayment(p){
  if(!app.threads) app.threads = [];
  if(!p.homeId) return;

  let t = app.threads.find(x => x.homeId === p.homeId && (x.owner||"") === (p.owner||""));
  if(t) return t;

  t = {
    id: uid("t"),
    owner: p.owner || "Propri√©taire",
    homeId: p.homeId,
    homeLabel: p.homeLabel || "Logement",
    last: "Conversation cr√©√©e depuis Paiements.",
    lastAt: Date.now(),
    unread: 0,
    flags: { paymentDue: true },
    messages: [
      { id: uid("m"), from:"me", text:"Conversation cr√©√©e depuis Paiements.", at: Date.now() }
    ]
  };
  app.threads.unshift(t);
  saveData(app);
  return t;
}

/* ===== LIAISON EVENT <-> PAIEMENT ===== */
function applyPaymentToEvent(p){
  // p.eventId est optionnel
  if(!p || !p.eventId) return;
  const ev = app.events.find(e => e.id === p.eventId);
  if(!ev) return;

  // on lie
  ev.paymentId = p.id;

  // r√®gles de blocage
  if(p.status !== "paye" && p.blocked){
    ev.isBlocked = true;
    ev.blockReason = "Paiement requis (" + (p.ref || "sans ref") + ")";
  }else{
    ev.isBlocked = false;
    ev.blockReason = "";
  }
}

/* ===== Remplir le select "prestation" selon le logement ===== */
function fillEventsForHome(homeId){
  // reset
  payEvent.innerHTML = `<option value="">‚Äî Ne pas lier ‚Äî</option>`;

  const evs = app.events
    .filter(e => e.homeId === homeId)
    .sort((a,b)=>{
      const da = String(a.date||"");
      const db = String(b.date||"");
      if(da !== db) return da.localeCompare(db);
      return String(a.time||"").localeCompare(String(b.time||""));
    });

  if(!evs.length){
    // pas de presta : on laisse seulement "ne pas lier"
    return;
  }

  const opts = evs.map(e=>{
    const label = `${e.date || "‚Äî"} ${e.time || "‚Äî"} ‚Ä¢ ${e.type || "Prestation"}${e.isBlocked ? " (bloqu√©)" : ""}`;
    return `<option value="${escapeHtml(e.id)}">${escapeHtml(label)}</option>`;
  }).join("");

  payEvent.insertAdjacentHTML("beforeend", opts);
}

renderPlanCardIfAny();



function buildFilterOptions(){
  const owners = Array.from(new Set(app.homes.map(h => (h.owner||"").trim()).filter(Boolean))).sort();
  const logements = app.homes.map(h => ({ id: h.id, label: `${h.name||"Logement"} ‚Ä¢ ${h.city||""}`.trim(), owner: h.owner||"" }));

  const currentOwner = fOwner.value;
  fOwner.innerHTML = `<option value="">Tous propri√©taires</option>` + owners.map(o=>`<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("");
  fOwner.value = owners.includes(currentOwner) ? currentOwner : "";

  const currentLog = fLog.value;
  fLog.innerHTML = `<option value="">Tous logements</option>` +
    logements.map(l=>`<option value="${escapeHtml(l.id)}">${escapeHtml(l.label)}</option>`).join("");
  fLog.value = logements.some(l=>l.id===currentLog) ? currentLog : "";

  payHome.innerHTML = logements.map(l=>`<option value="${escapeHtml(l.id)}">${escapeHtml(l.label)}</option>`).join("");

  // ‚úÖ important : remplir les events d√®s qu‚Äôon a une valeur
  const selectedHome = payHome.value || logements[0]?.id || "";
  if(selectedHome) fillEventsForHome(selectedHome);
}

function computeKpis(payments){
  const pending = payments.filter(x => x.status==="en_attente" && !(x.blocked && x.status!=="paye")).length;
  const late = payments.filter(x => x.status==="en_retard" && !(x.blocked && x.status!=="paye")).length;
  const paid = payments.filter(x => x.status==="paye").length;
  const blocked = payments.filter(x => x.blocked && x.status!=="paye").length;
  kpiPending.textContent = pending;
  kpiLate.textContent = late;
  kpiPaid.textContent = paid;
  kpiBlocked.textContent = blocked;
}

function render(){
  app.payments.forEach(p => computeStatusAuto(p));
  saveData(app);

  rowsBody.innerHTML = "";
  const q = (searchInput.value || "").toLowerCase().trim();

  const filtered = app.payments.filter(r => {
    const okOwner = !fOwner.value || (r.owner === fOwner.value);
    const okLog = !fLog.value || (r.homeId === fLog.value);
    const okStatus = !fStatus.value || (r.status === fStatus.value);
    const hay = `${r.due} ${r.owner} ${r.homeLabel} ${r.objet} ${r.ref} ${r.status} ${r.amount}`.toLowerCase();
    const okQ = !q || hay.includes(q);
    return okOwner && okLog && okStatus && okQ;
  }).sort((a,b)=> {
    const prio = (x)=> x.status==="en_retard" ? 0 : (x.status==="en_attente" ? 1 : 2);
    const pa = prio(a), pb = prio(b);
    if(pa !== pb) return pa - pb;
    return String(a.due||"").localeCompare(String(b.due||""));
  });

  if(!filtered.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td colspan="7" style="padding:16px 10px; color:#666;">
        Aucun paiement. Clique sur <b>+ Ajouter</b>.
      </td>
    `;
    rowsBody.appendChild(tr);
    computeKpis(app.payments);
    return;
  }

  filtered.forEach((r) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${fmtDue(r)}</td>
      <td><strong>${escapeHtml(r.owner || "‚Äî")}</strong><div class="small">${escapeHtml(r.ref || "")}</div></td>
      <td>${escapeHtml(r.homeLabel || "‚Äî")}</td>
      <td>
        <strong>${escapeHtml(r.objet || "‚Äî")}</strong>
        ${r.eventId ? `<div class="small">üìå Li√© √† une prestation</div>` : ``}
        ${r.note ? `<div class="small">${escapeHtml(r.note)}</div>` : ""}
      </td>
      <td>${statusBadge(r)}</td>
      <td><strong>${Number(r.amount||0)} ‚Ç¨</strong></td>
      <td>
        <div class="actions">
          <button class="action-btn" type="button" data-remind="${escapeHtml(r.id)}">Relancer</button>
          <button class="action-btn primary" type="button" data-paid="${escapeHtml(r.id)}">Marquer pay√©</button>
          <button class="action-btn danger" type="button" data-block="${escapeHtml(r.id)}">${(r.blocked && r.status!=="paye") ? "D√©bloquer" : "Bloquer"}</button>
          <button class="action-btn" type="button" data-chat="${escapeHtml(r.id)}">Conversation</button>
          <button class="action-btn danger" type="button" data-del="${escapeHtml(r.id)}">Supprimer</button>
        </div>
      </td>
    `;
    rowsBody.appendChild(tr);
  });

  // bind actions
  rowsBody.querySelectorAll("button[data-remind]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-remind");
      const p = app.payments.find(x=>x.id===id);
      if(!p) return;
      p.lastRemindedAt = Date.now();
      p.note = (p.note ? (p.note + "\n") : "") + "Relanc√© le " + new Date().toLocaleString("fr-FR");
      const t = ensureThreadsForPayment(p);
      if(t){
        t.flags = t.flags || {};
        t.flags.paymentDue = true;
      }
      saveData(app);
      render();
      alert("Relance not√©e (V1).");
    });
  });

  rowsBody.querySelectorAll("button[data-paid]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-paid");
      const p = app.payments.find(x=>x.id===id);
      if(!p) return;

      p.status = "paye";
      p.blocked = false;
      p.paidAt = Date.now();

      // ‚úÖ r√©percute sur l‚Äôevent li√©
      applyPaymentToEvent(p);

      const t = app.threads.find(x => x.homeId===p.homeId && (x.owner||"")===(p.owner||""));
      if(t && t.flags) t.flags.paymentDue = false;

      saveData(app);
      render();
      alert("Paiement marqu√© comme re√ßu. D√©bloqu√©.");
    });
  });

  rowsBody.querySelectorAll("button[data-block]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-block");
      const p = app.payments.find(x=>x.id===id);
      if(!p) return;
      if(p.status === "paye"){
        alert("D√©j√† pay√© : pas de blocage.");
        return;
      }

      p.blocked = !p.blocked;

      // ‚úÖ r√©percute sur l‚Äôevent li√©
      applyPaymentToEvent(p);

      const t = ensureThreadsForPayment(p);
      if(t){
        t.flags = t.flags || {};
        t.flags.paymentDue = !!p.blocked;
      }
      saveData(app);
      render();
    });
  });

  rowsBody.querySelectorAll("button[data-chat]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-chat");
      const p = app.payments.find(x=>x.id===id);
      if(!p) return;
      ensureThreadsForPayment(p);
      saveData(app);
      location.href = "messagerie.html";
    });
  });

  rowsBody.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      const ok = confirm("Supprimer ce paiement ? (pas d‚Äôannulation)");
      if(!ok) return;

      // (optionnel) si paiement li√©, on coupe le lien dans l'event
      const p = app.payments.find(x=>x.id===id);
      if(p && p.eventId){
        const ev = app.events.find(e=>e.id===p.eventId);
        if(ev && ev.paymentId === p.id){
          ev.paymentId = null;
          // on ne d√©bloque pas automatiquement (tu peux pr√©f√©rer le contraire)
          // ev.isBlocked = false;
          // ev.blockReason = "";
        }
      }

      app.payments = app.payments.filter(x=>x.id!==id);
      saveData(app);
      render();
    });
  });

  computeKpis(app.payments);
}

function openModal(){
  if(!app.homes.length){
    alert("Ajoute d‚Äôabord un logement (Logements).");
    location.href = "logements.html";
    return;
  }
  modalBackdrop.style.display = "flex";
  payDue.value = new Date().toISOString().slice(0,10);
  payBlocked.checked = true;

  // ‚úÖ remplir events pour le logement courant
  fillEventsForHome(payHome.value);

  setTimeout(()=>payOwner.focus(), 0);
}
function closeModal(){
  modalBackdrop.style.display = "none";
  payForm.reset();
}

addBtn.addEventListener("click", openModal);
cancelBtn.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", (e)=>{
  if(e.target === modalBackdrop) closeModal();
});

payHome.addEventListener("change", ()=>{
  const h = app.homes.find(x=>x.id===payHome.value);
  if(h && h.owner && !payOwner.value) payOwner.value = h.owner;

  // ‚úÖ update liste prestations
  fillEventsForHome(payHome.value);
});

payForm.addEventListener("submit", (e)=>{
  e.preventDefault();

  const homeId = payHome.value;
  const h = app.homes.find(x=>x.id===homeId);
  if(!h){ alert("Logement invalide."); return; }

  const owner = payOwner.value.trim();
  const due = payDue.value;
  const amount = Number(payAmount.value || 0);
  const objet = payObjet.value.trim();
  const ref = payRef.value.trim();
  const blocked = !!payBlocked.checked;
  const note = payNote.value.trim();

  // ‚úÖ ici : eventId vient du select
  const eventId = payEvent.value || "";

  if(!owner || !due || !objet || !amount){
    alert("Champs manquants.");
    return;
  }

  const p = {
    id: uid("p"),
    due,
    owner,
    homeId,
    homeLabel: `${h.name||"Logement"} ‚Ä¢ ${h.city||""}`.trim(),
    objet,
    ref: ref || ("REQ-" + Math.random().toString(16).slice(2,6).toUpperCase()),
    amount,
    status: "en_attente",
    blocked,
    note,
    lastRemindedAt: null,
    createdAt: Date.now(),
    paidAt: null,
    eventId // ‚úÖ stock√©
  };

  computeStatusAuto(p);
  app.payments.unshift(p);

  // ‚úÖ applique le blocage/d√©blocage √† la prestation li√©e
  applyPaymentToEvent(p);

  if(blocked){
    const t = ensureThreadsForPayment(p);
    if(t){
      t.flags = t.flags || {};
      t.flags.paymentDue = true;
    }
  }

  saveData(app);
  closeModal();
  buildFilterOptions();
  render();
});

[fOwner,fLog,fStatus].forEach(el => el.addEventListener("change", render));
searchInput.addEventListener("input", render);

buildFilterOptions();
render();
</script>

</body>
</html>
