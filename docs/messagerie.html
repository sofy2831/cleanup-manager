<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CleanUp Manager – Messagerie</title>

<style>
:root{
  --violet-light:#F3ECFF;
  --violet-main:#7A5CFF;
  --violet-dark:#6238FF;
  --text-dark:#111;
  --grey:#666;
  --green:#1E7A3A;
  --orange:#B37400;
  --red:#A61E4D;
  --bad:#b3261e;
  --ok:#1b8f4d;
}
body{
  margin:0;
  font-family:"Comic Sans MS", sans-serif;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}
.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
}
.topbar{
  width:100%;
  max-width:980px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:10;
  padding:10px 0;
  background:rgba(248,244,255,.85);
  backdrop-filter:blur(6px);
}
.pill-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:#fff;
  border:2px solid var(--violet-main);
  color:var(--violet-main);
  text-decoration:none;
  font-weight:900;
  font-size:13px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  white-space:nowrap;
  cursor:pointer;
}
.pill-link.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

.logo-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.logo-icon{
  width:36px;height:36px;border-radius:50%;
  border:2px solid var(--violet-main);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--violet-main);
  background:#fff;
  position:relative;
}
.logo-icon::after{
  content:"✦";
  position:absolute;
  top:-6px; right:-4px;
  font-size:12px;
  color:var(--violet-main);
}
h1{margin:0;font-size:24px;}
.subtitle{font-size:15px;color:#444;text-align:center;margin-top:4px;}
.badge{
  margin-top:8px;
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#555;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}

.alert{
  width:100%;
  max-width:980px;
  display:none;
  margin-top:10px;
  padding:10px 12px;
  background:#fff;
  border-radius:14px;
  border-left:5px solid var(--bad);
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  font-size:12px;
  color:#444;
  white-space:pre-wrap;
}
.alert.ok{ border-left-color: var(--ok); }

.top-nav{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  padding:4px;
  border-radius:999px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.top-nav a{
  text-decoration:none;
  font-size:12px;
  padding:6px 12px;
  border-radius:999px;
  color:#555;
}
.top-nav a.active{
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
}

.layout{
  width:100%;
  max-width:980px;
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
@media(min-width:900px){
  .layout{ flex-direction:row; align-items:stretch; }
}

.panel{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  padding:14px;
  box-sizing:border-box;
}

.threads{ flex:1; min-width:280px; }
.searchbar{
  display:flex;
  gap:8px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.searchbar input{
  flex:1;
  min-width:180px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid #D3C7FF;
  outline:none;
  background:#fff;
  font-size:12px;
}
.searchbar button{
  border:none;
  border-radius:999px;
  padding:8px 12px;
  font-size:12px;
  font-weight:900;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  cursor:pointer;
  white-space:nowrap;
}

.thread-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:520px;
  overflow:auto;
  padding-right:2px;
}
.thread{
  background:#fff;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:10px 10px;
  cursor:pointer;
  border:2px solid transparent;
}
.thread.active{ border-color: var(--violet-main); }
.thread-top{
  display:flex;
  justify-content:space-between;
  gap:8px;
  align-items:flex-start;
}
.thread-title{
  font-weight:900;
  font-size:13px;
  color:#222;
}
.thread-sub{
  font-size:11px;
  color:#666;
  margin-top:2px;
}
.thread-right{
  text-align:right;
  font-size:11px;
  color:#666;
  white-space:nowrap;
}
.pill-unread{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:18px;
  height:18px;
  padding:0 6px;
  border-radius:999px;
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
  font-size:11px;
  margin-top:6px;
}

.chat{
  flex:1.6;
  min-width:280px;
  display:flex;
  flex-direction:column;
}
.chat-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  margin-bottom:10px;
}
.chat-title{ font-weight:900; font-size:14px; }
.chat-meta{ font-size:11px; color:#666; margin-top:2px; }
.chat-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.action{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
  background:#fff;
  border:1px solid #D3C7FF;
  color:#555;
}
.action.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border:none;
  color:#fff;
}

.banner{
  background:#fff;
  border-radius:14px;
  padding:10px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  border-left:5px solid var(--orange);
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.banner strong{ color:#333; }
.banner small{ color:#666; display:block; margin-top:2px; }
.banner a{
  text-decoration:none;
  font-weight:900;
  color:#fff;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  padding:8px 12px;
  border-radius:999px;
  white-space:nowrap;
}

.msgs{
  background:#fff;
  border-radius:16px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:12px;
  flex:1;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  max-width:80%;
  padding:10px 10px;
  border-radius:14px;
  font-size:13px;
  line-height:1.25;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.msg.me{
  margin-left:auto;
  background:linear-gradient(180deg,#F3ECFF 0%, #EADFFF 100%);
  border:1px solid #D3C7FF;
}
.msg.them{
  background:#fff;
  border:1px solid #eee;
}
.msg .meta{
  display:flex;
  justify-content:space-between;
  gap:8px;
  margin-top:6px;
  font-size:11px;
  color:#666;
}

.composer{
  margin-top:10px;
  display:flex;
  gap:8px;
}
.composer textarea{
  flex:1;
  resize:none;
  border-radius:14px;
  border:1px solid #D3C7FF;
  padding:10px;
  font-size:13px;
  outline:none;
  background:#fff;
  min-height:44px;
  max-height:110px;
}
.send{
  border:none;
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
.small-note{
  text-align:center;
  margin-top:8px;
  font-size:12px;
  color:#666;
}
</style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;
    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

<div class="page">
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="import-ical.html">Import iCal</a>
      <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Messagerie propriétaires ↔ conciergerie</div>
  <div class="badge" id="badgeLine">Firestore • threads + messages</div>

  <div class="alert" id="alertBox"></div>

  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a class="active" href="messagerie.html">Messagerie</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="import-ical.html">Import</a>
  </div>

  <div class="layout">
    <div class="panel threads">
      <div class="searchbar">
        <input id="threadSearch" type="text" placeholder="Recherche (proprio, logement, mot-clé…)">
        <button type="button" id="newThreadBtn">Nouveau</button>
      </div>

      <div class="thread-list" id="threadList"></div>
      <div class="small-note">Firestore temps réel.</div>
    </div>

    <div class="panel chat">
      <div class="chat-head">
        <div>
          <div class="chat-title" id="chatTitle">Sélectionne une conversation</div>
          <div class="chat-meta" id="chatMeta">—</div>
        </div>
        <div class="chat-actions">
          <button class="action" type="button" id="goHomeBtn">Logement</button>
          <button class="action" type="button" id="goPaymentsBtn">Paiements</button>
          <button class="action primary" type="button" id="createPrestaBtn">Créer prestation</button>
        </div>
      </div>

      <div id="bannerZone"></div>

      <div class="msgs" id="msgs">
        <div class="small-note">Clique une conversation à gauche.</div>
      </div>

      <div class="composer">
        <textarea id="composerText" placeholder="Écrire un message…"></textarea>
        <button class="send" type="button" id="sendBtn">Envoyer</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    collection, doc, addDoc, updateDoc, getDocs,
    query, where, onSnapshot,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== UI =====
  const badgeLine = document.getElementById("badgeLine");
  const alertBox = document.getElementById("alertBox");
  function showAlert(msg, ok=false){
    alertBox.style.display = "block";
    alertBox.classList.toggle("ok", !!ok);
    alertBox.textContent = msg;
  }
  function hideAlert(){
    alertBox.style.display = "none";
    alertBox.classList.remove("ok");
    alertBox.textContent = "";
  }

  const threadListEl = document.getElementById("threadList");
  const threadSearchEl = document.getElementById("threadSearch");
  const chatTitleEl = document.getElementById("chatTitle");
  const chatMetaEl = document.getElementById("chatMeta");
  const msgsEl = document.getElementById("msgs");
  const bannerZoneEl = document.getElementById("bannerZone");
  const composerEl = document.getElementById("composerText");

  const newThreadBtn = document.getElementById("newThreadBtn");
  const sendBtn = document.getElementById("sendBtn");
  const createPrestaBtn = document.getElementById("createPrestaBtn");
  const goPaymentsBtn = document.getElementById("goPaymentsBtn");
  const goHomeBtn = document.getElementById("goHomeBtn");

  // ===== State =====
  let currentUser = null;
  let allThreads = [];
  let activeThreadId = null;
  let unsubThreads = null;
  let unsubMessages = null;

  function esc(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function truncate(str, n){
    const s = String(str ?? "");
    return (s.length > n) ? s.slice(0, n-1) + "…" : s;
  }
  function fmtTime(ts){
    try{
      const d = ts?.toDate ? ts.toDate() : new Date(ts || Date.now());
      return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch(e){ return "—"; }
  }

  function renderThreads(){
    const q = (threadSearchEl.value || "").toLowerCase().trim();
    threadListEl.innerHTML = "";

    const threads = allThreads.slice().sort((a,b)=>{
      const ta = a.lastAt?.seconds ?? 0;
      const tb = b.lastAt?.seconds ?? 0;
      return tb - ta;
    });

    const filtered = !q ? threads : threads.filter(t => {
      const hay = `${t.ownerName||""} ${t.ownerEmail||""} ${t.homeLabel||""} ${t.lastText||""}`.toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){
      const empty = document.createElement("div");
      empty.className = "small-note";
      empty.textContent = "Aucune conversation.";
      threadListEl.appendChild(empty);
      return;
    }

    filtered.forEach(t => {
      const div = document.createElement("div");
      div.className = "thread" + (t.id === activeThreadId ? " active" : "");
      div.onclick = () => openThread(t.id);

      const titleLeft = `${t.ownerName || "Propriétaire"} • ${t.homeLabel || "Logement"}`;
      const unread = Number(t.unreadForConciergerie || 0);

      div.innerHTML = `
        <div class="thread-top">
          <div>
            <div class="thread-title">${esc(titleLeft)}</div>
            <div class="thread-sub">${esc(truncate(t.lastText || "", 56))}</div>
          </div>
          <div class="thread-right">
            <div>${fmtTime(t.lastAt)}</div>
            ${unread ? `<div class="pill-unread">${unread}</div>` : ``}
          </div>
        </div>
      `;
      threadListEl.appendChild(div);
    });
  }

  function renderBanner(t){
    bannerZoneEl.innerHTML = "";
    if(!t?.flags?.paymentDue) return;

    const b = document.createElement("div");
    b.className = "banner";
    b.innerHTML = `
      <div>
        <strong>Paiement requis avant intervention</strong>
        <small>Ce fil est marqué “paiement dû”. Tu peux lever le blocage dans Paiements.</small>
      </div>
      <a href="paiements.html">Voir paiements</a>
    `;
    bannerZoneEl.appendChild(b);
  }

  function stopMessages(){
    if(unsubMessages) unsubMessages();
    unsubMessages = null;
  }

  function listenMessages(threadId){
    stopMessages();
    msgsEl.innerHTML = `<div class="small-note">Chargement…</div>`;

    const col = collection(db, "threads", threadId, "messages");

    // ✅ pas d'orderBy => pas d’index composite, on trie en JS
    unsubMessages = onSnapshot(col, (snap)=>{
      const msgs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      msgs.sort((a,b)=>{
        const ta = a.at?.seconds ?? 0;
        const tb = b.at?.seconds ?? 0;
        return ta - tb;
      });

      msgsEl.innerHTML = "";
      if(!msgs.length){
        msgsEl.innerHTML = `<div class="small-note">Aucun message.</div>`;
        return;
      }

      msgs.forEach(m=>{
        const div = document.createElement("div");
        div.className = "msg " + (m.from === "me" ? "me" : "them");
        div.innerHTML = `
          <div>${esc(m.text || "")}</div>
          <div class="meta">
            <span>${m.from === "me" ? "Conciergerie" : "Propriétaire"}</span>
            <span>${fmtTime(m.at)}</span>
          </div>
        `;
        msgsEl.appendChild(div);
      });

      setTimeout(()=>{ msgsEl.scrollTop = msgsEl.scrollHeight; }, 0);
    }, (err)=>{
      console.error(err);
      showAlert("Erreur lecture messages : " + (err?.message || "inconnue"));
    });
  }

  async function openThread(id){
    activeThreadId = id;
    const t = allThreads.find(x => x.id === id);
    if(!t) return;

    chatTitleEl.textContent = `${t.ownerName || "Propriétaire"} • ${t.homeLabel || "Logement"}`;
    chatMetaEl.textContent = t.homeId ? `Lié au logement • ${t.homeLabel}` : `Conversation générale`;

    renderBanner(t);
    renderThreads();
    listenMessages(id);

    // reset unread côté conciergerie (optionnel)
    try{
      await updateDoc(doc(db,"threads",id), { unreadForConciergerie: 0 });
    }catch(e){
      // pas bloquant
    }
  }

  async function sendMessage(){
    const text = (composerEl.value || "").trim();
    if(!activeThreadId){
      alert("Choisis une conversation à gauche.");
      return;
    }
    if(!text) return;

    const threadId = activeThreadId;

    try{
      await addDoc(collection(db,"threads",threadId,"messages"), {
        from: "me",
        text,
        at: serverTimestamp(),
        senderUid: currentUser?.uid || null
      });

      await updateDoc(doc(db,"threads",threadId), {
        lastText: text,
        lastAt: serverTimestamp()
      });

      composerEl.value = "";
    }catch(err){
      console.error(err);
      showAlert("Erreur envoi : " + (err?.message || "inconnue"));
    }
  }

  async function newThread(){
    // On crée un thread conciergerie → proprio (V1 simple : choix logement)
    // On récupère homes de cette conciergerie et on propose une liste.
    hideAlert();

    const homesSnap = await getDocs(query(
      collection(db,"homes"),
      where("conciergerieUid","==", currentUser.uid)
    ));

    const homes = homesSnap.docs.map(d=>({id:d.id, ...d.data()}));
    homes.sort((a,b)=> (b.createdAt?.seconds ?? 0) - (a.createdAt?.seconds ?? 0));

    if(!homes.length){
      alert("Ajoute d’abord un logement (Logements) pour lier une conversation.");
      location.href = "logements.html";
      return;
    }

    const list = homes.map((h,i)=>`${i+1}. ${h.name} (${h.city}) — ${(h.ownerName||h.ownerEmail||"Proprio")}`).join("\n");
    const pickStr = prompt("Choisis un logement (numéro) :\n\n" + list);
    if(!pickStr) return;
    const idx = Number(pickStr) - 1;
    const chosen = homes[idx];
    if(!chosen){ alert("Numéro invalide."); return; }

    const ownerName = prompt("Nom du propriétaire :", chosen.ownerName || "Propriétaire");
    if(!ownerName) return;

    try{
      const threadRef = await addDoc(collection(db,"threads"), {
        conciergerieUid: currentUser.uid,
        ownerUid: chosen.ownerUid || null,
        ownerName: String(ownerName).trim(),
        ownerEmail: chosen.ownerEmail || "",
        homeId: chosen.id,
        homeLabel: `${chosen.name || "Logement"} • ${chosen.city || ""}`.trim(),
        lastText: "Conversation créée.",
        lastAt: serverTimestamp(),
        unreadForConciergerie: 0,
        flags: { paymentDue:false },
        createdAt: serverTimestamp()
      });

      await addDoc(collection(db,"threads",threadRef.id,"messages"), {
        from:"me",
        text:"Conversation créée.",
        at: serverTimestamp(),
        senderUid: currentUser.uid
      });

      showAlert("✅ Conversation créée.", true);
      setTimeout(hideAlert, 900);
    }catch(err){
      console.error(err);
      showAlert("Erreur création thread : " + (err?.message || "inconnue"));
    }
  }

  function startThreadsListener(user){
    badgeLine.textContent = `Firestore • threads • uid=${user.uid.slice(0,6)}…`;

    // ✅ pas d'orderBy => pas d’index composite, tri JS
    const q = query(
      collection(db,"threads"),
      where("conciergerieUid","==", user.uid)
    );

    unsubThreads = onSnapshot(q, (snap)=>{
      allThreads = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      hideAlert();
      renderThreads();

      // auto-open le premier thread si rien d’ouvert
      if(!activeThreadId && allThreads.length){
        // on prend le plus récent via tri JS
        const sorted = allThreads.slice().sort((a,b)=>(b.lastAt?.seconds??0)-(a.lastAt?.seconds??0));
        openThread(sorted[0].id);
      }
    }, (err)=>{
      console.error(err);
      showAlert("Erreur lecture threads : " + (err?.message || "inconnue"));
    });
  }

  // ===== UI events =====
  threadSearchEl.addEventListener("input", renderThreads);
  newThreadBtn.addEventListener("click", newThread);
  sendBtn.addEventListener("click", sendMessage);
  composerEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendMessage();
    }
  });

  createPrestaBtn.addEventListener("click", ()=>{
    const t = allThreads.find(x => x.id === activeThreadId);
    if(t?.homeId){
      location.href = "planning.html?homeId=" + encodeURIComponent(t.homeId);
    }else{
      location.href = "planning.html";
    }
  });
  goPaymentsBtn.addEventListener("click", ()=> location.href = "paiements.html");
  goHomeBtn.addEventListener("click", ()=>{
    const t = allThreads.find(x => x.id === activeThreadId);
    if(t?.homeId){
      location.href = "planning.html?homeId=" + encodeURIComponent(t.homeId);
    }else{
      location.href = "logements.html";
    }
  });

  // ===== Boot =====
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      location.href = "login.html?role=conciergerie";
      return;
    }
    currentUser = user;

    if(unsubThreads) unsubThreads();
    stopMessages();
    activeThreadId = null;
    allThreads = [];
    msgsEl.innerHTML = `<div class="small-note">Clique une conversation à gauche.</div>`;

    startThreadsListener(user);
  });
</script>

</body>
</html>
