<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Planning</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --card:#fff;
      --shadow:0 6px 18px rgba(0,0,0,.10);
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .left, .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .pill.danger{
      border-color:#ffd2d2;
      background:#FFE3EC;
      color:var(--bad);
    }
    button.pill{ border:none; }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative; flex-shrink:0;
    }
    .logo-icon::after{
      content:"‚ú¶";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:24px; font-weight:900; }
    .subtitle{
      margin-top:4px;
      text-align:center;
      font-size:14px;
      color:#444;
      max-width:980px;
      line-height:1.35;
    }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#333;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .summary{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (min-width:768px){ .summary{ grid-template-columns:repeat(4,1fr); } }
    .summary-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:10px 10px 12px;
      text-align:left;
    }
    .summary-title{ font-size:12px; color:#666; font-weight:900; margin-bottom:4px; }
    .summary-value{ font-size:18px; font-weight:900; color:#222; }
    .summary-note{ font-size:11px; color:#666; margin-top:2px; }

    .toolbar{
      width:100%;
      max-width:980px;
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .toolbar .group{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .select{
      appearance:none;
      border:1px solid rgba(122,92,255,.25);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
      min-width:240px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      outline:none;
      cursor:pointer;
    }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media (min-width:768px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }
    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px 14px 18px;
    }
    .calendar-card{ flex:1.2; }
    .agenda-card{ flex:1; }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .hint{ font-size:12px; color:#666; font-weight:800; }

    .month-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .month-label{ font-size:15px; font-weight:900; }
    .month-btn{
      border:none;
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      color:var(--violet-main);
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      font-weight:900;
    }

    .weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      font-size:11px;
      color:#666;
      margin-bottom:4px;
      text-align:center;
    }
    .weekdays div{ padding:4px 0; }
    .calendar-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }

    .day{
      height:34px;
      border-radius:10px;
      font-size:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#333;
      background:#fff;
      border:1px solid transparent;
      position:relative;
      user-select:none;
    }
    .day.outside{ opacity:.25; cursor:default; }
    .day.today{ border-color: var(--violet-main); font-weight:900; }
    .day.selected{ background:var(--violet-main); color:#fff; border-color:var(--violet-main); }
    .day.has-any::after{
      content:"";
      position:absolute;
      bottom:4px;
      width:5px;height:5px;border-radius:50%;
      background:var(--violet-main);
    }

    .agenda-header{ font-size:14px; color:#555; margin-bottom:8px; }
    .agenda-date{ font-weight:900; color:var(--violet-dark); }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      background:#fff;
      border-radius:12px;
      padding:9px 10px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      border-left:4px solid var(--violet-main);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .item:hover{ transform:translateY(-1px); box-shadow:0 5px 14px rgba(0,0,0,.10); }
    .line1{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:2px;
    }
    .time{ font-weight:900; color:#333; }
    .pilltype{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }
    .pilltype.resa{ background:#E8F0FE; color:#1A5FD0; }
    .pilltype.job{ background:#E9F7EF; color:#1E7A3A; }

    .title{ font-weight:900; color:#333; }
    .meta{ font-size:11px; color:#666; margin-top:2px; line-height:1.25; }

    .empty{
      font-size:13px;
      color:#777;
      text-align:center;
      padding:18px 4px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .cta{
      margin-top:10px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .cta button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      min-width:220px;
    }
    .fineprint{ font-size:11px; color:#666; text-align:center; max-width:320px; line-height:1.25; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <div class="left">
        <a class="pill" href="conciergerie.html">‚Üê Tableau de bord</a>
      </div>
      <div class="right">
        <a class="pill" href="logements.html">Logements</a>
        <a class="pill" href="prestations.html">Catalogue</a>
        <a class="pill" href="import-ical.html">iCal</a>
        <button class="pill danger" id="logoutBtn" type="button">D√©connexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">‚úì</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle" id="subtitle">
      Planning (r√©servations iCal + prestations)
    </div>

    <div class="alert" id="alertBox"></div>

    <div class="summary">
      <div class="summary-card">
        <div class="summary-title">Aujourd‚Äôhui</div>
        <div class="summary-value" id="kpiToday">‚Äî</div>
        <div class="summary-note">√©l√©ments</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">7 jours</div>
        <div class="summary-value" id="kpiWeek">‚Äî</div>
        <div class="summary-note">√©l√©ments</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Logements</div>
        <div class="summary-value" id="kpiHomes">‚Äî</div>
        <div class="summary-note">g√©r√©s</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Mois</div>
        <div class="summary-value" id="kpiMonth">‚Äî</div>
        <div class="summary-note">√©l√©ments charg√©s</div>
      </div>
    </div>

    <div class="toolbar">
      <div class="group">
        <select class="select" id="homeFilter">
          <option value="">Tous les logements</option>
        </select>
      </div>
      <div class="group">
        <button class="pill primary" type="button" id="addJobBtn">+ Ajouter une prestation</button>
      </div>
    </div>

    <div class="layout">
      <div class="card calendar-card">
        <div class="card-title">
          <span>Calendrier</span>
          <span class="hint">‚Ä¢ point = jour charg√©</span>
        </div>

        <div class="month-header">
          <button class="month-btn" id="prevMonth">&lt;</button>
          <div class="month-label" id="monthLabel">Mois Ann√©e</div>
          <button class="month-btn" id="nextMonth">&gt;</button>
        </div>

        <div class="weekdays">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>

        <div class="calendar-grid" id="calendarDays"></div>
      </div>

      <div class="card agenda-card">
        <div class="card-title"><span>Agenda du jour</span></div>

        <div class="agenda-header">
          √âl√©ments du <span class="agenda-date" id="agendaDateLabel"></span>
        </div>

        <div class="list" id="agendaList"></div>

        <div class="cta">
          <button type="button" id="quickJobBtn">+ Prestation sur cette date</button>
          <div class="fineprint">Astuce : clique une r√©servation iCal pour cr√©er une prestation.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      doc, getDoc, setDoc, serverTimestamp,
      collection, query, where, onSnapshot, addDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== Admin gratuits =====
    const FREE_EMAILS = new Set([
      "mathilde.debout31@gmail.com",
      "s.dumas974@gmail.com"
    ]);

    // ===== UI helpers =====
    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(_){}
      location.href = "index.html";
    });

    // ===== Date utils =====
    const MONTHS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
    function pad2(n){ return n < 10 ? "0"+n : ""+n; }
    function dateKey(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
    function labelDate(d){ return d.getDate()+" "+MONTHS[d.getMonth()]+" "+d.getFullYear(); }

    // ===== Elements =====
    const monthLabelEl = document.getElementById("monthLabel");
    const calendarDaysEl = document.getElementById("calendarDays");
    const agendaDateLabelEl = document.getElementById("agendaDateLabel");
    const agendaListEl = document.getElementById("agendaList");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");

    const kpiTodayEl = document.getElementById("kpiToday");
    const kpiWeekEl  = document.getElementById("kpiWeek");
    const kpiHomesEl = document.getElementById("kpiHomes");
    const kpiMonthEl = document.getElementById("kpiMonth");

    const homeFilter = document.getElementById("homeFilter");
    const addJobBtn = document.getElementById("addJobBtn");
    const quickJobBtn = document.getElementById("quickJobBtn");

    // ===== State =====
    const today = new Date();
    let currentMonth = today.getMonth();
    let currentYear  = today.getFullYear();
    let selectedDate = new Date(currentYear, currentMonth, today.getDate());

    let homes = [];
    let homesById = new Map();

    let jobs = [];         // events (prestations)
    let reservations = []; // iCal imports

    let unsubHomes = null;
    let unsubJobs = null;
    let unsubResa = null;

    let currentUid = null;
    let currentEmail = null;

    function setHomes(list){
      homes = list || [];
      homesById = new Map(homes.map(h => [h.id, h]));
      kpiHomesEl.textContent = String(homes.length);
      renderHomeFilter();
    }
    function homeById(id){ return homesById.get(id) || null; }

    function getSelectedHomeId(){
      const v = (homeFilter.value || "").trim();
      return v || null;
    }

    function renderHomeFilter(){
      const selected = getSelectedHomeId();
      homeFilter.innerHTML = `<option value="">Tous les logements</option>` + homes
        .slice()
        .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
        .map(h => `<option value="${h.id}">${escapeHtml(h.name || "Logement")} ‚Äî ${escapeHtml(h.city || "")}</option>`)
        .join("");
      if(selected) homeFilter.value = selected;
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function inMonth(key){
      const [y,m] = key.split("-").map(Number);
      return y === currentYear && m === (currentMonth+1);
    }

    function filteredItems(){
      const homeId = getSelectedHomeId();

      const monthJobs = jobs.filter(j => j.date && inMonth(j.date));
      const monthResa = reservations.filter(r => r.dateKey && inMonth(r.dateKey));

      const a = monthJobs
        .filter(j => !homeId || j.homeId === homeId)
        .map(j => ({
          kind:"job",
          id:j.id,
          dateKey:j.date,
          time:(j.time||""),
          homeId:j.homeId,
          type:j.type || "Prestation",
          meta:j.meta || "",
          isBlocked:!!j.isBlocked,
          blockReason:j.blockReason || ""
        }));

      const b = monthResa
        .filter(r => !homeId || r.homeId === homeId)
        .map(r => ({
          kind:"resa",
          id:r.id,
          dateKey:r.dateKey,
          time:(r.startTime || "‚Äî"),
          homeId:r.homeId,
          type:"R√©servation",
          meta:(r.summary || ""),
          source:"iCal"
        }));

      const all = a.concat(b);
      all.sort((x,y)=>{
        const ak = (a.dateKey || a.date || "") + " " + (a.time||"");
      const bk = (b.dateKey || b.date || "") + " " + (b.time||"");

        return ak.localeCompare(bk);
      });
      return all;
    }

    function itemsForDate(key){
      return filteredItems().filter(it => it.dateKey === key);
    }

    function dayHasAny(key){
      return itemsForDate(key).length > 0;
    }

    function renderKpis(){
      const all = filteredItems();

      kpiMonthEl.textContent = String(all.length);

      const todayKey = dateKey(today);
      kpiTodayEl.textContent = String(all.filter(x => x.dateKey === todayKey).length);

      const end7 = new Date(today.getFullYear(), today.getMonth(), today.getDate()+6);
      const startKey = dateKey(today);
      const endKey = dateKey(end7);
      const weekCount = all.filter(x => x.dateKey >= startKey && x.dateKey <= endKey).length;
      kpiWeekEl.textContent = String(weekCount);
    }

    function renderCalendar(){
      monthLabelEl.textContent = MONTHS[currentMonth] + " " + currentYear;

      const firstDay = new Date(currentYear, currentMonth, 1);
      const firstDayWeek = firstDay.getDay(); // 0 dim
      const startIndex = (firstDayWeek + 6) % 7; // 0 lun

      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrev = new Date(currentYear, currentMonth, 0).getDate();

      calendarDaysEl.innerHTML = "";
      const totalCells = 42;

      for(let i=0;i<totalCells;i++){
        const cell = document.createElement("div");
        cell.className = "day";

        let dayNumber;
        let cellDate;

        if(i < startIndex){
          dayNumber = daysInPrev - (startIndex - 1) + i;
          cell.classList.add("outside");
          cellDate = new Date(currentYear, currentMonth - 1, dayNumber);
        }else if(i >= startIndex + daysInMonth){
          dayNumber = i - (startIndex + daysInMonth) + 1;
          cell.classList.add("outside");
          cellDate = new Date(currentYear, currentMonth + 1, dayNumber);
        }else{
          dayNumber = i - startIndex + 1;
          cellDate = new Date(currentYear, currentMonth, dayNumber);
        }

        cell.textContent = dayNumber;

        const cellKey = dateKey(cellDate);
        const selKey = dateKey(selectedDate);
        const todayKey = dateKey(today);

        if(cellKey === todayKey && cellDate.getMonth() === today.getMonth()) cell.classList.add("today");
        if(cellKey === selKey) cell.classList.add("selected");
        if(dayHasAny(cellKey)) cell.classList.add("has-any");

        if(!cell.classList.contains("outside")){
          cell.addEventListener("click", ()=>{
            selectedDate = cellDate;
            renderCalendar();
            renderAgenda();
            renderKpis();
          });
        }

        calendarDaysEl.appendChild(cell);
      }
    }

    function renderAgenda(){
      const key = dateKey(selectedDate);
      agendaDateLabelEl.textContent = labelDate(selectedDate);
      agendaListEl.innerHTML = "";

      const items = itemsForDate(key);

      if(!items.length){
        const empty = document.createElement("div");
        empty.className = "empty";
        empty.textContent = "Rien de pr√©vu sur cette date.";
        agendaListEl.appendChild(empty);
        return;
      }

      items.forEach(it=>{
        const h = homeById(it.homeId);

        const div = document.createElement("div");
        div.className = "item";

        const line1 = document.createElement("div");
        line1.className = "line1";

        const time = document.createElement("div");
        time.className = "time";
        time.textContent = it.time || "‚Äî";

        const pill = document.createElement("div");
        pill.className = "pilltype " + (it.kind === "resa" ? "resa" : "job");
        pill.textContent = (it.kind === "resa") ? "R√©servation iCal" : "Prestation";

        line1.appendChild(time);
        line1.appendChild(pill);

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = h ? `${h.name} ‚Äî ${h.city || ""}` : (it.homeId ? "Logement" : "‚Äî");

        const meta = document.createElement("div");
        meta.className = "meta";
        if(it.kind === "resa"){
          meta.textContent = (it.meta || "R√©servation import√©e") + " ‚Ä¢ Clique pour cr√©er une prestation";
        }else{
          const extra = [];
          extra.push(it.type || "Prestation");
          if(it.meta) extra.push(it.meta);
          if(it.isBlocked) extra.push("üîí " + (it.blockReason || "bloqu√©e"));
          meta.textContent = extra.join(" ‚Ä¢ ");
        }

        div.appendChild(line1);
        div.appendChild(title);
        div.appendChild(meta);

        div.addEventListener("click", ()=>{
          if(it.kind === "resa"){
            // raccourci : cr√©er une prestation depuis la r√©servation
            createJobFromReservation(it);
          }else{
            alert(
              [
                `${it.time || "‚Äî"} ‚Ä¢ ${it.type || "Prestation"}`,
                h ? `${h.name} ‚Äî ${h.city || ""}` : "Logement",
                it.meta ? `D√©tail: ${it.meta}` : null,
                it.isBlocked ? `üîí BLOQU√â : ${it.blockReason || "paiement requis"}` : null
              ].filter(Boolean).join("\n")
            );
          }
        });

        agendaListEl.appendChild(div);
      });
    }

    async function ensureAccess(user){
      const email = (user.email || "").toLowerCase();
      const isFree = FREE_EMAILS.has(email);
      if(isFree) return true;

      try{
        const snap = await getDoc(doc(db, "users", user.uid));
        if(!snap.exists()) return false;
        const data = snap.data() || {};
        return data.subscriptionStatus === "active";
      }catch(_){
        return false;
      }
    }

    function stop(){
      if(unsubHomes) unsubHomes();
      if(unsubJobs) unsubJobs();
      if(unsubResa) unsubResa();
      unsubHomes = unsubJobs = unsubResa = null;
    }

    function startListeners(user){
      // homes
      unsubHomes = onSnapshot(
        query(collection(db, "homes"), where("conciergerieUid","==", user.uid)),
        (snap)=>{
          const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          setHomes(list);
          hideAlert();
          renderCalendar(); renderAgenda(); renderKpis();
        },
        (err)=> showAlert("Erreur logements : " + (err?.message || "inconnue"))
      );

      // jobs (events)
      unsubJobs = onSnapshot(
        query(collection(db, "events"), where("conciergerieUid","==", user.uid)),
        (snap)=>{
          jobs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          hideAlert();
          renderCalendar(); renderAgenda(); renderKpis();
        },
        (err)=> showAlert("Erreur prestations : " + (err?.message || "inconnue"))
      );

      // reservations iCal
      unsubResa = onSnapshot(
        query(collection(db, "reservations"), where("conciergerieUid","==", user.uid)),
        (snap)=>{
          reservations = snap.docs.map(d => ({ id:d.id, ...d.data() }));
          hideAlert();
          renderCalendar(); renderAgenda(); renderKpis();
        },
        (err)=> showAlert("Erreur r√©servations iCal : " + (err?.message || "inconnue"))
      );
    }

    function pickHomePrompt(){
      if(!homes.length) return null;
      const list = homes
        .map((h,i)=> `${i+1}. ${h.name} (${h.city||""})`)
        .join("\n");
      const pick = prompt("Choisis un logement (num√©ro) :\n\n" + list);
      if(!pick) return null;
      const idx = Number(pick) - 1;
      return homes[idx] || null;
    }

    async function addJob({ home, type, time, meta }){
      const user = auth.currentUser;
      if(!user) return showAlert("Non connect√© Firebase.");

      const payload = {
        conciergerieUid: user.uid,
        date: dateKey(selectedDate),
        time: String(time||"").trim(),
        type: String(type||"").trim(),
        homeId: home.id,
        homeName: home.name || "",
        meta: String(meta||"").trim(),
        source: "manuel",
        createdAt: serverTimestamp(),
        isBlocked: false,
        blockReason: "",
        paymentId: null
      };

      try{
        await addDoc(collection(db, "events"), payload);
        showAlert("‚úÖ Prestation ajout√©e.", true);
        setTimeout(hideAlert, 900);
      }catch(err){
        showAlert("Erreur ajout prestation : " + (err?.message || "inconnue"));
      }
    }

    async function createJobFromReservation(resaItem){
      // resaItem.dateKey = selected date already, time = startTime maybe
      const h = homeById(resaItem.homeId) || null;
      if(!h){
        showAlert("Logement introuvable pour cette r√©servation.");
        return;
      }

      // type conseill√©
      const type = prompt("Cr√©er quelle prestation ?", "M√©nage");
      if(!type) return;

      // heure par d√©faut : si r√©servation a un startTime (HH:MM) sinon 10:00
      const defaultTime = (resaItem.time && resaItem.time !== "‚Äî") ? resaItem.time : "10:00";
      const time = prompt("Heure (HH:MM) ?", defaultTime);
      if(!time) return;

      const meta = prompt("D√©tail (optionnel) ?", "Depuis r√©servation iCal") || "";
      await addJob({ home:h, type, time, meta });
    }

    addJobBtn.addEventListener("click", async ()=>{
      if(!homes.length){
        alert("Ajoute d‚Äôabord un logement (ou accepte une demande).");
        location.href = "logements.html";
        return;
      }
      const selectedHomeId = getSelectedHomeId();
      const home = selectedHomeId ? homeById(selectedHomeId) : pickHomePrompt();
      if(!home) return;

      const type = prompt("Type (M√©nage / Check-in / Check-out / R√©assort / Maintenance / Photos / Urgence) ?", "M√©nage");
      if(!type) return;

      const time = prompt("Heure (HH:MM) ?", "10:00");
      if(!time) return;

      const meta = prompt("D√©tail (optionnel) ?", "") || "";
      await addJob({ home, type, time, meta });
    });

    quickJobBtn.addEventListener("click", ()=> addJobBtn.click());

    homeFilter.addEventListener("change", ()=>{
      renderCalendar(); renderAgenda(); renderKpis();
    });

    prevMonthBtn.addEventListener("click", ()=>{
      currentMonth--;
      if(currentMonth < 0){ currentMonth = 11; currentYear--; }
      selectedDate = new Date(currentYear, currentMonth, 1);
      renderCalendar(); renderAgenda(); renderKpis();
    });

    nextMonthBtn.addEventListener("click", ()=>{
      currentMonth++;
      if(currentMonth > 11){ currentMonth = 0; currentYear++; }
      selectedDate = new Date(currentYear, currentMonth, 1);
      renderCalendar(); renderAgenda(); renderKpis();
    });

    // ===== Boot =====
    onAuthStateChanged(auth, async (user)=>{
      stop();
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }

      currentUid = user.uid;
      currentEmail = user.email || "";

      const ok = await ensureAccess(user);
      if(!ok){
        location.href = "abonnement.html?plan=starter";
        return;
      }

      hideAlert();
      startListeners(user);
      renderCalendar(); renderAgenda(); renderKpis();
    });
  </script>
</body>
</html>
