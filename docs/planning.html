<!-- docs/planning.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Planning</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;

      --text:#111;
      --muted:#666;
      --border: rgba(122,92,255,0.18);

      --dot-ical:#b9b9b9;
      --dot-job: var(--violet-main);

      --bad:#b3261e;
      --ok:#1b8f4d;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      min-height:100vh;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    /* page padding bottom = place pour le bandeau */
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 110px; /* IMPORTANT: place bandeau bas */
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      margin-top:10px;
      margin-bottom:6px;
    }
    .logo-icon{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"‚ú¶";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:26px; font-weight:900; letter-spacing:-0.2px; }
    .subtitle{
      margin-top:2px;
      font-size:14px;
      color:#444;
      text-align:center;
    }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    /* KPIs */
    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:14px;
    }
    @media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr); } }
    .kpi{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      padding: 10px 10px 12px;
    }
    .kpi .t{ font-size:12px; color:#666; font-weight:900; margin-bottom:4px; }
    .kpi .v{ font-size:18px; font-weight:900; color:#222; }
    .kpi .n{ font-size:11px; color:#666; margin-top:2px; }

    /* Layout calendar + agenda */
    .layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width:900px){
      .layout{ grid-template-columns: 1.2fr 0.8fr; }
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      padding: 14px 14px 16px;
    }

    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:10px;
    }
    .card-title{ font-size:16px; font-weight:900; margin:0; }
    .legend{
      font-size:11px;
      color:#666;
      font-weight:800;
      text-align:right;
      line-height:1.2;
    }
    .legend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-left:10px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      display:inline-block;
    }
    .dot.ical{ background: var(--dot-ical); }
    .dot.job{ background: var(--dot-job); }

    /* calendar header */
    .cal-nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .cal-nav .month{
      font-weight:900;
      font-size:15px;
      text-transform: lowercase;
    }
    .cal-nav button{
      width:36px;height:36px;border-radius:12px;
      border:2px solid var(--violet-main);
      background:#fff;
      color:var(--violet-main);
      font-weight:900;
      cursor:pointer;
    }

    /* calendar grid */
    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-bottom:6px;
      font-size:11px;
      font-weight:900;
      color:#666;
      text-align:center;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
    }
    .day{
      background:#fff;
      border:1px solid rgba(122,92,255,0.10);
      border-radius:14px;
      min-height:56px;
      padding:8px 8px 6px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      transition: transform .08s ease, border-color .12s ease;
      position:relative;
    }
    .day:hover{ transform: translateY(-1px); border-color: rgba(122,92,255,0.35); }
    .day.muted{
      opacity:.35;
      cursor:default;
    }
    .day .num{
      font-weight:900;
      font-size:12px;
      color:#222;
    }
    .day.selected{
      border:2px solid var(--violet-main);
      box-shadow: 0 10px 22px rgba(0,0,0,0.06);
    }

    .dots{
      display:flex;
      gap:4px;
      align-items:center;
      justify-content:flex-start;
      padding-top:6px;
      flex-wrap:wrap;
    }
    .dots .mini{
      width:6px;height:6px;border-radius:999px;
      display:inline-block;
    }
    .dots .mini.ical{ background: var(--dot-ical); }
    .dots .mini.job{ background: var(--dot-job); }

    /* Agenda list */
    .agenda-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .agenda-date{
      font-weight:900;
      color: var(--violet-dark);
      font-size:13px;
    }

    .agenda-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
      padding-right:2px;
    }
    .agenda-item{
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      border-left:5px solid rgba(122,92,255,0.25);
    }
    .agenda-item.job{ border-left-color: var(--violet-main); }
    .agenda-item.ical{ border-left-color: #b9b9b9; }

    .ai-main{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .ai-time{ font-weight:900; font-size:12px; color:#222; }
    .ai-home{ font-weight:900; font-size:13px; color:#111; }
    .ai-sub{ font-size:12px; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100%; }

    .ai-actions{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      flex-shrink:0;
    }
    .tag{
      font-size:11px;
      font-weight:900;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(122,92,255,0.12);
      color: var(--violet-dark);
      white-space:nowrap;
    }
    .tag.ical{ background: rgba(0,0,0,0.06); color:#555; }
    .mini-cta{
      border:none;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 10px 22px rgba(0,0,0,0.10);
      white-space:nowrap;
    }

    .big-cta{
      margin-top:10px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .hint{
      margin-top:8px;
      font-size:11px;
      color:#777;
      text-align:center;
      line-height:1.3;
    }

    /* Bottom nav = vrai bandeau */
    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 80;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight: 900;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="conciergerie.html">‚Üê Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill" href="import-ical.html">Import iCal</a>
        <button class="pill" id="logoutBtn" type="button">D√©connexion</button>
      </div>
    </div>

    <div class="logo">
      <div class="logo-icon">‚úì</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Planning</div>

    <div class="alert" id="alertBox"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="t">Aujourd‚Äôhui</div>
        <div class="v" id="kpiToday">‚Äî</div>
        <div class="n">√©l√©ments</div>
      </div>
      <div class="kpi">
        <div class="t">7 jours</div>
        <div class="v" id="kpiWeek">‚Äî</div>
        <div class="n">√©l√©ments</div>
      </div>
      <div class="kpi">
        <div class="t">Logements</div>
        <div class="v" id="kpiHomes">‚Äî</div>
        <div class="n">g√©r√©s</div>
      </div>
      <div class="kpi">
        <div class="t">Ce mois</div>
        <div class="v" id="kpiMonth">‚Äî</div>
        <div class="n">√©l√©ments</div>
      </div>
    </div>

    <div class="layout">
      <!-- CALENDAR -->
      <section class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Calendrier</div>
          </div>
          <div class="legend">
            <span><i class="dot job"></i>prestations</span>
            <span><i class="dot ical"></i>r√©servations iCal</span>
          </div>
        </div>

        <div class="cal-nav">
          <button id="prevBtn" aria-label="Mois pr√©c√©dent">‚Äπ</button>
          <div class="month" id="monthLabel">‚Äî</div>
          <button id="nextBtn" aria-label="Mois suivant">‚Ä∫</button>
        </div>

        <div class="dow">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>
        <div class="grid" id="monthGrid"></div>
      </section>

      <!-- AGENDA -->
      <section class="card">
        <div class="agenda-head">
          <div class="card-title">Agenda</div>
          <div class="agenda-date" id="agendaDate">‚Äî</div>
        </div>

        <div class="agenda-list" id="agendaList"></div>

        <button class="big-cta" id="createBtn" type="button">+ Cr√©er une prestation</button>
        <div class="hint">Astuce : clique une r√©servation iCal pour cr√©er une prestation li√©e √† ce logement.</div>
      </section>
    </div>
  </div>

  <!-- BANDEAU BAS -->
  <nav class="bottom-nav" aria-label="Navigation">
    <a href="planning.html" class="active">Planning</a>
    <a href="import-ical.html">iCal</a>
    <a href="messagerie.html">Messages</a>
    <!-- mets ici prestation-detail.html si tu l'utilises -->
    <a href="prestations.html">Catalogue</a>
    <a href="logements.html">Logements</a>
  </nav>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI =====
    const alertBox = document.getElementById("alertBox");
    const logoutBtn = document.getElementById("logoutBtn");

    const kpiToday = document.getElementById("kpiToday");
    const kpiWeek = document.getElementById("kpiWeek");
    const kpiHomes = document.getElementById("kpiHomes");
    const kpiMonth = document.getElementById("kpiMonth");

    const monthLabel = document.getElementById("monthLabel");
    const monthGrid = document.getElementById("monthGrid");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const agendaDate = document.getElementById("agendaDate");
    const agendaList = document.getElementById("agendaList");
    const createBtn = document.getElementById("createBtn");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    // ===== Helpers dates =====
    const MONTHS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];

    function pad2(n){ return String(n).padStart(2,"0"); }
    function dateKeyFromDate(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function parseDateKey(s){
      // "YYYY-MM-DD" -> Date (local)
      const [y,m,d] = (s||"").split("-").map(Number);
      if(!y||!m||!d) return null;
      return new Date(y, m-1, d, 12, 0, 0); // midi pour √©viter d√©calages
    }
    function startOfWeekMonday(d){
      const x = new Date(d);
      const day = (x.getDay()+6)%7; // lundi=0
      x.setDate(x.getDate()-day);
      x.setHours(0,0,0,0);
      return x;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }

    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Data =====
    let currentUser = null;
    let homesById = new Map(); // homeId -> {name, city}
    let icalEvents = []; // {id, dateKey, time, homeId, homeName, summary, ...}
    let jobs = [];       // events collection {id, dateKey/date, time, homeId, type/meta,...}
    let allMerged = [];  // for render

    // calendrier state
    let viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth(); // 0..11
    let selectedDateKey = dateKeyFromDate(new Date());

    function normDateKeyFromEvent(ev){
      // events collection uses "date" in your screenshot
      return ev.dateKey || ev.date || "";
    }

    // ===== Load =====
    async function loadHomes(){
      const q = query(collection(db,"homes"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);
      homesById = new Map();
      snap.docs.forEach(d=>{
        const data = d.data() || {};
        homesById.set(d.id, { name: data.name || "Logement", city: data.city || "" });
      });
      kpiHomes.textContent = String(homesById.size);
    }

    async function loadIcal(){
      const q = query(collection(db,"icalEvents"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);
      icalEvents = snap.docs.map(d=>{
        const x = d.data() || {};
        return {
          id: d.id,
          kind: "ical",
          dateKey: x.dateKey || x.date || "",     // selon tes versions
          time: x.time || "",
          homeId: x.homeId || "",
          homeName: x.homeName || "",
          summary: x.summary || x.icalSummary || "",
          location: x.location || ""
        };
      }).filter(x=>!!x.dateKey);
    }

    async function loadJobs(){
      // ‚úÖ IMPORTANT : tes prestations = collection "events"
      const q = query(collection(db,"events"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);
      jobs = snap.docs.map(d=>{
        const x = d.data() || {};
        return {
          id: d.id,
          kind: "job",
          dateKey: normDateKeyFromEvent(x),
          time: x.time || "",
          homeId: x.homeId || "",
          homeName: x.homeName || "",
          type: x.type || "Prestation",
          meta: x.meta || "",
          team: x.team || "",
          isBlocked: !!x.isBlocked,
          blockReason: x.blockReason || "",
          source: x.source || "manuel",
          icalEventId: x.icalEventId || x.icalEventId || ""
        };
      }).filter(x=>!!x.dateKey);
    }

    function mergeAll(){
      allMerged = [
        ...icalEvents,
        ...jobs
      ];

      // tri par date + time
      allMerged.sort((a,b)=>{
        if(a.dateKey !== b.dateKey) return a.dateKey.localeCompare(b.dateKey);
        return String(a.time||"").localeCompare(String(b.time||""));
      });
    }

    // ===== KPIs =====
    function computeKpis(){
      const today = new Date();
      const todayKey = dateKeyFromDate(today);
      const startWeek = startOfWeekMonday(today);
      const weekKeys = new Set(Array.from({length:7}, (_,i)=>dateKeyFromDate(addDays(startWeek,i))));

      const monthKeyPrefix = viewYear + "-" + pad2(viewMonth+1) + "-";

      const cntToday = allMerged.filter(x=>x.dateKey === todayKey).length;
      const cntWeek = allMerged.filter(x=>weekKeys.has(x.dateKey)).length;
      const cntMonth = allMerged.filter(x=>String(x.dateKey).startsWith(monthKeyPrefix)).length;

      kpiToday.textContent = String(cntToday);
      kpiWeek.textContent = String(cntWeek);
      kpiMonth.textContent = String(cntMonth);
    }

    // ===== Calendar render =====
    function dotsCountByDay(dateKey){
      const dayEvents = allMerged.filter(x=>x.dateKey === dateKey);
      let hasIcal = false, hasJob = false;
      for(const e of dayEvents){
        if(e.kind === "ical") hasIcal = true;
        if(e.kind === "job") hasJob = true;
      }
      return { hasIcal, hasJob, total: dayEvents.length };
    }

    function setAgendaFor(dateKey){
      selectedDateKey = dateKey;
      const d = parseDateKey(dateKey);
      agendaDate.textContent = d ? (d.getDate()+" "+MONTHS[d.getMonth()]+" "+d.getFullYear()) : dateKey;

      const list = allMerged.filter(x=>x.dateKey === dateKey);

      agendaList.innerHTML = "";
      if(!list.length){
        const empty = document.createElement("div");
        empty.style.padding = "12px";
        empty.style.borderRadius = "14px";
        empty.style.background = "#fff";
        empty.style.boxShadow = "0 3px 10px rgba(0,0,0,.06)";
        empty.style.color = "#666";
        empty.style.fontWeight = "800";
        empty.style.fontSize = "12px";
        empty.textContent = "Aucun √©l√©ment ce jour-l√†.";
        agendaList.appendChild(empty);
        return;
      }

      list.forEach(ev=>{
        const home = homesById.get(ev.homeId);
        const homeLine = home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement");

        const item = document.createElement("div");
        item.className = "agenda-item " + (ev.kind === "ical" ? "ical" : "job");

        const sub = (ev.kind === "ical")
          ? (ev.summary ? ev.summary : "R√©servation iCal")
          : (ev.meta ? ev.meta : ev.type || "Prestation");

        item.innerHTML = `
          <div class="ai-main">
            <div class="ai-time">${esc(ev.time || "‚Äî")}</div>
            <div class="ai-home">${esc(homeLine)}</div>
            <div class="ai-sub">${esc(sub)}</div>
          </div>
          <div class="ai-actions">
            <span class="tag ${ev.kind === "ical" ? "ical" : ""}">${ev.kind === "ical" ? "R√©servation" : "Prestation"}</span>
            ${ev.kind === "ical"
              ? `<button class="mini-cta" type="button" data-add="${esc(ev.id)}">+ Ajouter prestation</button>`
              : ``}
          </div>
        `;

        agendaList.appendChild(item);

        // click row: infos rapides
        item.addEventListener("click", (e)=>{
          // √©vite double action quand on clique le bouton
          if(e.target && e.target.matches("button[data-add]")) return;

          if(ev.kind === "ical"){
            alert(
              [
                `${ev.time || "‚Äî"} ‚Ä¢ R√©servation`,
                homeLine,
                ev.summary ? `R√©sum√©: ${ev.summary}` : null
              ].filter(Boolean).join("\n")
            );
          }else{
            alert(
              [
                `${ev.time || "‚Äî"} ‚Ä¢ ${ev.type || "Prestation"}`,
                homeLine,
                ev.meta ? `D√©tail: ${ev.meta}` : null,
                ev.team ? `√âquipe: ${ev.team}` : null,
                ev.isBlocked ? `üîí BLOQU√â : ${ev.blockReason || "paiement requis"}` : null
              ].filter(Boolean).join("\n")
            );
          }
        });
      });

      // boutons "+ Ajouter prestation" (sur r√©servations)
      agendaList.querySelectorAll("button[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const icalId = btn.getAttribute("data-add");
          const ev = icalEvents.find(x=>x.id === icalId);
          if(!ev) return;

          // redirection vers page cr√©ation prestation (tu peux remplacer par nouvelle-prestation.html si tu la cr√©es)
          const params = new URLSearchParams();
          if(ev.homeId) params.set("homeId", ev.homeId);
          params.set("dateKey", ev.dateKey);
          if(ev.time) params.set("time", ev.time);
          if(ev.summary) params.set("summary", ev.summary);
          params.set("icalEventId", ev.id);

          // si homeId absent -> c'est un souci d'icalEvents
          if(!ev.homeId){
            alert("R√©servation iCal d√©tect√©e mais homeId manquant.\nV√©rifie que tes icalEvents ont bien homeId + homeName.");
            return;
          }

          location.href = "prestations.html?" + params.toString();
          // si tu utilises nouvelle-prestation.html :
          // location.href = "nouvelle-prestation.html?" + params.toString();
        });
      });
    }

    function renderCalendar(){
      monthGrid.innerHTML = "";

      const first = new Date(viewYear, viewMonth, 1, 12, 0, 0);
      const last = new Date(viewYear, viewMonth+1, 0, 12, 0, 0);

      monthLabel.textContent = `${MONTHS[viewMonth]} ${viewYear}`;

      // Grid start monday
      const startDow = (first.getDay()+6)%7; // lundi=0
      const daysInMonth = last.getDate();

      // cells count = 42 (6 weeks)
      const totalCells = 42;

      for(let i=0; i<totalCells; i++){
        const cell = document.createElement("div");

        const dayNum = i - startDow + 1;
        if(dayNum < 1 || dayNum > daysInMonth){
          cell.className = "day muted";
          cell.innerHTML = `<div class="num"> </div><div class="dots"></div>`;
          monthGrid.appendChild(cell);
          continue;
        }

        const d = new Date(viewYear, viewMonth, dayNum, 12,0,0);
        const key = dateKeyFromDate(d);

        cell.className = "day" + (key === selectedDateKey ? " selected" : "");
        const { hasIcal, hasJob } = dotsCountByDay(key);

        cell.innerHTML = `
          <div class="num">${dayNum}</div>
          <div class="dots">
            ${hasJob ? `<span class="mini job" title="prestations"></span>` : ``}
            ${hasIcal ? `<span class="mini ical" title="r√©servations"></span>` : ``}
          </div>
        `;

        cell.addEventListener("click", ()=>{
          selectedDateKey = key;
          renderCalendar();
          setAgendaFor(key);
        });

        monthGrid.appendChild(cell);
      }
    }

    // ===== Events =====
    prevBtn.addEventListener("click", ()=>{
      viewMonth--;
      if(viewMonth < 0){ viewMonth = 11; viewYear--; }
      computeKpis();
      renderCalendar();
      // garde agenda sur la date s√©lectionn√©e si elle existe
    });

    nextBtn.addEventListener("click", ()=>{
      viewMonth++;
      if(viewMonth > 11){ viewMonth = 0; viewYear++; }
      computeKpis();
      renderCalendar();
    });

    createBtn.addEventListener("click", ()=>{
      // cr√©ation manuelle (sans iCal)
      const params = new URLSearchParams();
      params.set("dateKey", selectedDateKey);
      location.href = "prestations.html?" + params.toString();
      // ou nouvelle-prestation.html
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // ===== Boot =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;

      try{
        hideAlert();
        await loadHomes();
        await loadIcal();
        await loadJobs();  // ‚úÖ events
        mergeAll();

        // initial view month = selected date month
        const sel = parseDateKey(selectedDateKey) || new Date();
        viewYear = sel.getFullYear();
        viewMonth = sel.getMonth();

        computeKpis();
        renderCalendar();
        setAgendaFor(selectedDateKey);

      }catch(err){
        console.error(err);
        showAlert("Erreur planning : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
