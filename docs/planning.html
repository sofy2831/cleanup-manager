<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Planning</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --violet-light: #F3ECFF;
      --violet-main: #7A5CFF;
      --violet-dark: #6238FF;
      --text-dark: #111;
      --bad:#b3261e;
      --ok:#1b8f4d;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #F8F4FF 0%, #EDE6FF 80%);
      color: var(--text-dark);
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 16px 32px;
    }

    .topbar {
      width: 100%;
      max-width: 960px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
      background: rgba(248, 244, 255, 0.85);
      backdrop-filter: blur(6px);
    }

    .pill-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--violet-main);
      color: var(--violet-main);
      text-decoration: none;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      white-space: nowrap;
      cursor: pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 6px;
      text-align: center;
    }
    .logo-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #FFF;
      border: 2px solid var(--violet-main);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--violet-main);
      font-size: 20px;
      font-weight: 900;
      position: relative;
      flex-shrink: 0;
    }
    .logo-icon::after {
      content: "‚ú¶";
      position: absolute;
      top: -6px;
      right: -4px;
      font-size: 12px;
      color: var(--violet-main);
    }
    h1 { font-size: 24px; margin: 0; font-weight: 900; color: #111; }
    .subtitle { font-size: 15px; color: #444; margin-top: 4px; text-align: center; }

    .alert{
      width:100%;
      max-width:960px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    /* KPI */
    .summary {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (min-width: 768px) {
      .summary { grid-template-columns: repeat(4, 1fr); }
    }
    .summary-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 10px 10px 12px;
      text-align: left;
    }
    .summary-title { font-size: 12px; color: #666; font-weight: 900; margin-bottom: 4px; }
    .summary-value { font-size: 18px; font-weight: 900; color: #222; }
    .summary-note { font-size: 11px; color: #666; margin-top: 2px; }

    /* Layout */
    .planning-layout {
      width: 100%;
      max-width: 960px;
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (min-width: 768px) {
      .planning-layout { flex-direction: row; align-items: flex-start; }
    }

    .calendar-card, .agenda-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      padding: 16px 14px 18px;
    }
    .calendar-card { flex: 1.2; }
    .agenda-card { flex: 1; }

    .card-title {
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .month-label { font-size: 15px; font-weight: 900; }

    .month-btn {
      border: none;
      background: #fff;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      color: var(--violet-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-weight: 900;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
      text-align: center;
    }
    .weekdays div { padding: 4px 0; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

    .day-cell {
      height: 32px;
      border-radius: 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      background: #fff;
      border: 1px solid transparent;
      position: relative;
      user-select: none;
    }
    .day-cell.outside { opacity: 0.25; cursor: default; }
    .day-cell.today { border-color: var(--violet-main); font-weight: 900; }
    .day-cell.has-events::after {
      content: "";
      position: absolute;
      bottom: 4px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--violet-main);
    }
    .day-cell.has-ical::before{
      content:"";
      position:absolute;
      bottom:4px;
      left:10px;
      width:5px;
      height:5px;
      border-radius:50%;
      background:#111;
      opacity:.25;
    }
    .day-cell.has-blocked::before{
      content:"üîí";
      position:absolute;
      top:3px;
      right:5px;
      font-size:10px;
      opacity:.8;
    }
    .day-cell.selected {
      background: var(--violet-main);
      color: #fff;
      border-color: var(--violet-main);
    }

    .agenda-header { font-size: 14px; color: #555; margin-bottom: 8px; }
    .agenda-date { font-weight: 900; color: var(--violet-dark); }

    .agenda-list { display: flex; flex-direction: column; gap: 8px; }

    .agenda-item {
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      text-align: left;
      border-left: 4px solid var(--violet-main);
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      position:relative;
    }
    .agenda-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0,0,0,0.10);
    }
    .agenda-item.blocked{ opacity:.88; border-left-color:#333; }
    .agenda-item.ical{ border-left-color: rgba(0,0,0,0.25); }

    .agenda-line1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      gap: 8px;
    }
    .agenda-time { font-weight: 900; color: #333; }

    .agenda-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--violet-light);
      color: #5b45c8;
      font-weight: 900;
      white-space: nowrap;
    }
    .agenda-type.t-menage      { background: #E9F7EF; color: #1E7A3A; }
    .agenda-type.t-checkin     { background: #E8F0FE; color: #1A5FD0; }
    .agenda-type.t-checkout    { background: #FCE8E6; color: #B3261E; }
    .agenda-type.t-reassort    { background: #FFF4E5; color: #a19600; }
    .agenda-type.t-maintenance { background: #EFEAFB; color: #5B45C8; }
    .agenda-type.t-photos      { background: #E7F7FA; color: #0B7285; }
    .agenda-type.t-urgence     { background: #FFE3EC; color: #A61E4D; }
    .agenda-type.t-reservation { background: #F1F3F5; color: #495057; }

    .agenda-logement { font-weight: 900; color: #333; }
    .agenda-meta { font-size: 11px; color: #666; margin-top: 2px; }

    .pill-blocked{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#eee;
      color:#777;
      font-weight:900;
      white-space:nowrap;
    }

    .agenda-empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      padding: 18px 4px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    .agenda-cta{
      margin-top:10px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .agenda-cta a, .agenda-cta button{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      min-width:210px;
      text-align:center;
      text-decoration:none;
      display:inline-block;
    }
    .fineprint{
      font-size:11px;
      color:#666;
      text-align:center;
      margin-top:4px;
      max-width:320px;
      line-height:1.25;
    }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
        <a class="pill-link" href="import-ical.html">Import iCal</a>
        <button class="pill-link" id="logoutBtn" type="button">D√©connexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">‚úì</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle" id="subtitle">Planning</div>
    <div class="alert" id="alertBox"></div>

    <div class="summary">
      <div class="summary-card">
        <div class="summary-title">Aujourd‚Äôhui</div>
        <div class="summary-value" id="kpiToday">‚Äî</div>
        <div class="summary-note">√©l√©ments</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">7 jours</div>
        <div class="summary-value" id="kpiWeek">‚Äî</div>
        <div class="summary-note">√©l√©ments</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Logements</div>
        <div class="summary-value" id="kpiHomes">‚Äî</div>
        <div class="summary-note">g√©r√©s</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">Ce mois</div>
        <div class="summary-value" id="kpiMonth">‚Äî</div>
        <div class="summary-note">√©l√©ments</div>
      </div>
    </div>

    <div class="planning-layout">
      <div class="calendar-card">
        <div class="card-title">
          <span>Calendrier</span>
          <span style="font-size:12px; color:#666;">‚Ä¢ point violet = prestations ‚Ä¢ point gris = r√©servations iCal</span>
        </div>

        <div class="month-header">
          <button class="month-btn" id="prevMonth">&lt;</button>
          <div class="month-label" id="monthLabel">Mois Ann√©e</div>
          <button class="month-btn" id="nextMonth">&gt;</button>
        </div>

        <div class="weekdays">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>

        <div class="calendar-grid" id="calendarDays"></div>
      </div>

      <div class="agenda-card">
        <div class="card-title"><span>Agenda</span></div>

        <div class="agenda-header">
          √âl√©ments du <span class="agenda-date" id="agendaDateLabel"></span>
        </div>

        <div class="agenda-list" id="agendaList"></div>

        <div class="agenda-cta">
          <a href="prestations.html">+ Cr√©er une prestation</a>
          <div class="fineprint">Astuce : les r√©servations iCal viennent de ‚ÄúImport iCal‚Äù.</div>
        </div>
      </div>
    </div>

  </div>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== UI =====
  const alertBox = document.getElementById("alertBox");
  function showAlert(msg, ok=false){
    alertBox.style.display = "block";
    alertBox.classList.toggle("ok", !!ok);
    alertBox.textContent = msg;
  }
  function hideAlert(){
    alertBox.style.display = "none";
    alertBox.classList.remove("ok");
    alertBox.textContent = "";
  }

  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await signOut(auth);
    location.href = "index.html";
  });

  const monthLabelEl = document.getElementById("monthLabel");
  const calendarDaysEl = document.getElementById("calendarDays");
  const agendaDateLabelEl = document.getElementById("agendaDateLabel");
  const agendaListEl = document.getElementById("agendaList");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");

  const kpiTodayEl  = document.getElementById("kpiToday");
  const kpiWeekEl   = document.getElementById("kpiWeek");
  const kpiHomesEl  = document.getElementById("kpiHomes");
  const kpiMonthEl  = document.getElementById("kpiMonth");

  // ===== Utils =====
  const MONTHS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function formatDateKey(date){ return date.getFullYear()+"-"+pad2(date.getMonth()+1)+"-"+pad2(date.getDate()); }
  function formatDateLabel(date){ return date.getDate()+" "+MONTHS[date.getMonth()]+" "+date.getFullYear(); }

  function getEventDate(e){
    // compat: certains docs ont encore "date" au lieu de "dateKey"
    return (e && (e.dateKey || e.date)) ? String(e.dateKey || e.date) : "";
  }

  function typeClass(label, isIcal=false){
    if(isIcal) return "t-reservation";
    const s = (label || "").toLowerCase();
    if (s.includes("m√©nage")) return "t-menage";
    if (s.includes("check-in") || s.includes("check in")) return "t-checkin";
    if (s.includes("check-out") || s.includes("check out")) return "t-checkout";
    if (s.includes("r√©assort") || s.includes("reassort")) return "t-reassort";
    if (s.includes("maintenance")) return "t-maintenance";
    if (s.includes("photo")) return "t-photos";
    if (s.includes("urgence")) return "t-urgence";
    return "t-maintenance";
  }

  function inCurrentMonth(dateKey){
    const [y,m] = String(dateKey || "").split("-").map(Number);
    return y === currentYear && m === (currentMonth+1);
  }

  // ===== State =====
  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear  = today.getFullYear();
  let selectedDate = new Date(currentYear, currentMonth, today.getDate());

  let homes = [];
  let homesById = new Map();
  let jobs = [];      // collection "events"
  let icals = [];     // collection "icalEvents"

  let unsubHomes = null;
  let unsubJobs = null;
  let unsubIcal = null;

  function setHomes(list){
    homes = list || [];
    homesById = new Map(homes.map(h => [h.id, h]));
  }
  function getHomeById(id){ return homesById.get(id) || null; }

  function mergedMonthItems(){
    const monthJobs = jobs.filter(e => inCurrentMonth(getEventDate(e)));
    const monthIcal = icals.filter(e => inCurrentMonth(getEventDate(e)));
    return { monthJobs, monthIcal, monthAll: monthJobs.concat(monthIcal) };
  }

  function itemsForDateKey(dateKey){
    const d = String(dateKey || "");
    const dayJobs = jobs.filter(e => getEventDate(e) === d);
    const dayIcal = icals.filter(e => getEventDate(e) === d);
    // tri: heure, puis type
    const sortKey = (x)=> (String(x.time||"") + " " + (x.type||x.summary||"")).toLowerCase();
    dayJobs.sort((a,b)=> sortKey(a).localeCompare(sortKey(b)));
    dayIcal.sort((a,b)=> sortKey(a).localeCompare(sortKey(b)));
    return { dayJobs, dayIcal };
  }

  function dayHasBlocked(dateKey){
    const { dayJobs } = itemsForDateKey(dateKey);
    return dayJobs.some(e => e && e.isBlocked === true);
  }
  function dayHasJobs(dateKey){
    return itemsForDateKey(dateKey).dayJobs.length > 0;
  }
  function dayHasIcal(dateKey){
    return itemsForDateKey(dateKey).dayIcal.length > 0;
  }

  function renderKpis(){
    kpiHomesEl.textContent = String(homes.length);

    const { monthAll } = mergedMonthItems();
    kpiMonthEl.textContent = String(monthAll.length);

    const todayKey = formatDateKey(today);
    const todayCount = monthAll.filter(e => getEventDate(e) === todayKey).length;
    kpiTodayEl.textContent = String(todayCount);

    const end7 = new Date(today.getFullYear(), today.getMonth(), today.getDate()+6);
    const startKey = formatDateKey(today);
    const endKey = formatDateKey(end7);

    const weekCount =
      jobs.concat(icals).filter(e=>{
        const d = getEventDate(e);
        return d && d >= startKey && d <= endKey;
      }).length;

    kpiWeekEl.textContent = String(weekCount);
  }

  function renderCalendar(){
    monthLabelEl.textContent = MONTHS[currentMonth] + " " + currentYear;

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstDayWeek = firstDay.getDay(); // 0=dimanche
    const startIndex = (firstDayWeek + 6) % 7; // 0=lundi

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

    calendarDaysEl.innerHTML = "";
    const totalCells = 42;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement("div");
      cell.classList.add("day-cell");

      let dayNumber;
      let cellDate;

      if(i < startIndex){
        dayNumber = daysInPrevMonth - (startIndex - 1) + i;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth - 1, dayNumber);
      }else if(i >= startIndex + daysInMonth){
        dayNumber = i - (startIndex + daysInMonth) + 1;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth + 1, dayNumber);
      }else{
        dayNumber = i - startIndex + 1;
        cellDate = new Date(currentYear, currentMonth, dayNumber);
      }

      cell.textContent = dayNumber;

      const todayKey = formatDateKey(today);
      const cellKey = formatDateKey(cellDate);
      const selectedKey = formatDateKey(selectedDate);

      if(cellKey === todayKey && cellDate.getMonth() === today.getMonth()){
        cell.classList.add("today");
      }
      if(dayHasJobs(cellKey)){
        cell.classList.add("has-events");
      }
      if(dayHasIcal(cellKey)){
        cell.classList.add("has-ical");
      }
      if(dayHasBlocked(cellKey)){
        cell.classList.add("has-blocked");
      }
      if(cellKey === selectedKey){
        cell.classList.add("selected");
      }

      if(!cell.classList.contains("outside")){
        cell.addEventListener("click", ()=>{
          selectedDate = cellDate;
          renderCalendar();
          renderAgenda();
          renderKpis();
        });
      }

      calendarDaysEl.appendChild(cell);
    }
  }

  function renderAgenda(){
    const key = formatDateKey(selectedDate);
    agendaDateLabelEl.textContent = formatDateLabel(selectedDate);
    agendaListEl.innerHTML = "";

    const { dayJobs, dayIcal } = itemsForDateKey(key);
    const all = dayJobs.map(x=>({ kind:"job", ...x })).concat(dayIcal.map(x=>({ kind:"ical", ...x })));

    if(!all.length){
      const empty = document.createElement("div");
      empty.classList.add("agenda-empty");
      empty.textContent = "Aucun √©l√©ment planifi√© pour cette journ√©e.";
      agendaListEl.appendChild(empty);
      return;
    }

    // tri global (heure puis type)
    all.sort((a,b)=>{
      const ak = String(a.time||"") + " " + String(a.type||a.summary||"");
      const bk = String(b.time||"") + " " + String(b.type||b.summary||"");
      return ak.localeCompare(bk);
    });

    all.forEach(ev=>{
      const home = getHomeById(ev.homeId);

      const item = document.createElement("div");
      item.classList.add("agenda-item");
      if(ev.kind === "ical") item.classList.add("ical");
      if(ev.isBlocked) item.classList.add("blocked");

     item.addEventListener("click", ()=>{
  if(ev.kind === "ical"){

    // 1) On r√©cup√®re une dateKey propre
    const dateKey = ev.dateKey || ev.date || (ev.startDateKey || "");
    if(!dateKey){
      alert("R√©servation iCal: date manquante (dateKey).");
      return;
    }

    // 2) On pr√©pare les params pour prestations.html
    const params = new URLSearchParams();
    if(ev.homeId) params.set("homeId", ev.homeId);
    params.set("dateKey", dateKey);

    // heure (optionnelle)
    if(ev.time) params.set("time", ev.time);

    // r√©sum√© (optionnel)
    if(ev.summary) params.set("summary", ev.summary);

    // id doc iCal (optionnel mais pratique)
    if(ev.id) params.set("icalEventId", ev.id);

    // 3) Redirection
    if(!ev.homeId){
      alert("R√©servation iCal d√©tect√©e mais homeId manquant.\nV√©rifie que tes icalEvents ont bien homeId (et/ou homeName).");
      return;
    }

    location.href = "prestations.html?" + params.toString();
    return;
  }

  // sinon = √©v√©nement 'job' (prestation normale) : on garde ton alert
  alert(
    [
      `${ev.time || "‚Äî"} ‚Ä¢ ${ev.type || "Prestation"}`,
      home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement"),
      ev.meta ? `D√©tail: ${ev.meta}` : null,
      ev.team ? `√âquipe: ${ev.team}` : null,
      ev.isBlocked ? `üîí BLOQU√â : ${ev.blockReason || "paiement requis"}` : null,
    ].filter(Boolean).join("\n")
  );
});


      const line1 = document.createElement("div");
      line1.classList.add("agenda-line1");

      const time = document.createElement("div");
      time.classList.add("agenda-time");
      time.textContent = ev.time || "‚Äî";

      const right = document.createElement("div");
      right.style.display = "inline-flex";
      right.style.alignItems = "center";
      right.style.gap = "6px";

      if(ev.isBlocked){
        const b = document.createElement("span");
        b.className = "pill-blocked";
        b.textContent = "üîí Bloqu√©";
        right.appendChild(b);
      }

      const type = document.createElement("div");
      const label = ev.kind === "ical" ? "R√©servation" : (ev.type || "Prestation");
      type.classList.add("agenda-type", typeClass(label, ev.kind === "ical"));
      type.textContent = label;
      right.appendChild(type);

      line1.appendChild(time);
      line1.appendChild(right);

      const logement = document.createElement("div");
      logement.classList.add("agenda-logement");
      logement.textContent = home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement");

      const meta = document.createElement("div");
      meta.classList.add("agenda-meta");

      const parts = [];
      if(ev.kind === "ical"){
        if(ev.summary) parts.push(ev.summary);
      }else{
        if(home?.ownerName) parts.push(`Proprio: ${home.ownerName}`);
        else if(home?.ownerEmail) parts.push(`Proprio: ${home.ownerEmail}`);
        if(ev.team) parts.push(`√âquipe: ${ev.team}`);
        if(ev.meta) parts.push(ev.meta);
        if(ev.isBlocked) parts.push(ev.blockReason ? ev.blockReason : "Paiement requis");
      }
      meta.textContent = parts.filter(Boolean).join(" ‚Ä¢ ");

      item.appendChild(line1);
      item.appendChild(logement);
      item.appendChild(meta);

      agendaListEl.appendChild(item);
    });
  }

  function stop(){
    if(unsubHomes) unsubHomes();
    if(unsubJobs) unsubJobs();
    if(unsubIcal) unsubIcal();
    unsubHomes = unsubJobs = unsubIcal = null;
  }

  function start(user){
    // homes
    unsubHomes = onSnapshot(
      query(collection(db, "homes"), where("conciergerieUid","==", user.uid)),
      (snap)=>{
        const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        list.sort((a,b)=>{
          const ta = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const tb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return tb - ta;
        });
        setHomes(list);
        renderCalendar(); renderAgenda(); renderKpis();
      },
      (err)=> showAlert("Erreur logements : " + (err?.message || "inconnue"))
    );

    // events (prestations)
    unsubJobs = onSnapshot(
      query(collection(db, "events"), where("conciergerieUid","==", user.uid)),
      (snap)=>{
        jobs = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hideAlert();
        renderCalendar(); renderAgenda(); renderKpis();
      },
      (err)=> showAlert("Erreur prestations : " + (err?.message || "inconnue"))
    );

    // icalEvents (r√©servations)
    unsubIcal = onSnapshot(
      query(collection(db, "icalEvents"), where("conciergerieUid","==", user.uid)),
      (snap)=>{
        icals = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hideAlert();
        renderCalendar(); renderAgenda(); renderKpis();
      },
      (err)=> showAlert("Erreur iCal : " + (err?.message || "inconnue"))
    );
  }

  prevMonthBtn.addEventListener("click", ()=>{
    currentMonth--;
    if(currentMonth < 0){ currentMonth = 11; currentYear--; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  nextMonthBtn.addEventListener("click", ()=>{
    currentMonth++;
    if(currentMonth > 11){ currentMonth = 0; currentYear++; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  onAuthStateChanged(auth, (user)=>{
    if(!user){
      location.href = "login.html?role=conciergerie";
      return;
    }
    stop();
    start(user);
    renderCalendar(); renderAgenda(); renderKpis();
  });
</script>
</body>
</html>
