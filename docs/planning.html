<!-- docs/planning.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Planning</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --border: rgba(122,92,255,0.18);
      --bad:#b3261e;
      --ok:#1b8f4d;
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }

    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px 14px 26px;
      padding-bottom:96px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:8px;
      margin-bottom:4px;
      text-align:center;
    }

    .logo-icon{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:800;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{ margin:0; font-size:24px; font-weight:800; letter-spacing:-0.2px; }
    .subtitle{ margin-top:2px; font-size:13px; color:#444; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .kpis{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:8px;
    }
    @media(min-width:740px){
      .kpis{ grid-template-columns:repeat(4,1fr); }
    }
    .kpi{
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:10px 10px 8px;
      min-height:70px;
    }
    .kpi .t{ font-size:11px; color:#666; font-weight:800; }
    .kpi .v{ font-size:20px; font-weight:800; margin-top:4px; color:#111; line-height:1; }
    .kpi .n{ font-size:10px; color:#777; margin-top:3px; font-weight:800; }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      align-items:start;
    }
    @media(min-width:920px){
      .layout{ grid-template-columns: 1.2fr .95fr; }
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px 12px 12px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card-title{
      font-size:15px;
      font-weight:800;
      color:#111;
    }

    .card-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
    }

    .legend{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      font-size:11px;
      font-weight:800;
      color:#666;
      align-items:center;
      justify-content:flex-end;
    }
    .legend span{ display:inline-flex; align-items:center; gap:6px; }

    .dot{
      width:10px;height:10px;border-radius:50%;
      display:inline-block;
      background:#bbb;
      border:2px solid #fff;
      box-shadow:0 2px 6px rgba(0,0,0,.10);
    }
    .dot.job{ background: #5B2CFF; }
    .dot.ical{ background: #00A3FF; }

    .cal-nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:2px;
    }
    .cal-nav button{
      width:36px;height:36px;
      border-radius:999px;
      border:2px solid var(--violet-main);
      background:#fff;
      color:var(--violet-main);
      font-weight:800;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .month{
      font-weight:800;
      color:#222;
      font-size:13px;
      text-transform:capitalize;
    }

    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-top:8px;
      font-size:10px;
      font-weight:800;
      color:#666;
      text-align:center;
    }

    #monthGrid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-top:6px;
    }

    .day{
      background:#fff;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.05);
      min-height:62px;
      padding:6px;
      cursor:pointer;
      position:relative;
    }
    .day.muted{
      background: rgba(255,255,255,0.55);
      box-shadow:none;
      border:1px dashed rgba(122,92,255,0.18);
      cursor:default;
    }
    .day.selected{
      outline:3px solid rgba(122,92,255,0.22);
      border-color: rgba(122,92,255,0.28);
    }
    .num{
      font-size:11px;
      font-weight:800;
      color:#222;
    }
    .dots{
      display:flex;
      gap:6px;
      position:absolute;
      left:6px;
      bottom:6px;
    }
    .mini{
      width:12px;height:12px;
      display:inline-block;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
      border:2px solid #fff;
      border-radius:50%;
    }
    .mini.job{ background:#5B2CFF; }
    .mini.ical{ background:#00A3FF; }

    .agenda-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
    }
    .agenda-date{
      font-size:12px;
      font-weight:800;
      color:#666;
      text-transform:capitalize;
      white-space:nowrap;
    }

    .actions-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .big-cta{
      flex:1;
      border:none;
      border-radius:999px;
      padding:11px 12px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      white-space:nowrap;
    }
    .big-cta.ghost{
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .agenda-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:6px;
    }

    .agenda-item{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .agenda-item.ical{ border-left:5px solid #00A3FF; }
    .agenda-item.job{ border-left:5px solid #5B2CFF; }

    .ai-main{ min-width:0; }
    .ai-time{
      font-size:11px;
      font-weight:800;
      color:#666;
    }
    .ai-home{
      font-size:13px;
      font-weight:800;
      color:#222;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }
    .ai-sub{
      font-size:12px;
      color:#666;
      font-weight:800;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }

    .ai-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
      justify-content:center;
      flex-shrink:0;
    }

    .tag{
      font-size:11px;
      font-weight:800;
      padding:3px 9px;
      border-radius:999px;
      background: rgba(122,92,255,0.12);
      color:#5b45c8;
      white-space:nowrap;
    }
    .tag.ical{
      background: rgba(0,163,255,0.14);
      color:#0067a6;
    }

    .mini-cta{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      color:#fff;
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      box-shadow:0 10px 22px rgba(0,0,0,0.10);
      white-space:nowrap;
    }
    .mini-cta.ghost{
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .mini-cta.danger{
      background:#ffe3ec;
      color:var(--bad);
      border:2px solid #ffc2d6;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .hint{
      font-size:12px;
      color:#666;
      font-weight:800;
      line-height:1.35;
      margin-top:2px;
    }

    /* ✅ Aide sous "Prestation" (agenda) */
    .ai-help{
      margin-top:4px;
      font-size:11px;
      font-weight:800;
      color:#666;
      line-height:1.25;
      text-align:right;
    }
    .ai-help a{
      color: var(--violet-main);
      text-decoration: none;
      font-weight:900;
    }
    .ai-help a:hover{
      text-decoration: underline;
    }

    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid rgba(122,92,255,0.18);
      backdrop-filter: blur(10px);
    }
    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight:800;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    @media(min-width: 860px){
      .bottom-nav{
        position: static;
        max-width: 980px;
        margin: 12px auto 0;
        border-top: none;
        border: 1px solid rgba(122,92,255,0.18);
        border-radius: 999px;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
      }
      .page{ padding-bottom: 32px; }
    }

    @media (max-width: 520px){
      .page{ padding-left:12px; padding-right:12px; }
      .card{ padding:12px; border-radius:16px; }
      .kpi{ padding:9px; border-radius:16px; min-height:64px; }
      .day{ min-height:58px; padding:6px; border-radius:12px; }
      .ai-home, .ai-sub{ max-width: 220px; }
      html, body{ overflow-x:hidden; }
    }

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:80;
    }
    .modal{
      width:100%;
      max-width:640px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.20);
      padding:16px 14px 18px;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; font-weight:900; color:#111; }
    .modal .sub{ margin:0 0 12px; font-size:12px; color:#666; font-weight:800; line-height:1.25; }

    .f-row{ display:flex; gap:10px; flex-wrap:wrap; }
    .f-row > div{ flex:1; min-width:190px; }
    label{ display:block; font-size:12px; font-weight:900; color:#333; margin:8px 0 4px; text-align:left; }
    input, select, textarea{
      width:100%; box-sizing:border-box; padding:10px 10px;
      border-radius:12px; border:1px solid #D3C7FF; font-size:13px; outline:none; background:#fff;
    }
    textarea{ resize:vertical; }

    input:focus, select:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .modal-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .inline-error{
      display:none;
      margin-top:6px;
      font-size:12px;
      font-weight:900;
      color:var(--bad);
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="conciergerie.html">← Tableau de bord</a>
      <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
    </div>

    <div class="logo">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Planning</div>

    <div class="alert" id="alertBox"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="t">Aujourd’hui</div>
        <div class="v" id="kpiToday">—</div>
        <div class="n">éléments</div>
      </div>
      <div class="kpi">
        <div class="t">7 jours</div>
        <div class="v" id="kpiWeek">—</div>
        <div class="n">éléments</div>
      </div>
      <div class="kpi">
        <div class="t">Logements</div>
        <div class="v" id="kpiHomes">—</div>
        <div class="n">gérés</div>
      </div>
      <div class="kpi">
        <div class="t">Ce mois</div>
        <div class="v" id="kpiMonth">—</div>
        <div class="n">éléments</div>
      </div>
    </div>

    <div class="layout">
      <section class="card">
        <div class="card-head">
          <div><div class="card-title">Calendrier</div></div>
          <div class="legend">
            <span><i class="dot job"></i>prestations</span>
            <span><i class="dot ical"></i>réservations</span>
          </div>
        </div>

        <div class="cal-nav">
          <button id="prevBtn" aria-label="Mois précédent">‹</button>
          <div class="month" id="monthLabel">—</div>
          <button id="nextBtn" aria-label="Mois suivant">›</button>
        </div>

        <div class="dow">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>
        <div id="monthGrid"></div>
      </section>

      <section class="card">
        <div class="agenda-head">
          <div class="card-title">Agenda</div>
          <div class="agenda-date" id="agendaDate">—</div>
        </div>

        <div class="actions-row">
          <button class="big-cta ghost" id="openResaBtn" type="button">+ Créer une réservation</button>
          <button class="big-cta" id="openJobBtn" type="button">+ Créer une prestation</button>
        </div>

        <div class="agenda-list" id="agendaList"></div>
      </section>
    </div>
  </div>

  <nav class="bottom-nav" aria-label="Navigation">
    <a href="planning.html" class="active">Planning</a>
    <a href="import-ical.html">iCal</a>
    <a href="messagerie.html">Messages</a>
    <a href="catalogue.html">Catalogue</a>
    <a href="logements.html">Logements</a>
  </nav>

  <div class="modal-backdrop" id="resaBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Créer une réservation</h2>
      <p class="sub">Réservation manuelle (interne). Elle active le planning du logement.</p>

      <form id="resaForm">
        <label for="resaHome">Logement</label>
        <select id="resaHome" required>
          <option value="">— Choisir un logement —</option>
        </select>

        <div class="f-row">
          <div>
            <label for="resaStart">Arrivée</label>
            <input id="resaStart" type="date" required />
          </div>
          <div>
            <label for="resaEnd">Départ</label>
            <input id="resaEnd" type="date" required />
            <div class="inline-error" id="resaDateErr">La date de départ doit être ≥ à la date d’arrivée.</div>
          </div>
        </div>

        <div class="f-row">
          <div>
            <label for="resaTime">Heure (optionnel)</label>
            <input id="resaTime" type="time" />
          </div>
          <div>
            <label for="resaOwnerName">Nom propriétaire</label>
            <input id="resaOwnerName" type="text" placeholder="Ex. Mme Dupont" required />
          </div>
        </div>

        <div class="f-row">
          <div>
            <label for="resaOwnerEmail">Email propriétaire</label>
            <input id="resaOwnerEmail" type="email" placeholder="ex. proprietaire@email.com" required />
          </div>
          <div>
            <label for="resaTitle">Nom réservation (optionnel)</label>
            <input id="resaTitle" type="text" placeholder="Ex. Famille Martin / Séjour Airbnb" />
          </div>
        </div>

        <label for="resaNote">Note interne (optionnel)</label>
        <textarea id="resaNote" rows="3" placeholder="Ex. arrivée tardive, lit bébé, etc."></textarea>

        <div class="modal-actions">
          <button class="btn" type="button" id="resaCancel">Annuler</button>
          <button class="btn primary" type="submit" id="resaSave">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="jobBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Créer une prestation</h2>
      <p class="sub">Choisis un logement + une date. Ensuite tu passes sur la création détaillée.</p>

      <form id="jobFormQuick">
        <label for="jobHome">Logement</label>
        <select id="jobHome" required>
          <option value="">— Choisir un logement —</option>
        </select>

        <div class="f-row">
          <div>
            <label for="jobDate">Date</label>
            <input id="jobDate" type="date" required />
          </div>
          <div>
            <label for="jobTime">Heure (optionnel)</label>
            <input id="jobTime" type="time" />
          </div>
        </div>

        <div class="f-row">
          <div>
            <label for="jobAgent">Agent (optionnel)</label>
            <input id="jobAgent" type="text" placeholder="Ex. Sarah / Équipe A" />
          </div>
          <div>
            <label for="jobNote">Note (optionnel)</label>
            <input id="jobNote" type="text" placeholder="Ex. check-in, urgence, etc." />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="jobCancel">Annuler</button>
          <button class="btn primary" type="submit" id="jobGo">Continuer</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, getDocs,
      addDoc, serverTimestamp,
      deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const alertBox = document.getElementById("alertBox");
    const logoutBtn = document.getElementById("logoutBtn");

    const kpiToday = document.getElementById("kpiToday");
    const kpiWeek = document.getElementById("kpiWeek");
    const kpiHomes = document.getElementById("kpiHomes");
    const kpiMonth = document.getElementById("kpiMonth");

    const monthLabel = document.getElementById("monthLabel");
    const monthGrid = document.getElementById("monthGrid");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const agendaDate = document.getElementById("agendaDate");
    const agendaList = document.getElementById("agendaList");

    const openResaBtn = document.getElementById("openResaBtn");
    const openJobBtn  = document.getElementById("openJobBtn");

    const resaBackdrop = document.getElementById("resaBackdrop");
    const resaForm = document.getElementById("resaForm");
    const resaHome = document.getElementById("resaHome");
    const resaStart = document.getElementById("resaStart");
    const resaEnd = document.getElementById("resaEnd");
    const resaDateErr = document.getElementById("resaDateErr");
    const resaTime = document.getElementById("resaTime");
    const resaOwnerName = document.getElementById("resaOwnerName");
    const resaOwnerEmail = document.getElementById("resaOwnerEmail");
    const resaTitle = document.getElementById("resaTitle");
    const resaNote = document.getElementById("resaNote");
    const resaCancel = document.getElementById("resaCancel");
    const resaSave = document.getElementById("resaSave");

    const jobBackdrop = document.getElementById("jobBackdrop");
    const jobFormQuick = document.getElementById("jobFormQuick");
    const jobHome = document.getElementById("jobHome");
    const jobDate = document.getElementById("jobDate");
    const jobTime = document.getElementById("jobTime");
    const jobAgent = document.getElementById("jobAgent");
    const jobNote = document.getElementById("jobNote");
    const jobCancel = document.getElementById("jobCancel");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    const MONTHS = ["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];
    function pad2(n){ return String(n).padStart(2,"0"); }
    function dateKeyFromDate(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function parseDateKey(s){
      const [y,m,d] = (s||"").split("-").map(Number);
      if(!y||!m||!d) return null;
      return new Date(y, m-1, d, 12, 0, 0);
    }
    function startOfWeekMonday(d){
      const x = new Date(d);
      const day = (x.getDay()+6)%7;
      x.setDate(x.getDate()-day);
      x.setHours(0,0,0,0);
      return x;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate()+n);
      return x;
    }
    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function normalizeEmail(s){ return (s||"").toString().trim().toLowerCase(); }

    let currentUser = null;

    // homesById: id -> {name, city, homeType, defaultAgent, ownerName, ownerEmail}
    let homesById = new Map();

    let icalEvents = [];
    let jobs = [];
    let allMerged = [];

    // ✅ ids de réservations déjà couvertes par une prestation (icalEventId)
    let usedIcalIds = new Set();

    // ✅ index mémoire ultra-rapide (anti lag)
    let byDate = new Map(); // dateKey -> array of events
    let countsByDate = new Map(); // dateKey -> {icalCount, jobCount}

    let viewYear = new Date().getFullYear();
    let viewMonth = new Date().getMonth();
    let selectedDateKey = dateKeyFromDate(new Date());

    function normDateKeyFromEvent(ev){
      return ev.dateKey || ev.date || "";
    }

    function rebuildIndexes(){
      byDate = new Map();
      countsByDate = new Map();

      for(const ev of allMerged){
        const dk = ev.dateKey;
        if(!dk) continue;

        if(!byDate.has(dk)) byDate.set(dk, []);
        byDate.get(dk).push(ev);

        if(!countsByDate.has(dk)) countsByDate.set(dk, {icalCount:0, jobCount:0});
        const c = countsByDate.get(dk);
        if(ev.kind === "ical") c.icalCount++;
        if(ev.kind === "job") c.jobCount++;
      }

      // tri par heure dans chaque jour (une fois)
      for(const [dk, arr] of byDate.entries()){
        arr.sort((a,b)=> String(a.time||"").localeCompare(String(b.time||"")));
      }
    }

    async function loadHomes(){
      const q = query(collection(db,"homes"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);

      homesById = new Map();
      resaHome.innerHTML = `<option value="">— Choisir un logement —</option>`;
      jobHome.innerHTML  = `<option value="">— Choisir un logement —</option>`;

      snap.docs.forEach(d=>{
        const data = d.data() || {};
        const h = {
          id: d.id,
          name: data.name || "Logement",
          city: data.city || "",
          homeType: data.homeType || data.type || data.kind || "",
          defaultAgent: data.defaultAgent || data.agent || data.teamDefault || "",
          ownerName: data.ownerName || "",
          ownerEmail: data.ownerEmail || ""
        };
        homesById.set(d.id, h);

        const label = `${h.name}${h.homeType ? " ("+h.homeType+")" : ""}${h.city ? " — "+h.city : ""}`;

        const opt1 = document.createElement("option");
        opt1.value = d.id;
        opt1.textContent = label;
        resaHome.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = d.id;
        opt2.textContent = label;
        jobHome.appendChild(opt2);
      });

      kpiHomes.textContent = String(homesById.size);
    }

    async function loadIcal(){
      const q = query(collection(db,"icalEvents"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);

      icalEvents = snap.docs.map(d=>{
        const x = d.data() || {};
        return {
          id: d.id,
          kind: "ical",
          source: x.source || "ical",
          dateKey: x.dateKey || x.date || "",
          time: x.time || "",
          startDate: x.startDate || "",
          endDate: x.endDate || "",
          homeId: x.homeId || "",
          homeName: x.homeName || "",
          ownerName: x.ownerName || "",
          ownerEmail: x.ownerEmail || "",
          summary: x.summary || x.icalSummary || x.title || "",
          note: x.note || ""
        };
      }).filter(x=>!!x.dateKey);
    }

    async function loadJobs(){
      const q = query(collection(db,"events"), where("conciergerieUid","==", currentUser.uid));
      const snap = await getDocs(q);

      jobs = snap.docs.map(d=>{
        const x = d.data() || {};
        return {
          id: d.id,
          kind: "job",
          dateKey: normDateKeyFromEvent(x),
          time: x.time || "",
          homeId: x.homeId || "",
          homeName: x.homeName || "",
          homeType: x.homeType || "",
          type: x.type || x.serviceName || "Prestation",
          meta: x.meta || "",
          team: x.team || x.agent || "",
          source: x.source || "manuel",
          icalEventId: x.icalEventId || ""
        };
      }).filter(x=>!!x.dateKey);
    }

    function mergeAll(){
      // ✅ 1) repérer les réservations (icalEvents) qui ont déjà une prestation liée
      usedIcalIds = new Set(
        jobs.map(j => (j.icalEventId || "").trim()).filter(Boolean)
      );

      // ✅ 2) masquer les réservations couvertes (sinon impression de doublon)
      const visibleIcal = icalEvents.filter(ev => !usedIcalIds.has(ev.id));

      allMerged = [...visibleIcal, ...jobs];

      allMerged.sort((a,b)=>{
        if(a.dateKey !== b.dateKey) return a.dateKey.localeCompare(b.dateKey);
        return String(a.time||"").localeCompare(String(b.time||""));
      });

      rebuildIndexes();
    }

    function computeKpis(){
      const today = new Date();
      const todayKey = dateKeyFromDate(today);

      const startWeek = startOfWeekMonday(today);
      let cntWeek = 0;
      for(let i=0;i<7;i++){
        const k = dateKeyFromDate(addDays(startWeek,i));
        const arr = byDate.get(k);
        if(arr) cntWeek += arr.length;
      }

      let cntToday = 0;
      const arrToday = byDate.get(todayKey);
      if(arrToday) cntToday = arrToday.length;

      let cntMonth = 0;
      const monthPrefix = viewYear + "-" + pad2(viewMonth+1) + "-";
      for(const [k, arr] of byDate.entries()){
        if(String(k).startsWith(monthPrefix)) cntMonth += arr.length;
      }

      kpiToday.textContent = String(cntToday);
      kpiWeek.textContent = String(cntWeek);
      kpiMonth.textContent = String(cntMonth);
    }

    function dotsCountByDay(dateKey){
      return countsByDate.get(dateKey) || {icalCount:0, jobCount:0};
    }

    function setAgendaFor(dateKey){
      selectedDateKey = dateKey;
      const d = parseDateKey(dateKey);
      agendaDate.textContent = d ? (d.getDate()+" "+MONTHS[d.getMonth()]+" "+d.getFullYear()) : dateKey;

      const list = byDate.get(dateKey) || [];

      agendaList.innerHTML = "";
      if(!list.length){
        const empty = document.createElement("div");
        empty.style.padding = "12px";
        empty.style.borderRadius = "14px";
        empty.style.background = "#fff";
        empty.style.boxShadow = "0 3px 10px rgba(0,0,0,.06)";
        empty.style.color = "#666";
        empty.style.fontWeight = "800";
        empty.style.fontSize = "12px";
        empty.textContent = "Aucun élément ce jour-là.";
        agendaList.appendChild(empty);
        return;
      }

      list.forEach(ev=>{
        const home = homesById.get(ev.homeId);
        const homeType = home?.homeType ? ` (${home.homeType})` : (ev.homeType ? ` (${ev.homeType})` : "");
        const homeLine = home
          ? `${home.name}${homeType}${home.city ? " — " + home.city : ""}`
          : (ev.homeName || "Logement");

        const item = document.createElement("div");
        item.className = "agenda-item " + (ev.kind === "ical" ? "ical" : "job");

        const sub = (ev.kind === "ical")
          ? (ev.summary ? ev.summary : (ev.source === "manuel" ? "Réservation manuelle" : "Réservation iCal"))
          : ((ev.meta ? ev.meta : ev.type || "Prestation") + (ev.team ? ` • Agent: ${ev.team}` : ""));

        const covered = (ev.kind === "ical") && usedIcalIds.has(ev.id);

        item.innerHTML = `
          <div class="ai-main">
            <div class="ai-time">${esc(ev.time || "—")}</div>
            <div class="ai-home">${esc(homeLine)}</div>
            <div class="ai-sub">${esc(sub)}</div>
          </div>
          <div class="ai-actions">
            <span class="tag ${ev.kind === "ical" ? "ical" : ""}">${ev.kind === "ical" ? "Réservation" : "Prestation"}</span>

            ${ev.kind === "job" ? `
              <div class="ai-help">
                Retrouve le détail dans <a href="prestations.html?eventId=${encodeURIComponent(ev.id)}">Facturation</a>
              </div>
            ` : ``}

            ${
              ev.kind === "ical"
                ? (
                    covered
                      ? `<span class="tag ical">Réservation (prestation créée)</span>`
                      : `
                          <button class="mini-cta" type="button" data-add="${esc(ev.id)}">+ Ajouter prestation</button>
                          <button class="mini-cta ghost" type="button" data-edit="${esc(ev.id)}">Modifier</button>
                          <button class="mini-cta danger" type="button" data-del="${esc(ev.id)}">Supprimer</button>
                        `
                  )
                : ``
            }
          </div>
        `;
        agendaList.appendChild(item);

        item.addEventListener("click", (e)=>{
          if(e.target && (e.target.matches("button[data-add]") || e.target.matches("button[data-edit]") || e.target.matches("button[data-del]"))) return;

          if(ev.kind === "ical"){
            const dd = parseDateKey(ev.dateKey);
            const dateLabel = dd ? (dd.getDate()+" "+MONTHS[dd.getMonth()]+" "+dd.getFullYear()) : (ev.dateKey || "—");
            alert(
              [
                `${dateLabel} • ${ev.time || "—"} • Réservation`,
                homeLine,
                ev.ownerName ? `Propriétaire: ${ev.ownerName}` : null,
                ev.ownerEmail ? `Email: ${ev.ownerEmail}` : null,
                ev.summary ? `Nom: ${ev.summary}` : null,
                ev.note ? `Note: ${ev.note}` : null
              ].filter(Boolean).join("\n")
            );
          }else{
            alert(
              [
                `${ev.time || "—"} • ${ev.type || "Prestation"}`,
                homeLine,
                ev.team ? `Agent: ${ev.team}` : null,
                ev.meta ? `Détail: ${ev.meta}` : null
              ].filter(Boolean).join("\n")
            );
          }
        });
      });

      agendaList.querySelectorAll("button[data-add]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const icalId = btn.getAttribute("data-add");
          const ev = icalEvents.find(x=>x.id === icalId);
          if(!ev) return;

          if(!ev.homeId){
            alert("Réservation détectée mais homeId manquant.\n➡️ Vérifie que tes icalEvents ont bien homeId.");
            return;
          }

          const h = homesById.get(ev.homeId);

          const params = new URLSearchParams();
          params.set("homeId", ev.homeId);
          params.set("dateKey", ev.dateKey);
          if(ev.time) params.set("time", ev.time);
          if(ev.summary) params.set("summary", ev.summary);
          params.set("icalEventId", ev.id);
          params.set("from", ev.source || "ical");

          if(h?.ownerName) params.set("ownerName", h.ownerName);
          if(h?.ownerEmail) params.set("ownerEmail", h.ownerEmail);

          // ✅ type + agent par défaut envoyés aussi
          if(h?.homeType) params.set("homeType", h.homeType);
          if(h?.defaultAgent) params.set("team", h.defaultAgent);

          location.href = "nouvelle-prestation.html?" + params.toString();
        });
      });

      // ✅ delete reservation
      agendaList.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const icalId = btn.getAttribute("data-del");
          const ev = icalEvents.find(x=>x.id === icalId);
          if(!ev) return;

          const ok = confirm("Supprimer cette réservation ? (définitif)");
          if(!ok) return;

          try{
            await deleteDoc(doc(db,"icalEvents", icalId));
            showAlert("✅ Réservation supprimée.", true);

            await loadIcal();
            mergeAll();
            computeKpis();
            renderCalendar();
            setAgendaFor(selectedDateKey);

          }catch(err){
            console.error(err);
            showAlert("Erreur suppression réservation : " + (err?.message || "inconnue"));
          }
        });
      });

      // ✅ edit button (V1 = ouvrir modale pré-remplie et recréer -> simple)
      agendaList.querySelectorAll("button[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const icalId = btn.getAttribute("data-edit");
          const ev = icalEvents.find(x=>x.id === icalId);
          if(!ev) return;

          openResaModal();

          resaHome.value = ev.homeId || "";
          resaStart.value = ev.startDate || ev.dateKey || selectedDateKey;
          resaEnd.value = ev.endDate || ev.startDate || ev.dateKey || selectedDateKey;
          resaTime.value = ev.time || "";
          resaOwnerName.value = ev.ownerName || "";
          resaOwnerEmail.value = ev.ownerEmail || "";
          resaTitle.value = ev.summary || "";
          resaNote.value = ev.note || "";

          resaForm.setAttribute("data-edit-id", icalId);
          refreshResaValidity();
        });
      });
    }

    function renderCalendar(){
      monthGrid.innerHTML = "";

      const first = new Date(viewYear, viewMonth, 1, 12, 0, 0);
      const last = new Date(viewYear, viewMonth+1, 0, 12, 0, 0);

      monthLabel.textContent = `${MONTHS[viewMonth]} ${viewYear}`;

      const startDow = (first.getDay()+6)%7;
      const daysInMonth = last.getDate();

      for(let i=0; i<42; i++){
        const dayNum = i - startDow + 1;
        const cell = document.createElement("div");

        if(dayNum < 1 || dayNum > daysInMonth){
          cell.className = "day muted";
          cell.innerHTML = `<div class="num"> </div><div class="dots"></div>`;
          monthGrid.appendChild(cell);
          continue;
        }

        const d = new Date(viewYear, viewMonth, dayNum, 12,0,0);
        const key = dateKeyFromDate(d);
        const { icalCount, jobCount } = dotsCountByDay(key);

        const dots = [];
        for(let j=0; j<Math.min(4, jobCount); j++) dots.push(`<span class="mini job" title="prestations"></span>`);
        for(let k=0; k<Math.min(4 - dots.length, icalCount); k++) dots.push(`<span class="mini ical" title="réservations"></span>`);

        cell.className = "day" + (key === selectedDateKey ? " selected" : "");
        cell.innerHTML = `
          <div class="num">${dayNum}</div>
          <div class="dots">${dots.join("")}</div>
        `;

        cell.addEventListener("click", ()=>{
          selectedDateKey = key;
          renderCalendar();
          setAgendaFor(key);
        });

        monthGrid.appendChild(cell);
      }
    }

    function openResaModal(){
      resaBackdrop.style.display = "flex";

      resaForm.removeAttribute("data-edit-id");

      resaStart.value = selectedDateKey;
      resaEnd.value = selectedDateKey;
      resaTime.value = "";
      resaTitle.value = "";
      resaNote.value = "";
      resaDateErr.style.display = "none";
      resaSave.disabled = false;

      setTimeout(()=> resaHome.focus(), 0);
    }
    function closeResaModal(){
      resaBackdrop.style.display = "none";
      resaForm.reset();
      resaForm.removeAttribute("data-edit-id");
      resaDateErr.style.display = "none";
      resaSave.disabled = false;
    }

    function openJobModal(){
      jobBackdrop.style.display = "flex";
      jobDate.value = selectedDateKey;
      jobTime.value = "";
      jobAgent.value = "";
      jobNote.value = "";

      const h = homesById.get(jobHome.value);
      if(h?.defaultAgent) jobAgent.value = h.defaultAgent;

      setTimeout(()=> jobHome.focus(), 0);
    }
    function closeJobModal(){
      jobBackdrop.style.display = "none";
      jobFormQuick.reset();
    }

    function fillOwnerFromHome(homeId){
      const h = homesById.get(homeId);
      if(!h) return;
      if(h.ownerName && !resaOwnerName.value) resaOwnerName.value = h.ownerName;
      if(h.ownerEmail && !resaOwnerEmail.value) resaOwnerEmail.value = h.ownerEmail;
    }

    function isEndValid(){
      const a = resaStart.value;
      const b = resaEnd.value;
      if(!a || !b) return true;
      return b >= a;
    }
    function refreshResaValidity(){
      const ok = isEndValid();
      resaDateErr.style.display = ok ? "none" : "block";
      resaSave.disabled = !ok;
    }

    prevBtn.addEventListener("click", ()=>{
      viewMonth--;
      if(viewMonth < 0){ viewMonth = 11; viewYear--; }
      computeKpis();
      renderCalendar();
    });

    nextBtn.addEventListener("click", ()=>{
      viewMonth++;
      if(viewMonth > 11){ viewMonth = 0; viewYear++; }
      computeKpis();
      renderCalendar();
    });

    openResaBtn.addEventListener("click", openResaModal);
    openJobBtn.addEventListener("click", openJobModal);

    resaCancel.addEventListener("click", closeResaModal);
    jobCancel.addEventListener("click", closeJobModal);

    resaBackdrop.addEventListener("click", (e)=>{ if(e.target === resaBackdrop) closeResaModal(); });
    jobBackdrop.addEventListener("click", (e)=>{ if(e.target === jobBackdrop) closeJobModal(); });

    resaHome.addEventListener("change", ()=> fillOwnerFromHome(resaHome.value));
    resaStart.addEventListener("input", refreshResaValidity);
    resaEnd.addEventListener("input", refreshResaValidity);

    jobHome.addEventListener("change", ()=>{
      const h = homesById.get(jobHome.value);
      if(h?.defaultAgent) jobAgent.value = h.defaultAgent;
    });

    resaForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      refreshResaValidity();
      if(resaSave.disabled) return;

      const editId = resaForm.getAttribute("data-edit-id") || "";

      const homeId = (resaHome.value || "").trim();
      const startDate = resaStart.value;
      const endDate = resaEnd.value;
      const time = resaTime.value || "";
      const ownerName = (resaOwnerName.value || "").trim();
      const ownerEmail = normalizeEmail(resaOwnerEmail.value);
      const title = (resaTitle.value || "").trim();
      const note = (resaNote.value || "").trim();

      if(!homeId) return showAlert("Choisis un logement.");
      if(!startDate || !endDate) return showAlert("Arrivée + départ obligatoires.");
      if(endDate < startDate) return;
      if(!ownerName) return showAlert("Nom du propriétaire obligatoire.");
      if(!ownerEmail || !/^\S+@\S+\.\S+$/.test(ownerEmail)) return showAlert("Email propriétaire invalide.");

      const h = homesById.get(homeId);
      const homeName = h?.name || "";
      const homeCity = h?.city || "";

      const dateKey = startDate;

      resaSave.disabled = true;
      try{
        if(editId){
          await deleteDoc(doc(db,"icalEvents", editId));
        }

        await addDoc(collection(db,"icalEvents"), {
          conciergerieUid: currentUser.uid,
          source: "manuel",

          homeId,
          homeName,
          homeCity,

          dateKey,
          date: dateKey,

          startDate,
          endDate,
          time,

          ownerName,
          ownerEmail,

          summary: title || "",
          note: note || "",

          createdAt: serverTimestamp()
        });

        closeResaModal();
        showAlert(editId ? "✅ Réservation modifiée." : "✅ Réservation créée.", true);

        await loadIcal();
        mergeAll();
        computeKpis();
        renderCalendar();
        setAgendaFor(selectedDateKey);

      }catch(err){
        console.error(err);
        showAlert("Erreur réservation : " + (err?.message || "inconnue"));
      }finally{
        resaSave.disabled = false;
      }
    });

    jobFormQuick.addEventListener("submit", (e)=>{
      e.preventDefault();
      hideAlert();

      const homeId = (jobHome.value || "").trim();
      const dateKey = jobDate.value;
      const time = jobTime.value || "";
      const team = (jobAgent.value || "").trim();
      const note = (jobNote.value || "").trim();

      if(!homeId) return showAlert("Choisis un logement.");
      if(!dateKey) return showAlert("Date obligatoire.");

      const h = homesById.get(homeId);

      const params = new URLSearchParams();
      params.set("homeId", homeId);
      params.set("dateKey", dateKey);
      if(time) params.set("time", time);
      if(team) params.set("team", team);
      if(note) params.set("note", note);
      params.set("from", "manuel");

      if(h?.ownerName) params.set("ownerName", h.ownerName);
      if(h?.ownerEmail) params.set("ownerEmail", h.ownerEmail);

      if(h?.homeType) params.set("homeType", h.homeType);

      closeJobModal();
      location.href = "nouvelle-prestation.html?" + params.toString();
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;

      try{
        hideAlert();
        await loadHomes();
        await loadIcal();
        await loadJobs();
        mergeAll();

        const sel = parseDateKey(selectedDateKey) || new Date();
        viewYear = sel.getFullYear();
        viewMonth = sel.getMonth();

        computeKpis();
        renderCalendar();
        setAgendaFor(selectedDateKey);

      }catch(err){
        console.error(err);
        showAlert("Erreur planning : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
