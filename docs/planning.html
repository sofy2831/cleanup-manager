<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Planning</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --border: rgba(122,92,255,0.18);
      --bad:#b3261e;
      --ok:#1b8f4d;
      --card:#ffffffde;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      padding-bottom: 90px; /* place pour bandeau */
    }

    .topbar{
      width:100%;
      max-width:1100px;
      position:sticky;
      top:0;
      z-index:20;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:44px;height:44px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);font-size:22px;font-weight:900;
      position:relative;flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:26px; font-weight:900; letter-spacing:-0.2px; }
    .subtitle{ margin-top:2px; font-size:14px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:700; text-align:center; }

    .alert{
      width:100%;
      max-width:1100px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .wrap{
      width:100%;
      max-width:1100px;
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media(min-width: 920px){
      .wrap{ grid-template-columns: 1.2fr 0.8fr; align-items:start; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 14px 36px rgba(0,0,0,0.08);
      backdrop-filter: blur(10px);
      padding: 14px;
    }

    .card h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .card p{
      margin:6px 0 0;
      font-size:12px;
      color:#666;
      line-height:1.35;
    }

    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }

    .seg{
      display:inline-flex;
      gap:4px;
      padding:4px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:999px;
      box-shadow:0 3px 10px rgba(0,0,0,.05);
    }
    .seg button{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:8px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      color:#666;
      white-space:nowrap;
    }
    .seg button.active{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 8px 18px rgba(0,0,0,.10);
    }

    .datebox{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .datebox input[type="date"]{
      border:1px solid rgba(122,92,255,0.25);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      font-weight:800;
      font-size:13px;
      outline:none;
    }

    .list{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 62vh;
      overflow:auto;
      padding-right:4px;
    }

    .dayBlock{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(122,92,255,0.14);
      box-shadow:0 6px 16px rgba(0,0,0,.06);
      padding:10px;
    }
    .dayHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .dayTitle{
      font-weight:900;
      color:#222;
      font-size:13px;
    }
    .dayCount{
      font-size:11px;
      font-weight:900;
      color:#666;
      background:rgba(122,92,255,0.10);
      padding:4px 8px;
      border-radius:999px;
    }

    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius:14px;
      cursor:pointer;
      border:2px solid transparent;
      margin-top:8px;
    }
    .item:hover{ border-color: rgba(122,92,255,0.35); }
    .item.selected{ border-color: rgba(122,92,255,0.65); background: rgba(122,92,255,0.06); }

    .left{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .dot{
      width:10px; height:10px; border-radius:50%;
      margin-top:5px;
      background:#bbb;
      flex-shrink:0;
    }
    .dot.ical{ background:#bdbdbd; }    /* gris = réservation */
    .dot.job{ background:#7A5CFF; }     /* violet = prestation */
    .meta{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .line1{
      font-weight:900;
      font-size:13px;
      color:#222;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 520px;
    }
    .line2{
      font-size:12px;
      color:#666;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 520px;
    }
    .tag{
      font-size:11px;
      font-weight:900;
      padding:3px 8px;
      border-radius:999px;
      background: var(--violet-light);
      color:#5b45c8;
      white-space:nowrap;
      flex-shrink:0;
    }
    .tag.gray{ background:#f2f2f2; color:#666; }
    .tag.green{ background:#e6f6ea; color:#1b8f4d; }

    /* Right panel */
    .panel{
      position:relative;
    }
    .panel .empty{
      margin-top:10px;
      padding:14px 12px;
      border-radius:16px;
      background:#fff;
      border:1px dashed rgba(122,92,255,0.35);
      color:#666;
      font-weight:800;
      font-size:12px;
      line-height:1.35;
    }
    .kv{
      margin-top:10px;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:8px 10px;
      font-size:12px;
      color:#333;
      align-items:start;
    }
    .kv div.k{ color:#666; font-weight:900; }
    .btnrow{
      margin-top:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
      flex:1;
      min-width: 170px;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    /* === Bottom nav (mobile + desktop) === */
    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 80;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight: 900;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }
    @media(min-width: 860px){
      .page{ padding-bottom: 32px; }
      .bottom-nav{
        position: static;
        max-width: 1100px;
        margin-top: 14px;
        border-top: none;
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
      }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="conciergerie.html">← Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill" href="import-ical.html">Import iCal</a>
        <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Planning (réservations + prestations)</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="alert" id="alertBox"></div>

    <div class="wrap">
      <!-- Left: timeline -->
      <section class="card">
        <h2>Agenda</h2>
        <p>Réservations iCal en gris. Prestations en violet. Clique un élément pour voir le détail.</p>

        <div class="controls">
          <div class="seg" role="tablist" aria-label="Période">
            <button type="button" class="active" id="btnToday">Aujourd’hui</button>
            <button type="button" id="btn7">7 jours</button>
          </div>

          <div class="datebox">
            <input type="date" id="datePick">
            <button class="pill primary" id="btnGo" type="button">Aller</button>
          </div>
        </div>

        <div class="list" id="list"></div>
      </section>

      <!-- Right: details panel -->
      <aside class="card panel">
        <h2>Détail</h2>
        <p id="panelHint">Sélectionne une réservation ou une prestation.</p>

        <div id="panelEmpty" class="empty">
          Astuce : clique une réservation grise, puis “Ajouter une prestation” pour créer le ménage / check-in associé au logement.
        </div>

        <div id="panelBody" style="display:none;">
          <div class="kv" id="kv"></div>

          <div class="btnrow" id="btnrow"></div>
        </div>
      </aside>
    </div>

    <nav class="bottom-nav" aria-label="Navigation">
      <a href="planning.html" class="active">Planning</a>
      <a href="import-ical.html">iCal</a>
      <a href="messagerie.html">Messages</a>
      <a href="prestation-detail.html">Catalogue</a>
      <a href="logements.html">Logements</a>
    </nav>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // === UI ===
    const emailLine = document.getElementById("emailLine");
    const alertBox = document.getElementById("alertBox");
    const logoutBtn = document.getElementById("logoutBtn");

    const btnToday = document.getElementById("btnToday");
    const btn7 = document.getElementById("btn7");
    const datePick = document.getElementById("datePick");
    const btnGo = document.getElementById("btnGo");
    const listEl = document.getElementById("list");

    const panelEmpty = document.getElementById("panelEmpty");
    const panelBody = document.getElementById("panelBody");
    const kvEl = document.getElementById("kv");
    const btnrowEl = document.getElementById("btnrow");
    const panelHint = document.getElementById("panelHint");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    // === Guard abonnement ===
    const FREE_EMAILS = new Set(["mathilde.debout31@gmail.com","s.dumas974@gmail.com"]);
    async function guardConciergerie(user){
      const email = (user.email || "").toLowerCase();
      if(FREE_EMAILS.has(email)) return true;
      try{
        const snap = await getDoc(doc(db, "users", user.uid));
        if(!snap.exists()) return false;
        const data = snap.data() || {};
        return (data.role === "conciergerie" || data.role === "admin") && (data.subscriptionStatus === "active");
      }catch(_){
        return false;
      }
    }

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // === Utils dates ===
    const pad2 = (n)=> String(n).padStart(2,"0");
    function toDateKey(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function parseDateKey(s){
      // "YYYY-MM-DD"
      const [y,m,dd] = String(s||"").split("-").map(Number);
      if(!y || !m || !dd) return null;
      return new Date(y, m-1, dd);
    }
    function addDays(d, days){
      const x = new Date(d);
      x.setDate(x.getDate() + days);
      return x;
    }
    function fmtDayTitle(dateKey){
      const d = parseDateKey(dateKey);
      if(!d) return dateKey;
      const wd = ["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][d.getDay()];
      return `${wd} ${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;
    }
    function esc(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // === State ===
    let currentUser = null;
    let mode = "today"; // today | week
    let startKey = null;
    let endKey = null;

    let homesById = new Map();
    let icalEvents = []; // normalized
    let jobs = [];       // normalized

    let unsubHomes = null;
    let unsubIcal = null;
    let unsubJobs = null;

    let selected = null; // {kind, ...}

    function setMode(newMode){
      mode = newMode;
      btnToday.classList.toggle("active", mode==="today");
      btn7.classList.toggle("active", mode==="week");
      computeRangeFromPicker();
      renderList();
      clearPanel();
    }

    function computeRangeFromPicker(){
      const base = parseDateKey(datePick.value) || new Date();
      const start = (mode==="today") ? base : base;
      const end = (mode==="today") ? base : addDays(base, 6);
      startKey = toDateKey(start);
      endKey = toDateKey(end);
    }

    function inRange(dateKey){
      if(!dateKey) return false;
      return dateKey >= startKey && dateKey <= endKey;
    }

    function clearPanel(){
      selected = null;
      panelBody.style.display = "none";
      panelEmpty.style.display = "block";
      kvEl.innerHTML = "";
      btnrowEl.innerHTML = "";
      panelHint.textContent = "Sélectionne une réservation ou une prestation.";
    }

    function openPanel(ev){
      selected = ev;

      panelEmpty.style.display = "none";
      panelBody.style.display = "block";
      kvEl.innerHTML = "";
      btnrowEl.innerHTML = "";

      const home = ev.homeId ? homesById.get(ev.homeId) : null;
      const homeLabel = home ? `${home.name || "Logement"} — ${home.city || ""}` : (ev.homeName || "Logement");

      const rows = [];
      rows.push(["Type", ev.kind === "ical" ? "Réservation (iCal)" : "Prestation"]);
      rows.push(["Logement", homeLabel]);
      rows.push(["Date", ev.dateKey || "—"]);
      rows.push(["Heure", ev.time || "—"]);

      if(ev.kind === "ical"){
        if(ev.summary) rows.push(["Résumé", ev.summary]);
        panelHint.textContent = "Réservation détectée. Tu peux créer la prestation liée.";
      }else{
        if(ev.type) rows.push(["Prestation", ev.type]);
        if(ev.status) rows.push(["Statut", ev.status]);
        if(ev.meta) rows.push(["Détail", ev.meta]);
        panelHint.textContent = "Prestation planifiée.";
      }

      kvEl.innerHTML = rows.map(([k,v])=>`
        <div class="k">${esc(k)}</div>
        <div>${esc(v)}</div>
      `).join("");

      // Buttons
      if(ev.kind === "ical"){
        const params = new URLSearchParams();
        if(ev.homeId) params.set("homeId", ev.homeId);
        if(ev.dateKey) params.set("dateKey", ev.dateKey);
        if(ev.time) params.set("time", ev.time);
        if(ev.summary) params.set("summary", ev.summary);
        if(ev.id) params.set("icalEventId", ev.id);

        const btn = document.createElement("a");
        btn.className = "btn primary";
        btn.href = "nouvelle-prestation.html?" + params.toString();
        btn.textContent = "Ajouter une prestation";
        btnrowEl.appendChild(btn);

        const btn2 = document.createElement("a");
        btn2.className = "btn";
        btn2.href = ev.homeId ? ("logements.html") : "logements.html";
        btn2.textContent = "Voir les logements";
        btnrowEl.appendChild(btn2);
      }else{
        const params = new URLSearchParams();
        if(ev.homeId) params.set("homeId", ev.homeId);
        if(ev.dateKey) params.set("dateKey", ev.dateKey);
        if(ev.id) params.set("jobId", ev.id);

        const btn = document.createElement("a");
        btn.className = "btn primary";
        btn.href = "nouvelle-prestation.html?" + params.toString();
        btn.textContent = "Modifier / compléter";
        btnrowEl.appendChild(btn);

        const btn2 = document.createElement("a");
        btn2.className = "btn";
        btn2.href = "planning.html";
        btn2.textContent = "Retour planning";
        btnrowEl.appendChild(btn2);
      }
    }

    function normalizeIcal(docSnap){
      const d = docSnap.data() || {};
      return {
        kind: "ical",
        id: docSnap.id,
        conciergerieUid: d.conciergerieUid || null,
        homeId: d.homeId || null,
        homeName: d.homeName || "",
        dateKey: d.dateKey || d.startDateKey || "",
        time: d.time || "",
        summary: d.summary || d.title || "",
        location: d.location || ""
      };
    }

    function normalizeJob(docSnap){
      const d = docSnap.data() || {};
      return {
        kind: "job",
        id: docSnap.id,
        conciergerieUid: d.conciergerieUid || null,
        homeId: d.homeId || null,
        homeName: d.homeName || "",
        dateKey: d.dateKey || "",
        time: d.time || "",
        type: d.type || d.serviceName || "Prestation",
        status: d.status || "",
        meta: d.meta || ""
      };
    }

    function groupByDate(items){
      const map = new Map();
      items.forEach(it=>{
        const k = it.dateKey || "—";
        if(!map.has(k)) map.set(k, []);
        map.get(k).push(it);
      });

      // sort dates asc
      const keys = Array.from(map.keys()).sort((a,b)=> a.localeCompare(b));
      return keys.map(k=>{
        const list = map.get(k) || [];
        // sort by time then kind (ical first or job first? -> iCal first = logique planning)
        list.sort((a,b)=>{
          const ta = a.time || "";
          const tb = b.time || "";
          if(ta !== tb) return ta.localeCompare(tb);
          // iCal first
          if(a.kind !== b.kind) return (a.kind==="ical") ? -1 : 1;
          return 0;
        });
        return { dateKey: k, items: list };
      });
    }

    function renderList(){
      listEl.innerHTML = "";

      // filter by range
      const filtered = []
        .concat(icalEvents.filter(e => inRange(e.dateKey)))
        .concat(jobs.filter(e => inRange(e.dateKey)));

      if(!filtered.length){
        const empty = document.createElement("div");
        empty.style.marginTop = "12px";
        empty.style.padding = "14px 12px";
        empty.style.borderRadius = "16px";
        empty.style.background = "#fff";
        empty.style.border = "1px dashed rgba(122,92,255,0.35)";
        empty.style.color = "#666";
        empty.style.fontWeight = "800";
        empty.style.fontSize = "12px";
        empty.textContent = "Rien sur cette période. (Vérifie l’import iCal ou ajoute une prestation.)";
        listEl.appendChild(empty);
        return;
      }

      const groups = groupByDate(filtered);

      groups.forEach(g=>{
        const block = document.createElement("div");
        block.className = "dayBlock";

        const head = document.createElement("div");
        head.className = "dayHead";
        head.innerHTML = `
          <div class="dayTitle">${esc(fmtDayTitle(g.dateKey))}</div>
          <div class="dayCount">${g.items.length} élément(s)</div>
        `;
        block.appendChild(head);

        g.items.forEach(ev=>{
          const home = ev.homeId ? homesById.get(ev.homeId) : null;
          const homeLabel = home ? `${home.name || "Logement"} — ${home.city || ""}` : (ev.homeName || "Logement");

          const item = document.createElement("div");
          item.className = "item";
          item.dataset.id = ev.id;

          const isSelected = selected && selected.id === ev.id && selected.kind === ev.kind;
          if(isSelected) item.classList.add("selected");

          const title =
            (ev.kind === "ical")
              ? (ev.summary ? ev.summary : "Réservation")
              : (ev.type || "Prestation");

          const small =
            (ev.kind === "ical")
              ? homeLabel
              : `${homeLabel}${ev.status ? " • " + ev.status : ""}`;

          item.innerHTML = `
            <div class="left">
              <div class="dot ${ev.kind}"></div>
              <div class="meta">
                <div class="line1">${esc((ev.time ? ev.time + " • " : "") + title)}</div>
                <div class="line2">${esc(small)}</div>
              </div>
            </div>
            <div class="tag ${ev.kind==="ical" ? "gray" : ""}">
              ${ev.kind==="ical" ? "Réservation" : "Presta"}
            </div>
          `;

          item.addEventListener("click", ()=>{
            // sélection visuelle
            listEl.querySelectorAll(".item.selected").forEach(x=>x.classList.remove("selected"));
            item.classList.add("selected");
            openPanel(ev);
          });

          block.appendChild(item);
        });

        listEl.appendChild(block);
      });
    }

    function startListeners(){
      // homes
      if(unsubHomes) unsubHomes();
      unsubHomes = onSnapshot(
        query(collection(db,"homes"), where("conciergerieUid","==", currentUser.uid)),
        (snap)=>{
          homesById = new Map();
          snap.docs.forEach(d=>{
            const data = d.data() || {};
            homesById.set(d.id, { id:d.id, ...data });
          });
          renderList();
          // si un item est ouvert, refresh panel label
          if(selected) openPanel(selected);
        },
        (err)=>{
          console.error(err);
          showAlert("Erreur lecture logements : " + (err?.message || "inconnue"));
        }
      );

      // icalEvents
      if(unsubIcal) unsubIcal();
      unsubIcal = onSnapshot(
        query(collection(db,"icalEvents"), where("conciergerieUid","==", currentUser.uid)),
        (snap)=>{
          icalEvents = snap.docs.map(normalizeIcal).filter(x=>!!x.dateKey);
          renderList();
          if(selected){
            const same = icalEvents.find(x=>x.kind===selected.kind && x.id===selected.id) || selected;
            openPanel(same);
          }
        },
        (err)=>{
          console.error(err);
          showAlert("Erreur lecture iCal : " + (err?.message || "inconnue"));
        }
      );

      // jobs (change le nom si ta collection s’appelle autrement)
      if(unsubJobs) unsubJobs();
      unsubJobs = onSnapshot(
        query(collection(db,"jobs"), where("conciergerieUid","==", currentUser.uid)),
        (snap)=>{
          jobs = snap.docs.map(normalizeJob).filter(x=>!!x.dateKey);
          renderList();
          if(selected){
            const same = jobs.find(x=>x.kind===selected.kind && x.id===selected.id) || selected;
            openPanel(same);
          }
        },
        (err)=>{
          console.error(err);
          showAlert("Erreur lecture prestations : " + (err?.message || "inconnue"));
        }
      );
    }

    // === Controls events ===
    btnToday.addEventListener("click", ()=> setMode("today"));
    btn7.addEventListener("click", ()=> setMode("week"));
    btnGo.addEventListener("click", ()=>{
      computeRangeFromPicker();
      renderList();
      clearPanel();
    });
    datePick.addEventListener("change", ()=>{
      computeRangeFromPicker();
      renderList();
      clearPanel();
    });

    // init datePick = today
    datePick.value = toDateKey(new Date());
    computeRangeFromPicker();

    // === Boot ===
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      const ok = await guardConciergerie(user);
      if(!ok){
        showAlert("⛔ Abonnement inactif. Merci de choisir une offre.", false);
        setTimeout(()=> location.href = "abonnement.html?plan=starter", 700);
        return;
      }
      hideAlert();
      startListeners();
      clearPanel();
      renderList();
    });
  </script>
</body>
</html>
