<!-- docs/mission.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager — Mission</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
      --bg1:#F8F4FF;
      --bg2:#EDE6FF;
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 80%); color:var(--text); }
    .page{ min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:14px 14px 26px; padding-bottom:36px; }
    .top{
      width:100%; max-width:860px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 0 4px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:var(--violet-main);
      position:relative; flex-shrink:0;
    }
    .logo::after{ content:"✦"; position:absolute; top:-6px; right:-6px; font-size:12px; color:var(--violet-main); }
    .title{ display:flex; flex-direction:column; line-height:1.05; }
    .title b{ font-size:15px; letter-spacing:-0.2px; }
    .title span{ font-size:12px; color:#444; font-weight:800; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:#fff;
      border:2px solid rgba(122,92,255,0.22);
      color:#5b45c8;
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(27,143,77,0.30); color:var(--ok); }
    .pill.bad{ border-color: rgba(179,38,30,0.30); color:var(--bad); }

    .alert{
      display:none; width:100%; max-width:860px;
      margin-top:10px; padding:10px 12px; background:#fff;
      border-radius:14px; border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px; color:#444; white-space:pre-wrap;
    }
    .alert.ok{ border-left-color:var(--ok); }

    .card{
      width:100%; max-width:860px;
      background: rgba(255,255,255,0.86);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr;
      gap:6px;
      font-size:13px;
      font-weight:800;
      color:#333;
    }
    .kv b{ font-weight:900; }
    .kv .muted{ color:#666; font-weight:800; }

    .divider{ height:1px; width:100%; background:rgba(122,92,255,0.18); margin:4px 0; }

    .badge{
      font-size:11px; font-weight:900;
      padding:3px 9px; border-radius:999px;
      background: rgba(122,92,255,0.12);
      color:#5b45c8;
      white-space:nowrap;
    }
    .badge.st-A_PLANIFIER{ background: rgba(0,0,0,0.08); color:#444; }
    .badge.st-ASSIGNEE{ background: rgba(0,163,255,0.14); color:#0067a6; }
    .badge.st-ENVOYEE{ background: rgba(255,153,0,0.16); color:#8a5600; }
    .badge.st-EN_COURS{ background: rgba(0,163,255,0.14); color:#0067a6; }
    .badge.st-A_VALIDER{ background: rgba(255,153,0,0.16); color:#8a5600; }
    .badge.st-TERMINEE_AGENT{ background: rgba(255,153,0,0.16); color:#8a5600; }
    .badge.st-VALIDEE{ background: rgba(27,143,77,0.16); color:#1b8f4d; }
    .badge.st-INCIDENT{ background: rgba(179,38,30,0.14); color:#b3261e; }
    .badge.st-A_REPRENDRE{ background: rgba(179,38,30,0.14); color:#b3261e; }

    .checklist{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .check{
      background:#fff;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      border-radius:14px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .check input[type="checkbox"]{ margin-top:3px; transform:scale(1.2); }
    .check .txt{ flex:1; min-width:0; }
    .check .txt .t{ font-weight:900; font-size:13px; color:#222; }
    .check .txt .s{ margin-top:2px; font-size:12px; font-weight:800; color:#666; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .row > div{ flex:1; min-width:220px; }

    label{ display:block; font-size:11px; font-weight:900; color:#444; margin:0 0 4px; }
    input, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      background:#fff;
      font-size:13px;
      font-weight:800;
      color:#222;
      outline:none;
    }
    textarea{ min-height:90px; resize:vertical; }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn.danger{
      border-color:#ffb7cc;
      color:var(--bad);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .photos{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .photoItem{
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .photoItem a{
      color:#5b45c8;
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      word-break:break-all;
    }
    .tiny{ font-size:12px; color:#666; font-weight:800; line-height:1.35; }

    /* ===== Modals ===== */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.28);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
      padding:16px;
    }
    .modal{
      width:100%;
      max-width:560px;
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(122,92,255,0.18);
      box-shadow:0 20px 60px rgba(0,0,0,.18);
      padding:14px;
    }
    .modal h3{ margin:0 0 8px; font-size:16px; font-weight:900; }
    .modal p{ margin:0 0 10px; color:#666; font-size:12px; font-weight:800; line-height:1.35; }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; margin-top:10px; }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <div class="brand">
        <div class="logo">✓</div>
        <div class="title">
          <b>CleanUp Manager</b>
          <span>Mission agent</span>
        </div>
      </div>
      <span class="pill" id="statusPill">Chargement…</span>
    </div>

    <div class="alert" id="alertBox"></div>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
        <div style="font-size:15px; font-weight:900;">Infos mission</div>
        <span class="badge" id="typeBadge">—</span>
      </div>

      <div class="kv" id="kv"></div>
      <div class="divider"></div>

      <div class="tiny" id="consignesLine">—</div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-size:15px; font-weight:900;">Checklist</div>
        <span class="tiny" id="checkHint">—</span>
      </div>
      <div class="checklist" id="checklist"></div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-size:15px; font-weight:900;">Photos</div>
        <span class="tiny" id="photoHint">0 / 3</span>
      </div>

      <div class="row">
        <div>
          <label>Ajouter une photo (max 3)</label>
          <input id="photoInput" type="file" accept="image/*" capture="environment" />
        </div>
        <div style="flex:0; min-width:auto;">
          <button class="btn primary" id="uploadPhotoBtn" type="button">Ajouter</button>
        </div>
      </div>

      <div class="photos" id="photos"></div>
      <div class="tiny">Les photos sont envoyées dans CleanUp (Storage) et liées à cette mission.</div>
    </section>

    <section class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-size:15px; font-weight:900;">Actions</div>
        <span class="tiny" id="saveState">—</span>
      </div>

      <div class="row">
        <div>
          <button class="btn danger" id="incidentBtn" type="button">Incident</button>
        </div>
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn primary" id="finishBtn" type="button" disabled>Terminé</button>
        </div>
      </div>

      <div class="tiny">
        “Terminé” verrouille la mission (locked=true) et passe en <b>A_VALIDER</b> côté conciergerie.
      </div>
    </section>
  </div>

  <!-- MODAL INCIDENT -->
  <div class="modal-backdrop" id="incidentBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Déclarer un incident</h3>
      <p>Motif + commentaire + photo optionnelle. L’incident sera visible côté conciergerie.</p>

      <div class="row">
        <div>
          <label for="incidentMotif">Motif</label>
          <input id="incidentMotif" placeholder="Ex. fuite, casse, logement sale, clés absentes…" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="incidentComment">Commentaire</label>
          <textarea id="incidentComment" placeholder="Détail rapide + action faite / à faire"></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Photo incident (optionnel)</label>
          <input id="incidentPhotoInput" type="file" accept="image/*" capture="environment" />
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="incidentCancelBtn" type="button">Annuler</button>
        <button class="btn primary" id="incidentSaveBtn" type="button">Enregistrer incident</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      doc, getDoc, updateDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    // ===== UI =====
    const alertBox = document.getElementById("alertBox");
    const statusPill = document.getElementById("statusPill");
    const typeBadge = document.getElementById("typeBadge");
    const kv = document.getElementById("kv");
    const consignesLine = document.getElementById("consignesLine");

    const checklistEl = document.getElementById("checklist");
    const checkHint = document.getElementById("checkHint");

    const photoInput = document.getElementById("photoInput");
    const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
    const photosEl = document.getElementById("photos");
    const photoHint = document.getElementById("photoHint");

    const saveState = document.getElementById("saveState");
    const incidentBtn = document.getElementById("incidentBtn");
    const finishBtn = document.getElementById("finishBtn");

    // incident modal
    const incidentBackdrop = document.getElementById("incidentBackdrop");
    const incidentMotif = document.getElementById("incidentMotif");
    const incidentComment = document.getElementById("incidentComment");
    const incidentPhotoInput = document.getElementById("incidentPhotoInput");
    const incidentCancelBtn = document.getElementById("incidentCancelBtn");
    const incidentSaveBtn = document.getElementById("incidentSaveBtn");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function qs(name){
      return new URLSearchParams(location.search).get(name);
    }
    function normalizeToken(raw){
      return (raw || "").toString().trim().replace(/\s+/g,"");
    }
    function normalizeEmail(s){ return (s||"").toString().trim().toLowerCase(); }
    function parseIso(s){ try{ return new Date(s).getTime(); }catch{ return 0; } }

    function typeLabel(t){
      const x = (t||"").toUpperCase();
      if(x === "CHECKIN") return "Check-in";
      if(x === "MENAGE") return "Ménage";
      if(x === "CHECKOUT") return "Check-out";
      return x || "Mission";
    }
    function statusLabel(s){
      const x = (s||"").toUpperCase();
      if(x === "A_PLANIFIER") return "À planifier";
      if(x === "ASSIGNEE") return "Assignée";
      if(x === "ENVOYEE") return "Envoyée";
      if(x === "EN_COURS") return "En cours";
      if(x === "TERMINEE_AGENT") return "Terminée (agent)";
      if(x === "A_VALIDER") return "À valider";
      if(x === "VALIDEE") return "Validée";
      if(x === "INCIDENT") return "Incident";
      if(x === "A_REPRENDRE") return "À reprendre";
      return x || "—";
    }

    // ===== state =====
    let currentUser = null;
    let token = "";
    let tokenDoc = null;

    const prestationId = qs("prestationId") || "";
    const missionId = qs("missionId") || "";
    let mission = null;

    const storage = getStorage();

    function missionRef(){
      return doc(db, "events", prestationId, "missions", missionId);
    }

    async function claimTokenIfNeeded(tokenId, td){
      if(!currentUser) return;
      if(td.agentUid && td.agentUid.length > 0) return;
      try{
        await updateDoc(doc(db, "dayTokens", tokenId), {
          agentUid: currentUser.uid,
          agentClaimedAt: serverTimestamp()
        });
      }catch(e){
        console.warn("claim token failed", e);
      }
    }

    async function loadTokenOrFail(){
      token = normalizeToken(qs("token") || "");
      if(!token){
        showAlert("⛔ Token manquant. Ouvre depuis agent.html (lien journée).");
        statusPill.textContent = "Token manquant";
        statusPill.className = "pill bad";
        return false;
      }

      const tSnap = await getDoc(doc(db, "dayTokens", token));
      if(!tSnap.exists()){
        showAlert("⛔ Token invalide.");
        statusPill.textContent = "Token invalide";
        statusPill.className = "pill bad";
        return false;
      }

      const td = tSnap.data() || {};
      if(td.active === false){
        showAlert("⛔ Token désactivé.");
        statusPill.textContent = "Token OFF";
        statusPill.className = "pill bad";
        return false;
      }

      if(td.expiresAtIso){
        const exp = parseIso(td.expiresAtIso);
        if(exp && Date.now() > exp){
          showAlert("⛔ Token expiré.");
          statusPill.textContent = "Token expiré";
          statusPill.className = "pill bad";
          return false;
        }
      }

      tokenDoc = { id: tSnap.id, ...td };
      await claimTokenIfNeeded(token, td);

      return true;
    }

    function render(){
      if(!mission){
        kv.innerHTML = "";
        checklistEl.innerHTML = "";
        photosEl.innerHTML = "";
        finishBtn.disabled = true;
        return;
      }

      const st = (mission.status || "").toUpperCase();
      const tl = typeLabel(mission.type);
      typeBadge.textContent = tl;

      statusPill.textContent = statusLabel(st);
      statusPill.className = "pill " + (mission.locked ? "bad" : "ok");

      const home = `${mission.homeName || "Logement"}${mission.homeCity ? " — " + mission.homeCity : ""}`;
      const addr = (mission.homeAddress || "").trim() || "—";
      const dt = `${mission.dateKey || "—"}${mission.time ? " à " + mission.time : ""}`;

      kv.innerHTML = [
        `<div><b>Logement</b> : ${esc(home)}</div>`,
        `<div><b>Adresse</b> : <span class="muted">${esc(addr)}</span></div>`,
        `<div><b>Date / heure</b> : ${esc(dt)}</div>`,
        `<div><b>Agent</b> : ${esc(mission.assignedToName || tokenDoc?.agentName || "—")}</div>`,
        `<div><b>Statut</b> : <span class="badge st-${esc(st)}">${esc(statusLabel(st))}</span></div>`,
      ].join("");

      consignesLine.textContent = (mission.consignes || mission.comment || "Consignes : —");

      // checklist
      checklistEl.innerHTML = "";
      const list = Array.isArray(mission.checklist) ? mission.checklist : [];

      const requiredCount = list.filter(i=> !!i.required).length;
      const requiredDone = list.filter(i=> !!i.required && !!i.checked).length;

      checkHint.textContent = `${requiredDone} / ${requiredCount} obligatoires`;

      if(!list.length){
        const e = document.createElement("div");
        e.className = "tiny";
        e.textContent = "Aucune checklist.";
        checklistEl.appendChild(e);
      }else{
        list.forEach((it, idx)=>{
          const box = document.createElement("div");
          box.className = "check";
          box.innerHTML = `
            <input type="checkbox" ${it.checked ? "checked": ""} ${mission.locked ? "disabled": ""} data-ck="${idx}">
            <div class="txt">
              <div class="t">${esc(it.label || "Item")}${it.required ? " • (obligatoire)" : ""}</div>
              ${it.key ? `<div class="s">Code: ${esc(it.key)}</div>` : `<div class="s">—</div>`}
            </div>
          `;
          checklistEl.appendChild(box);

          box.querySelector(`[data-ck="${idx}"]`)?.addEventListener("change", async (e)=>{
            if(!mission || mission.locked) return;
            hideAlert();

            const checked = !!e.target.checked;

            // update local
            const next = (Array.isArray(mission.checklist) ? mission.checklist : []).map(x=>({ ...x }));
            next[idx].checked = checked;
            mission.checklist = next;

            saveState.textContent = "Enregistrement…";
            try{
              await updateDoc(missionRef(), {
                checklist: next,
                status: (mission.status && mission.status !== "A_PLANIFIER") ? mission.status : "EN_COURS",
                updatedAt: serverTimestamp()
              });
              saveState.textContent = "✅ Enregistré";
              refreshFinishButton();
            }catch(err){
              console.error(err);
              saveState.textContent = "Erreur";
              showAlert("Erreur checklist : " + (err?.message || "inconnue"));
            }
          });
        });
      }

      // photos
      const photos = Array.isArray(mission.photos) ? mission.photos : [];
      photoHint.textContent = `${photos.length} / 3`;
      photosEl.innerHTML = "";

      if(!photos.length){
        const e = document.createElement("div");
        e.className = "tiny";
        e.textContent = "Aucune photo.";
        photosEl.appendChild(e);
      }else{
        photos.forEach((p)=>{
          const row = document.createElement("div");
          row.className = "photoItem";
          row.innerHTML = `
            <a href="${esc(p.url || "#")}" target="_blank" rel="noopener">${esc(p.url || "photo")}</a>
            <span class="tiny">${esc(p.kind || "photo")}</span>
          `;
          photosEl.appendChild(row);
        });
      }

      // disable actions if locked
      const locked = !!mission.locked;
      uploadPhotoBtn.disabled = locked;
      photoInput.disabled = locked;
      incidentBtn.disabled = locked;

      refreshFinishButton();
    }

    function refreshFinishButton(){
      if(!mission){ finishBtn.disabled = true; return; }
      if(mission.locked){ finishBtn.disabled = true; return; }

      const list = Array.isArray(mission.checklist) ? mission.checklist : [];
      const requiredOk = list.filter(i=> !!i.required).every(i=> !!i.checked);

      const photos = Array.isArray(mission.photos) ? mission.photos : [];
      const minPhotos = 2;
      const photosOk = photos.length >= minPhotos;

      finishBtn.disabled = !(requiredOk && photosOk);
    }

    async function loadMissionOrFail(){
      if(!prestationId || !missionId){
        showAlert("⛔ prestationId / missionId manquant.");
        statusPill.textContent = "URL invalide";
        statusPill.className = "pill bad";
        return false;
      }

      const snap = await getDoc(missionRef());
      if(!snap.exists()){
        showAlert("⛔ Mission introuvable.");
        statusPill.textContent = "Mission introuvable";
        statusPill.className = "pill bad";
        return false;
      }

      const x = snap.data() || {};

      // sécurité logique côté front (en plus des rules)
      if((x.dayToken || "") !== token){
        showAlert("⛔ Accès refusé (token ne correspond pas).");
        statusPill.textContent = "Accès refusé";
        statusPill.className = "pill bad";
        return false;
      }
      if(normalizeEmail(x.assignedToEmail || "") !== normalizeEmail(tokenDoc?.agentEmail || "")){
        showAlert("⛔ Accès refusé (agent mismatch).");
        statusPill.textContent = "Accès refusé";
        statusPill.className = "pill bad";
        return false;
      }

      mission = { id: snap.id, ...x };
      render();
      return true;
    }

    async function uploadPhoto(kind){
      if(!mission || mission.locked) return;

      hideAlert();

      const file = photoInput.files?.[0];
      if(!file){
        showAlert("Choisis une photo.");
        return;
      }

      const photos = Array.isArray(mission.photos) ? mission.photos : [];
      if(photos.length >= 3){
        showAlert("Max 3 photos atteintes.");
        return;
      }

      uploadPhotoBtn.disabled = true;
      uploadPhotoBtn.textContent = "Envoi…";
      saveState.textContent = "Envoi photo…";

      try{
        const path = `missions/${prestationId}/${missionId}/${currentUser.uid}/${Date.now()}-${file.name}`.replaceAll(" ", "_");
        const storageRef = sRef(storage, path);

        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        const next = photos.concat([{ url, kind: kind || "photo", createdAt: Date.now() }]);

        await updateDoc(missionRef(), {
          photos: next,
          status: (mission.status && mission.status !== "A_PLANIFIER") ? mission.status : "EN_COURS",
          updatedAt: serverTimestamp()
        });

        mission.photos = next;
        photoInput.value = "";
        saveState.textContent = "✅ Photo enregistrée";
        render();
      }catch(err){
        console.error(err);
        saveState.textContent = "Erreur";
        showAlert("Erreur upload photo : " + (err?.message || "inconnue"));
      }finally{
        uploadPhotoBtn.disabled = false;
        uploadPhotoBtn.textContent = "Ajouter";
        refreshFinishButton();
      }
    }

    // ===== Incident modal =====
    function openIncidentModal(){
      incidentMotif.value = "";
      incidentComment.value = "";
      incidentPhotoInput.value = "";
      incidentBackdrop.style.display = "flex";
      incidentMotif.focus();
    }
    function closeIncidentModal(){
      incidentBackdrop.style.display = "none";
    }
    incidentBackdrop.addEventListener("click", (e)=>{ if(e.target === incidentBackdrop) closeIncidentModal(); });
    incidentCancelBtn.addEventListener("click", closeIncidentModal);

    async function saveIncident(){
      if(!mission || mission.locked) return;

      hideAlert();
      const motif = (incidentMotif.value || "").trim();
      const comment = (incidentComment.value || "").trim();
      const file = incidentPhotoInput.files?.[0] || null;

      if(!motif){
        showAlert("Motif incident obligatoire.");
        return;
      }

      incidentSaveBtn.disabled = true;
      incidentSaveBtn.textContent = "Enregistrement…";
      saveState.textContent = "Incident…";

      try{
        let photoUrl = "";
        if(file){
          const path = `missions/${prestationId}/${missionId}/${currentUser.uid}/incident-${Date.now()}-${file.name}`.replaceAll(" ", "_");
          const storageRef = sRef(storage, path);
          await uploadBytes(storageRef, file);
          photoUrl = await getDownloadURL(storageRef);
        }

        await updateDoc(missionRef(), {
          status: "INCIDENT",
          incident: {
            isIncident: true,
            label: motif,
            comment: comment,
            photoUrl: photoUrl,
            at: serverTimestamp()
          },
          updatedAt: serverTimestamp()
        });

        // refresh local
        mission.status = "INCIDENT";
        mission.incident = { isIncident:true, label: motif, comment, photoUrl };
        saveState.textContent = "✅ Incident enregistré";
        closeIncidentModal();
        render();
      }catch(err){
        console.error(err);
        saveState.textContent = "Erreur";
        showAlert("Erreur incident : " + (err?.message || "inconnue"));
      }finally{
        incidentSaveBtn.disabled = false;
        incidentSaveBtn.textContent = "Enregistrer incident";
      }
    }

    // ===== Finish =====
    async function finishMission(){
      if(!mission || mission.locked) return;

      hideAlert();

      const list = Array.isArray(mission.checklist) ? mission.checklist : [];
      const requiredOk = list.filter(i=> !!i.required).every(i=> !!i.checked);
      const photos = Array.isArray(mission.photos) ? mission.photos : [];
      if(!requiredOk){
        showAlert("Checklist incomplète (items obligatoires).");
        return;
      }
      if(photos.length < 2){
        showAlert("Ajoute au moins 2 photos.");
        return;
      }

      const ok = confirm("Terminer la mission ? (elle sera verrouillée)");
      if(!ok) return;

      finishBtn.disabled = true;
      finishBtn.textContent = "Envoi…";
      saveState.textContent = "Finalisation…";

      try{
        await updateDoc(missionRef(), {
          status: "A_VALIDER",        // ou "TERMINEE_AGENT" si tu préfères
          completedByAgent: true,
          completedAt: serverTimestamp(),
          locked: true,
          updatedAt: serverTimestamp()
        });

        // redirect
        location.href = `missionfini.html?prestationId=${encodeURIComponent(prestationId)}&missionId=${encodeURIComponent(missionId)}&token=${encodeURIComponent(token)}`;
      }catch(err){
        console.error(err);
        showAlert("Erreur terminer : " + (err?.message || "inconnue"));
        finishBtn.disabled = false;
        finishBtn.textContent = "Terminé";
        saveState.textContent = "Erreur";
      }
    }

    // ===== wiring =====
    uploadPhotoBtn.addEventListener("click", ()=> uploadPhoto("photo"));
    incidentBtn.addEventListener("click", openIncidentModal);
    incidentSaveBtn.addEventListener("click", saveIncident);
    finishBtn.addEventListener("click", finishMission);

    // ===== boot =====
    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          await signInAnonymously(auth);
          return;
        }
        currentUser = user;

        const okToken = await loadTokenOrFail();
        if(!okToken) return;

        const okMission = await loadMissionOrFail();
        if(!okMission) return;

        // si A_PLANIFIER/ASSIGNEE -> EN_COURS dès ouverture
        if(!mission.locked && ["A_PLANIFIER","ASSIGNEE","ENVOYEE"].includes((mission.status||"").toUpperCase())){
          try{
            await updateDoc(missionRef(), { status:"EN_COURS", updatedAt: serverTimestamp() });
            mission.status = "EN_COURS";
            render();
          }catch(e){
            console.warn("status EN_COURS update failed", e);
          }
        }
      }catch(err){
        console.error(err);
        showAlert("Erreur : " + (err?.message || "inconnue"));
        statusPill.textContent = "Erreur";
        statusPill.className = "pill bad";
      }
    });
  </script>
</body>
</html>
