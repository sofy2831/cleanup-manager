<!-- docs/mission.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager — Mission</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF; --violet-dark:#6238FF;
      --text:#111; --muted:#666;
      --bad:#b3261e; --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
      --bg1:#F8F4FF; --bg2:#EDE6FF;
    }
    *{ box-sizing:border-box; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    body{ margin:0; background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 80%); color:var(--text); }
    .page{ min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:14px 14px 40px; }

    .top{ width:100%; max-width:920px; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0 4px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:#fff;
      border:2px solid rgba(122,92,255,0.22); color:#5b45c8; font-weight:900; font-size:12px; white-space:nowrap; text-decoration:none;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{ background:linear-gradient(90deg,var(--violet-main),var(--violet-dark)); border-color:transparent; color:#fff; }
    .pill.ok{ border-color: rgba(27,143,77,0.30); color:var(--ok); }
    .pill.bad{ border-color: rgba(179,38,30,0.30); color:var(--bad); }

    .alert{ display:none; width:100%; max-width:920px; margin-top:10px; padding:10px 12px; background:#fff;
      border-radius:14px; border-left:5px solid var(--bad); box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px; color:#444; white-space:pre-wrap;
    }
    .alert.ok{ border-left-color:var(--ok); }

    .card{ width:100%; max-width:920px; background: rgba(255,255,255,0.86); border:1px solid var(--border);
      border-radius:18px; box-shadow:var(--shadow); backdrop-filter: blur(10px);
      padding:12px; display:flex; flex-direction:column; gap:10px; margin-top:10px;
    }
    .titleRow{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .h1{ font-size:16px; font-weight:900; }
    .sub{ font-size:12px; font-weight:800; color:#666; white-space:pre-wrap; }
    .divider{ height:1px; width:100%; background:rgba(122,92,255,0.18); margin:4px 0; }

    .group{ background:#fff; border-radius:16px; border:1px solid rgba(0,0,0,0.03); box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px; display:flex; flex-direction:column; gap:8px;
    }
    .gtitle{ font-size:13px; font-weight:900; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > div{ flex:1; min-width:240px; }

    .check{ display:flex; gap:10px; align-items:flex-start; }
    .check input{ margin-top:2px; transform: scale(1.1); }
    .check label{ font-size:12px; font-weight:800; color:#222; }

    .radioLine{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .radioLine b{ font-size:12px; font-weight:900; color:#222; }
    .radioLine label{ font-size:12px; font-weight:800; color:#444; margin-right:8px; }

    textarea{
      width:100%; border-radius:12px; border:1px solid #D3C7FF; padding:10px; outline:none;
      font-size:13px; font-weight:800; color:#222; background:#fff; min-height:70px;
    }

    .btnRow{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .btn{
      border:none; border-radius:999px; padding:10px 14px; font-size:13px; font-weight:900; cursor:pointer;
      background:#fff; color:var(--violet-main); border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,0.06); white-space:nowrap;
    }
    .btn.primary{ background:linear-gradient(90deg,var(--violet-main),var(--violet-dark)); border-color:transparent; color:#fff; box-shadow:0 12px 24px rgba(0,0,0,0.10); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
  </style>
</head>

<body>
  <div class="page">
    <div class="top">
      <a class="pill" id="backLink" href="#">← Mes missions</a>
      <span class="pill" id="statusPill">—</span>
    </div>

    <div class="alert" id="alertBox"></div>

    <section class="card">
      <div class="titleRow">
        <div>
          <div class="h1" id="missionTitle">Mission</div>
          <div class="sub" id="contextLine">—</div>
        </div>
        <div class="sub" id="agentLine">—</div>
      </div>

      <div class="divider"></div>

      <div id="groups"></div>

      <div class="divider"></div>

      <div class="btnRow">
        <button class="btn" id="saveBtn" type="button">Enregistrer</button>
        <button class="btn primary" id="doneBtn" type="button">Terminé</button>
      </div>
    </section>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const alertBox = document.getElementById("alertBox");
    const statusPill = document.getElementById("statusPill");
    const missionTitle = document.getElementById("missionTitle");
    const contextLine = document.getElementById("contextLine");
    const agentLine = document.getElementById("agentLine");
    const groupsEl = document.getElementById("groups");
    const backLink = document.getElementById("backLink");
    const saveBtn = document.getElementById("saveBtn");
    const doneBtn = document.getElementById("doneBtn");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }
    function qs(name){ return new URLSearchParams(location.search).get(name); }
    function normalizeToken(raw){ return (raw||"").toString().trim().replace(/\s+/g,""); }

    function typeLabel(id){
      const x = (id||"").toUpperCase();
      if(x === "CHECKIN") return "Check-in";
      if(x === "MENAGE") return "Ménage";
      if(x === "CHECKOUT") return "Check-out";
      return x || "Mission";
    }
    function statusLabel(s){
      const x = (s||"").toUpperCase();
      if(x === "ASSIGNEE") return "ASSIGNÉE";
      if(x === "EN_COURS") return "EN COURS";
      if(x === "A_VALIDER") return "À VALIDER";
      if(x === "INCIDENT") return "INCIDENT";
      if(x === "VALIDEE") return "VALIDÉE";
      return x || "—";
    }

    const token = normalizeToken(qs("token") || "");
    const prestationId = qs("prestationId") || "";
    const missionId = (qs("missionId") || "").toUpperCase();

    backLink.href = token ? `agent.html?token=${encodeURIComponent(token)}` : "agent.html";

    let currentUser = null;
    let tokenDoc = null;
    let missionDoc = null;

    // ===== Templates checklist =====
    const GROUPS = {
      MENAGE_BASE: {
        title: "Ménage",
        items: [
          { k:"sols", t:"check", label:"Sols" },
          { k:"sanitaires", t:"check", label:"Sanitaires" },
          { k:"cuisine", t:"check", label:"Cuisine" },
          { k:"poubelles", t:"check", label:"Poubelles" },
          { k:"draps", t:"check", label:"Draps" }
        ]
      },
      PHOTOS: { title:"Photos", items:[ {k:"photos", t:"check", label:"Photos prises"} ] },
      LINGE: {
        title:"Linge",
        items:[
          {k:"lingeDraps", t:"check", label:"Changement draps"},
          {k:"lingeServiettes", t:"check", label:"Serviettes"}
        ]
      },
      BLANCHISSERIE: {
        title:"Blanchisserie",
        items:[
          {k:"blanchisserieCollecte", t:"check", label:"Collecte"},
          {k:"blanchisserieDepose", t:"check", label:"Dépose"},
          {k:"blanchisserieRecup", t:"check", label:"Récupération"}
        ]
      },
      KITS: {
        title:"Kits",
        items:[
          {k:"kitEssentiel", t:"tri", label:"Kit essentiel"},
          {k:"kitCuisine", t:"tri", label:"Kit cuisine"},
          {k:"kitBain", t:"tri", label:"Kit bain"},
          {k:"kitSejour", t:"tri", label:"Kit séjour"}
        ]
      },
      REASSORT: {
        title:"Réassort",
        items:[
          {k:"reassort", t:"check", label:"Réassort effectué"},
          {k:"reassortComment", t:"text", label:"Commentaire réassort"}
        ]
      },
      MAINTENANCE: {
        title:"Petite maintenance",
        items:[
          {k:"maintenanceRemplacement", t:"check", label:"Remplacement"},
          {k:"maintenanceTest", t:"check", label:"Test"},
          {k:"maintenancePhoto", t:"check", label:"Photo"}
        ]
      },
      URGENCE: {
        title:"Urgence",
        items:[
          {k:"urgenceMiseSecurite", t:"check", label:"Mise en sécurité"},
          {k:"urgenceCompteRendu", t:"text", label:"Compte-rendu"}
        ]
      },
      CHECKIN_BASE: {
        title:"Check-in",
        items:[
          {k:"accueil", t:"check", label:"Accueil"},
          {k:"remiseClesOuCode", t:"check", label:"Remise clés / code"},
          {k:"verifKitAccueil", t:"check", label:"Vérif kit d’accueil"}
        ]
      },
      CHECKOUT_BASE: {
        title:"Check-out",
        items:[
          {k:"recupClesOuChgtCode", t:"check", label:"Récupération clés / changement code"}
        ]
      },
      ANOMALIES: { title:"Anomalies", items:[ {k:"anomalies", t:"check", label:"Anomalies signalées"} ] },
      SECURISATION: { title:"Sécurisation", items:[ {k:"securisation", t:"check", label:"Remise en sécurité"} ] },
      COMMENT: { title:"Commentaire", items:[ {k:"comment", t:"text", label:"Commentaire"} ] }
    };

    function renderChecklist(visibleGroups, checklist){
      groupsEl.innerHTML = "";

      for(const gKey of visibleGroups){
        const g = GROUPS[gKey];
        if(!g) continue;

        const box = document.createElement("div");
        box.className = "group";
        box.innerHTML = `<div class="gtitle">${g.title}</div>`;
        const inner = document.createElement("div");
        inner.className = "row";
        box.appendChild(inner);

        for(const it of g.items){
          const wrap = document.createElement("div");

          if(it.t === "check"){
            wrap.innerHTML = `
              <div class="check">
                <input type="checkbox" id="${it.k}">
                <label for="${it.k}">${it.label}</label>
              </div>
            `;
            inner.appendChild(wrap);
            const el = wrap.querySelector("input");
            el.checked = !!checklist[it.k];
          }

          if(it.t === "tri"){
            const val = (checklist[it.k] || "NA").toString().toUpperCase();
            wrap.innerHTML = `
              <div class="radioLine">
                <b>${it.label}</b>
                <label><input type="radio" name="${it.k}" value="OUI"> OUI</label>
                <label><input type="radio" name="${it.k}" value="NON"> NON</label>
                <label><input type="radio" name="${it.k}" value="NA"> N/A</label>
              </div>
            `;
            inner.appendChild(wrap);
            const radios = wrap.querySelectorAll(`input[name="${it.k}"]`);
            radios.forEach(r => { if(r.value === val) r.checked = true; });
            if(!wrap.querySelector(`input[name="${it.k}"]:checked`)){
              wrap.querySelector(`input[name="${it.k}"][value="NA"]`).checked = true;
            }
          }

          if(it.t === "text"){
            wrap.innerHTML = `
              <label style="display:block; font-size:11px; font-weight:900; color:#444; margin:0 0 4px;">${it.label}</label>
              <textarea id="${it.k}" placeholder="—"></textarea>
            `;
            inner.appendChild(wrap);
            wrap.querySelector("textarea").value = (checklist[it.k] || "").toString();
          }
        }

        groupsEl.appendChild(box);
      }
    }

    function collectChecklistFromUI(visibleGroups, checklist){
      const out = { ...(checklist || {}) };

      for(const gKey of visibleGroups){
        const g = GROUPS[gKey];
        if(!g) continue;

        for(const it of g.items){
          if(it.t === "check"){
            const el = document.getElementById(it.k);
            if(el) out[it.k] = !!el.checked;
          }
          if(it.t === "tri"){
            const checked = document.querySelector(`input[name="${it.k}"]:checked`);
            out[it.k] = (checked ? checked.value : "NA");
          }
          if(it.t === "text"){
            const el = document.getElementById(it.k);
            if(el) out[it.k] = (el.value || "").toString();
          }
        }
      }

      return out;
    }

    async function loadAll(){
      hideAlert();

      if(!token || !prestationId || !missionId){
        showAlert("⛔ Paramètres manquants (token / prestationId / missionId).");
        return;
      }

      // token
      const tSnap = await getDoc(doc(db, "dayTokens", token));
      if(!tSnap.exists()){
        showAlert("⛔ Token invalide.");
        statusPill.textContent = "Token invalide";
        statusPill.className = "pill bad";
        return;
      }
      tokenDoc = tSnap.data() || {};

      if(tokenDoc.active === false){
        showAlert("⛔ Token désactivé.");
        statusPill.textContent = "Token OFF";
        statusPill.className = "pill bad";
        return;
      }

      agentLine.textContent = `${tokenDoc.agentName || "Agent"}${tokenDoc.agentEmail ? " • " + tokenDoc.agentEmail : ""}`.trim();

      // mission
      const mRef = doc(db, "events", prestationId, "missions", missionId);
      const mSnap = await getDoc(mRef);
      if(!mSnap.exists()){
        showAlert("⛔ Mission introuvable.");
        return;
      }
      missionDoc = { id: mSnap.id, ...(mSnap.data()||{}) };

      missionTitle.textContent = typeLabel(missionId);

      const st = (missionDoc.status || "ASSIGNEE").toUpperCase();
      statusPill.textContent = statusLabel(st);
      statusPill.className = "pill " + (st === "VALIDEE" ? "ok" : (st === "INCIDENT" ? "bad" : ""));

      // contexte (best effort via mission doc + event doc si lisible)
      let home = missionDoc.homeName || "";
      let city = missionDoc.homeCity || "";
      let addr = missionDoc.homeAddress || "";
      let dt = `${missionDoc.dateKey || ""}${missionDoc.time ? " à " + missionDoc.time : ""}`.trim();

      // si pas d’infos dans mission, on tente event (peut être interdit par rules, donc catch)
      if(!home && !dt){
        try{
          const pSnap = await getDoc(doc(db, "events", prestationId));
          if(pSnap.exists()){
            const p = pSnap.data() || {};
            home = p.homeName || "";
            city = p.homeCity || p.city || "";
            addr = p.homeAddress || p.address || "";
            dt = `${p.dateKey || p.date || ""}${p.time ? " à " + p.time : ""}`.trim();
          }
        }catch{}
      }

      const homeLine = `${home || "Logement"}${city ? " — " + city : ""}`.trim();
      contextLine.textContent = `${homeLine}${addr ? " • " + addr : ""}${dt ? " • " + dt : ""}`.trim();

      // groupes visibles
      const visible = Array.isArray(missionDoc?.checklistMeta?.visibleGroups)
        ? missionDoc.checklistMeta.visibleGroups
        : defaultVisibleGroups(missionId);

      // checklist
      const checklist = (missionDoc.checklist && typeof missionDoc.checklist === "object") ? missionDoc.checklist : {};
      renderChecklist(visible, checklist);

      // boutons
      doneBtn.disabled = (missionDoc.locked === true);
      saveBtn.disabled = (missionDoc.locked === true);

      // handlers
      saveBtn.onclick = ()=> saveChecklist(false);
      doneBtn.onclick = ()=> saveChecklist(true);

      statusPill.textContent = "OK";
      statusPill.className = "pill ok";
    }

    function defaultVisibleGroups(mid){
      if(mid === "CHECKIN") return ["CHECKIN_BASE","COMMENT"];
      if(mid === "CHECKOUT") return ["CHECKOUT_BASE","PHOTOS","ANOMALIES","SECURISATION","COMMENT"];
      return ["MENAGE_BASE","PHOTOS","LINGE","BLANCHISSERIE","KITS","REASSORT","MAINTENANCE","URGENCE","COMMENT"];
    }

    async function saveChecklist(markDone){
      hideAlert();
      if(!missionDoc) return;

      const visible = Array.isArray(missionDoc?.checklistMeta?.visibleGroups)
        ? missionDoc.checklistMeta.visibleGroups
        : defaultVisibleGroups(missionId);

      const prev = (missionDoc.checklist && typeof missionDoc.checklist === "object") ? missionDoc.checklist : {};
      const nextChecklist = collectChecklistFromUI(visible, prev);

      const patch = {
        checklist: nextChecklist,
        updatedAt: serverTimestamp()
      };

      if(markDone){
        patch.agentDone = true;
        patch.agentDoneAt = serverTimestamp();
        patch.status = "A_VALIDER"; // l’agent termine -> à valider conciergerie
      }else{
        patch.status = missionDoc.status || "EN_COURS";
      }

      try{
        await updateDoc(doc(db, "events", prestationId, "missions", missionId), patch);
        showAlert(markDone ? "✅ Mission terminée (à valider)." : "✅ Enregistré.", true);

        // refresh local state
        const mSnap = await getDoc(doc(db, "events", prestationId, "missions", missionId));
        missionDoc = { id: mSnap.id, ...(mSnap.data()||{}) };

        const st = (missionDoc.status || "ASSIGNEE").toUpperCase();
        statusPill.textContent = statusLabel(st);
        statusPill.className = "pill " + (st === "VALIDEE" ? "ok" : (st === "INCIDENT" ? "bad" : ""));
      }catch(err){
        console.error(err);
        showAlert("Erreur sauvegarde : " + (err?.message || "inconnue"));
      }
    }

    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          await signInAnonymously(auth);
          return;
        }
        currentUser = user;
        await loadAll();
      }catch(err){
        console.error(err);
        showAlert("Erreur : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
