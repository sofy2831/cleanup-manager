<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Conciergerie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    button.pill-link{
      border:none;
      border-radius:999px;
    }

    /* mini nav desktop */
    .top-nav{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      padding:0;
    }
    .top-nav a{
      text-decoration:none;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      color:#5b45c8;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(122,92,255,.25);
    }
    .top-nav a:hover{
      background:#fff;
      border-color:rgba(122,92,255,.45);
    }
    .top-nav a.active{
      background:rgba(122,92,255,.18);
      border-color:rgba(122,92,255,.55);
      color:#3f2fb6;
      font-weight:900;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:14px;
    }
    @media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr);} }

    .kpi-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:10px 10px 12px;
      text-align:left;
    }
    .kpi-title{font-size:12px;color:#666;font-weight:800;margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:900;color:#222;}
    .kpi-note{font-size:11px;color:#666;margin-top:2px;}

    .modules{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-top:16px;
    }
    @media(min-width:900px){ .modules{ grid-template-columns:repeat(3,1fr);} }

    .card-link{ text-decoration:none; color:inherit; display:block; }
    .module-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      transition:transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
      height:100%;
    }
    .module-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .module-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-weight:900;
      font-size:14px;
      color:#222;
      margin-bottom:6px;
    }
    .module-desc{
      font-size:13px;
      color:#555;
      line-height:1.35;
    }
    .chip{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:16px;
      font-size:12px;
      color:#666;
      text-align:center;
    }

    /* Masquer la mini top-nav sur mobile (évite le doublon) */
    @media (max-width: 520px){
      .top-nav{ display:none; }
    }

    /* Bottom-nav mobile */
    .bottom-nav{ display:none; }

    @media (max-width: 520px){
      .page{ padding-bottom: 86px; } /* laisse la place au bandeau */

      .bottom-nav{
        display:flex;
        position:fixed;
        left:12px; right:12px; bottom:12px;
        background: rgba(255,255,255,0.92);
        border:1px solid rgba(122,92,255,.25);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
        padding:10px;
        gap:8px;
        justify-content:space-between;
        z-index:9999;
        backdrop-filter: blur(10px);
      }
      .bottom-nav a{
        flex:1;
        text-decoration:none;
        font-size:12px;
        font-weight:900;
        color:#5b45c8;
        background: rgba(122,92,255,.10);
        border-radius: 12px;
        padding:10px 8px;
        text-align:center;
      }
      .bottom-nav a.active{
        background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
        color:#fff;
      }
    }
  </style>
</head>

<body>

<!-- ===== Session + garde ===== -->
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }

  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }

  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }

  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;

    // si session locale dit pas actif -> on laisse le module Firestore confirmer,
    // mais on évite de bloquer brutalement ici
  })();
</script>

<!-- ===== Sync Firestore subscription ===== -->
<script type="module">
  import { db } from "./firebase-init.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function setSession(s){
    localStorage.setItem("cm_auth", JSON.stringify(s));
  }

  async function syncSubscription(){
    const s = getSession();
    if(!s || !s.uid) return;

    try{
      const snap = await getDoc(doc(db, "users", s.uid));
      if(!snap.exists()) return;

      const u = snap.data() || {};
      const active = (u.subscriptionStatus === "active");

      s.planActive = !!active;
      s.plan = u.plan || s.plan || "";
      setSession(s);

      if(!active){
        location.href = "abonnement.html?plan=starter";
      }
    }catch(err){
      console.warn("syncSubscription failed:", err);
    }
  }

  syncSubscription();
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="index.html">← Accueil</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Ouvrir le planning</a>
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Tableau de bord</div>
  <div class="badge">Piloter • planifier • facturer • communiquer</div>

  <div class="top-nav">
    <a href="conciergerie.html" class="active">Menu</a>
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="invite.html">Inviter</a>
    <a href="demandes.html">Demandes</a>
    <a href="messagerie.html">Messagerie</a>
  </div>

  <div class="kpis">
    <div class="kpi-card">
      <div class="kpi-title">Aujourd’hui</div>
      <div class="kpi-value" id="kpiToday">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Cette semaine</div>
      <div class="kpi-value" id="kpiWeek">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Événements</div>
      <div class="kpi-value" id="kpiEvents">—</div>
      <div class="kpi-note">total</div>
    </div>

    <a href="logements.html" class="card-link">
      <div class="kpi-card">
        <div class="kpi-title">Logements actifs</div>
        <div class="kpi-value" id="kpiHomes">—</div>
        <div class="kpi-note">gérés</div>
      </div>
    </a>
  </div>

  <div class="modules">
    <a class="card-link" href="planning.html">
      <div class="module-card">
        <div class="module-title">Planning <span class="chip">réel</span></div>
        <div class="module-desc">Calendrier + agenda.</div>
      </div>
    </a>

    <a class="card-link" href="logements.html">
      <div class="module-card">
        <div class="module-title">Logements <span class="chip">réel</span></div>
        <div class="module-desc">Gestion + ajout des logements.</div>
      </div>
    </a>

    <a class="card-link" href="prestations.html">
      <div class="module-card">
        <div class="module-title">Prestations <span class="chip">réel</span></div>
        <div class="module-desc">Catalogue des services (tarifs / durées).</div>
      </div>
    </a>

    <a class="card-link" href="invite.html">
      <div class="module-card">
        <div class="module-title">Inviter un propriétaire <span class="chip">V1</span></div>
        <div class="module-desc">Générer un lien d’invitation.</div>
      </div>
    </a>

    <a class="card-link" href="demandes.html">
      <div class="module-card">
        <div class="module-title">Demandes propriétaires <span class="chip">V1</span></div>
        <div class="module-desc">Accepter / traiter les demandes.</div>
      </div>
    </a>

    <a class="card-link" href="messagerie.html">
      <div class="module-card">
        <div class="module-title">Messagerie <span class="chip">réel</span></div>
        <div class="module-desc">Messages conciergerie ↔ propriétaires.</div>
      </div>
    </a>
  </div>

  <div class="foot">
    V1 stable : dashboard léger + modules + navigation mobile.
  </div>

</div>

<!-- ===== KPIs data (localStorage V1) ===== -->
<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }

  function saveData(d){
    localStorage.setItem(DATA_KEY, JSON.stringify(d));
  }

  function ensureData(){
    const existing = loadData();
    if(existing) return existing;

    const seeded = {
      homes:[],
      events:[],
      services:[],
      threads:[],
      payments:[],
      icalSources:[],
      kits:[],
      invitations:[],
      owners:[],
      requests:[]
    };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.homes = Array.isArray(app.homes) ? app.homes : [];
  app.events = Array.isArray(app.events) ? app.events : [];

  (function migrate(){
    let changed = false;
    app.homes.forEach(h=>{ if(!h.id){ h.id = uid("h"); changed = true; }});
    app.events.forEach(e=>{ if(!e.id){ e.id = uid("e"); changed = true; }});
    if(changed) saveData(app);
  })();

  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function dateKey(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }

  function countToday(){
    const k = dateKey(new Date());
    return app.events.filter(e => e.date === k).length;
  }

  function countWeek(){
    const today = new Date();
    let total = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
      const k = dateKey(d);
      total += app.events.filter(e => e.date === k).length;
    }
    return total;
  }

  function renderKpis(){
    const elHomes = document.getElementById("kpiHomes");
    const elEvents = document.getElementById("kpiEvents");
    const elToday = document.getElementById("kpiToday");
    const elWeek = document.getElementById("kpiWeek");
    if(!elHomes || !elEvents || !elToday || !elWeek) return;

    elHomes.textContent = app.homes.length;
    elEvents.textContent = app.events.length;
    elToday.textContent = countToday();
    elWeek.textContent = countWeek();
  }

  renderKpis();
</script>

<!-- Bottom nav mobile -->
<nav class="bottom-nav">
  <a href="conciergerie.html" class="active">Menu</a>
  <a href="planning.html">Planning</a>
  <a href="logements.html">Logements</a>
  <a href="demandes.html">Demandes</a>
</nav>

</body>
</html>
