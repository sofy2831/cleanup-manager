<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Conciergerie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    button.pill-link{
      border:none;
      border-radius:999px;
    }

    /* mini nav desktop */
    .top-nav{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      padding:0;
    }
    .top-nav a{
      text-decoration:none;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      color:#5b45c8;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(122,92,255,.25);
    }
    .top-nav a:hover{
      background:#fff;
      border-color:rgba(122,92,255,.45);
    }
    .top-nav a.active{
      background:rgba(122,92,255,.18);
      border-color:rgba(122,92,255,.55);
      color:#3f2fb6;
      font-weight:900;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }

    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    /* Badge demandes pending */
    .badge.pending{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      margin-top:10px;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#333;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      border:1px solid rgba(122,92,255,.25);
      font-weight:900;
    }

    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:14px;
    }
    @media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr);} }

    .kpi-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:10px 10px 12px;
      text-align:left;
    }
    .kpi-title{font-size:12px;color:#666;font-weight:800;margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:900;color:#222;}
    .kpi-note{font-size:11px;color:#666;margin-top:2px;}

    .modules{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-top:16px;
    }
    @media(min-width:900px){ .modules{ grid-template-columns:repeat(3,1fr);} }

    .card-link{ text-decoration:none; color:inherit; display:block; }
    .module-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      transition:transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
      height:100%;
    }
    .module-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .module-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-weight:900;
      font-size:14px;
      color:#222;
      margin-bottom:6px;
    }
    .module-desc{
      font-size:13px;
      color:#555;
      line-height:1.35;
    }
    .chip{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:16px;
      font-size:12px;
      color:#666;
      text-align:center;
    }

    /* Masquer la mini top-nav sur mobile */
    @media (max-width: 520px){
      .top-nav{ display:none; }
    }

    /* Bottom-nav mobile */
    .bottom-nav{ display:none; }

    @media (max-width: 520px){
      .page{ padding-bottom: 86px; }

      .bottom-nav{
        display:flex;
        position:fixed;
        left:12px; right:12px; bottom:12px;
        background: rgba(255,255,255,0.92);
        border:1px solid rgba(122,92,255,.25);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
        padding:10px;
        gap:8px;
        justify-content:space-between;
        z-index:9999;
        backdrop-filter: blur(10px);
      }
      .bottom-nav a{
        flex:1;
        text-decoration:none;
        font-size:12px;
        font-weight:900;
        color:#5b45c8;
        background: rgba(122,92,255,.10);
        border-radius: 12px;
        padding:10px 8px;
        text-align:center;
      }
      .bottom-nav a.active{
        background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
        color:#fff;
      }
    }
  </style>
</head>

<body>

<!-- ===== Firebase guard + subscription + badge + KPIs (NO localStorage) ===== -->
<script type="module">
  import { db, auth } from "./firebase-init.js";

  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, query, where, onSnapshot, getCountFromServer
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- logout (appelé par ton bouton)
  window.logout = async function(){
    try { await signOut(auth); } catch(e){}
    location.href = "index.html";
  };

  // ---- DOM
  const pendingBadge = document.getElementById("pendingBadge");
  const kpiToday  = document.getElementById("kpiToday");
  const kpiWeek   = document.getElementById("kpiWeek");
  const kpiEvents = document.getElementById("kpiEvents");
  const kpiHomes  = document.getElementById("kpiHomes");

  function setPending(v){
    if(pendingBadge) pendingBadge.textContent = `Demandes en attente : ${v}`;
  }
  function setText(el, v){
    if(el) el.textContent = String(v);
  }

  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function dateKey(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }

  function nextDaysKeys(n){
    const today = new Date();
    const keys = [];
    for(let i=0;i<n;i++){
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
      keys.push(dateKey(d));
    }
    return keys;
  }

  async function requireUserAndRole(user){
    const uref = doc(db, "users", user.uid);
    const usnap = await getDoc(uref);
    if(!usnap.exists()){
      location.href = "login.html?role=conciergerie";
      throw new Error("Missing user profile (users/{uid})");
    }

    const u = usnap.data() || {};
    const role = u.role || "";
    if(role !== "conciergerie" && role !== "admin"){
      location.href = "login.html?role=conciergerie";
      throw new Error("Forbidden role");
    }

    const active = (u.subscriptionStatus === "active");
    if(!active){
      location.href = "abonnement.html?plan=starter";
      throw new Error("Subscription inactive");
    }

    return u;
  }

  function attachPendingBadge(uid){
    const qPending = query(
      collection(db, "requests"),
      where("conciergerieUid", "==", uid),
      where("status", "==", "pending")
    );

    return onSnapshot(qPending, (snap) => {
      setPending(snap.size);
    }, (err) => {
      console.error("pendingBadge snapshot error:", err);
      setPending("Erreur");
    });
  }

  async function attachKpis(uid){
    // Homes count
    try{
      const qHomes = query(collection(db, "homes"), where("conciergerieUid", "==", uid));
      const homesCount = await getCountFromServer(qHomes);
      setText(kpiHomes, homesCount.data().count);
    }catch(e){
      console.warn("kpiHomes failed:", e);
      setText(kpiHomes, "—");
    }

    // Total events count
    try{
      const qEvents = query(collection(db, "events"), where("conciergerieUid", "==", uid));
      const eventsCount = await getCountFromServer(qEvents);
      setText(kpiEvents, eventsCount.data().count);
    }catch(e){
      console.warn("kpiEvents failed:", e);
      setText(kpiEvents, "—");
    }

    // Today + Week (next 7 days) - realtime
    const keys7 = nextDaysKeys(7);
    const todayKey = keys7[0];

    // Firestore limite "in" = 10 valeurs => OK
    const qWeek = query(
      collection(db, "events"),
      where("conciergerieUid", "==", uid),
      where("date", "in", keys7)
    );

    return onSnapshot(qWeek, (snap) => {
      let today = 0;
      let week = snap.size;

      snap.forEach(d => {
        const data = d.data() || {};
        if(data.date === todayKey) today++;
      });

      setText(kpiToday, today);
      setText(kpiWeek, week);
    }, (err) => {
      console.error("kpiWeek snapshot error:", err);
      setText(kpiToday, "—");
      setText(kpiWeek, "—");
    });
  }

  // ---- Boot
  let unsubPending = null;
  let unsubWeek = null;

  onAuthStateChanged(auth, async (user) => {
    // reset UI
    setPending("—");
    setText(kpiHomes, "—");
    setText(kpiEvents, "—");
    setText(kpiToday, "—");
    setText(kpiWeek, "—");

    // cleanup listeners
    if(unsubPending) { try{ unsubPending(); }catch(e){} unsubPending = null; }
    if(unsubWeek) { try{ unsubWeek(); }catch(e){} unsubWeek = null; }

    if(!user){
      location.href = "login.html?role=conciergerie";
      return;
    }

    try{
      await requireUserAndRole(user);
      unsubPending = attachPendingBadge(user.uid);
      unsubWeek = await attachKpis(user.uid);
    }catch(e){
      console.warn("Guard blocked:", e);
      // redirection déjà faite dans requireUserAndRole()
    }
  });
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="index.html">← Accueil</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Ouvrir le planning</a>
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Tableau de bord</div>

  <!-- Badge demandes en attente -->
  <div class="badge pending" id="pendingBadge">Demandes en attente : —</div>

  <div class="badge">Piloter • planifier • facturer • communiquer</div>

  <div class="top-nav">
    <a href="conciergerie.html" class="active">Menu</a>
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="invite.html">Inviter</a>
    <a href="demandes.html">Demandes</a>
    <a href="messagerie.html">Messagerie</a>
  </div>

  <div class="kpis">
    <div class="kpi-card">
      <div class="kpi-title">Aujourd’hui</div>
      <div class="kpi-value" id="kpiToday">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Cette semaine</div>
      <div class="kpi-value" id="kpiWeek">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Événements</div>
      <div class="kpi-value" id="kpiEvents">—</div>
      <div class="kpi-note">total</div>
    </div>

    <a href="logements.html" class="card-link">
      <div class="kpi-card">
        <div class="kpi-title">Logements actifs</div>
        <div class="kpi-value" id="kpiHomes">—</div>
        <div class="kpi-note">gérés</div>
      </div>
    </a>
  </div>

  <div class="modules">
    <a class="card-link" href="planning.html">
      <div class="module-card">
        <div class="module-title">Planning <span class="chip">réel</span></div>
        <div class="module-desc">Calendrier + agenda.</div>
      </div>
    </a>

    <a class="card-link" href="logements.html">
      <div class="module-card">
        <div class="module-title">Logements <span class="chip">réel</span></div>
        <div class="module-desc">Gestion + ajout des logements.</div>
      </div>
    </a>

    <a class="card-link" href="prestations.html">
      <div class="module-card">
        <div class="module-title">Prestations <span class="chip">réel</span></div>
        <div class="module-desc">Catalogue des services (tarifs / durées).</div>
      </div>
    </a>

    <a class="card-link" href="invite.html">
      <div class="module-card">
        <div class="module-title">Inviter un propriétaire <span class="chip">V1</span></div>
        <div class="module-desc">Générer un lien d’invitation.</div>
      </div>
    </a>

    <a class="card-link" href="demandes.html">
      <div class="module-card">
        <div class="module-title">Demandes propriétaires <span class="chip">V1</span></div>
        <div class="module-desc">Accepter / traiter les demandes.</div>
      </div>
    </a>

    <a class="card-link" href="messagerie.html">
      <div class="module-card">
        <div class="module-title">Messagerie <span class="chip">réel</span></div>
        <div class="module-desc">Messages conciergerie ↔ propriétaires.</div>
      </div>
    </a>
  </div>

  <div class="foot">
    V1 stable : dashboard léger + modules + navigation mobile.
  </div>

</div>

<!-- Bottom nav mobile -->
<nav class="bottom-nav">
  <a href="conciergerie.html" class="active">Menu</a>
  <a href="planning.html">Planning</a>
  <a href="logements.html">Logements</a>
  <a href="demandes.html">Demandes</a>
</nav>

</body>
</html>
