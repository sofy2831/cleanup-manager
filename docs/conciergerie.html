<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Conciergerie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --ok:#1b8f4d;
      --bad:#b3261e;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    button.pill-link{
      border:none;
      border-radius:999px;
    }

    /* mini nav desktop */
    .top-nav{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      padding:0;
    }
    .top-nav a{
      text-decoration:none;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      color:#5b45c8;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(122,92,255,.25);
    }
    .top-nav a:hover{
      background:#fff;
      border-color:rgba(122,92,255,.45);
    }
    .top-nav a.active{
      background:rgba(122,92,255,.18);
      border-color:rgba(122,92,255,.55);
      color:#3f2fb6;
      font-weight:900;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }

    .badge{
      margin-top:10px;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
    }
    .badge .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--ok);
      box-shadow:0 0 0 3px rgba(27,143,77,.12);
    }
    .badge.warn .dot{ background:var(--bad); box-shadow:0 0 0 3px rgba(179,38,30,.12); }
    .badge strong{ font-weight:900; }

    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:14px;
    }
    @media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr);} }

    .kpi-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:10px 10px 12px;
      text-align:left;
    }
    .kpi-title{font-size:12px;color:#666;font-weight:800;margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:900;color:#222;}
    .kpi-note{font-size:11px;color:#666;margin-top:2px;}

    .modules{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-top:16px;
    }
    @media(min-width:900px){ .modules{ grid-template-columns:repeat(2,1fr);} }

    .card-link{ text-decoration:none; color:inherit; display:block; }
    .module-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      transition:transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
      height:100%;
    }
    .module-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .module-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-weight:900;
      font-size:14px;
      color:#222;
      margin-bottom:6px;
    }
    .module-desc{
      font-size:13px;
      color:#555;
      line-height:1.35;
    }
    .chip{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:16px;
      font-size:12px;
      color:#666;
      text-align:center;
    }

    @media (max-width: 520px){
      .top-nav{ display:none; }
    }

    .bottom-nav{ display:none; }

    @media (max-width: 520px){
      .page{ padding-bottom: 86px; }

      .bottom-nav{
        display:flex;
        position:fixed;
        left:12px; right:12px; bottom:12px;
        background: rgba(255,255,255,0.92);
        border:1px solid rgba(122,92,255,.25);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
        padding:10px;
        gap:8px;
        justify-content:space-between;
        z-index:9999;
        backdrop-filter: blur(10px);
      }
      .bottom-nav a{
        flex:1;
        text-decoration:none;
        font-size:12px;
        font-weight:900;
        color:#5b45c8;
        background: rgba(122,92,255,.10);
        border-radius: 12px;
        padding:10px 8px;
        text-align:center;
      }
      .bottom-nav a.active{
        background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
        color:#fff;
      }
    }
  </style>
</head>

<body>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    doc, getDoc,
    collection, query, where, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // === ADMIN GRATUIT ===
  const FREE_EMAILS = new Set([
    "mathilde.debout31@gmail.com",
    "s.dumas974@gmail.com"
  ]);

  // UI refs
  const kpiToday = () => document.getElementById("kpiToday");
  const kpiWeek = () => document.getElementById("kpiWeek");
  const kpiEvents = () => document.getElementById("kpiEvents");
  const kpiHomes = () => document.getElementById("kpiHomes");
  const statusBadge = () => document.getElementById("statusBadge");

  window.logout = async function logout(){
    try{ await signOut(auth); }catch(e){}
    location.href = "index.html";
  };

  function setBadge(ok, text){
    const el = statusBadge();
    if(!el) return;
    el.classList.toggle("warn", !ok);
    el.innerHTML = `<span class="dot"></span><span>${text}</span>`;
  }

  function setKpi(el, val){
    if(!el) return;
    el.textContent = (val === null || val === undefined) ? "—" : String(val);
  }

  function mondayOfWeek(d){
    const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = x.getDay(); // 0=dim
    const diff = (day === 0 ? -6 : 1) - day;
    x.setDate(x.getDate() + diff);
    x.setHours(0,0,0,0);
    return x;
  }

  // === IMPORTANT ===
  // Ici j'assume :
  // - logements dans collection "homes" avec champ conciergerieUid
  // - événements/prestations dans collection "events" avec champ conciergerieUid + champ dateKey "YYYY-MM-DD"
  //
  // Si ton schéma est différent, tu me le dis et je le recale.
  function dateKey(d){
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  let unsubHomes = null;
  let unsubEvents = null;

  function bindKpis(uid){
    // HOMES count
    if(unsubHomes) unsubHomes();
    const qHomes = query(
      collection(db, "homes"),
      where("conciergerieUid", "==", uid)
    );
    unsubHomes = onSnapshot(qHomes, (snap)=>{
      setKpi(kpiHomes(), snap.size);
    }, (err)=>{
      console.warn("homes KPI error:", err);
      setKpi(kpiHomes(), "—");
    });

    // EVENTS total + today + week
    if(unsubEvents) unsubEvents();
    const qEvents = query(
      collection(db, "events"),
      where("conciergerieUid", "==", uid)
    );

    unsubEvents = onSnapshot(qEvents, (snap)=>{
      const all = [];
      snap.forEach(docSnap => all.push(docSnap.data() || {}));

      const today = new Date();
      const todayKey = dateKey(today);

      const weekStart = mondayOfWeek(today);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate()+7);

      let total = all.length;
      let countToday = 0;
      let countWeek = 0;

      for(const ev of all){
        const dk = String(ev.dateKey || ev.date || "").trim(); // tolérant
        if(dk === todayKey) countToday++;

        // comptage semaine basé sur dateKey
        if(dk && /^\d{4}-\d{2}-\d{2}$/.test(dk)){
          const dt = new Date(dk + "T00:00:00");
          if(dt >= weekStart && dt < weekEnd) countWeek++;
        }
      }

      setKpi(kpiEvents(), total);
      setKpi(kpiToday(), countToday);
      setKpi(kpiWeek(), countWeek);

    }, (err)=>{
      console.warn("events KPI error:", err);
      setKpi(kpiEvents(), "—");
      setKpi(kpiToday(), "—");
      setKpi(kpiWeek(), "—");
    });
  }

  async function loadUserProfile(uid){
    try{
      const snap = await getDoc(doc(db, "users", uid));
      if(!snap.exists()) return null;
      return snap.data() || null;
    }catch(err){
      console.warn("profile read failed:", err);
      return null;
    }
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      location.href = "login.html?role=conciergerie";
      return;
    }

    // profil Firestore
    const profile = await loadUserProfile(user.uid);
    const email = (user.email || "").toLowerCase();
    const isFree = FREE_EMAILS.has(email);

    const role = (profile?.role || "conciergerie").toLowerCase();
    if(role !== "conciergerie" && role !== "admin"){
      // mauvais rôle = dehors
      location.href = "login.html?role=conciergerie";
      return;
    }

    const sub = (profile?.subscriptionStatus || "").toLowerCase();
    const active = isFree ? true : (sub === "active");

    if(!active){
      location.href = "abonnement.html?plan=starter";
      return;
    }

    // OK : on est loggé + actif
    setBadge(true, isFree ? "Compte admin (gratuit) • accès actif" : "Abonnement actif • accès complet");
    bindKpis(user.uid);
  });
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="index.html">← Accueil</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Ouvrir le planning</a>
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Tableau de bord conciergerie</div>

  <div class="badge" id="statusBadge">
    <span class="dot"></span>
    <span>Vérification accès…</span>
  </div>

  <div class="top-nav">
    <a href="conciergerie.html" class="active">Menu</a>
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="invite.html">Inviter</a>
    <a href="demandes.html">Demandes</a>
    <a href="prestations.html">Prestations</a>
    <a href="messagerie.html">Messagerie</a>
  </div>

  <div class="kpis">
    <div class="kpi-card">
      <div class="kpi-title">Aujourd’hui</div>
      <div class="kpi-value" id="kpiToday">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Cette semaine</div>
      <div class="kpi-value" id="kpiWeek">—</div>
      <div class="kpi-note">prestations</div>
    </div>

    <div class="kpi-card">
      <div class="kpi-title">Événements</div>
      <div class="kpi-value" id="kpiEvents">—</div>
      <div class="kpi-note">total</div>
    </div>

    <a href="logements.html" class="card-link">
      <div class="kpi-card">
        <div class="kpi-title">Logements actifs</div>
        <div class="kpi-value" id="kpiHomes">—</div>
        <div class="kpi-note">gérés</div>
      </div>
    </a>
  </div>

  <div class="modules">
    <a class="card-link" href="invite.html">
      <div class="module-card">
        <div class="module-title">Inviter un propriétaire <span class="chip">V1</span></div>
        <div class="module-desc">Générer un lien d’invitation et rattacher un propriétaire.</div>
      </div>
    </a>

    <a class="card-link" href="logements.html">
      <div class="module-card">
        <div class="module-title">Ajouter un logement <span class="chip">réel</span></div>
        <div class="module-desc">Créer un logement + infos + iCal (ensuite).</div>
      </div>
    </a>

    <a class="card-link" href="planning.html">
      <div class="module-card">
        <div class="module-title">Planning <span class="chip">réel</span></div>
        <div class="module-desc">Vision globale : ménages, check-in/out, réassort.</div>
      </div>
    </a>

    <a class="card-link" href="planning.html">
      <div class="module-card">
        <div class="module-title">Créer une prestation <span class="chip">V1</span></div>
        <div class="module-desc">Raccourci : choisir logement → prestation → date/heure.</div>
      </div>
    </a>
  </div>

  <div class="foot">
    V1 : 4 cartes principales + KPIs Firestore. Le reste passe par le menu.
  </div>

</div>

<nav class="bottom-nav">
  <a href="conciergerie.html" class="active">Menu</a>
  <a href="planning.html">Planning</a>
  <a href="logements.html">Logements</a>
  <a href="demandes.html">Demandes</a>
</nav>

</body>
</html>
