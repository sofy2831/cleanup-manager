<!-- docs/nouvelle-prestation.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Nouvelle prestation</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --violet-light:#F3ECFF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }
    *,*::before,*::after{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      padding-bottom:96px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .logo-title{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-top:10px; margin-bottom:6px; text-align:center;
    }
    .logo-icon{
      width:44px;height:44px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);font-size:22px;font-weight:800;
      position:relative;flex-shrink:0;
    }
    .logo-icon::after{ content:"✦"; position:absolute; top:-6px; right:-5px; font-size:12px; color:var(--violet-main); }
    h1{ margin:0; font-size:26px; font-weight:800; }
    .subtitle{ margin-top:2px; font-size:14px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:700; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    @media(min-width:860px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
    }
    .left{ flex:1.1; }
    .right{ flex:1; }

    .card-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-weight:800; font-size:15px;
      margin-bottom:10px;
    }
    .tiny{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }

    .kv{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      font-size:13px;
      color:#333;
    }
    .kv b{ font-weight:800; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:800;
      white-space:nowrap;
    }

    form{ display:flex; flex-direction:column; gap:10px; }
    label{ font-size:12px; font-weight:800; color:#333; text-align:left; }
    input, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    input:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn.ghost{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .btn-row{
      display:flex;
      gap:10px;
      margin-top:6px;
    }
    .btn-row .btn{ width:100%; }

    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid rgba(122,92,255,0.18);
      backdrop-filter: blur(10px);
    }
    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight: 800;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    @media(min-width: 860px){
      .bottom-nav{
        position: static;
        max-width: 980px;
        margin: 12px auto 0;
        border-top: none;
        border: 1px solid rgba(122,92,255,0.18);
        border-radius: 999px;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
      }
      .page{ padding-bottom: 32px; }
    }
    @media (max-width: 520px){
      .page{ padding-left:12px; padding-right:12px; }
      html, body{ overflow-x:hidden; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="planning.html">← Retour planning</a>
      <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Créer une prestation</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="alert" id="alertBox"></div>

    <div class="layout">
      <div class="card left">
        <div class="card-title">
          <span>Votre réservation</span>
          <span class="tag" id="contextTag">—</span>
        </div>

        <div class="kv" id="contextKv"></div>
      </div>

      <div class="card right">
        <div class="card-title">
          <span>Nouvelle prestation</span>
          <span class="tiny" id="homeLabel">—</span>
        </div>

        <form id="jobForm">
          <div>
            <label for="team">Agent / Équipe (optionnel)</label>
            <input id="team" placeholder="Ex. Sarah / Équipe A" />
          </div>

          <div>
            <label for="meta">Détail (optionnel)</label>
            <textarea id="meta" rows="4" placeholder="Ex. check-in, urgence, remarques..."></textarea>
          </div>

          <button class="btn primary" type="submit" id="createBtn">Continuer vers le catalogue</button>

          <div class="btn-row">
            <button class="btn ghost" type="button" id="sendQuoteBtn" disabled>Envoyer le devis</button>
            <button class="btn ghost" type="button" id="confirmBtn" disabled>Confirmer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <nav class="bottom-nav" aria-label="Navigation">
    <a href="planning.html">Planning</a>
    <a href="import-ical.html">iCal</a>
    <a href="messagerie.html">Messages</a>
    <a href="catalogue.html" class="active">Catalogue</a>
    <a href="logements.html">Logements</a>
  </nav>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      addDoc, collection, doc, getDoc, serverTimestamp, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");

    const contextTag = document.getElementById("contextTag");
    const contextKv = document.getElementById("contextKv");
    const homeLabel = document.getElementById("homeLabel");

    const teamEl = document.getElementById("team");
    const metaEl = document.getElementById("meta");
    const formEl = document.getElementById("jobForm");
    const createBtn = document.getElementById("createBtn");

    const sendQuoteBtn = document.getElementById("sendQuoteBtn");
    const confirmBtn = document.getElementById("confirmBtn");

    let currentUser = null;
    let currentHome = null;

    let createdEventId = null;
    let createdEventRef = null;

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    function escapeHtml(s){
      return String(s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return (p.get(name) || "").trim();
    }

    // Params depuis planning
    const homeId = getParam("homeId");                 // requis
    const dateKey = getParam("dateKey");               // requis
    const timeParam = getParam("time");                // optionnel
    const summary = getParam("summary");               // optionnel
    const icalEventId = getParam("icalEventId");       // optionnel
    const from = getParam("from") || (icalEventId ? "ical" : "manuel");

    // extras passés par planning si dispo
    const homeTypeParam = getParam("homeType");
    const teamParam = getParam("team");
    const ownerNameParam = getParam("ownerName");
    const ownerEmailParam = getParam("ownerEmail");

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    async function loadHome(){
      if(!homeId) throw new Error("homeId manquant.");
      const snap = await getDoc(doc(db, "homes", homeId));
      if(!snap.exists()) throw new Error("Logement introuvable (homeId).");

      const d = snap.data() || {};
      currentHome = {
        id: snap.id,
        name: d.name || "Logement",
        city: d.city || "",
        homeType: d.homeType || d.type || d.kind || homeTypeParam || "",
        defaultAgent: d.defaultAgent || d.agent || d.teamDefault || "",
        ownerUid: d.ownerUid || null,
        ownerName: d.ownerName || ownerNameParam || "",
        ownerEmail: d.ownerEmail || ownerEmailParam || ""
      };
    }

    function renderContext(){
      contextTag.textContent = (from === "ical") ? "Réservation iCal" : "Création manuelle";

      const ht = (currentHome?.homeType || "").trim();
      const homeText = currentHome
        ? (currentHome.name + (ht ? ` (${ht})` : "") + (currentHome.city ? ` — ${currentHome.city}` : ""))
        : "—";

      const rows = [];
      rows.push(`<div><b>Logement</b> : ${escapeHtml(homeText)}</div>`);
      rows.push(`<div><b>Propriétaire</b> : ${escapeHtml(currentHome?.ownerEmail || "—")}</div>`);
      rows.push(`<div><b>Date</b> : ${escapeHtml(dateKey || "—")}</div>`);
      rows.push(`<div><b>Heure</b> : ${escapeHtml(timeParam || "—")}</div>`);
      rows.push(`<div><b>Agent</b> : ${escapeHtml(teamEl.value || currentHome?.defaultAgent || "—")}</div>`);
      if(summary) rows.push(`<div><b>Réservation</b> : ${escapeHtml(summary)}</div>`);
      contextKv.innerHTML = rows.join("");

      homeLabel.textContent = currentHome ? (currentHome.name + (ht ? ` (${ht})` : "") + (currentHome.city ? ` — ${currentHome.city}` : "")) : "—";
    }

    function lockUI(locked){
      createBtn.disabled = !!locked;
      createBtn.style.opacity = locked ? "0.75" : "1";
    }
    function setStatusButtonsEnabled(enabled){
      sendQuoteBtn.disabled = !enabled;
      confirmBtn.disabled = !enabled;
      sendQuoteBtn.style.opacity = enabled ? "1" : "0.65";
      confirmBtn.style.opacity = enabled ? "1" : "0.65";
    }

    async function setEventStatus(newStatus){
      if(!createdEventRef) return showAlert("Crée d'abord la prestation (pas d'event à mettre à jour).");
      try{
        await updateDoc(createdEventRef, {
          status: newStatus,
          statusUpdatedAt: serverTimestamp()
        });
        showAlert(`✅ Statut mis à jour : ${newStatus}`, true);
      }catch(err){
        console.error(err);
        showAlert("Erreur MAJ statut : " + (err?.message || "inconnue"));
      }
    }

    sendQuoteBtn.addEventListener("click", ()=>{
      if(!createdEventId) return showAlert("Crée d’abord la prestation.");
      // Le devis récupèrera ownerEmail dans l’event, donc pré-rempli côté devis.
      location.href = `devis.html?eventId=${createdEventId}`;
    });

    confirmBtn.addEventListener("click", ()=> setEventStatus("CONFIRME"));

    formEl.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      if(!currentUser) return showAlert("Pas connecté Firebase.");
      if(!currentHome) return showAlert("Logement non chargé.");
      if(!dateKey) return showAlert("dateKey manquant (YYYY-MM-DD).");

      const team = (teamEl.value || "").trim() || (teamParam || "").trim() || (currentHome.defaultAgent || "").trim();
      const meta = (metaEl.value || "").trim();
      const time = (timeParam || "").trim() || "10:00";

      const payload = {
        conciergerieUid: currentUser.uid,

        homeId: currentHome.id,
        homeName: currentHome.name || "",
        homeCity: currentHome.city || "",
        homeType: currentHome.homeType || "",

        dateKey: dateKey,
        date: dateKey,

        time,
        team: team || "",
        agent: team || "",

        meta: meta || "",

        // ✅ workflow : on commence en brouillon interne
        status: "EN_COURS",

        source: (from === "ical") ? "ical" : "manuel",
        icalEventId: icalEventId || null,
        summary: summary || "",

        ownerUid: currentHome.ownerUid || null,
        ownerName: currentHome.ownerName || "",
        ownerEmail: currentHome.ownerEmail || "",

        createdAt: serverTimestamp()
      };

      lockUI(true);
      setStatusButtonsEnabled(false);
      createdEventId = null;
      createdEventRef = null;

      try{
        const ref = await addDoc(collection(db, "events"), payload);
        createdEventId = ref.id;
        createdEventRef = doc(db, "events", createdEventId);

        setStatusButtonsEnabled(true);
        showAlert("✅ Prestation créée (EN_COURS). Ajoute maintenant les lignes dans le catalogue.", true);

        // ✅ redirection vers catalogue pour ajouter les lignes
        const params = new URLSearchParams();
        params.set("eventId", createdEventId);
        params.set("homeId", currentHome.id);
        params.set("dateKey", dateKey);
        location.href = "catalogue.html?" + params.toString();

      }catch(err){
        console.error(err);
        showAlert("Erreur création : " + (err?.message || "inconnue"));
      }finally{
        lockUI(false);
      }
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      try{
        await loadHome();

        // ✅ agent auto (logement > param)
        if(!teamEl.value){
          if(teamParam) teamEl.value = teamParam;
          else if(currentHome.defaultAgent) teamEl.value = currentHome.defaultAgent;
        }

        renderContext();
        setStatusButtonsEnabled(false);

      }catch(err){
        console.error(err);
        showAlert("⛔ " + (err?.message || "Erreur chargement"), false);
      }
    });

    teamEl.addEventListener("input", renderContext);
  </script>
</body>
</html>
