<!-- docs/nouvelle-prestation.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Nouvelle prestation</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --violet-light:#F3ECFF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }
    *,*::before,*::after{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      padding-bottom:96px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }

    .logo-title{
      display:flex; justify-content:center; align-items:center;
      gap:10px; margin-top:10px; margin-bottom:6px; text-align:center;
    }
    .logo-icon{
      width:44px;height:44px;border-radius:50%;
      background:#fff;border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:#violet-main;font-size:22px;font-weight:800;
      position:relative;flex-shrink:0;
    }
    .logo-icon::after{ content:"‚ú¶"; position:absolute; top:-6px; right:-5px; font-size:12px; color:var(--violet-main); }
    h1{ margin:0; font-size:26px; font-weight:800; }
    .subtitle{ margin-top:2px; font-size:14px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:13px; color:var(--muted); font-weight:700; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:12px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    @media(min-width:860px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
    }
    .left{ flex:1.05; }
    .right{ flex:1; }

    .card-title{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      font-weight:800; font-size:15px;
      margin-bottom:10px;
    }
    .tiny{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }

    .kv{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      font-size:13px;
      color:#333;
    }
    .kv b{ font-weight:800; }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:800;
      white-space:nowrap;
    }

    form{ display:flex; flex-direction:column; gap:10px; }
    label{ font-size:12px; font-weight:800; color:#333; text-align:left; }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      outline:none;
      font-size:13px;
      background:#fff;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }
    textarea{ resize:vertical; }
    .inline{ display:flex; gap:10px; flex-wrap:wrap; }
    .inline > div{ flex:1; min-width:160px; }

    .hintline{
      margin-top:-6px;
      font-size:12px;
      color:#777;
      font-weight:800;
    }
    .hintline .sugg{
      color:#777;
      background: rgba(0,0,0,0.03);
      padding:2px 8px;
      border-radius:999px;
      display:inline-flex;
      gap:6px;
      align-items:center;
    }

    .btn{
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px 14px;
      font-size:13px;
      font-weight:800;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn.ghost{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.danger{
      background:#fff;
      border:2px solid #ffb7cc;
      color:var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .lines{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .line-item{
      background:#fff;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .li-main{ min-width:0; }
    .li-title{ font-weight:900; font-size:13px; color:#222; }
    .li-sub{ margin-top:2px; font-size:12px; color:#666; font-weight:800; }
    .li-sub b{ font-weight:900; color:#333; }
    .li-note{ margin-top:6px; font-size:12px; color:#666; font-weight:800; white-space:pre-wrap; }

    .li-actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; flex-shrink:0; }
    .mini-btn{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:var(--violet-light);
      color:#5b45c8;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .mini-btn.red{ background:#ffe3ec; color:var(--bad); }
    .mini-btn.ghost{ background:#fff; border:2px solid var(--violet-main); color:var(--violet-main); }

    .totals{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      font-weight:900;
    }
    .totals .mut{ font-weight:800; color:#666; }

    /* Bottom nav */
    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid rgba(122,92,255,0.18);
      backdrop-filter: blur(10px);
    }
    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight: 800;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    @media(min-width: 860px){
      .bottom-nav{
        position: static;
        max-width: 980px;
        margin: 12px auto 0;
        border-top: none;
        border: 1px solid rgba(122,92,255,0.18);
        border-radius: 999px;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
      }
      .page{ padding-bottom: 32px; }
    }

    @media (max-width: 520px){
      .page{ padding-left:12px; padding-right:12px; }
      html, body{ overflow-x:hidden; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="planning.html">‚Üê Retour planning</a>
      <button class="pill" id="logoutBtn" type="button">D√©connexion</button>
    </div>

    <div class="logo-title">
      <div class="logo-icon">‚úì</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Cr√©er une prestation</div>
    <div class="emailLine" id="emailLine">‚Äî</div>

    <div class="alert" id="alertBox"></div>

    <div class="layout">
      <!-- CONTEXTE -->
      <div class="card left">
        <div class="card-title">
          <span>Contexte</span>
          <span class="tag" id="contextTag">‚Äî</span>
        </div>
        <div class="kv" id="contextKv"></div>
      </div>

      <!-- PRESTATION -->
      <div class="card right">
        <div class="card-title">
          <span>Nouvelle prestation</span>
          <span class="tiny" id="homeLabel">‚Äî</span>
        </div>

        
          <form id="jobForm" autocomplete="off" novalidate>
            
          <div class="inline">
            <div>
              <label for="dateKeyInput">Date</label>
              <input id="dateKeyInput" type="date" required />
            </div>
            <div>
              <label for="time">Heure (optionnel)</label>
              <input id="time" type="time" />
            </div>
          </div>

          <div class="inline">
            <div>
              <label for="ownerName">Nom propri√©taire</label>
              <input id="ownerName" type="text" placeholder="Ex. Mme Dupont" />
            </div>
            <div>
              <label for="ownerEmail">Email propri√©taire</label>
              <input id="ownerEmail" type="email" placeholder="ex. proprietaire@email.com" />
            </div>
          </div>

          <div class="inline">
            <div>
              <label for="team">Agent (optionnel)</label>
              <input id="team" type="text" placeholder="Ex. Sarah / √âquipe A" />
            </div>
            <div>
              <label for="jobNote">Note globale (optionnel)</label>
              <input id="jobNote" type="text" placeholder="Ex. urgence, voyageurs exigeants‚Ä¶" />
            </div>
          </div>

          <div style="height:8px"></div>

          <div class="card-title" style="margin:0;">
            <span>Lignes</span>
            <span class="tiny">Tarif conseill√© + unit√© = indicatifs. Tu fixes ton prix.</span>
          </div>

          <!-- BUILDER LIGNE -->
          <div>
            <label for="productSelect">Prestation</label>
            <select id="productSelect">
              <option value="">‚Äî Choisir ‚Äî</option>
            </select>
          </div>

          <div id="otherNameWrap" style="display:none;">
            <label for="otherName">Nom du produit (si ‚ÄúAutre‚Äù)</label>
            <input id="otherName" type="text" placeholder="Ex. D√©placement / accueil sp√©cial‚Ä¶" />
          </div>

          <div class="inline">
            <div>
              <label for="qty">Quantit√©</label>
              <input id="qty" type="number" min="0" step="0.25" value="1" required />
            </div>
            <div>
              <label for="unit">Unit√©</label>
              <select id="unit" required>
                <option value="unit√©">unit√©</option>
                <option value="heure">heure</option>
                <option value="passage">passage</option>
                <option value="kit">kit</option>
                <option value="suppl√©ment">suppl√©ment</option>
                <option value="mois">mois</option>
                <option value="autre">autre</option>
              </select>
            </div>
          </div>

          <div class="inline">
            <div>
              <label for="unitPrice">Prix unitaire (ton prix)</label>
              <input id="unitPrice" type="number" min="0" step="0.01" placeholder="Ex. 60" />
              <div class="hintline" id="suggestLine" style="display:none;">
                <span class="sugg">üí° conseill√© : <span id="suggestText">‚Äî</span></span>
              </div>
            </div>
            <div>
              <label for="lineNote">Note ligne (optionnel)</label>
              <input id="lineNote" type="text" placeholder="Ex. inter-s√©jour, non conforme‚Ä¶" />
            </div>
          </div>

          <div class="inline">
            <div style="flex:1.2;">
              <label for="category">Cat√©gorie</label>
              <select id="category">
                <option value="Essentiel">Essentiel</option>
                <option value="M√©nage">M√©nage</option>
                <option value="Linge">Linge</option>
                <option value="Check-in/out">Check-in/out</option>
                <option value="Maintenance">Maintenance</option>
                <option value="Messages voyageurs">Messages voyageurs</option>
                <option value="Kits & consommables">Kits & consommables</option>
                <option value="Autre">Autre</option>
              </select>
            </div>
            <div style="flex:.8; display:flex; align-items:flex-end;">
              <button class="btn ghost" type="button" id="addLineBtn">+ Ajouter la ligne</button>
            </div>
          </div>

          <div class="lines" id="linesList"></div>

          <div class="totals">
            <div>
              <div class="mut">Total prestation</div>
              <div id="totalLabel">0,00 ‚Ç¨</div>
            </div>
            <div class="mut" id="linesCount">0 ligne</div>
          </div>

          <button class="btn primary" type="submit" id="saveBtn">Enregistrer (EN_COURS)</button>

          <div class="inline" style="margin-top:6px;">
            <button class="btn ghost" type="button" id="goQuoteBtn" disabled>Passer en devis</button>
            <button class="btn ghost" type="button" id="goInvoiceBtn" disabled>Facture directe</button>
          </div>

          <div class="hintline" id="billingHint" style="display:none;"></div>
        </form>
      </div>
    </div>
  </div>

  <nav class="bottom-nav" aria-label="Navigation">
    <a href="planning.html">Planning</a>
    <a href="import-ical.html">iCal</a>
    <a href="messagerie.html">Messages</a>
    <a href="catalogue.html">Catalogue</a>
    <a href="logements.html">Logements</a>
  </nav>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      doc, getDoc, addDoc, updateDoc,
      collection, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ========= UI =========
    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");

    const contextTag = document.getElementById("contextTag");
    const contextKv = document.getElementById("contextKv");
    const homeLabel = document.getElementById("homeLabel");

    const formEl = document.getElementById("jobForm");
    const dateKeyInput = document.getElementById("dateKeyInput");
    const timeEl = document.getElementById("time");
    const ownerNameEl = document.getElementById("ownerName");
    const ownerEmailEl = document.getElementById("ownerEmail");
    const teamEl = document.getElementById("team");
    const jobNoteEl = document.getElementById("jobNote");

    const productSelect = document.getElementById("productSelect");
    const otherNameWrap = document.getElementById("otherNameWrap");
    const otherNameEl = document.getElementById("otherName");
    const qtyEl = document.getElementById("qty");
    const unitEl = document.getElementById("unit");
    const unitPriceEl = document.getElementById("unitPrice");
    const lineNoteEl = document.getElementById("lineNote");
    const categoryEl = document.getElementById("category");
    const addLineBtn = document.getElementById("addLineBtn");

    const suggestLine = document.getElementById("suggestLine");
    const suggestText = document.getElementById("suggestText");

    const linesList = document.getElementById("linesList");
    const totalLabel = document.getElementById("totalLabel");
    const linesCount = document.getElementById("linesCount");

    const saveBtn = document.getElementById("saveBtn");
    const goQuoteBtn = document.getElementById("goQuoteBtn");
    const goInvoiceBtn = document.getElementById("goInvoiceBtn");
    const billingHint = document.getElementById("billingHint");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // ========= Guard =========
    const FREE_EMAILS = new Set(["mathilde.debout31@gmail.com","s.dumas974@gmail.com"]);
    async function guardConciergerie(user){
      const email = (user.email || "").toLowerCase();
      if(FREE_EMAILS.has(email)) return true;
      try{
        const snap = await getDoc(doc(db,"users",user.uid));
        if(!snap.exists()) return false;
        const d = snap.data() || {};
        return (d.role === "conciergerie" || d.role === "admin") && d.subscriptionStatus === "active";
      }catch(e){ return false; }
    }

    // ========= Params =========
    function getParam(name){
      const p = new URLSearchParams(location.search);
      return (p.get(name) || "").trim();
    }
    const homeId        = getParam("homeId");
    const from          = getParam("from") || "manuel";
    const icalEventId   = getParam("icalEventId");
    const summary       = getParam("summary");
    const timeParam     = getParam("time");
    const dateKeyParam  = getParam("dateKey");
    const ownerNameParam= getParam("ownerName");
    const ownerEmailParam=getParam("ownerEmail");
    const noteParam     = getParam("note");
    const homeTypeParam = getParam("homeType");      // <-- NOUVEAU

    // ========= Produits (suggestions) =========
    const PRODUCT_TEMPLATES = [
      { key:"MENAGE_STANDARD", label:"M√©nage standard (inter-s√©jour)", category:"M√©nage", suggested:"Ex. 45‚Ç¨ (studio/1ch) ‚Ä¢ 60‚Ç¨ (2ch) ‚Ä¢ 75‚Ç¨ (3ch) ‚Ä¢ 90‚Ç¨ (4ch)", unit:"unit√©" },
      { key:"MENAGE_INTERMEDIAIRE", label:"M√©nage interm√©diaire (long s√©jour)", category:"M√©nage", suggested:"Ex. +15‚Ç¨ suppl√©ment Long s√©jour", unit:"suppl√©ment" },
      { key:"BACK_TO_BACK", label:"Back-to-back (m√©nage en urgence)", category:"M√©nage", suggested:"Ex. +20‚Ç¨ suppl√©ment Urgence", unit:"suppl√©ment" },
      { key:"REMISE_EN_ETAT", label:"Remise en √©tat (logement non conforme)", category:"M√©nage", suggested:"Ex. +25‚Ç¨ suppl√©ment Non conforme", unit:"suppl√©ment" },

      { key:"RECHANGE_LINGE", label:"Rechange linge (rotation compl√®te)", category:"Linge", suggested:"Ex. 15‚Ç¨ par passage Rotation", unit:"passage" },
      { key:"LAVAGE_SECHAGE", label:"Collecte + lavage + s√©chage", category:"Linge", suggested:"Ex. 25‚Ç¨ par rotation", unit:"unit√©" },
      { key:"BLANCHISSERIE", label:"D√©pose / reprise blanchisserie", category:"Linge", suggested:"Ex. 20‚Ç¨ par rotation", unit:"unit√©" },

      { key:"CHECKIN_AUTONOME", label:"Check-in autonome (bo√Æte √† cl√©s)", category:"Check-in/out", suggested:"Ex. 0‚Ç¨ inclus", unit:"passage" },
      { key:"CHECKIN_PHYSIQUE", label:"Check-in physique", category:"Check-in/out", suggested:"Ex. 20‚Ç¨ par passage", unit:"passage" },
      { key:"CHECKOUT", label:"Check-out", category:"Check-in/out", suggested:"Ex. 15‚Ç¨ par passage", unit:"passage" },
      { key:"GESTION_CLES", label:"Gestion cl√©s / badges", category:"Check-in/out", suggested:"Ex. 10‚Ç¨ par intervention", unit:"unit√©" },
      { key:"RECUP_CLES", label:"R√©cup√©ration cl√©s apr√®s sortie", category:"Check-in/out", suggested:"Ex. 10‚Ç¨ par passage", unit:"passage" },

      { key:"PETITE_MAINTENANCE", label:"Petite maintenance (ampoule, joint‚Ä¶)", category:"Maintenance", suggested:"Ex. 15‚Ç¨ par intervention", unit:"unit√©" },
      { key:"URGENCE", label:"Intervention d‚Äôurgence (fuite, serrure)", category:"Maintenance", suggested:"Ex. 40‚Ç¨ par intervention", unit:"unit√©" },
      { key:"COORD_ARTISANS", label:"Coordination artisans", category:"Maintenance", suggested:"Ex. 30‚Ç¨ par coordination (hors co√ªt artisan)", unit:"unit√©" },

      { key:"MESSAGES", label:"R√©ponses messages voyageurs", category:"Messages voyageurs", suggested:"Ex. 19‚Ç¨/logement/mois (20 mess) + 1,20‚Ç¨/mess supp", unit:"mois" },

      { key:"KIT_ESSENTIEL", label:"Kit essentiel", category:"Kits & consommables", suggested:"Ex. 5‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_CUISINE", label:"Kit cuisine", category:"Kits & consommables", suggested:"Ex. 7‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_BAIN", label:"Kit bain", category:"Kits & consommables", suggested:"Ex. 4‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_SEJOUR_2", label:"Kit s√©jour (Pack 2 pers)", category:"Kits & consommables", suggested:"Ex. 14‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_SEJOUR_4", label:"Kit s√©jour (Pack 4 pers)", category:"Kits & consommables", suggested:"Ex. 28‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_SEJOUR_6", label:"Kit s√©jour (Pack 6 pers)", category:"Kits & consommables", suggested:"Ex. 42‚Ç¨ par kit", unit:"kit" },
      { key:"KIT_SEJOUR_8", label:"Kit s√©jour (Pack 8 pers)", category:"Kits & consommables", suggested:"Ex. 56‚Ç¨ par kit", unit:"kit" },
      { key:"REASSORT", label:"R√©assort produit unitaire (papier, caf√©‚Ä¶)", category:"Kits & consommables", suggested:"Ex. 1,20‚Ç¨ par unit√©", unit:"unit√©" },

      { key:"__OTHER__", label:"Autre (texte libre)", category:"Autre", suggested:"", unit:"unit√©" }
    ];

    // ========= Data =========
    let currentUser = null;
    let currentHome = null;

    // Event draft
    let lines = [];
    let editingIndex = -1;

    // After save
    let createdEventId = null;
    let createdEventRef = null;

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function money(n){
      const x = Number(n || 0);
      return x.toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ‚Ç¨";
    }

    function normalizeEmail(s){ return (s||"").toString().trim().toLowerCase(); }

    async function loadHome(){
      if(!homeId) throw new Error("homeId manquant.");
      const snap = await getDoc(doc(db, "homes", homeId));
      if(!snap.exists()) throw new Error("Logement introuvable (homeId).");
      const d = snap.data() || {};
      currentHome = {
        id: snap.id,
        ...d,
        // fallback pour le type
        homeType: (d.homeType || d.type || d.kind || homeTypeParam || "").toString().trim()
      };
    }

    function buildProductSelect(){
      const byCat = new Map();
      for(const p of PRODUCT_TEMPLATES){
        const cat = p.category || "Autre";
        if(!byCat.has(cat)) byCat.set(cat, []);
        byCat.get(cat).push(p);
      }
      const catOrder = ["M√©nage","Linge","Check-in/out","Maintenance","Messages voyageurs","Kits & consommables","Essentiel","Autre"];
      const cats = Array.from(byCat.keys()).sort((a,b)=>{
        const ia = catOrder.indexOf(a); const ib = catOrder.indexOf(b);
        if(ia === -1 && ib === -1) return a.localeCompare(b);
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      });
      productSelect.innerHTML = `<option value="">‚Äî Choisir ‚Äî</option>` + cats.map(cat=>{
        const opts = (byCat.get(cat) || []).map(p=>{
          return `<option value="${escapeHtml(p.key)}">${escapeHtml(p.label)}</option>`;
        }).join("");
        return `<optgroup label="${escapeHtml(cat)}">${opts}</optgroup>`;
      }).join("");
    }

    function getTemplateByKey(key){
      return PRODUCT_TEMPLATES.find(p=>p.key === key) || null;
    }

    function refreshSuggest(){
      const key = productSelect.value;
      const t = getTemplateByKey(key);
      if(!t){
        suggestLine.style.display = "none";
        return;
      }
      if(key === "__OTHER__"){
        otherNameWrap.style.display = "block";
      }else{
        otherNameWrap.style.display = "none";
        otherNameEl.value = "";
      }
      if(t.category && t.category !== "Autre") categoryEl.value = t.category;
      if(t.unit) unitEl.value = t.unit;
      if(t.suggested){
        suggestText.textContent = t.suggested;
        suggestLine.style.display = "block";
      }else{
        suggestLine.style.display = "none";
      }
    }

    function computeTotal(){
      return lines.reduce((sum, l)=> sum + (Number(l.qty)||0) * (Number(l.unitPrice)||0), 0);
    }

    function renderLines(){
      linesList.innerHTML = "";
      if(!lines.length){
        const empty = document.createElement("div");
        empty.style.background = "#fff";
        empty.style.borderRadius = "14px";
        empty.style.boxShadow = "0 3px 10px rgba(0,0,0,.06)";
        empty.style.padding = "12px";
        empty.style.color = "#666";
        empty.style.fontWeight = "900";
        empty.style.fontSize = "12px";
        empty.textContent = "Aucune ligne. Ajoute au moins une prestation.";
        linesList.appendChild(empty);
      }else{
        lines.forEach((l, idx)=>{
          const total = (Number(l.qty)||0) * (Number(l.unitPrice)||0);
          const div = document.createElement("div");
          div.className = "line-item";
          div.innerHTML = `
            <div class="li-main">
              <div class="li-title">${escapeHtml(l.label || "Ligne")}</div>
              <div class="li-sub">
                <b>${escapeHtml(String(l.qty))}</b> ${escapeHtml(l.unit || "unit√©")}
                ‚Ä¢ ${escapeHtml(money(l.unitPrice))} / ${escapeHtml(l.unit || "unit√©")}
                ‚Ä¢ total <b>${escapeHtml(money(total))}</b>
              </div>
              ${l.category ? `<div class="li-sub">Cat√©gorie : <b>${escapeHtml(l.category)}</b></div>` : ``}
              ${l.note ? `<div class="li-note">${escapeHtml(l.note)}</div>` : ``}
            </div>
            <div class="li-actions">
              <button class="mini-btn ghost" type="button" data-edit="${idx}">Modifier</button>
              <button class="mini-btn red" type="button" data-del="${idx}">Supprimer</button>
            </div>
          `;
          linesList.appendChild(div);
        });

        linesList.querySelectorAll("button[data-del]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const i = Number(btn.getAttribute("data-del"));
            lines.splice(i, 1);
            if(editingIndex === i) editingIndex = -1;
            renderLines();
            refreshTotals();
          });
        });

        linesList.querySelectorAll("button[data-edit]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const i = Number(btn.getAttribute("data-edit"));
            const l = lines[i];
            if(!l) return;
            editingIndex = i;
            const found = PRODUCT_TEMPLATES.find(p=>p.label === l.label);
            productSelect.value = found ? found.key : "__OTHER__";
            refreshSuggest();
            if(productSelect.value === "__OTHER__") otherNameEl.value = l.label || "";
            qtyEl.value = String(l.qty ?? 1);
            unitEl.value = l.unit || "unit√©";
            unitPriceEl.value = String(l.unitPrice ?? "");
            lineNoteEl.value = l.note || "";
            categoryEl.value = l.category || "Autre";
            addLineBtn.textContent = "Mettre √† jour la ligne";
            showAlert("Mode √©dition : modifie puis clique ‚ÄúMettre √† jour la ligne‚Äù.", true);
          });
        });
      }
      linesCount.textContent = lines.length + (lines.length > 1 ? " lignes" : " ligne");
    }

    function refreshTotals(){
      totalLabel.textContent = money(computeTotal());
    }

    function resetLineBuilder(){
      productSelect.value = "";
      otherNameWrap.style.display = "none";
      otherNameEl.value = "";
      qtyEl.value = "1";
      unitEl.value = "unit√©";
      unitPriceEl.value = "";
      lineNoteEl.value = "";
      categoryEl.value = "Essentiel";
      suggestLine.style.display = "none";
      editingIndex = -1;
      addLineBtn.textContent = "+ Ajouter la ligne";
    }

    function validateLineInputs(){
      const key = (productSelect.value || "").trim();
      if(!key) return { ok:false, msg:"Choisis une prestation." };
      let label = "";
      if(key === "__OTHER__"){
        label = (otherNameEl.value || "").trim();
        if(!label) return { ok:false, msg:"Renseigne le nom du produit (Autre)." };
      }else{
        const t = getTemplateByKey(key);
        label = t?.label || "";
        if(!label) return { ok:false, msg:"Prestation invalide." };
      }
      const qty = Number(qtyEl.value);
      if(!(qty > 0)) return { ok:false, msg:"Quantit√© invalide." };
      const unit = (unitEl.value || "").trim() || "unit√©";
      const unitPrice = Number(unitPriceEl.value);
      if(!(unitPrice >= 0)) return { ok:false, msg:"Prix unitaire invalide." };
      const category = (categoryEl.value || "").trim();
      const note = (lineNoteEl.value || "").trim();
      const tpl = getTemplateByKey(key);
      const suggested = tpl?.suggested || "";
      return {
        ok:true,
        line: {
          label,
          qty,
          unit,
          unitPrice,
          category: category || "",
          note,
          suggestedPrice: suggested
        }
      };
    }

    function renderContext(){
      contextTag.textContent = (from === "ical") ? "R√©servation" : "Cr√©ation manuelle";

      const ht = (currentHome?.homeType || "").trim();           // <-- type
      const homeText = currentHome
        ? (currentHome.name
           + (currentHome.city ? " ‚Äî " + currentHome.city : "")
           + (ht ? ` (${ht})` : ""))                             // <-- affichage dans le nom
        : "‚Äî";

      const ownerEmail = ownerEmailEl.value ? escapeHtml(ownerEmailEl.value) : escapeHtml(currentHome?.ownerEmail || "‚Äî");
      const ownerName  = ownerNameEl.value  ? escapeHtml(ownerNameEl.value)  : escapeHtml(currentHome?.ownerName  || "‚Äî");

      const rows = [];
      rows.push(`<div><b>Logement</b> : ${escapeHtml(homeText)}</div>`);
      if(ht) rows.push(`<div><b>Type</b> : ${escapeHtml(ht)}</div>`);   // <-- ligne d√©di√©e
      rows.push(`<div><b>Propri√©taire</b> : ${ownerName} ‚Ä¢ ${ownerEmail}</div>`);
      rows.push(`<div><b>Date</b> : ${escapeHtml(dateKeyInput.value || "‚Äî")}</div>`);
      rows.push(`<div><b>Heure</b> : ${escapeHtml(timeEl.value || "‚Äî")}</div>`);
      if(summary)  rows.push(`<div><b>R√©servation</b> : ${escapeHtml(summary)}</div>`);
      if(noteParam)rows.push(`<div><b>Note</b> : ${escapeHtml(noteParam)}</div>`);
      contextKv.innerHTML = rows.join("");

      homeLabel.textContent = homeText;                            // <-- aussi en en-t√™te
    }

    function setBillingButtonsAvailability(){
      const billingMode = currentHome?.billingMode || "";
      const firstDone = !!(currentHome?.firstQuoteDone || currentHome?.hasFirstApproval || currentHome?.firstApprovalDone);
      const canDirect = (billingMode === "facture_directe") || firstDone;

      billingHint.style.display = "block";

      if(!createdEventId){
        goQuoteBtn.disabled = true;
        goInvoiceBtn.disabled = true;
        billingHint.textContent = "Enregistre d‚Äôabord la prestation (EN_COURS).";
        return;
      }
      goQuoteBtn.disabled = false;

      if(canDirect){
        goInvoiceBtn.disabled = false;
        billingHint.textContent = "Facture directe autoris√©e (logement d√©j√† valid√© au moins une fois).";
      }else{
        goInvoiceBtn.disabled = true;
        billingHint.textContent = "1√®re fois sur ce logement : devis recommand√© (g√©n√©ralement obligatoire).";
      }
    }

    function lockUI(locked){
      saveBtn.disabled = !!locked;
      addLineBtn.disabled = !!locked;
      goQuoteBtn.disabled = locked ? true : goQuoteBtn.disabled;
      goInvoiceBtn.disabled = locked ? true : goInvoiceBtn.disabled;
    }

    // ========= Events =========
    productSelect.addEventListener("change", refreshSuggest);
    [dateKeyInput, timeEl, ownerNameEl, ownerEmailEl].forEach(el=>{
      el.addEventListener("input", renderContext);
    });

    addLineBtn.addEventListener("click", ()=>{
      hideAlert();
      const v = validateLineInputs();
      if(!v.ok) return showAlert(v.msg);
      if(editingIndex >= 0){
        lines[editingIndex] = v.line;
        showAlert("‚úÖ Ligne mise √† jour.", true);
      }else{
        lines.push(v.line);
        showAlert("‚úÖ Ligne ajout√©e.", true);
      }
      renderLines();
      refreshTotals();
      resetLineBuilder();
    });

    goQuoteBtn.addEventListener("click", async ()=>{
      if(!createdEventRef) return showAlert("Enregistre d‚Äôabord la prestation.");
      try{
        await updateDoc(createdEventRef, { status: "DEVIS", statusUpdatedAt: serverTimestamp() });
        showAlert("‚úÖ Statut : DEVIS", true);
        location.href = "devis.html?eventId=" + encodeURIComponent(createdEventId);
      }catch(err){
        console.error(err);
        showAlert("Erreur passage devis : " + (err?.message || "inconnue"));
      }
    });

    goInvoiceBtn.addEventListener("click", async ()=>{
      if(!createdEventRef) return showAlert("Enregistre d‚Äôabord la prestation.");
      if(goInvoiceBtn.disabled) return;
      try{
        await updateDoc(createdEventRef, { status: "FACTURE", statusUpdatedAt: serverTimestamp() });
        showAlert("‚úÖ Statut : FACTURE", true);
        location.href = "facture.html?eventId=" + encodeURIComponent(createdEventId);
      }catch(err){
        console.error(err);
        showAlert("Erreur passage facture : " + (err?.message || "inconnue"));
      }
    });

    formEl.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      if(!currentUser) return showAlert("Pas connect√© Firebase.");
      if(!currentHome) return showAlert("Logement non charg√©.");
      if(!dateKeyInput.value) return showAlert("Date obligatoire.");
      if(!lines.length) return showAlert("Ajoute au moins une ligne.");

      const ownerEmail = normalizeEmail(ownerEmailEl.value || currentHome.ownerEmail || "");
      const ownerName  = (ownerNameEl.value || currentHome.ownerName || "").trim();
      if(ownerEmail && !/^\S+@\S+\.\S+$/.test(ownerEmail)){
        return showAlert("Email propri√©taire invalide.");
      }

      const payload = {
        conciergerieUid: currentUser.uid,

        // logement
        homeId:   currentHome.id,
        homeName: currentHome.name || "",
        homeCity: currentHome.city || "",
        homeType: (currentHome.homeType || ""),           // <-- on stocke le type

        // date
        dateKey: dateKeyInput.value,
        date:    dateKeyInput.value,
        time:    (timeEl.value || "").trim(),

        // owner
        ownerUid:  currentHome.ownerUid || null,
        ownerName: ownerName || "",
        ownerEmail:ownerEmail || "",

        // prestation
        team: (teamEl.value || "").trim(),
        meta: (jobNoteEl.value || "").trim(),

        // lignes
        lines: lines.map(l=>({
          label: l.label || "",
          qty: Number(l.qty)||0,
          unit: l.unit || "unit√©",
          unitPrice: Number(l.unitPrice)||0,
          category: l.category || "",
          note: l.note || "",
          suggestedPrice: l.suggestedPrice || ""
        })),
        total: computeTotal(),

        // statut
        status: "EN_COURS",

        // source
        source: (from === "ical") ? "ical" : "manuel",
        icalEventId: icalEventId || null,
        summary: summary || "",

        updatedAt: serverTimestamp()
      };

      lockUI(true);
      try{
        if(!createdEventId){
          payload.createdAt = serverTimestamp();
          const ref = await addDoc(collection(db,"events"), payload);
          createdEventId = ref.id;
          createdEventRef = doc(db,"events",createdEventId);
          showAlert("‚úÖ Prestation enregistr√©e (EN_COURS).", true);
        }else{
          await updateDoc(createdEventRef, payload);
          showAlert("‚úÖ Prestation mise √† jour (EN_COURS).", true);
        }
        setBillingButtonsAvailability();
      }catch(err){
        console.error(err);
        showAlert("Erreur enregistrement : " + (err?.message || "inconnue"));
      }finally{
        lockUI(false);
      }
    });

    // ========= Boot =========
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      const ok = await guardConciergerie(user);
      if(!ok){
        location.href = "abonnement.html?plan=starter";
        return;
      }
      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      try{
        await loadHome();
      }catch(e){
        showAlert("‚õî " + (e.message || "Erreur logement"));
        return;
      }

      // Prefill
      dateKeyInput.value = dateKeyParam || "";
      if(!dateKeyInput.value){
        const d = new Date();
        const pad2 = (n)=> String(n).padStart(2,"0");
        dateKeyInput.value = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }
      timeEl.value = timeParam || "";
      ownerNameEl.value  = ownerNameParam  || currentHome.ownerName  || "";
      ownerEmailEl.value = ownerEmailParam || currentHome.ownerEmail || "";
      if(noteParam) jobNoteEl.value = noteParam;

      // Build products
      buildProductSelect();
      refreshSuggest();

      // Context
      renderContext();

      // Lines/init
      renderLines();
      refreshTotals();

      // Buttons
      setBillingButtonsAvailability();
    });
  </script>
</body>
</html>

