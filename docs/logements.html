  <!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Logements</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
      padding-bottom: 90px; /* place pour le bandeau */
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:8px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{font-size:15px;color:#444;margin-top:4px;text-align:center;}

    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      max-width:980px;
    }

    .card{
      width:100%;
      max-width:980px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .card-title .sub{ font-size:12px; font-weight:700; color:#666; }

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }
    .search{ flex:1; min-width:220px; }
    input[type="search"]{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input[type="search"]:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.danger{
      border-color:var(--bad);
      color:var(--bad);
    }

    .alert{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      border-left:5px solid var(--violet-main);
      text-align:left;
    }
    .item-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .item-title{ font-weight:900; color:#222; font-size:14px; line-height:1.2; }
    .item-meta{ font-size:12px; color:#666; margin-top:4px; line-height:1.25; }
    .chips{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
    .chip{
      font-size:11px;
      font-weight:900;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      white-space:nowrap;
    }

    .item-actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .mini-btn{
      border:none;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:var(--violet-light);
      color:#5b45c8;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .mini-btn.red{ background:#ffe3ec; color:var(--bad); }

    .empty{
      background:#fff;
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      color:#666;
      font-size:13px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:560px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.20);
      padding:16px 14px 18px;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; font-weight:900; color:#111; }
    .modal p{ margin:0 0 10px; font-size:12px; color:#666; line-height:1.25; }

    label{ display:block; font-size:12px; font-weight:900; color:#333; margin:8px 0 4px; text-align:left; }
    input, select{
      width:100%; box-sizing:border-box; padding:9px 10px;
      border-radius:10px; border:1px solid #D3C7FF; font-size:13px; outline:none; background:#fff;
    }

    .modal-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:12px;
    }

    /* Bottom nav */
    .bottom-nav{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 60;
      display: flex;
      gap: 6px;
      justify-content: space-around;
      align-items: center;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.92);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .bottom-nav a{
      flex: 1;
      text-align: center;
      text-decoration: none;
      font-size: 11px;
      font-weight: 900;
      color: #666;
      padding: 10px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .bottom-nav a.active{
      background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }

    @media(min-width: 860px){
      .page{ padding-bottom: 32px; }
      .bottom-nav{
        position: static;
        max-width: 980px;
        margin-top: 12px;
        border-top: none;
        border: 1px solid var(--border);
        border-radius: 999px;
        box-shadow: 0 4px 12px rgba(0,0,0,.08);
      }
      /* Desktop: on cache le bandeau (mobile only) */
@media(min-width: 860px){
  .bottom-nav{ display:none; }
  .page{ padding-bottom: 32px; }
}

    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill-link primary" href="planning.html">Planning</a>
        <button class="pill-link" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">Logements</div>
    <div class="badge" id="badgeLine">Chargement…</div>

    <div class="card">
      <div class="card-title">
        <span>Vos logements</span>
        <span class="sub" id="countLabel">—</span>
      </div>

      <div class="alert" id="alertBox"></div>

      <div class="toolbar">
        <div class="search">
          <input id="searchInput" type="search" placeholder="Recherche : nom, ville, propriétaire, type, équipe…" />
        </div>
        <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn primary" type="button" id="addBtn">+ Ajouter</button>
          <button class="btn" type="button" id="toggleArchivedBtn">Afficher archivés</button>
        </div>
      </div>

      <div class="list" id="homesList"></div>
    </div>

    <nav class="bottom-nav" aria-label="Navigation">
      <a href="planning.html">Planning</a>
      <a href="import-ical.html">iCal</a>
      <a href="messagerie.html">Messages</a>
      <a href="prestation-detail.html">Catalogue</a>
      <a href="logements.html" class="active">Logements</a>
    </nav>
  </div>

  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>Ajouter un logement</h2>
      <p>Nom + ville + propriétaire. Le reste, tu complètes quand tu veux.</p>

      <form id="homeForm">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:180px;">
            <label for="homeName">Nom</label>
            <input id="homeName" type="text" placeholder="Ex. T2 Centre" required />
          </div>
          <div style="flex:1; min-width:180px;">
            <label for="homeCity">Ville</label>
            <input id="homeCity" type="text" placeholder="Ex. Muret" required />
          </div>
        </div>

        <label for="homeOwner">Propriétaire (nom affiché)</label>
        <input id="homeOwner" type="text" placeholder="Ex. Mme Dupont" required />

        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:180px;">
            <label for="homeType">Type</label>
            <select id="homeType">
              <option>Studio</option><option>T1</option><option>T2</option><option>T3</option>
              <option>T4 et +</option><option>Maison</option>
            </select>
          </div>
          <div style="flex:1; min-width:180px;">
            <label for="homeTeam">Équipe</label>
            <select id="homeTeam">
              <option>Équipe A</option><option>Équipe B</option><option>Moi</option>
            </select>
          </div>
        </div>

        <label for="homeOwnerUid">Owner UID (optionnel)</label>
        <input id="homeOwnerUid" type="text" placeholder="UID du propriétaire (si tu l’as)">

        <div class="modal-actions">
          <button class="btn" type="button" id="cancelBtn">Annuler</button>
          <button class="btn primary" type="submit">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, where, getDocs,
      addDoc, updateDoc, doc, getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI =====
    const homesListEl = document.getElementById("homesList");
    const countLabelEl = document.getElementById("countLabel");
    const searchInputEl = document.getElementById("searchInput");
    const alertBox = document.getElementById("alertBox");
    const badgeLine = document.getElementById("badgeLine");

    const modalBackdrop = document.getElementById("modalBackdrop");
    const addBtn = document.getElementById("addBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const toggleArchivedBtn = document.getElementById("toggleArchivedBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const homeForm = document.getElementById("homeForm");
    const homeName = document.getElementById("homeName");
    const homeCity = document.getElementById("homeCity");
    const homeOwner = document.getElementById("homeOwner");
    const homeType = document.getElementById("homeType");
    const homeTeam = document.getElementById("homeTeam");
    const homeOwnerUid = document.getElementById("homeOwnerUid");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    function openModal(){
      modalBackdrop.style.display = "flex";
      setTimeout(()=>homeName.focus(), 0);
    }
    function closeModal(){
      modalBackdrop.style.display = "none";
      homeForm.reset();
      homeType.value = "Studio";
      homeTeam.value = "Équipe A";
    }

    function norm(s){ return (s||"").toString().toLowerCase().trim(); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ===== Abonnement guard (comme conciergerie.html) =====
    const FREE_EMAILS = new Set([
      "mathilde.debout31@gmail.com",
      "s.dumas974@gmail.com"
    ]);

    async function guardConciergerie(user){
      const email = (user.email || "").toLowerCase();
      if(FREE_EMAILS.has(email)) return true;

      try{
        const snap = await getDoc(doc(db, "users", user.uid));
        if(!snap.exists()) return false;
        const data = snap.data() || {};
        return (data.role === "conciergerie" || data.role === "admin") && (data.subscriptionStatus === "active");
      }catch(e){
        return false;
      }
    }

    // ===== Data =====
    let currentUid = null;
    let allHomes = [];
    let showArchived = false;

    function isArchived(h){
      return h?.status === "archived";
    }

    async function loadHomes(){
      hideAlert();

      const user = auth.currentUser;
      if(!user){
        showAlert("Firebase non connecté. Reconnecte-toi.");
        return;
      }
      currentUid = user.uid;

      try{
        const q = query(
          collection(db, "homes"),
          where("conciergerieUid", "==", currentUid)
        );

        const snap = await getDocs(q);
        allHomes = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // tri JS (createdAt desc)
        allHomes.sort((a,b)=>{
          const ta = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const tb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return tb - ta;
        });

        render();
      }catch(err){
        console.error("Erreur lecture homes:", err);
        showAlert("Erreur lecture homes : " + (err?.message || "inconnue"));
      }
    }

    function render(){
      const q = norm(searchInputEl.value);
      let homes = allHomes.slice();

      homes = homes.filter(h => showArchived ? true : !isArchived(h));

      const filtered = !q ? homes : homes.filter(h=>{
        const hay = [
          h.name, h.city, h.ownerName, h.ownerEmail, h.type, h.team
        ].map(norm).join(" ");
        return hay.includes(q);
      });

      countLabelEl.textContent = filtered.length + " / " + homes.length;
      homesListEl.innerHTML = "";

      if(!filtered.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = homes.length
          ? "Aucun résultat."
          : "Aucun logement. Clique sur “+ Ajouter”.";
        homesListEl.appendChild(e);
        return;
      }

      filtered.forEach(h=>{
        const item = document.createElement("div");
        item.className = "item";

        const ownerLabel = h.ownerName || h.ownerEmail || "—";
        const statusChip = isArchived(h) ? `<span class="chip">Archivé</span>` : "";

        item.innerHTML = `
          <div class="item-top">
            <div>
              <div class="item-title">${escapeHtml(h.name || "Logement")}</div>
              <div class="item-meta">${escapeHtml(h.city || "—")} • Propriétaire : <b>${escapeHtml(ownerLabel)}</b></div>
              <div class="chips">
                <span class="chip">${escapeHtml(h.type || "Type")}</span>
                <span class="chip">${escapeHtml(h.team || "Équipe")}</span>
                ${statusChip}
              </div>
            </div>
            <div class="item-actions">
              <a class="mini-btn" href="planning.html?homeId=${encodeURIComponent(h.id)}">Planning</a>
              ${
                isArchived(h)
                  ? `<button class="mini-btn" type="button" data-unarchive="${h.id}">Restaurer</button>`
                  : `<button class="mini-btn red" type="button" data-archive="${h.id}">Archiver</button>`
              }
            </div>
          </div>
        `;
        homesListEl.appendChild(item);
      });

      homesListEl.querySelectorAll("button[data-archive]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-archive");
          const ok = confirm("Archiver ce logement ? (il n’apparaîtra plus par défaut)");
          if(!ok) return;

          try{
            await updateDoc(doc(db,"homes",id), {
              status: "archived",
              archivedAt: serverTimestamp()
            });
            const h = allHomes.find(x=>x.id===id);
            if(h) h.status = "archived";
            render();
          }catch(err){
            console.error(err);
            showAlert("Erreur archive : " + (err?.message || "inconnue"));
          }
        });
      });

      homesListEl.querySelectorAll("button[data-unarchive]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-unarchive");
          try{
            await updateDoc(doc(db,"homes",id), {
              status: "active",
              unarchivedAt: serverTimestamp()
            });
            const h = allHomes.find(x=>x.id===id);
            if(h) h.status = "active";
            render();
          }catch(err){
            console.error(err);
            showAlert("Erreur restauration : " + (err?.message || "inconnue"));
          }
        });
      });
    }

    // ===== Add home =====
    homeForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      const name = homeName.value.trim();
      const city = homeCity.value.trim();
      const ownerName = homeOwner.value.trim();
      const type = homeType.value;
      const team = homeTeam.value;
      const ownerUidVal = homeOwnerUid.value.trim();

      if(!name || !city || !ownerName){
        showAlert("Champs manquants : nom + ville + propriétaire.");
        return;
      }

      try{
        const payload = {
          conciergerieUid: auth.currentUser.uid,
          name,
          city,
          ownerName,
          type,
          team,
          status: "active",
          createdAt: serverTimestamp()
        };

        if(ownerUidVal) payload.ownerUid = ownerUidVal;

        const ref = await addDoc(collection(db,"homes"), payload);

        closeModal();
        await loadHomes();
        showAlert("✅ Logement créé.", true);
        console.log("homes/" + ref.id);

      }catch(err){
        console.error(err);
        showAlert("Erreur création home : " + (err?.message || "inconnue"));
      }
    });

    // ===== Events =====
    addBtn.addEventListener("click", openModal);
    cancelBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e)=>{ if(e.target === modalBackdrop) closeModal(); });
    searchInputEl.addEventListener("input", render);

    toggleArchivedBtn.addEventListener("click", ()=>{
      showArchived = !showArchived;
      toggleArchivedBtn.textContent = showArchived ? "Masquer archivés" : "Afficher archivés";
      render();
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // ===== Init =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }

      const ok = await guardConciergerie(user);
      if(!ok){
        showAlert("⛔ Abonnement inactif. Merci de choisir une offre.");
        setTimeout(()=> location.href = "abonnement.html?plan=starter", 700);
        return;
      }

      badgeLine.textContent = "Gestion des logements • " + (user.email || user.uid);
      await loadHomes();
    });
  </script>
</body>
</html>

