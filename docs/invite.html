<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Inviter un propriétaire</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }
    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }
    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }
    .card{
      width:100%;
      max-width:720px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }
    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row > div{
      flex:1;
      min-width:220px;
    }
    .cta{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      flex:1;
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.danger{
      border-color:#ffd2d2;
      background:#FFE3EC;
      color:var(--bad);
    }
    .alert{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#333;
      display:none;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }
    .fineprint{
      margin-top:10px;
      text-align:center;
      font-size:11px;
      color:#666;
      line-height:1.25;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
      <button class="pill-link" type="button" id="logoutBtn">Déconnexion</button>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">Inviter un propriétaire</div>
    <div class="badge">1 lien unique • à usage unique • à envoyer par email</div>

    <div class="card">
      <div class="card-title">
        <span>Créer une invitation</span>
        <span class="small">Lien sécurisé</span>
      </div>

      <div class="small" style="margin-bottom:10px;">
        Tu génères un lien d’accès propriétaire. Le propriétaire clique le lien et crée son accès.
      </div>

      <div class="alert" id="alertBox"></div>

      <form id="inviteGenForm">
        <div class="row">
          <div>
            <label for="invEmail">Email du propriétaire</label>
            <input id="invEmail" type="email" placeholder="ex. propriétaire@email.com" required>
          </div>
          <div>
            <label for="invBy">Nom et prénom du propriétaire (optionnel)</label>
            <input id="invBy" type="text" placeholder="ex. Riviera Clean Conciergerie">
          </div>
        </div>

        <button class="cta" type="submit" id="genBtn">Générer le lien</button>

        <label for="invLink">Lien d’invitation</label>
        <input id="invLink" type="text" placeholder="Le lien s’affiche ici…" readonly>

        <div class="actions">
          <button class="btn" type="button" id="copyBtn" disabled> Copier le lien</button>
          <button class="btn primary" type="button" id="sendMailBtn" disabled> Ouvrir l’email</button>
          <button class="btn danger" type="button" id="clearBtn">Effacer</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Étapes : Génère → copie → ouvre l’email → colle → envoie.
        </div>

        <div class="fineprint">
          Astuce : certains mails n’affichent pas bien les liens cliquables → on colle le lien en texte, point. ✅
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI helpers =====
    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }
    function normalizeEmail(s){ return (s||"").trim().toLowerCase(); }

    // ===== Elements =====
    const form = document.getElementById("inviteGenForm");
    const invEmail = document.getElementById("invEmail");
    const invBy = document.getElementById("invBy");
    const invLink = document.getElementById("invLink");
    const copyBtn = document.getElementById("copyBtn");
    const sendMailBtn = document.getElementById("sendMailBtn");
    const clearBtn = document.getElementById("clearBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const genBtn = document.getElementById("genBtn");

    function setButtonsEnabled(enabled){
      copyBtn.disabled = !enabled;
      sendMailBtn.disabled = !enabled;
    }

    if(invBy && !invBy.value) invBy.value = "CleanUp Manager";
    setButtonsEnabled(false);

    function makeToken(){
      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      return Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("") + "_" + Date.now().toString(16);
    }

    function buildInviteUrl(token){
      const u = new URL("invite-proprietaire.html", location.href);
      u.searchParams.set("token", token);
      return u.toString();
    }

    // Guard : conciergerie connectée (Firebase)
    let currentUid = null;
    onAuthStateChanged(auth, (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }
      currentUid = user.uid;
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      location.href = "index.html";
    });

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      if(!currentUid){
        return showAlert("⛔ Pas connecté. Recharge la page.");
      }

      const email = normalizeEmail(invEmail.value);
      const by = (invBy.value || "").trim() || "CleanUp Manager";

      if(!email) return showAlert("Email manquant.");
      if(!/^\S+@\S+\.\S+$/.test(email)) return showAlert("Email invalide.");

      genBtn.disabled = true;
      genBtn.style.opacity = "0.75";

      try{
        const token = makeToken();
        const link = buildInviteUrl(token);

        // invites/{token}
        await setDoc(doc(db, "invites", token), {
          token,
          email,
          by,
          conciergerieUid: currentUid,
          status: "pending",
          createdAt: serverTimestamp(),
          usedAt: null,
          usedOwnerUid: null
        });

        invLink.value = link;
        invLink.focus();
        invLink.select();
        setButtonsEnabled(true);

        showAlert("✅ Invitation créée. Copie le lien puis ouvre l’email.", true);
      }catch(err){
        console.error(err);
        showAlert("Erreur Firestore : " + (err?.message || "inconnue"));
      }finally{
        genBtn.disabled = false;
        genBtn.style.opacity = "1";
      }
    });

    copyBtn.addEventListener("click", async ()=>{
      hideAlert();
      const link = (invLink.value || "").trim();
      if(!link) return showAlert("Rien à copier. Génère d’abord.");

      try{
        await navigator.clipboard.writeText(link);
        showAlert("✅ Lien copié.", true);
      }catch(e){
        invLink.focus();
        invLink.select();
        try{
          document.execCommand("copy");
          showAlert("✅ Lien copié (fallback).", true);
        }catch(e2){
          showAlert("Copie manuelle nécessaire.");
        }
      }
    });

    sendMailBtn.addEventListener("click", ()=>{
      hideAlert();
      const email = normalizeEmail(invEmail.value);
      const by = (invBy.value || "").trim() || "CleanUp Manager";

      if(!email) return showAlert("Email manquant.");
      if(!invLink.value) return showAlert("Génère d’abord.");

      // IMPORTANT : on garde volontairement un placeholder (Outlook / clients mail)
      const subject = encodeURIComponent("Votre accès propriétaire");
      const body = encodeURIComponent(
`Bonjour,

Voici votre lien d’accès propriétaire :

(Colle ton lien ici)


À bientôt,
${by}`
      );

      window.location.href = `mailto:${encodeURIComponent(email)}?subject=${subject}&body=${body}`;
      showAlert("✅ Email ouvert. Colle le lien, puis envoie.", true);
    });

    clearBtn.addEventListener("click", ()=>{
      hideAlert();
      invEmail.value = "";
      invBy.value = "Ex.CleanUp Manager";
      invLink.value = "";
      setButtonsEnabled(false);
      invEmail.focus();
    });
  </script>
</body>
</html>

