<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Demandes propriétaires</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --muted:#666;
      --ok:#1b8f4d;
      --warn:#b37400;
      --bad:#b3261e;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .wrap{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-title .t{
      font-size:16px;
      font-weight:900;
    }
    .card-title .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:#5b45c8;
      border:1px solid rgba(122,92,255,.25);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .tab.active{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }

    .req-item{
      background:#fff;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px 12px;
      border-left:5px solid rgba(122,92,255,.55);
      text-align:left;
      margin-top:10px;
    }
    .req-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:#666;
      font-weight:800;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .req-message{
      font-size:13px;
      color:#333;
      line-height:1.35;
      margin:0;
      white-space:pre-wrap;
    }
    .req-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .req-actions button{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn-accept{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
    }
    .btn-done{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
    }
    .btn-reject{
      background:#FFE3EC;
      color:var(--bad);
    }

    .hint{
      font-size:12px;
      color:#666;
      margin-top:6px;
      line-height:1.25;
    }

    .empty{
      background:#fff;
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      color:#666;
      font-size:13px;
      margin-top:10px;
    }

    /* bottom nav (mobile) */
    .bottom-nav{ display:none; }
    @media (max-width: 520px){
      .page{ padding-bottom: 86px; }
      .bottom-nav{
        display:flex;
        position:fixed;
        left:12px; right:12px; bottom:12px;
        background: rgba(255,255,255,0.92);
        border:1px solid rgba(122,92,255,.25);
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.12);
        padding:10px;
        gap:8px;
        justify-content:space-between;
        z-index:9999;
        backdrop-filter: blur(10px);
      }
      .bottom-nav a{
        flex:1;
        text-decoration:none;
        font-size:12px;
        font-weight:900;
        color:#5b45c8;
        background: rgba(122,92,255,.10);
        border-radius: 12px;
        padding:10px 8px;
        text-align:center;
      }
      .bottom-nav a.active{
        background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
        color:#fff;
      }
    }
  </style>
</head>

<body>

<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;
    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

<div class="page">
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Planning</a>
      <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>

  <div class="subtitle">Demandes propriétaires</div>
  <div class="badge">Accepter • Traiter • Refuser</div>

  <div class="wrap">
    <div class="card">
      <div class="card-title">
        <div>
          <div class="t">Boîte de demandes</div>
          <div class="sub"><span id="pendingCount">0</span> en attente</div>
        </div>
        <div class="tabs">
          <button class="tab active" id="tabPending" type="button">En attente</button>
          <button class="tab" id="tabDone" type="button">Traitées</button>
          <button class="tab" id="tabRejected" type="button">Refusées</button>
        </div>
      </div>

      <div class="hint">
        “Accepter” : si c’est un ajout logement → crée le logement + rattache au propriétaire (V1). Sinon : passe en “Traité”.
      </div>

      <div id="reqList"></div>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <a href="conciergerie.html">Menu</a>
  <a href="planning.html">Planning</a>
  <a href="logements.html">Logements</a>
  <a href="demandes.html" class="active">Demandes</a>
</nav>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
  function ensureData(){
    const existing = loadData();
    if(existing) return existing;
    const seeded = {
      homes:[], events:[], services:[], threads:[], payments:[],
      owners:[], invitations:[], icalSources:[], kits:[], requests:[]
    };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.homes = Array.isArray(app.homes) ? app.homes : [];
  app.owners = Array.isArray(app.owners) ? app.owners : [];
  app.requests = Array.isArray(app.requests) ? app.requests : [];

  // migration requests
  (function migrate(){
    let changed = false;
    app.requests.forEach(r=>{
      if(!r.id){ r.id = uid("req"); changed = true; }
      if(!r.status){ r.status = "pending"; changed = true; }
      if(!r.createdAt){ r.createdAt = Date.now(); changed = true; }
    });
    if(changed) saveData(app);
  })();

  const reqList = document.getElementById("reqList");
  const pendingCount = document.getElementById("pendingCount");

  const tabPending = document.getElementById("tabPending");
  const tabDone = document.getElementById("tabDone");
  const tabRejected = document.getElementById("tabRejected");

  let view = "pending";

  function escapeText(s){
    return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function fmt(ts){
    const d = new Date(ts || Date.now());
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm} ${hh}:${mi}`;
  }

  function findOwnerForRequest(r){
    if(r.ownerId){
      const byId = app.owners.find(o => o.id === r.ownerId);
      if(byId) return byId;
    }
    if(r.ownerEmail){
      const email = (r.ownerEmail||"").trim().toLowerCase();
      const byMail = app.owners.find(o => (o.email||"").trim().toLowerCase() === email);
      if(byMail) return byMail;
    }
    return null;
  }

  function setStatus(reqId, status){
    const r = app.requests.find(x => x.id === reqId);
    if(!r) return;
    r.status = status;
    r.usedAt = Date.now();
    saveData(app);
    render();
  }

  function acceptRequest(reqId){
    const r = app.requests.find(x => x.id === reqId);
    if(!r) return;

    // si c'est un add_home -> créer logement + rattacher
    if(r.type === "add_home"){
      const owner = findOwnerForRequest(r);
      if(!owner){
        alert("Propriétaire introuvable (ownerId/ownerEmail).");
        return;
      }
      owner.homes = Array.isArray(owner.homes) ? owner.homes : [];

      const home = {
        id: uid("h"),
        name: r.homeName || "Logement",
        city: r.city || "",
        owner: owner.fullname || owner.email || "Propriétaire",
        type: r.homeType || "Studio",
        team: r.team || "Équipe A",
        ownerId: owner.id
      };

      app.homes.unshift(home);
      owner.homes.unshift(home.id);

      r.status = "accepted";
      r.usedAt = Date.now();
      saveData(app);
      render();
      alert("✅ Logement créé et demande acceptée.");
      return;
    }

    // sinon : traité
    setStatus(reqId, "done");
  }

  function render(){
    const pending = app.requests.filter(r => (r.status || "pending") === "pending");
    pendingCount.textContent = String(pending.length);

    let list = [];
    if(view === "pending") list = pending;
    if(view === "done") list = app.requests.filter(r => ["done","accepted"].includes(r.status));
    if(view === "rejected") list = app.requests.filter(r => r.status === "rejected");

    reqList.innerHTML = "";

    if(!list.length){
      const e = document.createElement("div");
      e.className = "empty";
      e.textContent = view === "pending"
        ? "Aucune demande en attente."
        : (view === "done" ? "Aucune demande traitée." : "Aucune demande refusée.");
      reqList.appendChild(e);
      return;
    }

    list
      .slice()
      .sort((a,b)=> (b.createdAt||0) - (a.createdAt||0))
      .forEach(r=>{
        const ownerLabel = r.ownerName || r.ownerEmail || "Propriétaire";
        const typeLabel = r.type === "add_home" ? "Ajout logement" : (r.type || "Message");
        const msg = escapeText(r.message || "");

        const wrap = document.createElement("div");
        wrap.className = "req-item";
        wrap.innerHTML = `
          <div class="req-meta">
            <span>${escapeText(typeLabel)} • ${escapeText(ownerLabel)}</span>
            <span>${fmt(r.createdAt)}</span>
          </div>
          <p class="req-message">${msg || "<i>(pas de message)</i>"}</p>

          ${view === "pending" ? `
            <div class="req-actions">
              <button class="btn-accept" type="button" data-act="accept" data-id="${r.id}">Accepter</button>
              <button class="btn-done" type="button" data-act="done" data-id="${r.id}">Traiter</button>
              <button class="btn-reject" type="button" data-act="reject" data-id="${r.id}">Refuser</button>
            </div>
          ` : ""}
        `;
        reqList.appendChild(wrap);
      });

    reqList.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if(act === "accept") acceptRequest(id);
        if(act === "done") setStatus(id, "done");
        if(act === "reject") setStatus(id, "rejected");
      });
    });
  }

  function setTab(newView){
    view = newView;
    tabPending.classList.toggle("active", view === "pending");
    tabDone.classList.toggle("active", view === "done");
    tabRejected.classList.toggle("active", view === "rejected");
    render();
  }

  tabPending.addEventListener("click", ()=>setTab("pending"));
  tabDone.addEventListener("click", ()=>setTab("done"));
  tabRejected.addEventListener("click", ()=>setTab("rejected"));

  render();
</script>

</body>
</html>
