<!-- docs/intervention.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Interventions (Missions)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }
    *,*::before,*::after{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px 14px 26px;
      padding-bottom:40px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:8px;
      margin-bottom:4px;
      text-align:center;
    }
    .logo-icon{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:800;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:22px; font-weight:800; letter-spacing:-0.2px; }
    .subtitle{ margin-top:2px; font-size:13px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:800; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:start;
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:15px;
      font-weight:900;
      color:#111;
    }
    .tiny{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn.danger{
      border-color:#ffb7cc;
      color:var(--bad);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .row > div{ flex:1; min-width:200px; }

    label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:#444;
      margin:0 0 4px;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:13px;
      outline:none;
      background:#fff;
      font-weight:800;
      color:#222;
    }
    input:focus, select:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }

    .divider{
      height:1px;
      width:100%;
      background: rgba(122,92,255,0.18);
      margin:4px 0;
    }

    /* Missions */
    .mission{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .m-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .m-title{
      font-weight:900;
      font-size:13px;
      color:#222;
    }
    .m-sub{
      margin-top:2px;
      font-size:12px;
      font-weight:800;
      color:#666;
    }
    .badge{
      font-size:11px;
      font-weight:900;
      padding:3px 9px;
      border-radius:999px;
      background: rgba(122,92,255,0.12);
      color:#5b45c8;
      white-space:nowrap;
    }
    .badge.st-A_PLANIFIER{ background: rgba(0,0,0,0.08); color:#444; }
    .badge.st-ASSIGNEE{ background: rgba(0,163,255,0.14); color:#0067a6; }
    .badge.st-ENVOYEE{ background: rgba(255,153,0,0.16); color:#8a5600; }

    .m-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .empty{
      padding:12px;
      border-radius:14px;
      background:#fff;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      color:#666;
      font-weight:900;
      font-size:12px;
    }

    @media (max-width: 520px){
      .page{ padding-left:12px; padding-right:12px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="prestations.html">← Prestations</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill primary" href="planning.html">Planning</a>
        <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo">
      <div class="logo-icon">☑</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Interventions (Missions)</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="alert" id="alertBox"></div>

    <div class="layout">
      <section class="card">
        <div class="card-title">
          <span>Prestation</span>
          <span class="tiny" id="prestaHint">—</span>
        </div>

        <div class="row">
          <div>
            <label>Logement</label>
            <input id="homeLine" disabled value="—" />
          </div>
          <div>
            <label>Date / heure</label>
            <input id="dtLine" disabled value="—" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Créer / régénérer missions (si vide)</label>
            <button class="btn" id="createMissionsBtn" type="button">Créer missions (check-in / ménage / check-out)</button>
          </div>
          <div>
            <label>Agents connus (pour dropdown)</label>
            <button class="btn" id="refreshAgentsBtn" type="button">Rafraîchir agents</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card-title" style="margin-top:2px;">
          <span>Envoyer lien “journée”</span>
          <span class="tiny">1 token / agent • valable 24h • mailto</span>
        </div>

        <div class="row">
          <div>
            <label>Agent</label>
            <select id="dayAgentSelect">
              <option value="">— Choisir —</option>
            </select>
          </div>
          <div>
            <label>Action</label>
            <button class="btn primary" id="sendDayLinkBtn" type="button" disabled>Envoyer lien journée</button>
          </div>
        </div>

        <div class="tiny" id="dayLinkPreview" style="display:none;"></div>
      </section>

      <section class="card">
        <div class="card-title">
          <span>Missions</span>
          <span class="tiny" id="countLabel">—</span>
        </div>

        <div id="missionsList"></div>
      </section>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      doc, getDoc, setDoc, updateDoc, serverTimestamp,
      collection, getDocs, query, where, orderBy,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ===== UI =====
    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");

    const prestaHint = document.getElementById("prestaHint");
    const homeLine = document.getElementById("homeLine");
    const dtLine = document.getElementById("dtLine");

    const createMissionsBtn = document.getElementById("createMissionsBtn");
    const refreshAgentsBtn = document.getElementById("refreshAgentsBtn");

    const dayAgentSelect = document.getElementById("dayAgentSelect");
    const sendDayLinkBtn = document.getElementById("sendDayLinkBtn");
    const dayLinkPreview = document.getElementById("dayLinkPreview");

    const missionsList = document.getElementById("missionsList");
    const countLabel = document.getElementById("countLabel");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function qs(name){
      return new URLSearchParams(location.search).get(name);
    }

    function normalizeEmail(s){ return (s||"").toString().trim().toLowerCase(); }

    function nowMs(){ return Date.now(); }
    function addHoursMs(ms, h){ return ms + h*3600*1000; }

    function makeToken(len=14){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // sans O/0/I/1
      let out = "";
      for(let i=0;i<len;i++){
        out += chars[Math.floor(Math.random()*chars.length)];
      }
      return out;
    }

    function statusLabel(s){
      const x = (s||"A_PLANIFIER").toUpperCase();
      if(x === "A_PLANIFIER") return "À PLANIFIER";
      if(x === "ASSIGNEE") return "ASSIGNÉE";
      if(x === "ENVOYEE") return "ENVOYÉE";
      return x;
    }

    // ===== State =====
    let currentUser = null;
    const prestationId = qs("prestationId") || qs("eventId") || "";

    let prestation = null;
    let missions = []; // {id, type, status, assignedToName, assignedToEmail, ...}
    let agents = [];   // {name,email}

    // ===== Auth =====
    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    // ===== Data model =====
    // On stocke les missions dans : events/{prestationId}/missions/{missionId}
    // Et les tokens journée dans : dayTokens/{token}
    function missionsColRef(){
      return collection(db, "events", prestationId, "missions");
    }

    async function loadPrestation(){
      if(!prestationId){
        showAlert("⛔ prestationId manquant dans l'URL. Ouvre depuis prestations.html (Programmer).");
        return false;
      }

      const ref = doc(db, "events", prestationId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        showAlert("⛔ Prestation introuvable (events/" + prestationId + ").");
        return false;
      }

      const x = snap.data() || {};
      // sécurité conciergerie
      if(x.conciergerieUid && x.conciergerieUid !== currentUser.uid){
        showAlert("⛔ Accès refusé : cette prestation n'est pas à cette conciergerie.");
        return false;
      }

      prestation = { id: snap.id, ...x };
      const title = `${x.homeName || "Logement"}${x.homeCity ? " — " + x.homeCity : ""}`;
      const dt = `${x.dateKey || x.date || "—"}${x.time ? " à " + x.time : ""}`;

      prestaHint.textContent = "#" + prestationId.slice(0,6);
      homeLine.value = title;
      dtLine.value = dt;

      return true;
    }

    async function loadMissions(){
      missionsList.innerHTML = "";
      missions = [];

      const q = query(missionsColRef(), orderBy("createdAt","asc"));
      const snap = await getDocs(q);

      missions = snap.docs.map(d=>{
        const x = d.data() || {};
        return {
          id: d.id,
          type: (x.type || "").toUpperCase(),
          status: (x.status || "A_PLANIFIER").toUpperCase(),
          plannedAt: x.plannedAt || null,
          assignedToName: x.assignedToName || "",
          assignedToEmail: x.assignedToEmail || "",
          sentAt: x.sentAt || null
        };
      });

      renderMissions();
    }

    function renderMissions(){
      missionsList.innerHTML = "";

      countLabel.textContent = `${missions.length} mission(s)`;

      if(!missions.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Aucune mission. Clique “Créer missions”.";
        missionsList.appendChild(e);
        return;
      }

      for(const m of missions){
        const typeLabel = (
          m.type === "CHECKIN" ? "Check-in" :
          m.type === "MENAGE" ? "Ménage" :
          m.type === "CHECKOUT" ? "Check-out" :
          (m.type || "Mission")
        );

        const agentLine = m.assignedToName
          ? `${m.assignedToName}${m.assignedToEmail ? " • " + m.assignedToEmail : ""}`
          : "— non assignée —";

        const box = document.createElement("div");
        box.className = "mission";
        box.innerHTML = `
          <div class="m-top">
            <div>
              <div class="m-title">${esc(typeLabel)}</div>
              <div class="m-sub">Agent : <b>${esc(agentLine)}</b></div>
            </div>
            <span class="badge st-${esc(m.status)}">${esc(statusLabel(m.status))}</span>
          </div>

          <div class="row">
            <div>
              <label>Agent (obligatoire)</label>
              <select data-agent-select="${esc(m.id)}">
                <option value="">— Choisir —</option>
                ${agents.map(a=>{
                  const v = `${a.name}||${a.email}`;
                  const sel = (normalizeEmail(a.email) === normalizeEmail(m.assignedToEmail)) ? "selected" : "";
                  return `<option value="${esc(v)}" ${sel}>${esc(a.name)}${a.email ? " — " + esc(a.email) : ""}</option>`;
                }).join("")}
              </select>
            </div>
            <div>
              <label>Action</label>
              <button class="btn primary" type="button" data-assign="${esc(m.id)}">Assigner</button>
            </div>
          </div>

          <div class="m-actions">
            <button class="btn" type="button" data-open-agent="${esc(m.id)}">Ouvrir agent.html (test)</button>
          </div>

          <div class="tiny" style="color:#666;">
            Astuce : “Assigner” met la mission en <b>ASSIGNÉE</b>. “Envoyer lien journée” met <b>ENVOYÉE</b>.
          </div>
        `;
        missionsList.appendChild(box);

        // assign
        box.querySelector(`[data-assign="${m.id}"]`)?.addEventListener("click", async ()=>{
          hideAlert();

          const sel = box.querySelector(`[data-agent-select="${m.id}"]`);
          const val = (sel?.value || "").trim();
          if(!val){
            showAlert("Agent obligatoire pour assigner.");
            return;
          }

          const [name, email] = val.split("||");
          if(!name || !email){
            showAlert("Agent invalide (nom/email). Rafraîchis les agents.");
            return;
          }

          try{
            await updateDoc(doc(db, "events", prestationId, "missions", m.id), {
              assignedToName: name,
              assignedToEmail: normalizeEmail(email),
              status: "ASSIGNEE",
              updatedAt: serverTimestamp()
            });
            showAlert("✅ Mission assignée.", true);
            await loadMissions();
            await loadAgentsAndFillSelects(); // keep dropdown day link in sync
          }catch(err){
            console.error(err);
            showAlert("Erreur assignation : " + (err?.message || "inconnue"));
          }
        });

        // open agent test
        box.querySelector(`[data-open-agent="${m.id}"]`)?.addEventListener("click", ()=>{
          // Pour l’instant agent.html attend un token (journée).
          // Donc on ouvre juste la page pour tester l’UI si besoin.
          window.open("agent.html", "_blank");
        });
      }
    }

    // ===== Agents list (from past events of this conciergerie) =====
    async function loadAgents(){
      agents = [];

      // on récupère des agents “connus” depuis events
      // (c’est simple, pas parfait, mais efficace pour v1)
      const q = query(
        collection(db,"events"),
        where("conciergerieUid","==", currentUser.uid),
        orderBy("createdAt","desc")
      );
      const snap = await getDocs(q);

      const map = new Map(); // email -> {name,email}
      for(const d of snap.docs){
        const x = d.data() || {};
        const email = normalizeEmail(x.assignedToEmail || "");
        const name = (x.assignedToName || "").trim();
        if(email && name){
          map.set(email, { name, email });
        }
      }

      agents = Array.from(map.values())
        .sort((a,b)=> a.name.localeCompare(b.name, "fr"));

      return agents;
    }

    function fillDayAgentSelect(){
      dayAgentSelect.innerHTML = `<option value="">— Choisir —</option>` +
        agents.map(a=>{
          const v = `${a.name}||${a.email}`;
          return `<option value="${esc(v)}">${esc(a.name)} — ${esc(a.email)}</option>`;
        }).join("");

      sendDayLinkBtn.disabled = !(dayAgentSelect.value);
      dayLinkPreview.style.display = "none";
      dayLinkPreview.textContent = "";
    }

    async function loadAgentsAndFillSelects(){
      await loadAgents();
      fillDayAgentSelect();
      // re-render missions to rebuild dropdowns
      renderMissions();
    }

    dayAgentSelect.addEventListener("change", ()=>{
      sendDayLinkBtn.disabled = !(dayAgentSelect.value);
      dayLinkPreview.style.display = "none";
      dayLinkPreview.textContent = "";
    });

    // ===== Create default missions =====
    function defaultChecklist(type){
      if(type === "MENAGE"){
        return [
          { key:"SOL", label:"Sols faits (aspirateur + serpillière)", required:true, checked:false },
          { key:"SDB", label:"Salle de bain (lavabo/douche/WC/miroir)", required:true, checked:false },
          { key:"CUISINE", label:"Cuisine (plan/évier/plaques)", required:true, checked:false },
          { key:"POUBELLES", label:"Poubelles vidées + sac remis", required:true, checked:false },
          { key:"PHOTO_MAIN", label:"Photo pièce principale", required:true, checked:false },
          { key:"PHOTO_SDB", label:"Photo salle de bain", required:true, checked:false }
        ];
      }
      if(type === "CHECKIN"){
        return [
          { key:"MSG", label:"Message d’arrivée envoyé / confirmé", required:true, checked:false },
          { key:"CLES", label:"Boîte à clés / code OK", required:true, checked:false },
          { key:"KIT", label:"Kit / consommables OK (si inclus)", required:true, checked:false },
          { key:"OK_TECH", label:"Eau/élec/chauffage OK (check rapide)", required:true, checked:false }
        ];
      }
      if(type === "CHECKOUT"){
        return [
          { key:"CLES", label:"Clés récupérées / sortie confirmée", required:true, checked:false },
          { key:"PHOTOS", label:"Photos état général (entrée + pièce principale)", required:true, checked:false },
          { key:"ANOM", label:"Vérif casse / anomalies", required:true, checked:false },
          { key:"LINGE", label:"Linge récupéré / mis en sac (si prévu)", required:true, checked:false }
        ];
      }
      return [];
    }

    async function createDefaultMissionsIfEmpty(){
      hideAlert();
      if(!prestationId || !prestation) return;

      // reload count quickly
      const existing = await getDocs(query(missionsColRef(), orderBy("createdAt","asc")));
      if(existing.size > 0){
        showAlert("⛔ Missions déjà présentes. (Je ne régénère pas automatiquement.)");
        return;
      }

      const batch = writeBatch(db);

      const types = ["CHECKIN","MENAGE","CHECKOUT"];
      types.forEach((type, idx)=>{
        const id = type; // ids stables (CHECKIN/MENAGE/CHECKOUT)
        const ref = doc(db, "events", prestationId, "missions", id);

        batch.set(ref, {
          conciergerieUid: currentUser.uid,
          prestationId,
          type,
          status: "A_PLANIFIER",
          plannedAt: prestation.dateKey || prestation.date || null,
          checklist: defaultChecklist(type),
          photos: [],
          comment: "",
          incident: { isIncident:false, label:"" },
          assignedToName: "",
          assignedToEmail: "",
          locked: false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      });

      try{
        await batch.commit();
        showAlert("✅ Missions créées.", true);
        await loadMissions();
      }catch(err){
        console.error(err);
        showAlert("Erreur création missions : " + (err?.message || "inconnue"));
      }
    }

    // ===== Day token + mailto =====
    function buildDayMail({agentName, agentEmail, token}){
      const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
      const link = base + "agent.html?token=" + encodeURIComponent(token);

      const home = homeLine.value || "Logement";
      const dt = dtLine.value || "—";

      const subject = `Lien interventions (24h) — ${agentName} — ${home}`;
      const body =
`Bonjour ${agentName},

Voici votre lien d’accès (valable 24h) pour vos interventions :
${link}

Logement / contexte : ${home}
Date / heure : ${dt}

Token : ${token}

Merci.
CleanUp Manager`;

      return { subject, body, link };
    }

    async function sendDayLink(){
      hideAlert();

      const v = (dayAgentSelect.value || "").trim();
      if(!v){
        showAlert("Choisis un agent.");
        return;
      }
      const [agentName, agentEmailRaw] = v.split("||");
      const agentEmail = normalizeEmail(agentEmailRaw);

      if(!agentName || !agentEmail){
        showAlert("Agent invalide (nom/email).");
        return;
      }

      // Il faut au moins une mission ASSIGNEE pour cet agent (sinon ça n’a aucun sens)
      const assigned = missions.filter(m => normalizeEmail(m.assignedToEmail) === agentEmail && (m.status === "ASSIGNEE" || m.status === "ENVOYEE"));
      if(!assigned.length){
        showAlert("⛔ Aucune mission assignée à cet agent sur cette prestation. Assigne d’abord.");
        return;
      }

      const token = makeToken(14);
      const expiresAtMs = addHoursMs(nowMs(), 24);
      const expiresAt = new Date(expiresAtMs); // on stocke en string ISO (simple) ou Timestamp via firebase-init (ici simple)

      try{
        // 1) enregistrer le token
        await setDoc(doc(db, "dayTokens", token), {
          conciergerieUid: currentUser.uid,
          prestationId,
          agentName,
          agentEmail,
          active: true,
          expiresAtIso: expiresAt.toISOString(),
          createdAt: serverTimestamp()
        });

        // 2) marquer les missions ENVOYEE (celles de cet agent)
        const batch = writeBatch(db);
        for(const m of missions){
          if(normalizeEmail(m.assignedToEmail) === agentEmail){
            const ref = doc(db, "events", prestationId, "missions", m.id);
            batch.update(ref, {
              status: "ENVOYEE",
              sentAt: serverTimestamp(),
              dayToken: token,
              updatedAt: serverTimestamp()
            });
          }
        }
        await batch.commit();

        // 3) mailto
        const { subject, body, link } = buildDayMail({ agentName, agentEmail, token });
        const mailto = `mailto:${encodeURIComponent(agentEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

        dayLinkPreview.style.display = "block";
        dayLinkPreview.innerHTML = `✅ Lien prêt : <b>${esc(link)}</b> (token ${esc(token)})`;
        window.location.href = mailto;

        showAlert("✅ Lien journée généré + mailto ouvert.", true);
        await loadMissions();
      }catch(err){
        console.error(err);
        showAlert("Erreur envoi lien journée : " + (err?.message || "inconnue"));
      }
    }

    // ===== Events =====
    createMissionsBtn.addEventListener("click", createDefaultMissionsIfEmpty);
    refreshAgentsBtn.addEventListener("click", async ()=>{
      hideAlert();
      try{
        await loadAgentsAndFillSelects();
        showAlert("✅ Agents rafraîchis.", true);
      }catch(err){
        console.error(err);
        showAlert("Erreur rafraîchir agents : " + (err?.message || "inconnue"));
      }
    });
    sendDayLinkBtn.addEventListener("click", sendDayLink);

    // ===== Boot =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }

      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      try{
        hideAlert();

        const ok = await loadPrestation();
        if(!ok) return;

        await loadAgentsAndFillSelects();
        await loadMissions();

        // enable send button when selection exists
        sendDayLinkBtn.disabled = !(dayAgentSelect.value);
      }catch(err){
        console.error(err);
        showAlert("Erreur initialisation : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
