<!-- docs/intervention.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Intervention</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
      --border: rgba(122,92,255,0.18);
      --shadow: 0 14px 36px rgba(0,0,0,0.08);
    }
    *,*::before,*::after{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      background: linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px 14px 26px;
      padding-bottom:40px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      cursor:pointer;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .pill.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:8px;
      margin-bottom:4px;
      text-align:center;
    }
    .logo-icon{
      width:42px;height:42px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:800;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-5px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{ margin:0; font-size:22px; font-weight:800; letter-spacing:-0.2px; }
    .subtitle{ margin-top:2px; font-size:13px; color:#444; text-align:center; }
    .emailLine{ margin-top:4px; font-size:12px; color:var(--muted); font-weight:800; text-align:center; }

    .alert{
      width:100%;
      max-width:980px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:start;
    }

    .card{
      background: rgba(255,255,255,0.86);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 12px;
      text-align:left;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:15px;
      font-weight:900;
      color:#111;
    }
    .tiny{ font-size:12px; color:var(--muted); font-weight:800; line-height:1.35; }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .row > div{ flex:1; min-width:200px; }

    label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:#444;
      margin:0 0 4px;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:13px;
      outline:none;
      background:#fff;
      font-weight:800;
      color:#222;
    }
    input:focus, select:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 3px rgba(122,92,255,.12);
    }

    .divider{
      height:1px;
      width:100%;
      background: rgba(122,92,255,0.18);
      margin:4px 0;
    }

    .line-item{
      background:#fff;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.03);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .li-title{
      font-weight:900;
      font-size:13px;
      color:#222;
    }
    .li-sub{
      font-size:12px;
      font-weight:800;
      color:#666;
      white-space:pre-wrap;
    }
    .empty{
      padding:12px;
      border-radius:14px;
      background:#fff;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      color:#666;
      font-weight:900;
      font-size:12px;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill" href="prestations.html">← Prestations</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill primary" href="planning.html">Planning</a>
        <button class="pill" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo">
      <div class="logo-icon">☑</div>
      <h1>CleanUp Manager</h1>
    </div>
    <div class="subtitle">Intervention</div>
    <div class="emailLine" id="emailLine">—</div>

    <div class="alert" id="alertBox"></div>

    <div class="layout">
      <section class="card">
        <div class="card-title">
          <span>Prestation</span>
          <span class="tiny" id="prestaHint">—</span>
        </div>

        <div class="row">
          <div>
            <label>Logement</label>
            <input id="homeLine" disabled value="—" />
          </div>
          <div>
            <label>Date / heure</label>
            <input id="dtLine" disabled value="—" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Adresse (éditable)</label>
            <input id="addrInput" placeholder="Ex. 12 rue ..., code, étage..." />
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn" id="saveAddrBtn" type="button">Enregistrer l’adresse</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card-title" style="margin-top:2px;">
          <span>Lien agent (24h)</span>
        </div>

        <div class="row">
          <div>
            <label>Agent (depuis la prestation)</label>
            <input id="agentLine" disabled value="—" />
          </div>
          <div>
            <label>Action</label>
            <button class="btn primary" id="sendLinkBtn" type="button" disabled>Envoyer le lien</button>
          </div>
        </div>

        <div class="tiny" id="linkPreview" style="display:none;"></div>
      </section>

      <section class="card">
        <div class="card-title">
          <span>Tâches (résumé)</span>
        </div>
        <div id="linesList"></div>
      </section>
    </div>
  </div>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      doc, getDoc, updateDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // UI
    const emailLine = document.getElementById("emailLine");
    const logoutBtn = document.getElementById("logoutBtn");
    const alertBox = document.getElementById("alertBox");

    const prestaHint = document.getElementById("prestaHint");
    const homeLine = document.getElementById("homeLine");
    const dtLine = document.getElementById("dtLine");

    const addrInput = document.getElementById("addrInput");
    const saveAddrBtn = document.getElementById("saveAddrBtn");

    const agentLine = document.getElementById("agentLine");
    const sendLinkBtn = document.getElementById("sendLinkBtn");
    const linkPreview = document.getElementById("linkPreview");

    const linesList = document.getElementById("linesList");

    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }
    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function qs(name){
      return new URLSearchParams(location.search).get(name);
    }
    function normalizeEmail(s){ return (s||"").toString().trim().toLowerCase(); }

    function nowMs(){ return Date.now(); }
    function addHoursMs(ms, h){ return ms + h*3600*1000; }
    function makeToken(len=14){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for(let i=0;i<len;i++){
        out += chars[Math.floor(Math.random()*chars.length)];
      }
      return out;
    }

    // ===== Checklist builders (depuis lines[].key) =====
    function uniqUpperKeys(lines){
      const keys = (Array.isArray(lines) ? lines : [])
        .map(l => (l.key || "").toString().trim().toUpperCase())
        .filter(Boolean);
      return Array.from(new Set(keys));
    }

    function visibleGroupsForMission(missionId, keys){
      const has = (k)=> keys.includes(k);

      if(missionId === "CHECKIN"){
        return ["CHECKIN_BASE"];
      }
      if(missionId === "CHECKOUT"){
        const groups = ["CHECKOUT_BASE","PHOTOS","ANOMALIES","COMMENT"];
        if(has("RECUP_CLES_APRES_SORTIE")) groups.push("SECURISATION");
        return groups;
      }
      // MENAGE
      const groups = ["MENAGE_BASE","PHOTOS","COMMENT"];
      if(keys.some(k => ["RECHANGE_LINGE"].includes(k))) groups.push("LINGE");
      if(keys.some(k => ["COLLECTE_LAVAGE_SECHAGE","DEPOSE_REPRISE_BLANCHISSERIE"].includes(k))) groups.push("BLANCHISSERIE");
      if(keys.some(k => ["KIT_ESSENTIEL","KIT_CUISINE","KIT_BAIN","KIT_SEJOUR"].includes(k))) groups.push("KITS");
      if(keys.some(k => ["REASSORT_UNITAIRE"].includes(k))) groups.push("REASSORT");
      if(keys.some(k => ["PETITE_MAINTENANCE"].includes(k))) groups.push("MAINTENANCE");
      if(keys.some(k => ["INTERVENTION_URGENCE"].includes(k))) groups.push("URGENCE");
      return groups;
    }

    function defaultChecklistForMission(missionId){
      if(missionId === "CHECKIN"){
        return {
          accueil: false,
          remiseClesOuCode: false,
          verifKitAccueil: false,
          comment: ""
        };
      }

      if(missionId === "CHECKOUT"){
        return {
          recupClesOuChgtCode: false,
          photos: false,
          anomalies: false,
          securisation: false,
          comment: ""
        };
      }

      // MENAGE
      return {
        sols: false,
        sanitaires: false,
        cuisine: false,
        poubelles: false,
        draps: false,
        photos: false,

        lingeDraps: false,
        lingeServiettes: false,

        blanchisserieCollecte: false,
        blanchisserieDepose: false,
        blanchisserieRecup: false,

        kitEssentiel: "NA", // "OUI"|"NON"|"NA"
        kitCuisine: "NA",
        kitBain: "NA",
        kitSejour: "NA",

        reassort: false,
        reassortComment: "",

        maintenanceRemplacement: false,
        maintenanceTest: false,
        maintenancePhoto: false,

        urgenceMiseSecurite: false,
        urgenceCompteRendu: "",

        comment: ""
      };
    }

    async function ensureMissionsForToken({prestationId, token, agentName, agentEmail, keys}){
      const common = {
        prestationId,
        dayToken: token,
        assignedToName: agentName,
        assignedToEmail: agentEmail,
        updatedAt: serverTimestamp()
      };

      const missions = ["CHECKIN","MENAGE","CHECKOUT"];

      for(const mid of missions){
        const visibleGroups = visibleGroupsForMission(mid, keys);
        const checklist = defaultChecklistForMission(mid);

        await setDoc(doc(db, "events", prestationId, "missions", mid), {
          ...common,
          id: mid,
          type: mid,
          status: "ASSIGNEE",
          locked: false,

          checklist,
          checklistMeta: {
            version: 1,
            visibleGroups,
            sourceKeys: keys
          },

          agentDone: false,
          agentDoneAt: null,
          agentComment: ""
        }, { merge: true });
      }
    }

    // State
    let currentUser = null;
    const prestationId = qs("prestationId") || qs("eventId") || "";
    let prestation = null;

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    async function loadPrestation(){
      if(!prestationId){
        showAlert("⛔ prestationId manquant dans l'URL. Ouvre depuis prestations.html (Programmer).");
        return false;
      }

      const ref = doc(db, "events", prestationId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        showAlert("⛔ Prestation introuvable (events/" + prestationId + ").");
        return false;
      }

      const x = snap.data() || {};
      if(x.conciergerieUid && x.conciergerieUid !== currentUser.uid){
        showAlert("⛔ Accès refusé : cette prestation n'est pas à cette conciergerie.");
        return false;
      }

      prestation = { id: snap.id, ...x };

      const title = `${x.homeName || "Logement"}${x.homeCity ? " — " + x.homeCity : ""}`;
      const dt = `${x.dateKey || x.date || "—"}${x.time ? " à " + x.time : ""}`;

      homeLine.value = title;
      dtLine.value = dt;
      prestaHint.textContent = "#" + prestationId.slice(0,6);

      // adresse editable (stockée dans l'event)
      addrInput.value = (x.homeAddress || x.address || "").trim();

      // agent depuis event
      const aName = (x.assignedToName || "").trim();
      const aEmail = normalizeEmail(x.assignedToEmail || "");
      agentLine.value = aName ? `${aName}${aEmail ? " • " + aEmail : ""}` : "—";

      sendLinkBtn.disabled = !(aName && aEmail);

      renderLinesAgentFriendly(x);

      return true;
    }

    function renderLinesAgentFriendly(x){
      linesList.innerHTML = "";

      const lines = Array.isArray(x.lines) ? x.lines : (Array.isArray(x.items) ? x.items : []);

      if(!lines.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Aucune tâche enregistrée sur cette prestation.";
        linesList.appendChild(e);
        return;
      }

      for(const l of lines){
        const label =
          (l.label || l.name || l.serviceName || l.title || "Tâche").toString().trim();

        const note =
          (l.note || l.details || l.meta || l.description || "").toString().trim();

        const box = document.createElement("div");
        box.className = "line-item";
        box.innerHTML = `
          <div class="li-title">${esc(label)}</div>
          ${note ? `<div class="li-sub">${esc(note)}</div>` : `<div class="li-sub">—</div>`}
        `;
        linesList.appendChild(box);
      }
    }

    async function saveAddress(){
      hideAlert();
      if(!prestationId) return;

      const addr = (addrInput.value || "").trim();
      try{
        await updateDoc(doc(db, "events", prestationId), {
          homeAddress: addr,
          updatedAt: serverTimestamp()
        });
        showAlert("✅ Adresse enregistrée.", true);
      }catch(err){
        console.error(err);
        showAlert("Erreur sauvegarde adresse : " + (err?.message || "inconnue"));
      }
    }

    function buildMail({agentName, token}){
      const base = location.origin + location.pathname.replace(/\/[^\/]*$/, "/");
      const link = base + "agent.html?token=" + encodeURIComponent(token);

      const home = homeLine.value || "Logement";
      const dt = dtLine.value || "—";
      const addr = (addrInput.value || "").trim() || "—";

      const subject = `Lien intervention (24h) — ${agentName} — ${home}`;
      const body =
`Bonjour ${agentName},

Voici votre lien d’accès (valable 24h) :
${link}

Logement : ${home}
Adresse : ${addr}
Date / heure : ${dt}

Token : ${token}

Merci.
CleanUp Manager`;

      return { subject, body, link };
    }

    async function sendAgentLink(){
      hideAlert();

      const aName = (prestation?.assignedToName || "").trim();
      const aEmail = normalizeEmail(prestation?.assignedToEmail || "");

      if(!aName || !aEmail){
        showAlert("⛔ Agent manquant sur la prestation. Mets nom + email dans prestations.html.");
        return;
      }

      const token = makeToken(14);
      const expiresAtMs = addHoursMs(nowMs(), 24);
      const expiresAtIso = new Date(expiresAtMs).toISOString();

      try{
        await setDoc(doc(db, "dayTokens", token), {
          conciergerieUid: currentUser.uid,
          prestationId,
          agentName: aName,
          agentEmail: aEmail,
          agentUid: "",
          active: true,
          expiresAtIso,
          createdAt: serverTimestamp()
        });

        // ✅ missions auto : dayToken + assignation + checklist (merge)
        const keys = uniqUpperKeys(prestation?.lines || []);
        await ensureMissionsForToken({
          prestationId,
          token,
          agentName: aName,
          agentEmail: aEmail,
          keys
        });

        const { subject, body, link } = buildMail({ agentName: aName, token });
        linkPreview.style.display = "block";
        linkPreview.innerHTML = `✅ Lien prêt : <b>${esc(link)}</b> (token ${esc(token)})`;

        const mailto = `mailto:${encodeURIComponent(aEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;

        showAlert("✅ Lien généré + mailto ouvert.", true);
      }catch(err){
        console.error(err);
        showAlert("Erreur envoi lien : " + (err?.message || "inconnue"));
      }
    }

    saveAddrBtn.addEventListener("click", saveAddress);
    sendLinkBtn.addEventListener("click", sendAgentLink);

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html?role=conciergerie";
        return;
      }

      currentUser = user;
      emailLine.textContent = user.email || user.uid;

      try{
        hideAlert();
        const ok = await loadPrestation();
        if(!ok) return;
      }catch(err){
        console.error(err);
        showAlert("Erreur initialisation : " + (err?.message || "inconnue"));
      }
    });
  </script>
</body>
</html>
