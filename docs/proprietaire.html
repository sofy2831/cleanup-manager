<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Propriétaire</title>

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --grey:#666;
      --ok:#1b8f4d;
      --bad:#b3261e;
    }

    body{
      margin:0;
      font-family:"Comic Sans MS", sans-serif;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      white-space:nowrap;
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media(min-width:900px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }
    .col{ flex:1; display:flex; flex-direction:column; gap:16px; }

    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }
    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .card-title .sub{
      font-size:12px;
      font-weight:400;
      color:#666;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #D3C7FF;
      font-size:13px;
      outline:none;
      background:#fff;
      font-family:"Comic Sans MS", sans-serif;
    }
    textarea{ resize:vertical; min-height:90px; }
    input:focus, select:focus, textarea:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .form-row{ display:flex; gap:8px; }
    .form-row > div{ flex:1; }

    .cta-btn{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }

    .hint{
      font-size:11px;
      color:#666;
      margin-top:6px;
      line-height:1.25;
    }

    .alert{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .item{
      background:#fff;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px 12px;
      border-left:5px solid rgba(122,92,255,.55);
      text-align:left;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      font-size:11px;
      font-weight:900;
      color:#666;
      margin-bottom:6px;
    }
    .msg{
      margin:0;
      font-size:13px;
      color:#333;
      white-space:pre-wrap;
      line-height:1.35;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:16px;
      font-size:12px;
      color:#666;
      text-align:center;
    }
  </style>
</head>

<body>

<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("proprietaire");
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="index.html">← Accueil</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Espace propriétaire</div>
  <div class="badge" id="badgeLine">—</div>

  <div class="layout">
    <div class="col">

      <!-- ✅ Demander ajout logement -->
      <div class="card">
        <div class="card-title">
          <span>Demander l’ajout d’un logement</span>
          <span class="sub">V1</span>
        </div>

        <div class="alert" id="alertHome"></div>

        <form id="addHomeReqForm">
          <label for="homeName">Nom du logement</label>
          <input id="homeName" type="text" placeholder="Ex. T2 Centre" required>

          <div class="form-row">
            <div>
              <label for="homeCity">Ville</label>
              <input id="homeCity" type="text" placeholder="Ex. Muret" required>
            </div>
            <div>
              <label for="homeType">Type</label>
              <select id="homeType">
                <option>Studio</option><option>T1</option><option>T2</option><option>T3</option>
                <option>T4 et +</option><option>Maison</option>
              </select>
            </div>
          </div>

          <label for="homeMsg">Message (optionnel)</label>
          <textarea id="homeMsg" placeholder="Infos utiles (accès, contraintes, priorité, etc.)"></textarea>

          <button class="cta-btn" type="submit">Envoyer la demande</button>
          <div class="hint">La conciergerie verra ta demande dans “Demandes propriétaires”.</div>
        </form>
      </div>

      <!-- ✅ Message / besoin -->
      <div class="card">
        <div class="card-title">
          <span>Envoyer un message / besoin</span>
          <span class="sub">V1</span>
        </div>

        <div class="alert" id="alertMsg"></div>

        <form id="msgReqForm">
          <label for="needMsg">Ton message</label>
          <textarea id="needMsg" placeholder="Ex. J’ai besoin d’un réassort, ou un souci sur le logement…" required></textarea>

          <button class="cta-btn" type="submit">Envoyer</button>
          <div class="hint">Affiché côté conciergerie (Détail = uniquement le message).</div>
        </form>
      </div>

    </div>

    <!-- ✅ Mes demandes (lecture) -->
    <div class="col">
      <div class="card">
        <div class="card-title">
          <span>Mes demandes</span>
          <span class="sub" id="myReqCount">—</span>
        </div>
        <div class="hint" style="margin-top:-2px;">
          Statuts : pending / accepted / rejected (V1).
        </div>
        <div id="myReqList" class="list"></div>
      </div>
    </div>
  </div>

  <div class="foot">
    V1 : stockage local (dans ton navigateur). En production : vraie base + sécurité + notifications.
  </div>
</div>

<script>
  /* ===== Storage / base ===== */
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }

  function ensureData(){
    const existing = loadData();
    if(existing) return existing;

    const seeded = {
      homes:[],
      events:[],
      services:[],
      threads:[],
      payments:[],
      owners:[],
      invitations:[],
      icalSources:[],
      kits:[],
      requests:[]
    };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.owners = Array.isArray(app.owners) ? app.owners : [];
  app.requests = Array.isArray(app.requests) ? app.requests : [];

  function normalizeEmail(s){ return (s||"").trim().toLowerCase(); }

  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }

  function getOwnerFromSession(){
    const s = getSession();
    if(!s || s.role !== "proprietaire") return null;

    // 1) ownerId si présent
    if(s.ownerId){
      const byId = app.owners.find(o => o.id === s.ownerId);
      if(byId) return byId;
    }
    // 2) fallback email
    if(s.email){
      const byEmail = app.owners.find(o => normalizeEmail(o.email) === normalizeEmail(s.email));
      if(byEmail) return byEmail;
    }
    return null;
  }

  const owner = getOwnerFromSession();

  // (optionnel) si tu as un badge quelque part, on le remplit, sinon on ignore
  const badgeLine = document.getElementById("badgeLine");
  if(badgeLine){
    badgeLine.textContent = owner
      ? `Connecté : ${owner.fullname || owner.email}`
      : "Session propriétaire introuvable (repasser par invite.html).";
  }

  /* ===== Alerts ===== */
  function showAlert(el, msg, ok=false){
    if(!el) return;
    el.style.display = "block";
    el.classList.toggle("ok", !!ok);
    el.innerHTML = msg;
  }
  function hideAlert(el){
    if(!el) return;
    el.style.display = "none";
    el.classList.remove("ok");
    el.innerHTML = "";
  }

  function fmtDate(ts){
    try{
      const d = new Date(ts);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${dd}/${mm} ${hh}:${mi}`;
    }catch(e){
      return "";
    }
  }

  /* ===== Push requests ===== */
  function pushRequest(req){
    app.requests.unshift(req);
    saveData(app);
    renderMyRequests();
  }

  // Demande ajout logement
  const addHomeReqForm = document.getElementById("addHomeReqForm");
  const alertHome = document.getElementById("alertHome");

  if(addHomeReqForm){
    addHomeReqForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      hideAlert(alertHome);

      if(!owner){
        showAlert(alertHome, "⚠️ Propriétaire non trouvé. Recrée ton accès via le lien d’invitation.", false);
        return;
      }

      const homeName = (document.getElementById("homeName")?.value || "").trim();
      const city = (document.getElementById("homeCity")?.value || "").trim();
      const homeType = (document.getElementById("homeType")?.value || "Studio").trim();
      const extra = (document.getElementById("homeMsg")?.value || "").trim();

      if(!homeName || !city){
        showAlert(alertHome, "Champs manquants : nom + ville.", false);
        return;
      }

      const req = {
        id: uid("req"),
        type: "add_home",
        status: "pending",
        createdAt: Date.now(),

        ownerId: owner.id,
        ownerEmail: owner.email,
        ownerName: owner.fullname || "",

        homeName,
        city,
        homeType,
        team: "Équipe A",

        // ✅ conciergerie affichera uniquement ce message
        message: extra
          ? `Ajout logement : ${homeName} (${city})\n${extra}`
          : `Ajout logement : ${homeName} (${city})`
      };

      pushRequest(req);
      showAlert(alertHome, "✅ Demande envoyée à la conciergerie.", true);
      e.target.reset();
      const typeEl = document.getElementById("homeType");
      if(typeEl) typeEl.value = "Studio";
    });
  }

  // Message / besoin
  const msgReqForm = document.getElementById("msgReqForm");
  const alertMsg = document.getElementById("alertMsg");

  if(msgReqForm){
    msgReqForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      hideAlert(alertMsg);

      if(!owner){
        showAlert(alertMsg, "⚠️ Propriétaire non trouvé. Recrée ton accès via le lien d’invitation.", false);
        return;
      }

      const msg = (document.getElementById("needMsg")?.value || "").trim();
      if(!msg){
        showAlert(alertMsg, "Message vide.", false);
        return;
      }

      const req = {
        id: uid("req"),
        type: "message",
        status: "pending",
        createdAt: Date.now(),

        ownerId: owner.id,
        ownerEmail: owner.email,
        ownerName: owner.fullname || "",

        // ✅ conciergerie = affiche uniquement ce message
        message: msg
      };

      pushRequest(req);
      showAlert(alertMsg, "✅ Message envoyé à la conciergerie.", true);
      e.target.reset();
    });
  }

  /* ===== Render “Mes demandes” ===== */
  function myRequests(){
    if(!owner) return [];
    return app.requests.filter(r =>
      r.ownerId === owner.id ||
      (r.ownerEmail && normalizeEmail(r.ownerEmail) === normalizeEmail(owner.email))
    );
  }

  function labelType(t){
    return t === "add_home" ? "Ajout logement" : "Message";
  }

  function escapeHtml(s){
    return (s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/\n/g,"<br>");
  }

  function renderMyRequests(){
    const list = document.getElementById("myReqList");
    const count = document.getElementById("myReqCount");
    if(!list || !count) return;

    const items = myRequests();
    count.textContent = `${items.length}`;

    list.innerHTML = "";
    if(items.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `<div class="meta"><span>Aucune demande</span><span>—</span></div><p class="msg">Tu peux envoyer une demande à gauche.</p>`;
      list.appendChild(empty);
      return;
    }

    items.forEach(r=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="meta">
          <span>${labelType(r.type)} • ${r.status}</span>
          <span>${fmtDate(r.createdAt || Date.now())}</span>
        </div>
        <p class="msg">${escapeHtml(r.message)}</p>
      `;
      list.appendChild(el);
    });
  }

  renderMyRequests();
</script>
