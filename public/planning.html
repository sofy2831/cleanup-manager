<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Planning</title>

  <style>
    :root {
      --violet-light: #F3ECFF;
      --violet-main: #7A5CFF;
      --violet-dark: #6238FF;
      --text-dark: #111;
      --bad:#b3261e;
      --ok:#1b8f4d;
    }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #F8F4FF 0%, #EDE6FF 80%);
      color: var(--text-dark);
    }
    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 16px 32px;
      box-sizing: border-box;
    }
    .topbar {
      width: 100%;
      max-width: 960px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
      background: rgba(248, 244, 255, 0.85);
      backdrop-filter: blur(6px);
    }
    .pill-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--violet-main);
      color: var(--violet-main);
      text-decoration: none;
      font-weight: 900;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      white-space: nowrap;
      cursor: pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .logo-title {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 6px;
      text-align: center;
    }
    .logo-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #FFF;
      border: 2px solid var(--violet-main);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--violet-main);
      font-size: 20px;
      font-weight: 900;
      position: relative;
      flex-shrink: 0;
    }
    .logo-icon::after {
      content: "‚ú¶";
      position: absolute;
      top: -6px;
      right: -4px;
      font-size: 12px;
      color: var(--violet-main);
    }
    h1 { font-size: 24px; margin: 0; font-weight: 900; color: #111; }
    .subtitle { font-size: 16px; color: #444; margin-top: 4px; text-align: center; }
    .badge {
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      color: #555;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      text-align: center;
      max-width:960px;
    }

    .alert{
      width:100%;
      max-width:960px;
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .top-nav {
      margin-top: 14px;
      display: inline-flex;
      flex-wrap:wrap;
      gap: 4px;
      background: #fff;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 3px;
      max-width: 960px;
      justify-content:center;
    }
    .top-nav a {
      text-decoration: none;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      color: #555;
    }
    .top-nav a.active {
      background: var(--violet-main);
      color: #fff;
      font-weight: 900;
    }

    .summary {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (min-width: 768px) {
      .summary { grid-template-columns: repeat(4, 1fr); }
    }
    .summary-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 10px 10px 12px;
      text-align: left;
    }
    .summary-title { font-size: 12px; color: #666; font-weight: 900; margin-bottom: 4px; }
    .summary-value { font-size: 18px; font-weight: 900; color: #222; }
    .summary-note { font-size: 11px; color: #666; margin-top: 2px; }

    .planning-layout {
      width: 100%;
      max-width: 960px;
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (min-width: 768px) {
      .planning-layout { flex-direction: row; align-items: flex-start; }
    }
    .calendar-card, .agenda-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      padding: 16px 14px 18px;
      box-sizing: border-box;
    }
    .calendar-card { flex: 1.2; }
    .agenda-card { flex: 1; }

    .card-title {
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .month-label { font-size: 15px; font-weight: 900; }

    .month-btn {
      border: none;
      background: #fff;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      color: var(--violet-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-weight: 900;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
      text-align: center;
    }
    .weekdays div { padding: 4px 0; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

    .day-cell {
      height: 32px;
      border-radius: 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      background: #fff;
      border: 1px solid transparent;
      position: relative;
      user-select: none;
    }
    .day-cell.outside { opacity: 0.25; cursor: default; }
    .day-cell.today { border-color: var(--violet-main); font-weight: 900; }
    .day-cell.has-events::after {
      content: "";
      position: absolute;
      bottom: 4px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--violet-main);
    }
    .day-cell.has-blocked::before{
      content:"üîí";
      position:absolute;
      top:3px;
      right:5px;
      font-size:10px;
      opacity:.8;
    }
    .day-cell.selected {
      background: var(--violet-main);
      color: #fff;
      border-color: var(--violet-main);
    }

    .agenda-header { font-size: 14px; color: #555; margin-bottom: 8px; }
    .agenda-date { font-weight: 900; color: var(--violet-dark); }

    .agenda-list { display: flex; flex-direction: column; gap: 8px; }

    .agenda-item {
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      text-align: left;
      border-left: 4px solid var(--violet-main);
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      position:relative;
    }
    .agenda-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0,0,0,0.10);
    }
    .agenda-item.blocked{ opacity:.88; }

    .agenda-line1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      gap: 8px;
    }
    .agenda-time { font-weight: 900; color: #333; }

    .agenda-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--violet-light);
      color: #5b45c8;
      font-weight: 900;
      white-space: nowrap;
    }
    .agenda-type.t-menage      { background: #E9F7EF; color: #1E7A3A; }
    .agenda-type.t-checkin     { background: #E8F0FE; color: #1A5FD0; }
    .agenda-type.t-checkout    { background: #FCE8E6; color: #B3261E; }
    .agenda-type.t-reassort    { background: #FFF4E5; color: #a19600; }
    .agenda-type.t-maintenance { background: #EFEAFB; color: #5B45C8; }
    .agenda-type.t-photos      { background: #E7F7FA; color: #0B7285; }
    .agenda-type.t-urgence     { background: #FFE3EC; color: #A61E4D; }

    .agenda-logement { font-weight: 900; color: #333; }
    .agenda-meta { font-size: 11px; color: #666; margin-top: 2px; }

    .pill-blocked{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#eee;
      color:#777;
      font-weight:900;
      white-space:nowrap;
    }

    .agenda-empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      padding: 18px 4px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    .agenda-cta{
      margin-top:10px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .agenda-cta button{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      min-width:210px;
      text-align:center;
    }
    .fineprint{
      font-size:11px;
      color:#666;
      text-align:center;
      margin-top:4px;
      max-width:320px;
      line-height:1.25;
    }
  </style>
</head>

<body>

<!-- ‚úÖ UN SEUL guard localStorage (conciergerie/admin). Plus de requireRole("conciergerie") -->
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;
    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

<div class="page">
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="logements.html">Logements</a>
      <a class="pill-link" href="prestations.html">Catalogue</a>
      <button class="pill-link" onclick="logout()" type="button">D√©connexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">‚úì</div>
    <h1>CleanUp Manager</h1>
  </div>

  <div class="subtitle" id="subtitle">Planning des prestations</div>
  <div class="badge" id="badge">Firestore (homes + events) ‚Ä¢ sans index (tri JS)</div>

  <div class="alert" id="alertBox"></div>

  <div class="top-nav">
    <a href="planning.html" class="active">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="messagerie.html">Messagerie</a>
    <a href="import-ical.html">Import iCal</a>
  </div>

  <div class="summary">
    <div class="summary-card">
      <div class="summary-title">Aujourd‚Äôhui</div>
      <div class="summary-value" id="kpiToday">‚Äî</div>
      <div class="summary-note">prestations</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">7 jours</div>
      <div class="summary-value" id="kpiWeek">‚Äî</div>
      <div class="summary-note">prestations</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Logements</div>
      <div class="summary-value" id="kpiHomes">‚Äî</div>
      <div class="summary-note">g√©r√©s</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">√âv√©nements (mois)</div>
      <div class="summary-value" id="kpiEvents">‚Äî</div>
      <div class="summary-note">charg√©s</div>
    </div>
  </div>

  <div class="planning-layout">
    <div class="calendar-card">
      <div class="card-title">
        <span>Calendrier</span>
        <span style="font-size:12px; color:#666;">‚Ä¢ point = jour avec prestations ‚Ä¢ üîí = au moins 1 bloqu√©e</span>
      </div>

      <div class="month-header">
        <button class="month-btn" id="prevMonth">&lt;</button>
        <div class="month-label" id="monthLabel">Mois Ann√©e</div>
        <button class="month-btn" id="nextMonth">&gt;</button>
      </div>

      <div class="weekdays">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
      </div>

      <div class="calendar-grid" id="calendarDays"></div>
    </div>

    <div class="agenda-card">
      <div class="card-title"><span>Agenda du jour</span></div>

      <div class="agenda-header">
        Prestations du <span class="agenda-date" id="agendaDateLabel"></span>
      </div>

      <div class="agenda-list" id="agendaList"></div>

      <div class="agenda-cta">
        <button type="button" id="addBtn">+ Ajouter une prestation</button>
        <div class="fineprint">Clique une prestation pour la voir (V1).</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { collection, query, where, onSnapshot, addDoc, serverTimestamp } from
    "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ===== UI =====
  const alertBox = document.getElementById("alertBox");
  function showAlert(msg, ok=false){
    alertBox.style.display = "block";
    alertBox.classList.toggle("ok", !!ok);
    alertBox.textContent = msg;
  }
  function hideAlert(){
    alertBox.style.display = "none";
    alertBox.classList.remove("ok");
    alertBox.textContent = "";
  }

  const monthLabelEl = document.getElementById("monthLabel");
  const calendarDaysEl = document.getElementById("calendarDays");
  const agendaDateLabelEl = document.getElementById("agendaDateLabel");
  const agendaListEl = document.getElementById("agendaList");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");

  const kpiTodayEl  = document.getElementById("kpiToday");
  const kpiWeekEl   = document.getElementById("kpiWeek");
  const kpiHomesEl  = document.getElementById("kpiHomes");
  const kpiEventsEl = document.getElementById("kpiEvents");

  const subtitleEl = document.getElementById("subtitle");
  const badgeEl = document.getElementById("badge");
  const addBtn = document.getElementById("addBtn");

  // ===== Utils =====
  const MONTHS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function formatDateKey(date){ return date.getFullYear()+"-"+pad2(date.getMonth()+1)+"-"+pad2(date.getDate()); }
  function formatDateLabel(date){ return date.getDate()+" "+MONTHS[date.getMonth()]+" "+date.getFullYear(); }
  function typeClass(label){
    const s = (label || "").toLowerCase();
    if (s.includes("m√©nage")) return "t-menage";
    if (s.includes("check-in") || s.includes("check in")) return "t-checkin";
    if (s.includes("check-out") || s.includes("check out")) return "t-checkout";
    if (s.includes("r√©assort") || s.includes("reassort")) return "t-reassort";
    if (s.includes("maintenance")) return "t-maintenance";
    if (s.includes("photo")) return "t-photos";
    if (s.includes("urgence")) return "t-urgence";
    return "t-maintenance";
  }

  function getHomeIdFromUrl(){
    const p = new URLSearchParams(location.search);
    return p.get("homeId");
  }
  const focusHomeId = getHomeIdFromUrl();

  // ===== State =====
  const today = new Date();
  let currentMonth = today.getMonth();
  let currentYear  = today.getFullYear();
  let selectedDate = new Date(currentYear, currentMonth, today.getDate());

  let homes = [];
  let homesById = new Map();
  let allEvents = []; // on √©coute tout, filtre JS => 0 index

  let unsubHomes = null;
  let unsubEvents = null;

  function setHomes(list){
    homes = list || [];
    homesById = new Map(homes.map(h => [h.id, h]));
  }
  function getHomeById(id){ return homesById.get(id) || null; }

  function setHeader(){
    if(focusHomeId){
      const h = getHomeById(focusHomeId);
      const label = h ? `${h.name} ‚Äî ${h.city}` : "Logement inconnu";
      subtitleEl.textContent = "Planning (filtr√©) : " + label;
      badgeEl.textContent = "planning.html?homeId=" + focusHomeId + " ‚Ä¢ Firestore";
    }else{
      subtitleEl.textContent = "Planning des prestations";
      badgeEl.textContent = "Firestore (homes + events) ‚Ä¢ sans index (tri JS)";
    }
  }

  function inCurrentMonth(dateKey){
    // dateKey = YYYY-MM-DD
    const [y,m] = dateKey.split("-").map(Number);
    return y === currentYear && m === (currentMonth+1);
  }

  function filteredEvents(){
    let evs = allEvents.slice();

    // filtre home si besoin
    if(focusHomeId){
      evs = evs.filter(e => e.homeId === focusHomeId);
    }

    // filtre mois courant
    evs = evs.filter(e => e.date && inCurrentMonth(e.date));

    // tri local
    evs.sort((a,b)=>{
      const ak = (a.date||"") + " " + (a.time||"");
      const bk = (b.date||"") + " " + (b.time||"");
      return ak.localeCompare(bk);
    });

    return evs;
  }

  function eventsForDateKey(dateKey){
    return filteredEvents().filter(e => e.date === dateKey);
  }

  function dayHasBlocked(dateKey){
    return eventsForDateKey(dateKey).some(e => e && e.isBlocked === true);
  }

  function renderKpis(){
    kpiHomesEl.textContent = String(homes.length);

    const monthEvents = filteredEvents();
    kpiEventsEl.textContent = String(monthEvents.length);

    const todayKey = formatDateKey(today);
    kpiTodayEl.textContent = String(monthEvents.filter(e => e.date === todayKey).length);

    // 7 jours glissants (depuis aujourd'hui), pas besoin d'index : filtre JS
    const end7 = new Date(today.getFullYear(), today.getMonth(), today.getDate()+6);
    const startKey = formatDateKey(today);
    const endKey = formatDateKey(end7);

    const weekCount = allEvents.filter(e=>{
      if(focusHomeId && e.homeId !== focusHomeId) return false;
      if(!e.date) return false;
      return e.date >= startKey && e.date <= endKey;
    }).length;

    kpiWeekEl.textContent = String(weekCount);
  }

  function renderCalendar(){
    monthLabelEl.textContent = MONTHS[currentMonth] + " " + currentYear;

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstDayWeek = firstDay.getDay(); // 0=dimanche
    const startIndex = (firstDayWeek + 6) % 7; // 0=lundi

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

    calendarDaysEl.innerHTML = "";
    const totalCells = 42;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement("div");
      cell.classList.add("day-cell");

      let dayNumber;
      let cellDate;

      if(i < startIndex){
        dayNumber = daysInPrevMonth - (startIndex - 1) + i;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth - 1, dayNumber);
      }else if(i >= startIndex + daysInMonth){
        dayNumber = i - (startIndex + daysInMonth) + 1;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth + 1, dayNumber);
      }else{
        dayNumber = i - startIndex + 1;
        cellDate = new Date(currentYear, currentMonth, dayNumber);
      }

      cell.textContent = dayNumber;

      const todayKey = formatDateKey(today);
      const cellKey = formatDateKey(cellDate);
      const selectedKey = formatDateKey(selectedDate);

      if(cellKey === todayKey && cellDate.getMonth() === today.getMonth()){
        cell.classList.add("today");
      }
      if(eventsForDateKey(cellKey).length){
        cell.classList.add("has-events");
      }
      if(dayHasBlocked(cellKey)){
        cell.classList.add("has-blocked");
      }
      if(cellKey === selectedKey){
        cell.classList.add("selected");
      }

      if(!cell.classList.contains("outside")){
        cell.addEventListener("click", ()=>{
          selectedDate = cellDate;
          renderCalendar();
          renderAgenda();
          renderKpis();
        });
      }

      calendarDaysEl.appendChild(cell);
    }
  }

  function renderAgenda(){
    const key = formatDateKey(selectedDate);
    agendaDateLabelEl.textContent = formatDateLabel(selectedDate);
    agendaListEl.innerHTML = "";

    const events = eventsForDateKey(key);

    if(!events.length){
      const empty = document.createElement("div");
      empty.classList.add("agenda-empty");
      empty.textContent = focusHomeId ? "Aucune prestation pour ce logement √† cette date." : "Aucune prestation planifi√©e pour cette journ√©e.";
      agendaListEl.appendChild(empty);
      return;
    }

    events.forEach(ev=>{
      const home = getHomeById(ev.homeId);

      const item = document.createElement("div");
      item.classList.add("agenda-item");
      if(ev.isBlocked) item.classList.add("blocked");

      item.addEventListener("click", ()=>{
        alert(
          [
            `${ev.time || "‚Äî"} ‚Ä¢ ${ev.type || "Prestation"}`,
            home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement"),
            ev.meta ? `D√©tail: ${ev.meta}` : null,
            ev.team ? `√âquipe: ${ev.team}` : null,
            ev.isBlocked ? `üîí BLOQU√â : ${ev.blockReason || "paiement requis"}` : null,
          ].filter(Boolean).join("\n")
        );
      });

      const line1 = document.createElement("div");
      line1.classList.add("agenda-line1");

      const time = document.createElement("div");
      time.classList.add("agenda-time");
      time.textContent = ev.time || "‚Äî";

      const right = document.createElement("div");
      right.style.display = "inline-flex";
      right.style.alignItems = "center";
      right.style.gap = "6px";

      if(ev.isBlocked){
        const b = document.createElement("span");
        b.className = "pill-blocked";
        b.textContent = "üîí Bloqu√©";
        right.appendChild(b);
      }

      const type = document.createElement("div");
      type.classList.add("agenda-type", typeClass(ev.type));
      type.textContent = ev.type || "Prestation";
      right.appendChild(type);

      line1.appendChild(time);
      line1.appendChild(right);

      const logement = document.createElement("div");
      logement.classList.add("agenda-logement");
      logement.textContent = home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement");

      const meta = document.createElement("div");
      meta.classList.add("agenda-meta");
      const parts = [
        home?.ownerName ? `Proprio: ${home.ownerName}` : (home?.ownerEmail ? `Proprio: ${home.ownerEmail}` : null),
        ev.team ? `√âquipe: ${ev.team}` : null,
        ev.meta ? ev.meta : null
      ].filter(Boolean);

      if(ev.isBlocked) parts.push(ev.blockReason ? ev.blockReason : "Paiement requis");
      meta.textContent = parts.join(" ‚Ä¢ ");

      item.appendChild(line1);
      item.appendChild(logement);
      item.appendChild(meta);

      agendaListEl.appendChild(item);
    });
  }

  function stop(){
    if(unsubHomes) unsubHomes();
    if(unsubEvents) unsubEvents();
    unsubHomes = unsubEvents = null;
  }

  function start(user){
    // HOMES : 1 filtre => pas d‚Äôindex, tri JS
    unsubHomes = onSnapshot(
      query(collection(db, "homes"), where("conciergerieUid","==", user.uid)),
      (snap)=>{
        const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        list.sort((a,b)=>{
          const ta = a.createdAt?.seconds ? a.createdAt.seconds : 0;
          const tb = b.createdAt?.seconds ? b.createdAt.seconds : 0;
          return tb - ta;
        });
        setHomes(list);
        setHeader();
        renderCalendar(); renderAgenda(); renderKpis();
      },
      (err)=> showAlert("Erreur homes : " + (err?.message || "inconnue"))
    );

    // EVENTS : 1 filtre => pas d‚Äôindex, filtre/tri JS
    unsubEvents = onSnapshot(
      query(collection(db, "events"), where("conciergerieUid","==", user.uid)),
      (snap)=>{
        allEvents = snap.docs.map(d => ({ id:d.id, ...d.data() }));
        hideAlert();
        renderCalendar(); renderAgenda(); renderKpis();
      },
      (err)=> showAlert("Erreur events : " + (err?.message || "inconnue"))
    );
  }

  async function addPresta(){
    const user = auth.currentUser;
    if(!user){ showAlert("Non connect√© Firebase."); return; }
    if(!homes.length){
      alert("Ajoute d‚Äôabord un logement (ou accepte une demande).");
      location.href = "logements.html";
      return;
    }

    let chosenHome = null;
    if(focusHomeId){
      chosenHome = getHomeById(focusHomeId);
      if(!chosenHome){ alert("homeId invalide."); return; }
    }else{
      const list = homes.map((h,i)=>`${i+1}. ${h.name} (${h.city}) ‚Äî ${(h.ownerName||h.ownerEmail||"‚Äî")}`).join("\n");
      const pickStr = prompt("Choisis un logement (num√©ro) :\n\n" + list);
      if(!pickStr) return;
      const idx = Number(pickStr) - 1;
      chosenHome = homes[idx] || null;
      if(!chosenHome){ alert("Num√©ro invalide."); return; }
    }

    const type = prompt("Type (M√©nage / Check-in / Check-out / R√©assort / Maintenance / Photos / Urgence) ?", "M√©nage");
    if(!type) return;

    const time = prompt("Heure (HH:MM) ?", "10:00");
    if(!time) return;

    const meta = prompt("D√©tail (optionnel) ?", "") || "";
    const team = prompt("√âquipe (optionnel) ?", (chosenHome.team || "√âquipe A")) || "";

    const payload = {
      conciergerieUid: user.uid,
      date: formatDateKey(selectedDate),
      time: String(time).trim(),
      type: String(type).trim(),
      homeId: chosenHome.id,
      homeName: chosenHome.name || "",
      meta: String(meta).trim(),
      team: String(team).trim(),
      source: "manuel",
      createdAt: serverTimestamp(),
      isBlocked: false,
      blockReason: "",
      paymentId: null
    };

    try{
      await addDoc(collection(db, "events"), payload);
      showAlert("‚úÖ Prestation ajout√©e.", true);
      setTimeout(hideAlert, 900);
    }catch(err){
      showAlert("Erreur ajout prestation : " + (err?.message || "inconnue"));
    }
  }

  addBtn.addEventListener("click", addPresta);

  prevMonthBtn.addEventListener("click", ()=>{
    currentMonth--;
    if(currentMonth < 0){ currentMonth = 11; currentYear--; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  nextMonthBtn.addEventListener("click", ()=>{
    currentMonth++;
    if(currentMonth > 11){ currentMonth = 0; currentYear++; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  onAuthStateChanged(auth, (user)=>{
    if(!user){
      // Firebase auth absent => login
      location.href = "login.html?role=conciergerie";
      return;
    }
    hideAlert();
    stop();
    start(user);
    setHeader();
    renderCalendar(); renderAgenda(); renderKpis();
  });
</script>
</body>
</html>
