<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Planning</title>

  <style>
    :root {
      --violet-light: #F3ECFF;
      --violet-main: #7A5CFF;
      --violet-dark: #6238FF;
      --text-dark: #111;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Comic Sans MS", sans-serif;
      background: linear-gradient(180deg, #F8F4FF 0%, #EDE6FF 80%);
      color: var(--text-dark);
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 16px 32px;
      box-sizing: border-box;
    }

    .topbar {
      width: 100%;
      max-width: 960px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 10px 0;
      background: rgba(248, 244, 255, 0.85);
      backdrop-filter: blur(6px);
    }

    .pill-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #fff;
      border: 2px solid var(--violet-main);
      color: var(--violet-main);
      text-decoration: none;
      font-weight: 800;
      font-size: 13px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      white-space: nowrap;
      cursor: pointer;
    }

    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 6px;
      text-align: center;
    }

    .logo-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #FFF;
      border: 2px solid var(--violet-main);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--violet-main);
      font-size: 20px;
      font-weight: 900;
      position: relative;
      flex-shrink: 0;
    }

    .logo-icon::after {
      content: "‚ú¶";
      position: absolute;
      top: -6px;
      right: -4px;
      font-size: 12px;
      color: var(--violet-main);
    }

    h1 { font-size: 24px; margin: 0; font-weight: 800; color: #111; }
    .subtitle { font-size: 16px; color: #444; margin-top: 4px; text-align: center; }
    .badge {
      margin-top: 10px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      color: #555;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      text-align: center;
    }

    /* NAV */
    .top-nav {
      margin-top: 14px;
      display: inline-flex;
      flex-wrap:wrap;
      gap: 4px;
      background: #fff;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 3px;
      max-width: 960px;
      justify-content:center;
    }
    .top-nav a {
      text-decoration: none;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      color: #555;
    }
    .top-nav a.active {
      background: var(--violet-main);
      color: #fff;
      font-weight: 900;
    }

    .summary {
      width: 100%;
      max-width: 960px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (min-width: 768px) {
      .summary { grid-template-columns: repeat(4, 1fr); }
    }

    .summary-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 10px 10px 12px;
      text-align: left;
    }
    .summary-title { font-size: 12px; color: #666; font-weight: 800; margin-bottom: 4px; }
    .summary-value { font-size: 18px; font-weight: 900; color: #222; }
    .summary-note { font-size: 11px; color: #666; margin-top: 2px; }

    .planning-layout {
      width: 100%;
      max-width: 960px;
      margin-top: 14px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    @media (min-width: 768px) {
      .planning-layout { flex-direction: row; align-items: flex-start; }
    }

    .calendar-card, .agenda-card {
      background: linear-gradient(180deg, #FFFFFF 0%, #EEE4FF 100%);
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.10);
      padding: 16px 14px 18px;
      box-sizing: border-box;
    }
    .calendar-card { flex: 1.2; }
    .agenda-card { flex: 1; }

    .card-title {
      font-size: 16px;
      font-weight: 900;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .month-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .month-label { font-size: 15px; font-weight: 900; }

    .month-btn {
      border: none;
      background: #fff;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      color: var(--violet-main);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-weight: 900;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
      text-align: center;
    }
    .weekdays div { padding: 4px 0; }

    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

    .day-cell {
      height: 32px;
      border-radius: 10px;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #333;
      background: #fff;
      border: 1px solid transparent;
      position: relative;
      user-select: none;
    }
    .day-cell.outside { opacity: 0.25; cursor: default; }
    .day-cell.today { border-color: var(--violet-main); font-weight: 900; }
    .day-cell.has-events::after {
      content: "";
      position: absolute;
      bottom: 4px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--violet-main);
    }
    /* ‚úÖ si au moins 1 presta bloqu√©e ce jour-l√† */
    .day-cell.has-blocked::before{
      content:"üîí";
      position:absolute;
      top:3px;
      right:5px;
      font-size:10px;
      opacity:.8;
    }

    .day-cell.selected {
      background: var(--violet-main);
      color: #fff;
      border-color: var(--violet-main);
    }

    .agenda-header { font-size: 14px; color: #555; margin-bottom: 8px; }
    .agenda-date { font-weight: 900; color: var(--violet-dark); }

    .agenda-list { display: flex; flex-direction: column; gap: 8px; }

    .agenda-item {
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      text-align: left;
      border-left: 4px solid var(--violet-main);
      font-size: 13px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      position:relative;
    }
    .agenda-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 5px 14px rgba(0,0,0,0.10);
    }
    /* ‚úÖ presta bloqu√©e : visuel clair */
    .agenda-item.blocked{
      opacity:.88;
    }

    .agenda-line1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
      gap: 8px;
    }
    .agenda-time { font-weight: 900; color: #333; }

    .agenda-type {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--violet-light);
      color: #5b45c8;
      font-weight: 900;
      white-space: nowrap;
    }

    .agenda-type.t-menage      { background: #E9F7EF; color: #1E7A3A; }
    .agenda-type.t-checkin     { background: #E8F0FE; color: #1A5FD0; }
    .agenda-type.t-checkout    { background: #FCE8E6; color: #B3261E; }
    .agenda-type.t-reassort    { background: #FFF4E5; color: #a19600; }
    .agenda-type.t-maintenance { background: #EFEAFB; color: #5B45C8; }
    .agenda-type.t-photos      { background: #E7F7FA; color: #0B7285; }
    .agenda-type.t-urgence     { background: #FFE3EC; color: #A61E4D; }

    .agenda-logement { font-weight: 900; color: #333; }
    .agenda-meta { font-size: 11px; color: #666; margin-top: 2px; }

    .pill-blocked{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:#eee;
      color:#777;
      font-weight:900;
      white-space:nowrap;
    }

    .agenda-empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      padding: 18px 4px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }

    .agenda-cta{
      margin-top:10px;
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
    }
    .agenda-cta button{
      border:none;
      border-radius:999px;
      padding:9px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 10px rgba(0,0,0,0.18);
      min-width:210px;
      text-align:center;
    }
    .fineprint{
      font-size:11px;
      color:#666;
      text-align:center;
      margin-top:4px;
      max-width:320px;
      line-height:1.25;
    }
  </style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="logements.html">Logements</a>
      <a class="pill-link" href="prestations.html">Catalogue</a>
      <button class="pill-link" onclick="logout()" type="button">D√©connexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">‚úì</div>
    <h1>CleanUp Manager</h1>
  </div>

  <div class="subtitle" id="subtitle">Planning des prestations</div>
  <div class="badge" id="badge">Vue mensuelle + agenda</div>

  <div class="top-nav">
    <a href="planning.html" class="active">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="messagerie.html">Messagerie</a>
    <a href="import-ical.html">Import iCal</a>
  </div>

  <div class="summary">
    <div class="summary-card">
      <div class="summary-title">Aujourd‚Äôhui</div>
      <div class="summary-value" id="kpiToday">‚Äî</div>
      <div class="summary-note">prestations</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Cette semaine</div>
      <div class="summary-value" id="kpiWeek">‚Äî</div>
      <div class="summary-note">prestations</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">Logements</div>
      <div class="summary-value" id="kpiHomes">‚Äî</div>
      <div class="summary-note">g√©r√©s</div>
    </div>
    <div class="summary-card">
      <div class="summary-title">√âv√©nements</div>
      <div class="summary-value" id="kpiEvents">‚Äî</div>
      <div class="summary-note">total</div>
    </div>
  </div>

  <div class="planning-layout">
    <div class="calendar-card">
      <div class="card-title">
        <span>Calendrier</span>
        <span style="font-size:12px; color:#666;">‚Ä¢ point = jour avec prestations ‚Ä¢ üîí = au moins 1 bloqu√©e</span>
      </div>

      <div class="month-header">
        <button class="month-btn" id="prevMonth">&lt;</button>
        <div class="month-label" id="monthLabel">Mois Ann√©e</div>
        <button class="month-btn" id="nextMonth">&gt;</button>
      </div>

      <div class="weekdays">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
      </div>

      <div class="calendar-grid" id="calendarDays"></div>
    </div>

    <div class="agenda-card">
      <div class="card-title">
        <span>Agenda du jour</span>
      </div>

      <div class="agenda-header">
        Prestations du <span class="agenda-date" id="agendaDateLabel"></span>
      </div>

      <div class="agenda-list" id="agendaList"></div>

      <div class="agenda-cta">
        <button type="button" onclick="addPresta()">+ Ajouter une prestation</button>
        <div class="fineprint">Clique une prestation pour la modifier/supprimer.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){
    localStorage.setItem(DATA_KEY, JSON.stringify(d));
  }
  function ensureData(){
    const existing = loadData();
    if(existing) return existing;
    const seeded = { homes:[], events:[], services:[], icalSources:[], payments:[], threads:[], kits:[], requests:[] };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.homes  = Array.isArray(app.homes)  ? app.homes  : [];
  app.events = Array.isArray(app.events) ? app.events : [];
  app.services = Array.isArray(app.services) ? app.services : [];
  app.icalSources = Array.isArray(app.icalSources) ? app.icalSources : [];
  app.payments = Array.isArray(app.payments) ? app.payments : [];
  app.requests = Array.isArray(app.requests) ? app.requests : [];

  (function migrateData(){
    let changed = false;

    app.homes.forEach(h=>{
      if(!h.id){ h.id = uid("h"); changed = true; }
    });

    app.events.forEach(e=>{
      if(!e.id){ e.id = uid("e"); changed = true; }

      // ‚úÖ champs ajout√©s pour le lien paiement
      if(typeof e.isBlocked !== "boolean"){ e.isBlocked = false; changed = true; }
      if(typeof e.blockReason !== "string"){ e.blockReason = ""; changed = true; }
      if(typeof e.paymentId === "undefined"){ e.paymentId = null; changed = true; }
    });

    if(changed) saveData(app);
  })();

  const MONTHS = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function formatDateKey(date){ return date.getFullYear()+"-"+pad2(date.getMonth()+1)+"-"+pad2(date.getDate()); }
  function formatDateLabel(date){ return date.getDate()+" "+MONTHS[date.getMonth()]+" "+date.getFullYear(); }

  function typeClass(label){
    const s = (label || "").toLowerCase();
    if (s.includes("m√©nage")) return "t-menage";
    if (s.includes("check-in") || s.includes("check in")) return "t-checkin";
    if (s.includes("check-out") || s.includes("check out")) return "t-checkout";
    if (s.includes("r√©assort") || s.includes("reassort")) return "t-reassort";
    if (s.includes("maintenance")) return "t-maintenance";
    if (s.includes("photo")) return "t-photos";
    if (s.includes("urgence")) return "t-urgence";
    return "t-maintenance";
  }

  function getHomeIdFromUrl(){
    const p = new URLSearchParams(location.search);
    return p.get("homeId");
  }
  let focusHomeId = getHomeIdFromUrl();

  function getHomeById(id){
    return app.homes.find(h=>h.id===id) || null;
  }

  function getPaymentById(id){
    if(!id) return null;
    return app.payments.find(p=>p.id===id) || null;
  }

  // UI refs
  const monthLabelEl = document.getElementById("monthLabel");
  const calendarDaysEl = document.getElementById("calendarDays");
  const agendaDateLabelEl = document.getElementById("agendaDateLabel");
  const agendaListEl = document.getElementById("agendaList");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");

  const kpiTodayEl  = document.getElementById("kpiToday");
  const kpiWeekEl   = document.getElementById("kpiWeek");
  const kpiHomesEl  = document.getElementById("kpiHomes");
  const kpiEventsEl = document.getElementById("kpiEvents");

  const subtitleEl = document.getElementById("subtitle");
  const badgeEl = document.getElementById("badge");

  // State
  const currentDate = new Date();
  let currentMonth = currentDate.getMonth();
  let currentYear  = currentDate.getFullYear();
  let selectedDate = new Date(currentYear, currentMonth, currentDate.getDate());

  function eventsForDateKey(dateKey){
    let evs = app.events.filter(e=>e.date === dateKey);
    if(focusHomeId) evs = evs.filter(e=>e.homeId === focusHomeId);
    return evs.sort((a,b)=> (a.time||"").localeCompare(b.time||""));
  }

  function dayHasBlocked(dateKey){
    const evs = eventsForDateKey(dateKey);
    return evs.some(e => e && e.isBlocked === true);
  }

  function renderHeader(){
    if(focusHomeId){
      const h = getHomeById(focusHomeId);
      const label = h ? `${h.name} ‚Äî ${h.city}` : "Logement inconnu";
      subtitleEl.textContent = "Planning (filtr√©) : " + label;
      badgeEl.textContent = "planning.html?homeId=" + focusHomeId;
    }else{
      subtitleEl.textContent = "Planning des prestations";
      badgeEl.textContent = "Vue mensuelle + agenda";
    }
  }

  function renderCalendar(){
    monthLabelEl.textContent = MONTHS[currentMonth] + " " + currentYear;

    const firstDay = new Date(currentYear, currentMonth, 1);
    const firstDayWeek = firstDay.getDay(); // 0=dimanche
    const startIndex = (firstDayWeek + 6) % 7; // 0=lundi

    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

    calendarDaysEl.innerHTML = "";
    const totalCells = 42;

    for(let i=0;i<totalCells;i++){
      const cell = document.createElement("div");
      cell.classList.add("day-cell");

      let dayNumber;
      let cellDate;

      if(i < startIndex){
        dayNumber = daysInPrevMonth - (startIndex - 1) + i;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth - 1, dayNumber);
      }else if(i >= startIndex + daysInMonth){
        dayNumber = i - (startIndex + daysInMonth) + 1;
        cell.classList.add("outside");
        cellDate = new Date(currentYear, currentMonth + 1, dayNumber);
      }else{
        dayNumber = i - startIndex + 1;
        cellDate = new Date(currentYear, currentMonth, dayNumber);
      }

      cell.textContent = dayNumber;

      const todayKey = formatDateKey(currentDate);
      const cellKey = formatDateKey(cellDate);
      const selectedKey = formatDateKey(selectedDate);

      if(cellKey === todayKey && cellDate.getMonth() === currentDate.getMonth()){
        cell.classList.add("today");
      }
      if(eventsForDateKey(cellKey).length){
        cell.classList.add("has-events");
      }
      if(dayHasBlocked(cellKey)){
        cell.classList.add("has-blocked");
      }
      if(cellKey === selectedKey){
        cell.classList.add("selected");
      }

      if(!cell.classList.contains("outside")){
        cell.addEventListener("click", ()=>{
          selectedDate = cellDate;
          renderCalendar();
          renderAgenda();
          renderKpis();
        });
      }

      calendarDaysEl.appendChild(cell);
    }
  }

  function openEventDetail(ev){
    const url = new URL("prestation-detail.html", location.href);
    url.searchParams.set("eventId", ev.id);
    url.searchParams.set("returnTo", "planning");
    if(ev.homeId) url.searchParams.set("homeId", ev.homeId);
    if(ev.date) url.searchParams.set("date", ev.date);
    location.href = url.toString();
  }

  function onClickEvent(ev){
    if(ev && ev.isBlocked){
      const pay = getPaymentById(ev.paymentId);
      const msg = [
        "Prestation BLOQU√âE (paiement requis).",
        ev.blockReason ? ("Raison : " + ev.blockReason) : null,
        pay?.ref ? ("R√©f paiement : " + pay.ref) : null,
        "",
        "OK = aller sur Paiements",
        "Annuler = ouvrir quand m√™me le d√©tail"
      ].filter(Boolean).join("\n");

      const goPay = confirm(msg);
      if(goPay){
        // simple et efficace : tu arrives sur paiements et tu cherches la ref
        location.href = "paiements.html";
        return;
      }
      openEventDetail(ev);
      return;
    }
    openEventDetail(ev);
  }

  function renderAgenda(){
    const key = formatDateKey(selectedDate);
    agendaDateLabelEl.textContent = formatDateLabel(selectedDate);
    agendaListEl.innerHTML = "";

    const events = eventsForDateKey(key);

    if(!events.length){
      const empty = document.createElement("div");
      empty.classList.add("agenda-empty");
      empty.textContent = focusHomeId ? "Aucune prestation pour ce logement √† cette date." : "Aucune prestation planifi√©e pour cette journ√©e.";
      agendaListEl.appendChild(empty);
      return;
    }

    events.forEach(ev=>{
      const home = getHomeById(ev.homeId);
      const pay = getPaymentById(ev.paymentId);

      const item = document.createElement("div");
      item.classList.add("agenda-item");
      if(ev.isBlocked) item.classList.add("blocked");
      item.title = ev.isBlocked ? "Bloqu√© : paiement requis" : "Cliquer pour modifier / supprimer";
      item.addEventListener("click", ()=> onClickEvent(ev));

      const line1 = document.createElement("div");
      line1.classList.add("agenda-line1");

      const time = document.createElement("div");
      time.classList.add("agenda-time");
      time.textContent = ev.time || "‚Äî";

      const right = document.createElement("div");
      right.style.display = "inline-flex";
      right.style.alignItems = "center";
      right.style.gap = "6px";

      if(ev.isBlocked){
        const b = document.createElement("span");
        b.className = "pill-blocked";
        b.textContent = "üîí Bloqu√©";
        right.appendChild(b);
      }

      const type = document.createElement("div");
      type.classList.add("agenda-type", typeClass(ev.type));
      type.textContent = ev.type || "Prestation";

      right.appendChild(type);

      line1.appendChild(time);
      line1.appendChild(right);

      const logement = document.createElement("div");
      logement.classList.add("agenda-logement");
      logement.textContent = home ? `${home.name} ‚Äî ${home.city}` : (ev.homeName || "Logement");

      const meta = document.createElement("div");
      meta.classList.add("agenda-meta");

      const parts = [
        home?.owner ? `Proprio: ${home.owner}` : null,
        ev.team ? `√âquipe: ${ev.team}` : null,
        ev.meta ? ev.meta : null
      ].filter(Boolean);

      if(ev.isBlocked){
        parts.push(ev.blockReason ? ev.blockReason : "Paiement requis");
        if(pay?.ref) parts.push(`Ref: ${pay.ref}`);
      }

      meta.textContent = parts.join(" ‚Ä¢ ");

      item.appendChild(line1);
      item.appendChild(logement);
      item.appendChild(meta);

      agendaListEl.appendChild(item);
    });
  }

  function renderKpis(){
    kpiHomesEl.textContent = app.homes.length;
    kpiEventsEl.textContent = app.events.length;

    const todayKey = formatDateKey(currentDate);
    kpiTodayEl.textContent = eventsForDateKey(todayKey).length;

    let weekCount = 0;
    for(let i=0;i<7;i++){
      const d = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()+i);
      weekCount += eventsForDateKey(formatDateKey(d)).length;
    }
    kpiWeekEl.textContent = weekCount;
  }

  function addPresta(){
    if(!app.homes.length){
      alert("Ajoute d‚Äôabord un logement (Logements).");
      location.href = "logements.html";
      return;
    }

    let chosenHome = null;

    if(focusHomeId){
      chosenHome = getHomeById(focusHomeId);
      if(!chosenHome){
        alert("homeId invalide.");
        return;
      }
    }else{
      const list = app.homes.map((h,i)=>`${i+1}. ${h.name} (${h.city}) ‚Äî ${h.owner}`).join("\n");
      const pickStr = prompt("Choisis un logement (num√©ro) :\n\n" + list);
      if(!pickStr) return;
      const idx = Number(pickStr) - 1;
      chosenHome = app.homes[idx] || null;
      if(!chosenHome){
        alert("Num√©ro invalide.");
        return;
      }
    }

    const type = prompt("Type (M√©nage / Check-in / Check-out / R√©assort / Maintenance / Photos / Urgence) ?", "M√©nage");
    if(!type) return;

    const time = prompt("Heure (HH:MM) ?", "10:00");
    if(!time) return;

    const meta = prompt("D√©tail (optionnel) ?", "") || "";
    const team = prompt("√âquipe (optionnel) ?", (chosenHome.team || "√âquipe A")) || "";

    const ev = {
      id: uid("e"),
      date: formatDateKey(selectedDate),
      time: String(time).trim(),
      type: String(type).trim(),
      homeId: chosenHome.id,
      homeName: chosenHome.name,
      meta: String(meta).trim(),
      team: String(team).trim(),
      source: "manuel",
      createdAt: Date.now(),

      // ‚úÖ champs de lien paiement
      isBlocked: false,
      blockReason: "",
      paymentId: null
    };

    app.events.push(ev);
    saveData(app);

    renderCalendar();
    renderAgenda();
    renderKpis();
  }
  window.addPresta = addPresta;

  prevMonthBtn.addEventListener("click", ()=>{
    currentMonth--;
    if(currentMonth < 0){ currentMonth = 11; currentYear--; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  nextMonthBtn.addEventListener("click", ()=>{
    currentMonth++;
    if(currentMonth > 11){ currentMonth = 0; currentYear++; }
    selectedDate = new Date(currentYear, currentMonth, 1);
    renderCalendar(); renderAgenda(); renderKpis();
  });

  renderHeader();
  renderCalendar();
  renderAgenda();
  renderKpis();
</script>
</body>
</html>
