<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Demandes propriétaires</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --muted:#666;
      --ok:#1b8f4d;
      --bad:#b3261e;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .wrap{
      width:100%;
      max-width:980px;
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }

    .card-title{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-title .t{
      font-size:16px;
      font-weight:900;
    }
    .card-title .sub{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:#5b45c8;
      border:1px solid rgba(122,92,255,.25);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .tab.active{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
    }

    .req-item{
      background:#fff;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px 12px;
      border-left:5px solid rgba(122,92,255,.55);
      text-align:left;
      margin-top:10px;
    }
    .req-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:#666;
      font-weight:800;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .req-message{
      font-size:13px;
      color:#333;
      line-height:1.35;
      margin:0;
      white-space:pre-wrap;
    }
    .req-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .req-actions button{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn-accept{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
    }
    .btn-done{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
    }
    .btn-reject{
      background:#FFE3EC;
      color:var(--bad);
    }

    .hint{
      font-size:12px;
      color:#666;
      margin-top:6px;
      line-height:1.25;
    }

    .empty{
      background:#fff;
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      color:#666;
      font-size:13px;
      margin-top:10px;
    }

    .alert{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      white-space:pre-wrap;
      max-width:980px;
      width:100%;
    }
    .alert.ok{ border-left-color: var(--ok); }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
      <div style="display:flex; gap:8px; align-items:center;">
        <a class="pill-link primary" href="planning.html">Planning</a>
        <button class="pill-link" id="logoutBtn" type="button">Déconnexion</button>
      </div>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">Demandes propriétaires</div>
    <div class="badge">Firestore • Temps réel</div>

    <div class="alert" id="alertBox"></div>

    <div class="wrap">
      <div class="card">
        <div class="card-title">
          <div>
            <div class="t">Boîte de demandes</div>
            <div class="sub"><span id="pendingCount">0</span> en attente</div>
          </div>
          <div class="tabs">
            <button class="tab active" id="tabPending" type="button">En attente</button>
            <button class="tab" id="tabDone" type="button">Traitées</button>
            <button class="tab" id="tabRejected" type="button">Refusées</button>
          </div>
        </div>

        <div class="hint">
          “Accepter” : si c’est un ajout logement → crée le logement (homes) + rattache au propriétaire (ownerUid) + met la demande en accepted.
          Sinon : met en done.
        </div>

        <div id="reqList"></div>
      </div>
    </div>
  </div>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }

  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;
    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

  <script type="module">
    import { auth, db } from "./firebase-init.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      collection, query, orderBy, onSnapshot,
      doc, updateDoc, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.textContent = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.textContent = "";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      localStorage.removeItem("cm_auth");
      location.href = "index.html";
    });

    const reqList = document.getElementById("reqList");
    const pendingCount = document.getElementById("pendingCount");

    const tabPending = document.getElementById("tabPending");
    const tabDone = document.getElementById("tabDone");
    const tabRejected = document.getElementById("tabRejected");

    let view = "pending";
    let unsubscribe = null;

    function esc(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function fmt(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : new Date(ts || Date.now());
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${dd}/${mm} ${hh}:${mi}`;
      }catch(e){
        return "";
      }
    }

    function setTab(newView){
      view = newView;
      tabPending.classList.toggle("active", view === "pending");
      tabDone.classList.toggle("active", view === "done");
      tabRejected.classList.toggle("active", view === "rejected");
      // re-render depuis le dernier snapshot
      if(window.__lastItems) render(window.__lastItems);
    }

    tabPending.addEventListener("click", ()=>setTab("pending"));
    tabDone.addEventListener("click", ()=>setTab("done"));
    tabRejected.addEventListener("click", ()=>setTab("rejected"));

    function statusBucket(status){
      const s = status || "pending";
      if(s === "pending") return "pending";
      if(s === "refused" || s === "rejected") return "rejected";
      // accepted / done
      return "done";
    }

    function render(items){
      // count pending global
      const pending = items.filter(r => (r.status || "pending") === "pending").length;
      pendingCount.textContent = String(pending);

      // filter by tab
      let list = [];
      if(view === "pending") list = items.filter(r => statusBucket(r.status) === "pending");
      if(view === "done") list = items.filter(r => statusBucket(r.status) === "done");
      if(view === "rejected") list = items.filter(r => statusBucket(r.status) === "rejected");

      reqList.innerHTML = "";
      if(!list.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = view === "pending"
          ? "Aucune demande en attente."
          : (view === "done" ? "Aucune demande traitée." : "Aucune demande refusée.");
        reqList.appendChild(e);
        return;
      }

      list.forEach(r=>{
        const ownerLabel = r.ownerEmail || r.ownerUid || "Propriétaire";
        const typeLabel = (r.type === "add_home") ? "Ajout logement" : (r.type || "Message");
        const title = r.title ? r.title : "";
        const msg = r.message ? r.message : "";

        const wrap = document.createElement("div");
        wrap.className = "req-item";
        wrap.setAttribute("data-id", r.id);

        wrap.innerHTML = `
          <div class="req-meta">
            <span>${esc(typeLabel)} • ${esc(ownerLabel)}</span>
            <span>${fmt(r.createdAt)}</span>
          </div>

          ${title ? `<div style="font-weight:900; font-size:13px; margin-bottom:6px;">${esc(title)}</div>` : ""}

          <p class="req-message">${esc(msg) || "<i>(pas de message)</i>"}</p>

          ${(view === "pending") ? `
            <div class="req-actions">
              <button class="btn-accept" type="button" data-act="accept">Accepter</button>
              <button class="btn-done" type="button" data-act="done">Traiter</button>
              <button class="btn-reject" type="button" data-act="reject">Refuser</button>
            </div>
          ` : ""}
        `;

        reqList.appendChild(wrap);
      });
    }

    async function setStatus(reqId, status){
      await updateDoc(doc(db, "requests", reqId), {
        status,
        decidedAt: serverTimestamp()
      });
    }

    async function acceptRequest(req){
      // Si ajout logement : créer un doc homes + rattacher ownerUid + update request
      if(req.type === "add_home"){
        const p = req.payload || {};
        const homeRef = await addDoc(collection(db, "homes"), {
  conciergerieUid: auth.currentUser.uid,   // IMPORTANT
  ownerUid: req.ownerUid || null,
  ownerEmail: req.ownerEmail || "",
  name: p.homeName || "Logement",
  city: p.city || "",
  type: p.homeType || "Studio",
  team: "Équipe A",
  active: true,
  createdAt: serverTimestamp()
});


        await updateDoc(doc(db, "requests", req.id), {
          status: "accepted",
          decidedAt: serverTimestamp(),
          homeId: homeRef.id
        });

        showAlert("✅ Logement créé (homes/" + homeRef.id + ") + demande acceptée.", true);
        return;
      }

      // Sinon : traité
      await setStatus(req.id, "done");
      showAlert("✅ Demande traitée.", true);
    }

    function bindActions(items){
      reqList.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          hideAlert();

          const card = btn.closest(".req-item");
          const id = card?.getAttribute("data-id");
          if(!id) return;

          const act = btn.getAttribute("data-act");
          const req = items.find(x => x.id === id);
          if(!req) return;

          btn.disabled = true;
          btn.style.opacity = "0.7";

          try{
            if(act === "accept") await acceptRequest(req);
            if(act === "done"){
              await setStatus(id, "done");
              showAlert("✅ Demande marquée traitée.", true);
            }
            if(act === "reject"){
              await setStatus(id, "refused");
              showAlert("✅ Demande refusée.", true);
            }
          }catch(err){
            console.error(err);
            showAlert("Erreur action : " + (err?.message || "inconnue"));
          }finally{
            btn.disabled = false;
            btn.style.opacity = "1";
          }
        });
      });
    }

    function startListening(){
      if(unsubscribe) unsubscribe();
      hideAlert();

      const q = query(collection(db, "requests"), orderBy("createdAt", "desc"));

      unsubscribe = onSnapshot(q, (snap)=>{
        const items = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        window.__lastItems = items;

        render(items);
        bindActions(items);
      }, (err)=>{
        console.error(err);
        showAlert("Erreur Firestore (lecture) : " + (err?.message || "inconnue"));
      });
    }

    onAuthStateChanged(auth, (user)=>{
      if(!user){
        location.href = "login.html";
        return;
      }
      // (optionnel) si tu veux forcer planActive via localStorage cm_auth, tu peux garder ton guard ailleurs.
      startListening();
    });
  </script>
</body>
</html>


