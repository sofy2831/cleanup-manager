<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CleanUp Manager – Historique & Facturation</title>

<style>
:root{
  --violet-light:#F3ECFF;
  --violet-main:#7A5CFF;
  --violet-dark:#6238FF;
  --text-dark:#111;
  --grey:#777;
  --green:#1E7A3A;
  --orange:#B37400;
  --red:#A61E4D;
  --bad:#b3261e;
}

body{
  margin:0;
  font-family:"Comic Sans MS", sans-serif;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}

.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
}

/* TOPBAR */
.topbar{
  width:100%;
  max-width:980px;
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(248,244,255,.85);
  backdrop-filter:blur(6px);
  padding:10px 0;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.pill-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  border:2px solid var(--violet-main);
  color:var(--violet-main);
  background:#fff;
  font-weight:900;
  text-decoration:none;
  font-size:13px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  white-space:nowrap;
  cursor:pointer;
}
.pill-link.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

/* LOGO */
.logo-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.logo-icon{
  width:36px;height:36px;border-radius:50%;
  border:2px solid var(--violet-main);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--violet-main);
  background:#fff;
  position:relative;
}
.logo-icon::after{
  content:"✦";
  position:absolute; top:-6px; right:-4px;
  font-size:12px; color:var(--violet-main);
}
h1{margin:0;font-size:24px;}
.subtitle{font-size:15px;color:#444;text-align:center;margin-top:4px;}
.badge{
  margin-top:8px;
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#555;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}

/* NAV */
.top-nav{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  padding:4px;
  border-radius:999px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.top-nav a{
  text-decoration:none;
  font-size:12px;
  padding:6px 12px;
  border-radius:999px;
  color:#555;
}
.top-nav a.active{
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
}

/* TABS */
.tabs{margin-top:16px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;}
.tab-btn{
  border:none;
  border-radius:999px;
  padding:7px 14px;
  background:#fff;
  font-weight:900;
  cursor:pointer;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.tab-btn.active{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
}

/* FILTER BAR */
.filters{
  width:100%;
  max-width:980px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:14px 0;
}
.filters select,.filters input,.filters button{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid #D3C7FF;
  font-size:12px;
  background:#fff;
  outline:none;
}
.filters input{ flex:1; min-width:180px; }
.filters button{
  border:none;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  font-weight:900;
  cursor:pointer;
}

/* CONTENT */
.content{width:100%;max-width:980px;}
.card{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  padding:16px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
}

/* EVENTS */
.timeline{display:flex;flex-direction:column;gap:10px;}
.event{
  background:#fff;
  padding:10px;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  border-left:5px solid var(--violet-main);
}
.event-header{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;}
.event-type{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  background:var(--violet-light);
  font-weight:900;
  white-space:nowrap;
}
.event-meta{font-size:11px;color:#666;margin-top:4px;line-height:1.25;}
.event-meta b{color:#333;}
.badge-status{
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  font-weight:900;
  white-space:nowrap;
  background:#eee;
  color:#666;
}
.badge-status.done{ background:#E9F7EF; color:var(--green); }
.badge-status.todo{ background:#FFF4DA; color:var(--orange); }
.badge-status.block{ background:#FFE3EC; color:var(--red); }
.badge-status.lock{ background:#EFEAFB; color:#5B45C8; }

.small{ font-size:11px; color:#666; }

/* BILLING */
.billing-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  font-size:12px;
}
.billing-table thead th{
  text-align:left;
  padding:6px 8px;
  color:#555;
  font-weight:900;
}
.billing-table tbody tr{
  background:#fff;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.billing-table tbody td{
  padding:10px 8px;
  vertical-align:middle;
}
.billing-table tbody tr td:first-child{
  border-top-left-radius:12px;
  border-bottom-left-radius:12px;
}
.billing-table tbody tr td:last-child{
  border-top-right-radius:12px;
  border-bottom-right-radius:12px; /* ✅ FIX */
}

.actions{display:flex;gap:6px;flex-wrap:wrap;}
.action-btn{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  background:#eee;
  color:#777;
  cursor:pointer;
}
.action-btn.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
}
.action-btn.danger{ background:#FFE3EC; color:var(--red); }

.hidden{display:none;}
</style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">

  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="paiements.html">Paiements</a>
      <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Historique & facturation</div>
  <div class="badge">Filtrer • contrôler • facturer</div>

  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="messagerie.html">Messagerie</a>
    <a href="paiement.html">Paiements</a>
    <a class="active" href="historique.html">Historique</a>
    <a href="boutique.html">Boutique</a>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="history">Historique</button>
    <button class="tab-btn" data-tab="billing">Facturation</button>
  </div>

  <!-- FILTRES -->
  <div class="filters">
    <select id="filterLogement">
      <option value="">Tous les logements</option>
    </select>

    <select id="filterType">
      <option value="">Tous types</option>
      <option>Ménage</option>
      <option>Check-in</option>
      <option>Check-out</option>
      <option>Réassort</option>
      <option>Maintenance</option>
      <option>Photos</option>
      <option>Urgence</option>
    </select>

    <select id="filterStatus">
      <option value="">Tous statuts</option>
      <option value="done">Terminé</option>
      <option value="todo">À facturer</option>
      <option value="blocked">Bloqué</option>
    </select>

    <input id="searchInput" type="text" placeholder="Recherche (logement, type, équipe, note…)">

    <button type="button" onclick="exportLocked()">Exporter</button>
  </div>

  <div class="content">
    <div class="card" id="tab-history">
      <div class="timeline" id="timeline"></div>
      <div class="small" style="margin-top:10px;text-align:center;">
        V1 : on affiche tes événements (planning). Terminé/À facturer/Bloqué.
      </div>
    </div>

    <div class="card hidden" id="tab-billing">
      <table class="billing-table" aria-label="Facturation">
        <thead>
          <tr>
            <th>Date</th>
            <th>Logement</th>
            <th>Prestation</th>
            <th>Statut</th>
            <th>Montant</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="billingBody"></tbody>
      </table>
      <div class="small" style="margin-top:10px;text-align:center;">
        V1 : pas de PDF/Excel. Juste la structure + “marquer terminé”.
      </div>
    </div>

  </div>
</div>

<script>
/* ===== BASE ===== */
const DATA_KEY = "cm_conciergerie_data_v1";

function uid(prefix){
  return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function loadData(){
  try{
    const raw = localStorage.getItem(DATA_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return null;
}
function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
function ensureData(){
  const existing = loadData();
  if(existing) return existing;
  const seeded = { homes:[], events:[], services:[], threads:[], payments:[], icalSources:[], kits:[], requests:[] };
  saveData(seeded);
  return seeded;
}
const app = ensureData();
app.homes = Array.isArray(app.homes) ? app.homes : [];
app.events = Array.isArray(app.events) ? app.events : [];
app.payments = Array.isArray(app.payments) ? app.payments : [];
app.requests = Array.isArray(app.requests) ? app.requests : [];


/* ✅ migration champs manquants */
(function migrateEvents(){
  let changed = false;
  app.events.forEach(e=>{
    if(!e.id){ e.id = uid("e"); changed = true; }
    if(typeof e.isDone !== "boolean"){ e.isDone = false; changed = true; }
    if(typeof e.isBlocked !== "boolean"){ e.isBlocked = false; changed = true; }
    if(typeof e.blockReason !== "string"){ e.blockReason = ""; changed = true; }
    if(typeof e.paymentId === "undefined"){ e.paymentId = null; changed = true; }
  });
  if(changed) saveData(app);
})();

/* ===== UTIL ===== */
const MONTHS = ["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];
function fmtDateKeyToFr(key){
  const m = String(key||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return key || "—";
  const y = Number(m[1]), mo = Number(m[2])-1, d = Number(m[3]);
  return `${d} ${MONTHS[mo]} ${y}`;
}
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function norm(s){ return (s||"").toString().toLowerCase().trim(); }

function getHomeById(id){ return app.homes.find(h=>h.id===id) || null; }
function getPaymentById(id){ return app.payments.find(p=>p.id===id) || null; }

function computeEventStatus(e){
  if(e.isBlocked) return "blocked";
  if(e.isDone) return "done";
  return "todo";
}

function statusLabel(s){
  if(s==="done") return `<span class="badge-status done">Terminé</span>`;
  if(s==="blocked") return `<span class="badge-status block">Bloqué</span>`;
  return `<span class="badge-status todo">À facturer</span>`;
}

function buildLogementFilter(){
  const fLog = document.getElementById("filterLogement");
  const current = fLog.value;
  const labels = app.homes.map(h => ({
    id: h.id,
    label: `${h.name||"Logement"} • ${h.city||""}`.trim()
  }));
  fLog.innerHTML = `<option value="">Tous les logements</option>` +
    labels.map(l => `<option value="${escapeHtml(l.id)}">${escapeHtml(l.label)}</option>`).join("");
  if(labels.some(l=>l.id===current)) fLog.value = current;
}

const timeline = document.getElementById("timeline");
const billingBody = document.getElementById("billingBody");
const fLog = document.getElementById("filterLogement");
const fType = document.getElementById("filterType");
const fStatus = document.getElementById("filterStatus");
const searchInput = document.getElementById("searchInput");

function render(){
  timeline.innerHTML = "";
  billingBody.innerHTML = "";

  const q = norm(searchInput.value);

  const filtered = app.events
    .map(e => {
      const h = getHomeById(e.homeId);
      const homeLabel = h ? `${h.name||"Logement"} • ${h.city||""}`.trim() : (e.homeName || "Logement");
      const status = computeEventStatus(e);
      const pay = e.paymentId ? getPaymentById(e.paymentId) : null;
      return { e, h, homeLabel, status, pay };
    })
    .filter(x => {
      const okLog = !fLog.value || (x.e.homeId === fLog.value);
      const okType = !fType.value || (norm(x.e.type) === norm(fType.value));
      const okStatus = !fStatus.value || (x.status === fStatus.value);
      const hay = [
        x.homeLabel, x.e.type, x.e.time, x.e.team, x.e.meta,
        x.e.blockReason,
        x.pay ? (`${x.pay.owner} ${x.pay.objet} ${x.pay.ref}`) : ""
      ].map(norm).join(" ");
      const okQ = !q || hay.includes(q);
      return okLog && okType && okStatus && okQ;
    })
    .sort((a,b)=>{
      const da = String(a.e.date||"");
      const db = String(b.e.date||"");
      if(da !== db) return db.localeCompare(da);
      return String(a.e.time||"").localeCompare(String(b.e.time||""));
    });

  if(!filtered.length){
    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML = `<strong>Aucun événement.</strong><div class="event-meta">Ajoute des prestations via Planning.</div>`;
    timeline.appendChild(div);
    return;
  }

  filtered.forEach(x=>{
    const e = x.e;

    const payInfo = x.pay
      ? `<div class="event-meta"><b>Paiement :</b> ${escapeHtml(x.pay.owner||"—")} • ${escapeHtml(x.pay.objet||"—")} • ${escapeHtml(x.pay.ref||"")}</div>`
      : "";

    const blockInfo = e.isBlocked
      ? `<div class="event-meta"><b>Blocage :</b> ${escapeHtml(e.blockReason || "Paiement requis")}</div>`
      : "";

    const div = document.createElement("div");
    div.className = "event";
    div.innerHTML = `
      <div class="event-header">
        <div>
          <strong>${escapeHtml(e.type||"Prestation")} – ${escapeHtml(x.homeLabel)}</strong>
          <div class="event-meta">${escapeHtml(fmtDateKeyToFr(e.date))} • ${escapeHtml(e.time||"—")} • ${statusLabel(x.status)}</div>
        </div>
        <span class="event-type">${escapeHtml(e.type||"")}</span>
      </div>
      ${e.team ? `<div class="event-meta">Équipe : <b>${escapeHtml(e.team)}</b></div>` : ``}
      ${e.meta ? `<div class="event-meta">${escapeHtml(e.meta)}</div>` : ``}
      ${blockInfo}
      ${payInfo}
      <div class="event-meta">
        <button class="action-btn ${e.isDone ? "" : "primary"}" type="button" data-done="${escapeHtml(e.id)}">${e.isDone ? "Annuler terminé" : "Marquer terminé"}</button>
        <button class="action-btn" type="button" data-linkpay="${escapeHtml(e.id)}">Lier paiement</button>
        <button class="action-btn danger" type="button" data-del="${escapeHtml(e.id)}">Supprimer</button>
      </div>
    `;
    timeline.appendChild(div);
  });

  const billingRows = filtered.filter(x => x.status !== "blocked");
  billingRows.forEach(x=>{
    const e = x.e;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(fmtDateKeyToFr(e.date))}</td>
      <td>${escapeHtml(x.homeLabel)}</td>
      <td><strong>${escapeHtml(e.type||"—")}</strong><div class="small">${escapeHtml(e.time||"—")} • ${escapeHtml(e.team||"")}</div></td>
      <td>${statusLabel(x.status)}</td>
      <td><span class="badge-status lock">V1</span></td>
      <td>
        <div class="actions">
          <button class="action-btn" type="button" data-linkpay="${escapeHtml(e.id)}">Lier paiement</button>
          <button class="action-btn primary" type="button" data-done="${escapeHtml(e.id)}">${e.isDone ? "Annuler terminé" : "Marquer terminé"}</button>
        </div>
      </td>
    `;
    billingBody.appendChild(tr);
  });

  document.querySelectorAll("[data-done]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-done");
      const ev = app.events.find(z=>z.id===id);
      if(!ev) return;
      ev.isDone = !ev.isDone;
      saveData(app);
      render();
    });
  });

  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-del");
      const ok = confirm("Supprimer cet événement ? (pas d’annulation)");
      if(!ok) return;
      app.events = app.events.filter(z=>z.id!==id);
      saveData(app);
      render();
    });
  });

  document.querySelectorAll("[data-linkpay]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-linkpay");
      linkPaymentToEvent(id);
    });
  });
}

function linkPaymentToEvent(eventId){
  const ev = app.events.find(e=>e.id===eventId);
  if(!ev){ alert("Événement introuvable."); return; }

  if(!app.payments.length){
    alert("Aucun paiement. Crée un paiement d’abord.");
    location.href = "paiements.html";
    return;
  }

  const sameHome = app.payments.filter(p => p.homeId === ev.homeId);
  const pool = sameHome.length ? sameHome : app.payments;

  const list = pool.slice(0, 30).map((p,i)=>{
    return `${i+1}. ${p.owner} • ${p.objet} • ${p.amount}€ • ${p.status}${p.blocked && p.status!=="paye" ? " (bloqué)" : ""} • ${p.ref||""}`;
  }).join("\n");

  const pick = prompt("Choisis un paiement (numéro) :\n\n" + list);
  if(!pick) return;
  const idx = Number(pick) - 1;
  const chosen = pool[idx];
  if(!chosen){ alert("Numéro invalide."); return; }

  ev.paymentId = chosen.id;

  if(chosen.status !== "paye" && chosen.blocked){
    ev.isBlocked = true;
    ev.blockReason = "Paiement requis (" + (chosen.ref || "sans ref") + ")";
  }else{
    ev.isBlocked = false;
    ev.blockReason = "";
  }

  saveData(app);
  render();
  alert("Paiement lié à la prestation.");
}

function exportLocked(){
  alert("Export PDF/Excel : plus tard. V1 = structure + contrôle.");
}

/* Tabs */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("tab-history").classList.toggle("hidden",btn.dataset.tab!=="history");
    document.getElementById("tab-billing").classList.toggle("hidden",btn.dataset.tab!=="billing");
  });
});

buildLogementFilter();
[fLog,fType,fStatus].forEach(el=>el.addEventListener("change",render));
searchInput.addEventListener("input",render);
render();
</script>
</body>
</html>
