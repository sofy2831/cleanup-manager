<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Détail prestation</title>

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --bad:#b3261e;
    }

    body{
      margin:0;
      font-family:"Comic Sans MS", sans-serif;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:820px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .card{
      width:100%;
      max-width:820px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }

    h1{
      margin:0;
      font-size:18px;
      font-weight:900;
      color:#111;
    }

    .sub{
      margin-top:6px;
      font-size:12px;
      color:#666;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #D3C7FF;
      font-size:13px;
      outline:none;
      background:#fff;
      font-family:"Comic Sans MS", sans-serif;
    }
    textarea{ resize:vertical; }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row > div{ flex:1; min-width:180px; }

    .btn-row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:14px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.danger{
      background:linear-gradient(90deg,#d64c4c,#b3261e);
      color:#fff;
      border-color:transparent;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .empty{
      width:100%;
      max-width:820px;
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      padding:16px 14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      color:#666;
      text-align:center;
    }
  </style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">

  <div class="topbar">
    <button class="pill-link" type="button" onclick="goBack()">← Retour</button>
    <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
  </div>

  <div id="missing" class="empty" style="display:none;">
    Prestation introuvable. (eventId manquant ou supprimé)
    <div style="margin-top:10px;">
      <button class="btn" type="button" onclick="goBack()">Retour planning</button>
    </div>
  </div>

  <div class="card" id="card" style="display:none;">
    <h1>Détail prestation</h1>
    <div class="sub">Ici tu modifies / supprimes une prestation planifiée (événement).</div>

    <form id="form">
      <label>Logement</label>
      <select id="homeId"></select>

      <div class="row">
        <div>
          <label>Date</label>
          <input id="date" type="date" required>
        </div>
        <div>
          <label>Heure</label>
          <input id="time" type="time" required>
        </div>
      </div>

      <label>Type</label>
      <input id="type" type="text" placeholder="Ex. Ménage / Check-in / Check-out…" required>

      <label>Détail (optionnel)</label>
      <textarea id="meta" rows="3" placeholder="Notes, consignes, etc."></textarea>

      <label>Équipe (optionnel)</label>
      <input id="team" type="text" placeholder="Ex. Équipe A">

      <div class="btn-row">
        <button class="btn primary" type="submit">Enregistrer</button>
        <button class="btn" type="button" onclick="goBack()">Annuler</button>
        <button class="btn danger" type="button" onclick="deleteEvent()">Supprimer</button>
      </div>
    </form>
  </div>

</div>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return { homes:[], events:[], services:[], icalSources:[] };
  }
  function saveData(d){
    localStorage.setItem(DATA_KEY, JSON.stringify(d));
  }

  const params = new URLSearchParams(location.search);
  const eventId = params.get("eventId");
  const returnTo = params.get("returnTo") || "planning";
  const returnHomeId = params.get("homeId") || "";
  const returnDate = params.get("date") || "";

  const app = loadData();
  app.homes = Array.isArray(app.homes) ? app.homes : [];
  app.events = Array.isArray(app.events) ? app.events : [];

  const missingEl = document.getElementById("missing");
  const cardEl = document.getElementById("card");

  const homeSel = document.getElementById("homeId");
  const dateEl = document.getElementById("date");
  const timeEl = document.getElementById("time");
  const typeEl = document.getElementById("type");
  const metaEl = document.getElementById("meta");
  const teamEl = document.getElementById("team");
  const formEl = document.getElementById("form");

  let ev = app.events.find(e => e.id === eventId);

  function goBack(){
    if(returnTo === "planning"){
      let url = "planning.html";
      const qs = [];
      if(returnHomeId) qs.push("homeId=" + encodeURIComponent(returnHomeId));
      if(qs.length) url += "?" + qs.join("&");
      location.href = url;
      return;
    }
    location.href = "conciergerie.html";
  }
  window.goBack = goBack;

  function fillHomes(selectedId){
    homeSel.innerHTML = "";
    app.homes.forEach(h=>{
      const opt = document.createElement("option");
      opt.value = h.id;
      opt.textContent = `${h.name} — ${h.city}`;
      if(h.id === selectedId) opt.selected = true;
      homeSel.appendChild(opt);
    });
  }

  if(!eventId || !ev){
    missingEl.style.display = "block";
  }else{
    cardEl.style.display = "block";

    fillHomes(ev.homeId);

    dateEl.value = ev.date || returnDate || "";
    timeEl.value = (ev.time && ev.time.length >= 4) ? ev.time : "10:00";
    typeEl.value = ev.type || "Ménage";
    metaEl.value = ev.meta || "";
    teamEl.value = ev.team || "";

    formEl.addEventListener("submit", (e)=>{
      e.preventDefault();

      ev.homeId = homeSel.value;
      ev.date = dateEl.value;
      ev.time = timeEl.value;
      ev.type = typeEl.value.trim();
      ev.meta = metaEl.value.trim();
      ev.team = teamEl.value.trim();
      ev.updatedAt = Date.now();

      // refresh homeName (utile)
      const h = app.homes.find(x=>x.id === ev.homeId);
      ev.homeName = h ? h.name : (ev.homeName || "");

      saveData(app);

      // retour planning filtré sur le logement de l'événement
      const url = new URL("planning.html", location.href);
      url.searchParams.set("homeId", ev.homeId);
      location.href = url.toString();
    });
  }

  function deleteEvent(){
    if(!ev) return;
    if(!confirm("Supprimer cette prestation ?")) return;

    app.events = app.events.filter(e => e.id !== ev.id);
    saveData(app);

    // retour planning filtré
    const url = new URL("planning.html", location.href);
    url.searchParams.set("homeId", returnHomeId || ev.homeId);
    location.href = url.toString();
  }
  window.deleteEvent = deleteEvent;
</script>
</body>
</html>
