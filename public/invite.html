<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager ‚Äì Inviter un propri√©taire</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --border: rgba(122,92,255,0.18);
      --bad:#b3261e;
      --ok:#1b8f4d;
    }
    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"‚ú¶";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{font-size:15px;color:#444;margin-top:4px;text-align:center;}
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .card{
      width:100%;
      max-width:720px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .small{ font-size:12px; color:#666; line-height:1.3; }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > div{ flex:1; min-width:220px; }

    .cta{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      display:none;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .actions{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
  </style>
</head>

<body>

<!-- ===== Garde session ===== -->
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }
  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;
    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

<div class="page">
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">‚Üê Tableau de bord</a>
    <a class="pill-link primary" href="demandes.html">Demandes propri√©taires</a>
  </div>

  <div class="logo-title">
    <div class="logo-icon">‚úì</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Inviter un propri√©taire</div>
  <div class="badge">G√©n√©rer un lien d‚Äôacc√®s (V1 localStorage)</div>

  <div class="card">
    <div class="card-title">
      <span>G√©n√©rer un lien</span>
      <span class="small">√† envoyer au propri√©taire</span>
    </div>

    <div class="small" style="margin-bottom:10px;">
      Le propri√©taire ouvre le lien ‚Üí cr√©e son acc√®s ‚Üí arrive sur <b>proprietaire.html</b>.
    </div>

    <div class="alert" id="alertBox"></div>

    <form id="genForm">
      <div class="row">
        <div>
          <label for="ownerEmail">Email propri√©taire</label>
          <input id="ownerEmail" type="email" placeholder="ex: proprio@email.com" required>
        </div>
        <div>
          <label for="invitedBy">Nom affich√© (optionnel)</label>
          <input id="invitedBy" type="text" placeholder="ex: Riviera Clean" />
        </div>
      </div>

      <label for="inviteLink">Lien d‚Äôinvitation</label>
      <input id="inviteLink" type="text" readonly placeholder="Le lien appara√Ætra ici‚Ä¶">

      <button class="cta" type="submit">G√©n√©rer le lien</button>

      <div class="actions">
        <button class="btn" type="button" id="copyBtn">Copier</button>
        <button class="btn" type="button" id="clearBtn" style="border-color: rgba(179,38,30,.55); color: var(--bad);">Effacer</button>
      </div>
    </form>
  </div>
</div>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
  function ensureData(){
    const existing = loadData();
    if(existing) return existing;
    const seeded = { homes:[], events:[], services:[], threads:[], payments:[], owners:[], invitations:[], icalSources:[], kits:[], requests:[] };
    saveData(seeded);
    return seeded;
  }
  const app = ensureData();
  app.invitations = Array.isArray(app.invitations) ? app.invitations : [];

  function normalizeEmail(s){ return (s||"").trim().toLowerCase(); }

  const alertBox = document.getElementById("alertBox");
  function showAlert(msg, ok=false){
    alertBox.style.display = "block";
    alertBox.classList.toggle("ok", !!ok);
    alertBox.textContent = msg;
  }
  function hideAlert(){
    alertBox.style.display = "none";
    alertBox.classList.remove("ok");
    alertBox.textContent = "";
  }

  const ownerEmailEl = document.getElementById("ownerEmail");
  const invitedByEl = document.getElementById("invitedBy");
  const inviteLinkEl = document.getElementById("inviteLink");
  const copyBtn = document.getElementById("copyBtn");
  const clearBtn = document.getElementById("clearBtn");

  if(!invitedByEl.value) invitedByEl.value = "CleanUp Manager";

  function makeToken(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function buildInviteUrl(email, by, token){
    // üëâ le propri√©taire atterrit sur invite-proprietaire.html
    const u = new URL("invite-proprietaire.html", location.href);
    u.searchParams.set("email", email);
    u.searchParams.set("by", by);
    u.searchParams.set("token", token);
    return u.toString();
  }

  document.getElementById("genForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    hideAlert();

    const email = normalizeEmail(ownerEmailEl.value);
    const by = (invitedByEl.value || "").trim() || "CleanUp Manager";

    if(!email) return showAlert("Email manquant.");
    if(!/^\S+@\S+\.\S+$/.test(email)) return showAlert("Email invalide.");

    const token = makeToken();
    const link = buildInviteUrl(email, by, token);

    app.invitations.unshift({
      id: uid("inv"),
      email, by, token, link,
      createdAt: Date.now(),
      usedAt: null,
      usedOwnerId: null
    });
    saveData(app);

    inviteLinkEl.value = link;
    showAlert("‚úÖ Lien g√©n√©r√©. Copie/colle et envoie au propri√©taire.", true);
  });

  copyBtn.addEventListener("click", async ()=>{
    const v = (inviteLinkEl.value || "").trim();
    if(!v) return showAlert("Rien √† copier.");

    try{
      await navigator.clipboard.writeText(v);
      showAlert("‚úÖ Lien copi√©.", true);
    }catch(err){
      inviteLinkEl.focus();
      inviteLinkEl.select();
      document.execCommand("copy");
      showAlert("‚úÖ Lien copi√© (fallback).", true);
    }
  });

  clearBtn.addEventListener("click", ()=>{
    ownerEmailEl.value = "";
    inviteLinkEl.value = "";
    hideAlert();
    ownerEmailEl.focus();
  });
</script>

</body>
</html>
