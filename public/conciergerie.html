<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Conciergerie</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-mid:#DCCBFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --ok:#1b8f4d;
      --warn:#b37400;
      --bad:#b3261e;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

body{
  margin:0;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}


    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    /* NAV (mini, non redondant avec les cartes modules) */
    .top-nav{
      width:100%;
      max-width:980px;
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:6px;
      background:transparent;
      border-radius:0;
      box-shadow:none;
      padding:0;
    }

    .top-nav a{
      text-decoration:none;
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      color:#5b45c8;
      background:rgba(255,255,255,.75);
      border:1px solid rgba(122,92,255,.25);
    }

    .top-nav a:hover{
      background:#fff;
      border-color:rgba(122,92,255,.45);
    }

    .top-nav a.active{
      background:rgba(122,92,255,.18);
      border-color:rgba(122,92,255,.55);
      color:#3f2fb6;
      font-weight:900;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{
      font-size:15px;
      color:#444;
      margin-top:4px;
      text-align:center;
    }
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .kpis{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
      margin-top:14px;
    }
    @media(min-width:768px){ .kpis{ grid-template-columns:repeat(4,1fr);} }

    .kpi-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      padding:10px 10px 12px;
      text-align:left;
    }
    .kpi-title{font-size:12px;color:#666;font-weight:800;margin-bottom:4px;}
    .kpi-value{font-size:18px;font-weight:900;color:#222;}
    .kpi-note{font-size:11px;color:#666;margin-top:2px;}

    .modules{
      width:100%;
      max-width:980px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
      margin-top:16px;
    }
    @media(min-width:900px){ .modules{ grid-template-columns:repeat(3,1fr);} }

    .card-link{ text-decoration:none; color:inherit; display:block; }
    .module-card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      transition:transform .15s ease, box-shadow .15s ease;
      cursor:pointer;
      height:100%;
      box-sizing:border-box;
    }
    .module-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 22px rgba(0,0,0,.12);
    }
    .module-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-weight:900;
      font-size:14px;
      color:#222;
      margin-bottom:6px;
    }
    .module-desc{
      font-size:13px;
      color:#555;
      line-height:1.35;
    }
    .chip{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      font-weight:900;
      white-space:nowrap;
    }

    .layout{
      width:100%;
      max-width:980px;
      margin-top:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media(min-width:900px){
      .layout{ flex-direction:row; align-items:flex-start; }
    }
    .col{ flex:1; display:flex; flex-direction:column; gap:16px; }

    .card{
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }
    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .card-title .sub{
      font-size:12px;
      font-weight:400;
      color:#666;
    }

    .form-row{ display:flex; gap:8px; }
    .form-row > div{ flex:1; }

    label{
      display:block;
      font-size:12px;
      font-weight:800;
      color:#333;
      margin:8px 0 4px;
      text-align:left;
    }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #D3C7FF;
      font-size:13px;
      outline:none;
      background:#fff;
      
    }
    input:focus, select:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .cta-btn{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }

    .hint{
      font-size:11px;
      color:#666;
      margin-top:6px;
      line-height:1.25;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:16px;
      font-size:12px;
      color:#666;
      text-align:center;
    }

    /* Masquer la mini top-nav sur mobile (évite le doublon avec les cartes) */
    @media (max-width: 520px){
      .top-nav{ display:none; }
    }

    /* ===== Demandes propriétaires (UI) ===== */
    .req-item{
      background:#fff;
      border-radius:14px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      padding:10px 10px 12px;
      border-left:5px solid rgba(122,92,255,.55);
      text-align:left;
      margin-top:10px;
    }
    .req-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:#666;
      font-weight:800;
      margin-bottom:6px;
      flex-wrap:wrap;
    }
    .req-message{
      font-size:13px;
      color:#333;
      line-height:1.35;
      margin:0;
      white-space:pre-wrap;
    }
    .req-actions{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .req-actions button{
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn-accept{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      color:#fff;
    }
    .btn-done{
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
    }
    .btn-reject{
      background:#FFE3EC;
      color:var(--bad);
    }
.bottom-nav{
  display:none;
}

@media (max-width: 520px){
  .page{ padding-bottom: 86px; } /* laisse la place au bandeau */
  .bottom-nav{
    display:flex;
    position:fixed;
    left:12px; right:12px; bottom:12px;
    background: rgba(255,255,255,0.92);
    border:1px solid rgba(122,92,255,.25);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,.12);
    padding:10px;
    gap:8px;
    justify-content:space-between;
    z-index:9999;
    backdrop-filter: blur(10px);
  }
  .bottom-nav a{
    flex:1;
    text-decoration:none;
    font-size:12px;
    font-weight:900;
    color:#5b45c8;
    background: rgba(122,92,255,.10);
    border-radius: 12px;
    padding:10px 8px;
    text-align:center;
  }
  .bottom-nav a.active{
    background: linear-gradient(90deg,var(--violet-main),var(--violet-dark));
    color:#fff;
  }
}


    
  </style>
  
</head>

<body>

<!-- ===== Session + garde ===== -->
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }

  // ✅ autorise conciergerie OU admin
  function requireRoleOneOf(roles){
    const s = getSession();
    if(!s || !roles.includes(s.role)){
      location.href = "login.html?role=" + encodeURIComponent(roles[0] || "conciergerie");
      return null;
    }
    return s;
  }

  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }

  (function guard(){
    const s = requireRoleOneOf(["conciergerie","admin"]);
    if(!s) return;

    if(!s.planActive){
      location.href = "abonnement.html?plan=starter";
      return;
    }
  })();
</script>

<script type="module">
  import { db } from "./firebase-init.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function setSession(s){
    localStorage.setItem("cm_auth", JSON.stringify(s));
  }

  async function syncSubscription(){
    const s = getSession();
    if(!s || !s.uid) return;

    try{
      const snap = await getDoc(doc(db, "users", s.uid));
      if(!snap.exists()) return;

      const u = snap.data() || {};
      const active = (u.subscriptionStatus === "active");

      // maj session locale
      s.planActive = !!active;
      s.plan = u.plan || s.plan || "";
      setSession(s);

      // si pas actif -> abonnement
      if(!active){
        location.href = "abonnement.html?plan=starter";
      }
    }catch(err){
      console.warn("syncSubscription failed:", err);
      // en cas d’erreur, ne bloque pas brutalement (sinon tu te tires une balle)
    }
  }

  syncSubscription();
</script>


<div class="page">

  <div class="topbar">
    <a class="pill-link" href="index.html">← Accueil</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Ouvrir le planning</a>
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Tableau de bord</div>
  <div class="badge">Piloter • planifier • facturer • communiquer</div>

  <div class="top-nav">
    <a href="conciergerie.html" class="active">Menu</a>
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="messagerie.html">Messagerie</a>
    <a href="paiement.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="boutique.html">Boutique</a>
    <a href="import-ical.html">Import iCal</a>
  </div>

  <div class="kpis">
    <div class="kpi-card">
      <div class="kpi-title">Aujourd’hui</div>
      <div class="kpi-value" id="kpiToday">—</div>
      <div class="kpi-note">prestations</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">Cette semaine</div>
      <div class="kpi-value" id="kpiWeek">—</div>
      <div class="kpi-note">prestations</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-title">Événements</div>
      <div class="kpi-value" id="kpiEvents">—</div>
      <div class="kpi-note">total</div>
    </div>
    <a href="logements.html" class="card-link">
      <div class="kpi-card">
        <div class="kpi-title">Logements actifs</div>
        <div class="kpi-value" id="kpiHomes">—</div>
        <div class="kpi-note">gérés</div>
      </div>
    </a>
  </div>

  <!-- ✅ Carte : Inviter un propriétaire -->
  <div class="layout" style="margin-top:14px;">
    <div class="col">
      <div class="card">
        <div class="card-title">
          <span>Inviter un propriétaire</span>
          <span class="sub">V1 (lien)</span>
        </div>

        <form id="inviteForm">
          <label for="invEmail">Email du propriétaire</label>
          <input id="invEmail" type="email" placeholder="ex. proprio@email.com" required>

          <label for="invBy">Nom affiché (optionnel)</label>
          <input id="invBy" type="text" placeholder="ex. CleanUp Manager">

          <button class="cta-btn" type="submit">Générer le lien</button>

          <label for="invLink">Lien d’invitation</label>
          <input id="invLink" type="text" placeholder="Le lien s’affiche ici…" readonly>

          <div class="form-row" style="margin-top:8px;">
            <div>
              <button class="cta-btn" id="copyInviteBtn" type="button"
                style="background:#fff;color:var(--violet-main);border:2px solid var(--violet-main);box-shadow:0 3px 10px rgba(0,0,0,.06);">
                Copier le lien
              </button>
            </div>
            <div>
              <button class="cta-btn" id="clearInviteBtn" type="button" style="background:#FFE3EC;color:var(--bad);">
                Effacer
              </button>
            </div>
          </div>

          <div class="hint" id="inviteHint"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- ✅ Carte : Demandes propriétaires -->
  <div class="layout" style="margin-top:14px;">
    <div class="col">
      <div class="card">
        <div class="card-title">
          <span>Demandes propriétaires</span>
          <span class="sub"><span id="reqCount">0</span> en attente</span>
        </div>

        <div class="hint" style="margin-bottom:8px;">
          Détail = uniquement le message. “Accepter” crée un logement (si besoin) + rattache au propriétaire (V1).
        </div>

        <div id="reqList"></div>
      </div>
    </div>
  </div>

  <div class="modules">
    <a class="card-link" href="planning.html">
      <div class="module-card">
        <div class="module-title">Planning <span class="chip">réel</span></div>
        <div class="module-desc">Calendrier + agenda. Clique une prestation pour modifier/supprimer.</div>
      </div>
    </a>

    <a class="card-link" href="logements.html">
      <div class="module-card">
        <div class="module-title">Logements <span class="chip">réel</span></div>
        <div class="module-desc">Liste + recherche + ajout. Filtre le planning par logement.</div>
      </div>
    </a>

    <a class="card-link" href="prestations.html">
      <div class="module-card">
        <div class="module-title">Prestations <span class="chip">réel</span></div>
        <div class="module-desc">Catalogue des services (tarifs / durées). Base V1 locale.</div>
      </div>
    </a>

    <a class="card-link" href="messagerie.html">
      <div class="module-card">
        <div class="module-title">Messagerie <span class="chip">réel</span></div>
        <div class="module-desc">Messages conciergerie ↔ propriétaires (page réelle).</div>
      </div>
    </a>

    <a class="card-link" href="paiement.html">
      <div class="module-card">
        <div class="module-title">Paiements <span class="chip">réel</span></div>
        <div class="module-desc">Suivi règlements, relances, statuts (page réelle).</div>
      </div>
    </a>

    <a class="card-link" href="historique.html">
      <div class="module-card">
        <div class="module-title">Historique <span class="chip">réel</span></div>
        <div class="module-desc">Historique des opérations, exports, facturation (page réelle).</div>
      </div>
    </a>

    <a class="card-link" href="boutique.html">
      <div class="module-card">
        <div class="module-title">Boutique <span class="chip">réel</span></div>
        <div class="module-desc">Kits / consommables / commandes (page réelle).</div>
      </div>
    </a>

    <a class="card-link" href="import-ical.html">
      <div class="module-card">
        <div class="module-title">Import planning <span class="chip">iCal</span></div>
        <div class="module-desc">Importer Airbnb/Booking via lien iCal du propriétaire.</div>
      </div>
    </a>
  </div>

  <div class="layout">
    <div class="col">
      <div class="card">
        <div class="card-title">
          <span>Créer un logement (rapide)</span>
          <span class="sub">V1</span>
        </div>

        <form id="homeForm">
          <div class="form-row">
            <div>
              <label for="homeName">Nom</label>
              <input id="homeName" type="text" placeholder="Ex. T2 Centre" required>
            </div>
            <div>
              <label for="homeCity">Ville</label>
              <input id="homeCity" type="text" placeholder="Ex. Muret" required>
            </div>
          </div>

          <label for="homeOwner">Propriétaire</label>
          <input id="homeOwner" type="text" placeholder="Ex. Mme Dupont" required>

          <div class="form-row">
            <div>
              <label for="homeType">Type</label>
              <select id="homeType">
                <option>Studio</option><option>T1</option><option>T2</option><option>T3</option>
                <option>T4 et +</option><option>Maison</option>
              </select>
            </div>
            <div>
              <label for="homeTeam">Équipe</label>
              <select id="homeTeam">
                <option>Équipe A</option><option>Équipe B</option><option>Moi</option>
              </select>
            </div>
          </div>

          <button class="cta-btn" type="submit">Ajouter</button>
          <div class="hint">Stocké en localStorage (base V1). Tu retrouves le logement dans Logements et Planning.</div>
        </form>
      </div>
    </div>
  </div>

  <div class="foot">
    V1 stable : base locale + logements + invitations + demandes propriétaires.
  </div>

</div>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){
    localStorage.setItem(DATA_KEY, JSON.stringify(d));
  }
  function ensureData(){
    const existing = loadData();
    if(existing) return existing;

    const seeded = {
      homes:[],
      events:[],
      services:[],
      threads:[],
      payments:[],
      icalSources:[],
      kits:[],
      invitations:[],
      owners:[],       // créé côté invite.html
      requests:[]      // demandes propriétaires
    };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.homes = Array.isArray(app.homes) ? app.homes : [];
  app.events = Array.isArray(app.events) ? app.events : [];
  app.services = Array.isArray(app.services) ? app.services : [];
  app.threads = Array.isArray(app.threads) ? app.threads : [];
  app.payments = Array.isArray(app.payments) ? app.payments : [];
  app.icalSources = Array.isArray(app.icalSources) ? app.icalSources : [];
  app.kits = Array.isArray(app.kits) ? app.kits : [];
  app.invitations = Array.isArray(app.invitations) ? app.invitations : [];
  app.owners = Array.isArray(app.owners) ? app.owners : [];
  app.requests = Array.isArray(app.requests) ? app.requests : [];

  (function migrate(){
    let changed = false;
    app.homes.forEach(h=>{ if(!h.id){ h.id = uid("h"); changed = true; }});
    app.events.forEach(e=>{ if(!e.id){ e.id = uid("e"); changed = true; }});
    app.owners.forEach(o=>{
      if(!o.id){ o.id = uid("own"); changed = true; }
      if(!Array.isArray(o.homes)){ o.homes = []; changed = true; }
    });
    app.requests.forEach(r=>{
      if(!r.id){ r.id = uid("req"); changed = true; }
      if(!r.status){ r.status = "pending"; changed = true; }
      if(!r.createdAt){ r.createdAt = Date.now(); changed = true; }
    });
    if(changed) saveData(app);
  })();

  function pad2(n){ return n < 10 ? "0"+n : ""+n; }
  function dateKey(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }

  function countToday(){
    const k = dateKey(new Date());
    return app.events.filter(e => e.date === k).length;
  }
  function countWeek(){
    const today = new Date();
    let total = 0;
    for(let i=0;i<7;i++){
      const d = new Date(today.getFullYear(), today.getMonth(), today.getDate()+i);
      const k = dateKey(d);
      total += app.events.filter(e => e.date === k).length;
    }
    return total;
  }

  function renderKpis(){
    const elHomes = document.getElementById("kpiHomes");
    const elEvents = document.getElementById("kpiEvents");
    const elToday = document.getElementById("kpiToday");
    const elWeek = document.getElementById("kpiWeek");
    if(!elHomes || !elEvents || !elToday || !elWeek) return;

    elHomes.textContent = app.homes.length;
    elEvents.textContent = app.events.length;
    elToday.textContent = countToday();
    elWeek.textContent = countWeek();
  }

  // ===== Ajout logement rapide =====
  const homeForm = document.getElementById("homeForm");
  if(homeForm){
    homeForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const name = (document.getElementById("homeName").value || "").trim();
      const city = (document.getElementById("homeCity").value || "").trim();
      const owner = (document.getElementById("homeOwner").value || "").trim();
      const type = document.getElementById("homeType").value;
      const team = document.getElementById("homeTeam").value;

      if(!name || !city || !owner) return;

      app.homes.push({ id: uid("h"), name, city, owner, type, team });
      saveData(app);
      renderKpis();

      alert("Logement ajouté. Va sur Logements ou Planning pour planifier.");
      e.target.reset();
      document.getElementById("homeType").value = "Studio";
      document.getElementById("homeTeam").value = "Équipe A";
    });
  }

  // ===== Invitations propriétaires (V1) =====
  (function initInvites(){
    const form = document.getElementById("inviteForm");
    if(!form) return;

    const invEmail = document.getElementById("invEmail");
    const invBy = document.getElementById("invBy");
    const invLink = document.getElementById("invLink");
    const hint = document.getElementById("inviteHint");
    const copyBtn = document.getElementById("copyInviteBtn");
    const clearBtn = document.getElementById("clearInviteBtn");

    function setHint(msg){ if(hint) hint.textContent = msg || ""; }
    function normalizeEmail(s){ return (s || "").trim().toLowerCase(); }
    function safeBy(s){ return (s || "").trim() || "CleanUp Manager"; }
    function makeToken(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function buildInviteUrl(email, by, token){
      const u = new URL("invite.html", location.href);
      u.searchParams.set("email", email);
      u.searchParams.set("by", by);
      u.searchParams.set("token", token);
      return u.toString();
    }

    if(invBy && !invBy.value) invBy.value = "CleanUp Manager";

    form.addEventListener("submit", (e)=>{
      e.preventDefault();
      const email = normalizeEmail(invEmail ? invEmail.value : "");
      const by = safeBy(invBy ? invBy.value : "");

      if(!email){ setHint("Email manquant."); return; }
      if(!/^\S+@\S+\.\S+$/.test(email)){ setHint("Email invalide."); return; }

      const token = makeToken();
      const link = buildInviteUrl(email, by, token);

      app.invitations.unshift({
        id: uid("inv"),
        email, by, token, link,
        createdAt: Date.now(),
        usedAt: null
      });
      saveData(app);

      if(invLink) invLink.value = link;
      setHint("Lien généré. Copie/colle-le et envoie-le au propriétaire.");
    });

    if(copyBtn){
      copyBtn.addEventListener("click", async ()=>{
        const v = (invLink ? invLink.value : "").trim();
        if(!v){ setHint("Rien à copier."); return; }

        try{
          await navigator.clipboard.writeText(v);
          setHint("✅ Lien copié.");
        }catch(err){
          try{
            if(invLink){
              invLink.focus();
              invLink.select();
              document.execCommand("copy");
              setHint("✅ Lien copié (fallback).");
            }else{
              setHint("Copie manuelle nécessaire.");
            }
          }catch(e2){
            setHint("Copie manuelle nécessaire.");
          }
        }
      });
    }

    if(clearBtn){
      clearBtn.addEventListener("click", ()=>{
        if(invEmail) invEmail.value = "";
        if(invLink) invLink.value = "";
        setHint("");
        if(invEmail) invEmail.focus();
      });
    }
  })();

  // ===== Demandes propriétaires (V1) — VERSION UNIQUE OK =====
  function escapeText(s){
    return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
  function fmt(ts){
    const d = new Date(ts || Date.now());
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm} ${hh}:${mi}`;
  }

  function findOwnerForRequest(r){
    if(r.ownerId){
      const byId = app.owners.find(o => o.id === r.ownerId);
      if(byId) return byId;
    }
    if(r.ownerEmail){
      const email = (r.ownerEmail||"").trim().toLowerCase();
      const byMail = app.owners.find(o => (o.email||"").trim().toLowerCase() === email);
      if(byMail) return byMail;
    }
    return null;
  }

  function acceptRequest(reqId){
    const r = app.requests.find(x => x.id === reqId);
    if(!r) return;

    const owner = findOwnerForRequest(r);
    if(!owner){
      alert("Owner introuvable. (Invite.html pas passé ?)");
      return;
    }

    owner.homes = Array.isArray(owner.homes) ? owner.homes : [];

    if(r.type === "add_home"){
      const home = {
        id: uid("h"),
        name: r.homeName || "Logement",
        city: r.city || "",
        owner: owner.fullname || owner.email || "Propriétaire",
        type: r.homeType || "Studio",
        team: r.team || "Équipe A",
        ownerId: owner.id
      };
      app.homes.push(home);
      owner.homes.unshift(home.id);

      r.status = "accepted";
      r.usedAt = Date.now();
    } else {
      r.status = "done";
      r.usedAt = Date.now();
    }

    saveData(app);
    renderRequests();
    renderKpis();
  }

  function doneRequest(reqId){
    const r = app.requests.find(x => x.id === reqId);
    if(!r) return;
    r.status = "done";
    r.usedAt = Date.now();
    saveData(app);
    renderRequests();
  }

  function rejectRequest(reqId){
    const r = app.requests.find(x => x.id === reqId);
    if(!r) return;
    r.status = "rejected";
    r.usedAt = Date.now();
    saveData(app);
    renderRequests();
  }

  function renderRequests(){
    const list = document.getElementById("reqList");
    const count = document.getElementById("reqCount");
    if(!list || !count) return;

    const pending = app.requests.filter(r => (r.status || "pending") === "pending");
    count.textContent = String(pending.length);

    list.innerHTML = "";
    if(pending.length === 0){
      list.innerHTML = `<div class="hint">Aucune demande en attente.</div>`;
      return;
    }

    pending.forEach(r=>{
      const ownerLabel = r.ownerName || r.ownerEmail || "Propriétaire";
      const typeLabel = r.type === "add_home" ? "Ajout logement" : "Message";
      const msg = escapeText(r.message || "");

      const wrap = document.createElement("div");
      wrap.className = "req-item";
      wrap.innerHTML = `
        <div class="req-meta">
          <span>${typeLabel} • ${escapeText(ownerLabel)}</span>
          <span>${fmt(r.createdAt)}</span>
        </div>
        <p class="req-message">${msg}</p>
        <div class="req-actions">
          <button class="btn-accept" type="button" data-act="accept" data-id="${r.id}">Accepter</button>
          <button class="btn-done" type="button" data-act="done" data-id="${r.id}">Traiter</button>
          <button class="btn-reject" type="button" data-act="reject" data-id="${r.id}">Refuser</button>
        </div>
      `;
      list.appendChild(wrap);
    });

    list.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const act = btn.getAttribute("data-act");
        if(act === "accept") acceptRequest(id);
        if(act === "done") doneRequest(id);
        if(act === "reject") rejectRequest(id);
      });
    });
  }

  // Boot
  renderKpis();
  renderRequests();
</script>
<nav class="bottom-nav">
  <a href="conciergerie.html" class="active">Menu</a>
  <a href="planning.html">Planning</a>
  <a href="logements.html">Logements</a>
  <a href="prestations.html">Prestations</a>
</nav>

</body>
</html>









