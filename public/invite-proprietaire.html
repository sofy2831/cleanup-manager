<!-- docs/invite-proprietaire.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Invitation propriétaire</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text:#111;
      --muted:#666;
      --bad:#b3261e;
      --ok:#1b8f4d;
    }

    *{ box-sizing:border-box; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:900;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:10px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }

    h1{margin:0;font-size:24px;font-weight:900;color:#111;}
    .subtitle{font-size:15px;color:#444;margin-top:4px;text-align:center;}
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .card{
      width:100%;
      max-width:720px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
    }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .small{ font-size:12px; color:#666; line-height:1.3; }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color:#333;
      margin:10px 0 4px;
      text-align:left;
    }
    input{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    input:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > div{ flex:1; min-width:220px; }

    .checkbox{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:flex-start;
      font-size:12px;
      color:#444;
      line-height:1.25;
    }
    .checkbox input{ width:auto; margin-top:2px; }

    .cta{
      margin-top:12px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      font-weight:900;
      color:#fff;
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.18);
    }

    .alert{
      margin-top:10px;
      padding:10px 12px;
      background:#fff;
      border-radius:14px;
      border-left:5px solid var(--bad);
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-size:12px;
      color:#444;
      display:none;
      white-space:pre-wrap;
    }
    .alert.ok{ border-left-color: var(--ok); }

    .fineprint{
      margin-top:10px;
      text-align:center;
      font-size:11px;
      color:#666;
      line-height:1.25;
    }
  </style>
</head>

<body>
  <div class="page">

    <div class="topbar">
      <a class="pill-link" href="index.html">← Accueil</a>
      <a class="pill-link primary" href="login.html?role=proprietaire">J’ai déjà un accès</a>
    </div>

    <div class="logo-title">
      <div class="logo-icon">✓</div>
      <h1>CleanUp Manager</h1>
    </div>

    <div class="subtitle">Création d’accès propriétaire</div>
    <div class="badge" id="badgeLine">Invitation sécurisée</div>

    <div class="card">
      <div class="card-title">
        <span>Créer mon accès</span>
        <span class="small" id="invitedByLabel"></span>
      </div>

      <div class="small" style="margin-bottom:10px;">
        Tu crées ton accès en 30 secondes. Ensuite tu peux consulter : planning, demandes, paiements, messages.
        <br><b>Gratuit pour les propriétaires</b> (accès invité par la conciergerie).
      </div>

      <div class="alert" id="alertBox"></div>

      <form id="inviteForm">
        <label for="email">Email</label>
        <input id="email" type="email" required />

        <div class="row">
          <div>
            <label for="fullname">Nom / Prénom</label>
            <input id="fullname" type="text" placeholder="Ex. Sophie Dupont" required />
          </div>
          <div>
            <label for="phone">Téléphone (optionnel)</label>
            <input id="phone" type="tel" placeholder="Ex. 06 00 00 00 00" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="password">Mot de passe</label>
            <input id="password" type="password" autocomplete="new-password" placeholder="Au moins 8 caractères" required />
            <div class="small">Min. 8 caractères avec 1 lettre + 1 chiffre.</div>
          </div>
          <div>
            <label for="password2">Confirmer le mot de passe</label>
            <input id="password2" type="password" autocomplete="new-password" placeholder="Ressaisis le mot de passe" required />
          </div>
        </div>

        <div class="checkbox">
          <input id="accept" type="checkbox" />
          <label for="accept">
            J’accepte que mes infos soient utilisées uniquement pour le fonctionnement de la plateforme (V1 localStorage).
          </label>
        </div>

        <button class="cta" type="submit">Créer mon accès</button>

        <div class="fineprint">
          Mode V1 : stockage local (dans le navigateur). En production : Firebase Auth + Firestore + droits.
        </div>
      </form>
    </div>
  </div>

  <script>
    const DATA_KEY = "cm_conciergerie_data_v1";

    function uid(prefix){
      return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function loadData(){
      try{
        const raw = localStorage.getItem(DATA_KEY);
        if(raw) return JSON.parse(raw);
      }catch(e){}
      return null;
    }
    function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
    function ensureData(){
      const existing = loadData();
      if(existing) return existing;
      const seeded = { homes:[], events:[], services:[], threads:[], payments:[], owners:[], invitations:[], icalSources:[], kits:[], requests:[] };
      saveData(seeded);
      return seeded;
    }
    const app = ensureData();
    app.owners = Array.isArray(app.owners) ? app.owners : [];
    app.invitations = Array.isArray(app.invitations) ? app.invitations : [];
    app.requests = Array.isArray(app.requests) ? app.requests : [];

    const alertBox = document.getElementById("alertBox");
    function showAlert(msg, ok=false){
      alertBox.style.display = "block";
      alertBox.classList.toggle("ok", !!ok);
      alertBox.innerHTML = msg;
    }
    function hideAlert(){
      alertBox.style.display = "none";
      alertBox.classList.remove("ok");
      alertBox.innerHTML = "";
    }

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return (p.get(name) || "").trim();
    }
    function normalizeEmail(s){ return (s||"").trim().toLowerCase(); }

    function setSessionOwner(owner){
      localStorage.setItem("cm_auth", JSON.stringify({
        role: "proprietaire",
        ownerId: owner.id,
        email: owner.email,
        name: owner.fullname,
        createdAt: Date.now()
      }));
    }

    function isStrongPassword(pw){
      return typeof pw === "string"
        && pw.length >= 8
        && /[A-Za-z]/.test(pw)
        && /\d/.test(pw);
    }

    async function sha256(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,"0")).join("");
    }

    const emailEl = document.getElementById("email");
    const fullnameEl = document.getElementById("fullname");
    const phoneEl = document.getElementById("phone");
    const passwordEl = document.getElementById("password");
    const password2El = document.getElementById("password2");
    const acceptEl = document.getElementById("accept");
    const invitedByLabel = document.getElementById("invitedByLabel");
    const badgeLine = document.getElementById("badgeLine");

    const invitedEmail = normalizeEmail(getParam("email"));
    const invitedBy = getParam("by");
    const token = getParam("token");

    invitedByLabel.textContent = invitedBy ? ("Invité par : " + invitedBy) : "";

    if(invitedEmail){
      emailEl.value = invitedEmail;
      emailEl.readOnly = true;
      badgeLine.textContent = "Invitation pré-remplie";
    }else{
      badgeLine.textContent = "Lien d’invitation incomplet";
      showAlert("⛔ Ton lien d’invitation ne contient pas l’email. Demande à la conciergerie de renvoyer un lien.", false);
    }

    let matchedInvite = null;

    if(token){
      const pool = app.invitations.filter(inv => inv && inv.token === token);
      if(pool.length){
        if(invitedEmail){
          matchedInvite = pool.find(inv => normalizeEmail(inv.email) === invitedEmail) || null;
        }else{
          matchedInvite = pool[0] || null;
        }
      }
    }

    // Blocage strict : pas de token = pas d'accès
    if(!token){
      showAlert("⛔ Invitation invalide : token manquant. Demande à la conciergerie de renvoyer un lien.", false);
      document.getElementById("inviteForm").querySelectorAll("input,button").forEach(el => el.disabled = true);
    }

    // Blocage strict : token non reconnu
    if(token && !matchedInvite){
      showAlert("⛔ Invitation introuvable. Demande à la conciergerie de générer un nouveau lien.", false);
      document.getElementById("inviteForm").querySelectorAll("input,button").forEach(el => el.disabled = true);
    }

    if(matchedInvite && matchedInvite.usedAt){
      showAlert("⛔ Cette invitation a déjà été utilisée. Demande à la conciergerie de générer un nouveau lien.", false);
      document.getElementById("inviteForm").querySelectorAll("input,button").forEach(el => el.disabled = true);
    }

    document.getElementById("inviteForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();

      const email = normalizeEmail(emailEl.value);
      const fullname = fullnameEl.value.trim();
      const phone = phoneEl.value.trim();
      const password = passwordEl.value || "";
      const password2 = password2El.value || "";

      if(!email || !fullname) return showAlert("Champs manquants : email + nom/prénom.", false);
      if(!/^\S+@\S+\.\S+$/.test(email)) return showAlert("Email invalide.", false);

      if(!isStrongPassword(password)){
        return showAlert("Mot de passe trop faible : <b>8 caractères minimum</b>, avec <b>1 lettre</b> et <b>1 chiffre</b>.", false);
      }
      if(password !== password2) return showAlert("Les deux mots de passe ne correspondent pas.", false);
      if(!acceptEl.checked) return showAlert("Tu dois cocher l’acceptation (V1).", false);

      // Interdire la recréation d'un compte existant
      const existing = app.owners.find(o => normalizeEmail(o.email) === email);
      if(existing){
        showAlert("⛔ Un accès existe déjà pour cet email. Clique sur <b>“J’ai déjà un accès”</b> pour te connecter.", false);
        return;
      }

      const passwordHash = await sha256(password);

      const owner = {
        id: uid("own"),
        email,
        fullname,
        phone,
        passwordHash,
        invitedBy: invitedBy || (matchedInvite?.by || ""),
        inviteToken: token || "",
        invitationId: matchedInvite?.id || null,
        createdAt: Date.now(),
        lastLoginAt: Date.now(),
        homes: []
      };

      app.owners.unshift(owner);

      if(matchedInvite && !matchedInvite.usedAt){
        matchedInvite.usedAt = Date.now();
        matchedInvite.usedOwnerId = owner.id;
      }

      saveData(app);
      setSessionOwner(owner);

      passwordEl.value = "";
      password2El.value = "";

      showAlert("✅ Accès créé. Connexion…", true);
      setTimeout(()=> location.href = "proprietaire.html", 600);
    });
  </script>
</body>
</html>
