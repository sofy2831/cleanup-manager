<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CleanUp Manager – Logements</title>

  <style>
    :root{
      --violet-light:#F3ECFF;
      --violet-main:#7A5CFF;
      --violet-dark:#6238FF;
      --text-dark:#111;
      --bad:#b3261e;
    }

    body{
      margin:0;
      font-family:"Comic Sans MS", sans-serif;
      background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
      color:var(--text-dark);
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:16px 16px 32px;
      box-sizing:border-box;
    }

    .topbar{
      width:100%;
      max-width:980px;
      position:sticky;
      top:0;
      z-index:10;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0;
      background:rgba(248,244,255,.85);
      backdrop-filter:blur(6px);
    }

    .pill-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#fff;
      border:2px solid var(--violet-main);
      color:var(--violet-main);
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .pill-link.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }

    /* NAV */
    .top-nav {
      margin-top: 14px;
      display: inline-flex;
      flex-wrap:wrap;
      gap: 4px;
      background: #fff;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 3px;
      max-width: 980px;
      justify-content:center;
    }
    .top-nav a {
      text-decoration: none;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      color: #555;
    }
    .top-nav a.active {
      background: var(--violet-main);
      color: #fff;
      font-weight: 900;
    }

    .logo-title{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      margin-top:8px;
      margin-bottom:6px;
      text-align:center;
    }
    .logo-icon{
      width:38px;height:38px;border-radius:50%;
      background:#fff;
      border:2px solid var(--violet-main);
      display:flex;align-items:center;justify-content:center;
      color:var(--violet-main);
      font-size:20px;font-weight:900;
      position:relative;
      flex-shrink:0;
    }
    .logo-icon::after{
      content:"✦";
      position:absolute;
      top:-6px; right:-4px;
      font-size:12px;
      color:var(--violet-main);
    }
    h1{margin:0;font-size:24px;font-weight:800;color:#111;}
    .subtitle{font-size:15px;color:#444;margin-top:4px;text-align:center;}
    .badge{
      margin-top:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#555;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
    }

    .card{
      width:100%;
      max-width:980px;
      margin-top:14px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.10);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }

    .card-title{
      font-size:16px;
      font-weight:900;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .card-title .sub{
      font-size:12px;
      font-weight:400;
      color:#666;
    }

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }
    .search{ flex:1; min-width:220px; }
    input[type="search"]{
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #D3C7FF;
      font-size:14px;
      outline:none;
      background:#fff;
      font-family:"Comic Sans MS", sans-serif;
    }
    input[type="search"]:focus{
      border-color:var(--violet-main);
      box-shadow:0 0 0 2px rgba(122,92,255,.15);
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:9px 12px;
      font-size:13px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      color:var(--violet-main);
      border:2px solid var(--violet-main);
      white-space:nowrap;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .btn.primary{
      background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
      border-color:transparent;
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,.15);
    }
    .btn.danger{
      border-color:var(--bad);
      color:var(--bad);
    }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top:12px; }
    .item{
      background:#fff;
      border-radius:14px;
      padding:10px 10px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      border-left:5px solid var(--violet-main);
      text-align:left;
    }
    .item-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .item-title{ font-weight:900; color:#222; font-size:14px; line-height:1.2; }
    .item-meta{ font-size:12px; color:#666; margin-top:4px; line-height:1.25; }
    .chips{ margin-top:6px; display:flex; gap:6px; flex-wrap:wrap; }
    .chip{
      font-size:11px;
      font-weight:900;
      padding:3px 9px;
      border-radius:999px;
      background:var(--violet-light);
      color:#5b45c8;
      white-space:nowrap;
    }

    .item-actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .mini-btn{
      border:none;
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:var(--violet-light);
      color:#5b45c8;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      white-space:nowrap;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .mini-btn.red{ background:#ffe3ec; color:var(--bad); }

    .empty{
      background:#fff;
      border-radius:14px;
      padding:14px 12px;
      box-shadow:0 3px 10px rgba(0,0,0,.06);
      text-align:center;
      color:#666;
      font-size:13px;
    }

    .hint{ font-size:12px; color:#666; margin-top:6px; line-height:1.25; }

    /* Modal simple */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.25);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:100%;
      max-width:560px;
      background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.20);
      padding:16px 14px 18px;
      box-sizing:border-box;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; font-weight:900; color:#111; }
    .modal p{ margin:0 0 10px; font-size:12px; color:#666; line-height:1.25; }

    label{ display:block; font-size:12px; font-weight:900; color:#333; margin:8px 0 4px; text-align:left; }
    input, select{
      width:100%; box-sizing:border-box; padding:9px 10px;
      border-radius:10px; border:1px solid #D3C7FF; font-size:13px; outline:none; background:#fff;
      font-family:"Comic Sans MS", sans-serif;
    }

    .modal-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:12px;
    }

    .foot{
      width:100%;
      max-width:980px;
      margin-top:14px;
      font-size:12px;
      color:#666;
      text-align:center;
    }
  </style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link primary" href="planning.html">Planning</a>
      <a class="pill-link" href="prestations.html">Catalogue</a>
      <button class="pill-link" onclick="logout()" type="button">Déconnexion</button>
    </div>
  </div>

  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Logements</div>
  <div class="badge">Lister • Rechercher • Ajouter • Supprimer</div>

  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html" class="active">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="messagerie.html">Messagerie</a>
    <a href="import-ical.html">Import iCal</a>
  </div>

  <div class="card">
    <div class="card-title">
      <span>Vos logements</span>
      <span class="sub" id="countLabel">—</span>
    </div>

    <div class="toolbar">
      <div class="search">
        <input id="searchInput" type="search" placeholder="Recherche : nom, ville, propriétaire, type…" />
        <div class="hint">Tout est local (localStorage). Planning et logements partagent la même base.</div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="addBtn">+ Ajouter</button>
        <button class="btn danger" type="button" id="wipeBtn" title="Supprime TOUS les logements">Tout supprimer</button>
      </div>
    </div>

    <div class="list" id="homesList"></div>
  </div>

  <div class="foot">
    Astuce : “Planning (ce logement)” ouvre <b>planning.html?homeId=...</b>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Ajouter un logement</h2>
    <p>V1 rapide : on garde l’essentiel.</p>

    <form id="homeForm">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <label for="homeName">Nom</label>
          <input id="homeName" type="text" placeholder="Ex. T2 Centre" required />
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="homeCity">Ville</label>
          <input id="homeCity" type="text" placeholder="Ex. Muret" required />
        </div>
      </div>

      <label for="homeOwner">Propriétaire</label>
      <input id="homeOwner" type="text" placeholder="Ex. Mme Dupont" required />

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <div style="flex:1; min-width:180px;">
          <label for="homeType">Type</label>
          <select id="homeType">
            <option>Studio</option><option>T1</option><option>T2</option><option>T3</option>
            <option>T4 et +</option><option>Maison</option>
          </select>
        </div>
        <div style="flex:1; min-width:180px;">
          <label for="homeTeam">Équipe</label>
          <select id="homeTeam">
            <option>Équipe A</option><option>Équipe B</option><option>Moi</option>
          </select>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" id="cancelBtn">Annuler</button>
        <button class="btn primary" type="submit">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<script>
  const DATA_KEY = "cm_conciergerie_data_v1";

  function uid(prefix){
    return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }
  function loadData(){
    try{
      const raw = localStorage.getItem(DATA_KEY);
      if(raw) return JSON.parse(raw);
    }catch(e){}
    return null;
  }
  function saveData(d){
    localStorage.setItem(DATA_KEY, JSON.stringify(d));
  }
  function ensureData(){
    const existing = loadData();
    if(existing) return existing;
    const seeded = { homes:[], events:[], services:[], icalSources:[],kits:[], requests:[] };
    saveData(seeded);
    return seeded;
  }

  const app = ensureData();
  app.homes = Array.isArray(app.homes) ? app.homes : [];
  app.events = Array.isArray(app.events) ? app.events : [];
  app.services = Array.isArray(app.services) ? app.services : [];
  app.icalSources = Array.isArray(app.icalSources) ? app.icalSources : [];
  app.requests = Array.isArray(app.requests) ? app.requests : [];

  (function migrateHomes(){
    let changed = false;
    app.homes.forEach(h=>{
      if(!h.id){ h.id = uid("h"); changed = true; }
    });
    if(changed) saveData(app);
  })();

  const homesListEl = document.getElementById("homesList");
  const countLabelEl = document.getElementById("countLabel");
  const searchInputEl = document.getElementById("searchInput");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const addBtn = document.getElementById("addBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const wipeBtn = document.getElementById("wipeBtn");

  const homeForm = document.getElementById("homeForm");
  const homeName = document.getElementById("homeName");
  const homeCity = document.getElementById("homeCity");
  const homeOwner = document.getElementById("homeOwner");
  const homeType = document.getElementById("homeType");
  const homeTeam = document.getElementById("homeTeam");

  function openModal(){
    modalBackdrop.style.display = "flex";
    setTimeout(()=>homeName.focus(), 0);
  }
  function closeModal(){
    modalBackdrop.style.display = "none";
    homeForm.reset();
    homeType.value = "Studio";
    homeTeam.value = "Équipe A";
  }

  function norm(s){ return (s||"").toString().toLowerCase().trim(); }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function render(){
    const q = norm(searchInputEl.value);
    const homes = app.homes || [];

    const filtered = !q ? homes : homes.filter(h=>{
      const hay = [h.name,h.city,h.owner,h.type,h.team].map(norm).join(" ");
      return hay.includes(q);
    });

    countLabelEl.textContent = filtered.length + " / " + homes.length;
    homesListEl.innerHTML = "";

    if(!filtered.length){
      const e = document.createElement("div");
      e.className = "empty";
      e.textContent = homes.length ? "Aucun résultat." : "Aucun logement. Clique sur “+ Ajouter”.";
      homesListEl.appendChild(e);
      return;
    }

    filtered.forEach(h=>{
      const item = document.createElement("div");
      item.className = "item";

      item.innerHTML = `
        <div class="item-top">
          <div>
            <div class="item-title">${escapeHtml(h.name || "Logement")}</div>
            <div class="item-meta">${escapeHtml(h.city || "—")} • Propriétaire : <b>${escapeHtml(h.owner || "—")}</b></div>
            <div class="chips">
              <span class="chip">${escapeHtml(h.type || "Type")}</span>
              <span class="chip">${escapeHtml(h.team || "Équipe")}</span>
            </div>
          </div>
          <div class="item-actions">
            <a class="mini-btn" href="planning.html?homeId=${encodeURIComponent(h.id)}">Planning (ce logement)</a>
            <a class="mini-btn" href="prestations.html">Catalogue prestations</a>
            <button class="mini-btn red" type="button" data-del="${h.id}">Supprimer</button>
          </div>
        </div>
      `;

      homesListEl.appendChild(item);
    });

    homesListEl.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        const ok = confirm("Supprimer ce logement ? (et ses événements)");
        if(!ok) return;

        app.homes = app.homes.filter(h=>h.id !== id);
        app.events = app.events.filter(e=>e.homeId !== id);

        saveData(app);
        render();
      });
    });
  }

  addBtn.addEventListener("click", openModal);
  cancelBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e)=>{
    if(e.target === modalBackdrop) closeModal();
  });

  homeForm.addEventListener("submit", (e)=>{
    e.preventDefault();

    const h = {
      id: uid("h"),
      name: homeName.value.trim(),
      city: homeCity.value.trim(),
      owner: homeOwner.value.trim(),
      type: homeType.value,
      team: homeTeam.value
    };
    if(!h.name || !h.city || !h.owner) return;

    app.homes.unshift(h);
    saveData(app);

    closeModal();
    render();
  });

  searchInputEl.addEventListener("input", render);

  wipeBtn.addEventListener("click", ()=>{
    if(!app.homes.length){
      alert("Aucun logement à supprimer.");
      return;
    }
    const ok = confirm("Tout supprimer ? (logements + événements liés)");
    if(!ok) return;

    app.homes = [];
    app.events = [];
    saveData(app);
    render();
  });

  render();
</script>
</body>
</html>
