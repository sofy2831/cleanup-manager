<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CleanUp Manager – Messagerie</title>

<style>
:root{
  --violet-light:#F3ECFF;
  --violet-main:#7A5CFF;
  --violet-dark:#6238FF;
  --text-dark:#111;
  --grey:#666;
  --green:#1E7A3A;
  --orange:#B37400;
  --red:#A61E4D;
}

body{
  margin:0;
  font-family:"Comic Sans MS", sans-serif;
  background:linear-gradient(180deg,#F8F4FF 0%,#EDE6FF 80%);
  color:var(--text-dark);
}

.page{
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px;
  box-sizing:border-box;
}

/* TOPBAR */
.topbar{
  width:100%;
  max-width:980px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  position:sticky;
  top:0;
  z-index:10;
  padding:10px 0;
  background:rgba(248,244,255,.85);
  backdrop-filter:blur(6px);
}
.pill-link{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:999px;
  background:#fff;
  border:2px solid var(--violet-main);
  color:var(--violet-main);
  text-decoration:none;
  font-weight:900;
  font-size:13px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  white-space:nowrap;
  cursor:pointer;
}
.pill-link.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border-color:transparent;
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}

/* HEADER */
.logo-title{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  margin-top:10px;
}
.logo-icon{
  width:36px;height:36px;border-radius:50%;
  border:2px solid var(--violet-main);
  display:flex;align-items:center;justify-content:center;
  font-weight:900;color:var(--violet-main);
  background:#fff;
  position:relative;
}
.logo-icon::after{
  content:"✦";
  position:absolute;
  top:-6px; right:-4px;
  font-size:12px;
  color:var(--violet-main);
}
h1{margin:0;font-size:24px;}
.subtitle{font-size:15px;color:#444;text-align:center;margin-top:4px;}
.badge{
  margin-top:8px;
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  color:#555;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}

/* NAV */
.top-nav{
  width:100%;
  max-width:980px;
  margin-top:12px;
  background:#fff;
  padding:4px;
  border-radius:999px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:4px;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.top-nav a{
  text-decoration:none;
  font-size:12px;
  padding:6px 12px;
  border-radius:999px;
  color:#555;
}
.top-nav a.active{
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
}

/* LAYOUT */
.layout{
  width:100%;
  max-width:980px;
  margin-top:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
@media(min-width:900px){
  .layout{ flex-direction:row; align-items:stretch; }
}

.panel{
  background:linear-gradient(180deg,#fff 0%,#EEE4FF 100%);
  border-radius:18px;
  box-shadow:0 6px 18px rgba(0,0,0,.10);
  padding:14px;
  box-sizing:border-box;
}

/* LEFT (threads) */
.threads{
  flex:1;
  min-width:280px;
}
.searchbar{
  display:flex;
  gap:8px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.searchbar input{
  flex:1;
  min-width:180px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid #D3C7FF;
  outline:none;
  background:#fff;
  font-size:12px;
}
.searchbar button{
  border:none;
  border-radius:999px;
  padding:8px 12px;
  font-size:12px;
  font-weight:900;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  cursor:pointer;
  white-space:nowrap;
}

.thread-list{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:520px;
  overflow:auto;
  padding-right:2px;
}
.thread{
  background:#fff;
  border-radius:14px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:10px 10px;
  cursor:pointer;
  border:2px solid transparent;
}
.thread.active{ border-color: var(--violet-main); }
.thread-top{
  display:flex;
  justify-content:space-between;
  gap:8px;
  align-items:flex-start;
}
.thread-title{
  font-weight:900;
  font-size:13px;
  color:#222;
}
.thread-sub{
  font-size:11px;
  color:#666;
  margin-top:2px;
}
.thread-right{
  text-align:right;
  font-size:11px;
  color:#666;
  white-space:nowrap;
}
.pill-unread{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:18px;
  height:18px;
  padding:0 6px;
  border-radius:999px;
  background:var(--violet-main);
  color:#fff;
  font-weight:900;
  font-size:11px;
  margin-top:6px;
}

/* RIGHT (chat) */
.chat{
  flex:1.6;
  min-width:280px;
  display:flex;
  flex-direction:column;
}
.chat-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  margin-bottom:10px;
}
.chat-title{
  font-weight:900;
  font-size:14px;
}
.chat-meta{
  font-size:11px;
  color:#666;
  margin-top:2px;
}
.chat-actions{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.action{
  border:none;
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  font-weight:900;
  cursor:pointer;
  background:#fff;
  border:1px solid #D3C7FF;
  color:#555;
}
.action.primary{
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  border:none;
  color:#fff;
}

/* banner */
.banner{
  background:#fff;
  border-radius:14px;
  padding:10px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  border-left:5px solid var(--orange);
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.banner strong{ color:#333; }
.banner small{ color:#666; display:block; margin-top:2px; }
.banner a{
  text-decoration:none;
  font-weight:900;
  color:#fff;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  padding:8px 12px;
  border-radius:999px;
  white-space:nowrap;
}

/* messages */
.msgs{
  background:#fff;
  border-radius:16px;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
  padding:12px;
  flex:1;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  max-width:80%;
  padding:10px 10px;
  border-radius:14px;
  font-size:13px;
  line-height:1.25;
  box-shadow:0 3px 10px rgba(0,0,0,.06);
}
.msg.me{
  margin-left:auto;
  background:linear-gradient(180deg,#F3ECFF 0%, #EADFFF 100%);
  border:1px solid #D3C7FF;
}
.msg.them{
  background:#fff;
  border:1px solid #eee;
}
.msg .meta{
  display:flex;
  justify-content:space-between;
  gap:8px;
  margin-top:6px;
  font-size:11px;
  color:#666;
}

/* composer */
.composer{
  margin-top:10px;
  display:flex;
  gap:8px;
}
.composer textarea{
  flex:1;
  resize:none;
  border-radius:14px;
  border:1px solid #D3C7FF;
  padding:10px;
  font-size:13px;
  outline:none;
  background:#fff;
  min-height:44px;
  max-height:110px;
}
.send{
  border:none;
  border-radius:14px;
  padding:10px 14px;
  font-weight:900;
  cursor:pointer;
  background:linear-gradient(90deg,var(--violet-main),var(--violet-dark));
  color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
.small-note{
  text-align:center;
  margin-top:8px;
  font-size:12px;
  color:#666;
}
</style>
</head>

<body>
<script>
  function getSession(){
    try{ return JSON.parse(localStorage.getItem("cm_auth") || "null"); }
    catch(e){ return null; }
  }
  function requireRole(role){
    const s = getSession();
    if(!s || s.role !== role){
      location.href = "login.html?role=" + encodeURIComponent(role);
    }
  }
  function logout(){
    localStorage.removeItem("cm_auth");
    location.href = "index.html";
  }
  requireRole("conciergerie");
</script>

<div class="page">

  <!-- TOPBAR -->
  <div class="topbar">
    <a class="pill-link" href="conciergerie.html">← Tableau de bord</a>
    <div style="display:flex; gap:8px; align-items:center;">
      <a class="pill-link" href="import-ical.html">Import iCal</a>
      <button class="pill-link" type="button" onclick="logout()">Déconnexion</button>
    </div>
  </div>

  <!-- TITRE -->
  <div class="logo-title">
    <div class="logo-icon">✓</div>
    <h1>CleanUp Manager</h1>
  </div>
  <div class="subtitle">Messagerie propriétaires ↔ conciergerie</div>
  <div class="badge">Centraliser • tracer • éviter les oublis</div>

  <!-- NAV -->
  <div class="top-nav">
    <a href="planning.html">Planning</a>
    <a href="logements.html">Logements</a>
    <a href="prestations.html">Prestations</a>
    <a class="active" href="messagerie.html">Messagerie</a>
    <a href="paiements.html">Paiements</a>
    <a href="historique.html">Historique</a>
    <a href="boutique.html">Boutique</a>
  </div>

  <div class="layout">
    <!-- LEFT: threads -->
    <div class="panel threads">
      <div class="searchbar">
        <input id="threadSearch" type="text" placeholder="Recherche (proprio, logement, mot-clé…)">
        <button type="button" id="newThreadBtn">Nouveau</button>
      </div>

      <div class="thread-list" id="threadList"></div>

      <div class="small-note">Tout est stocké en localStorage (V1).</div>
    </div>

    <!-- RIGHT: chat -->
    <div class="panel chat">
      <div class="chat-head">
        <div>
          <div class="chat-title" id="chatTitle">Sélectionne une conversation</div>
          <div class="chat-meta" id="chatMeta">—</div>
        </div>
        <div class="chat-actions">
          <button class="action" type="button" id="goHomeBtn">Logement</button>
          <button class="action" type="button" id="goPaymentsBtn">Paiements</button>
          <button class="action primary" type="button" id="createPrestaBtn">Créer prestation</button>
        </div>
      </div>

      <div id="bannerZone"></div>

      <div class="msgs" id="msgs">
        <div class="small-note">Clique une conversation à gauche. Ici tu vois l’historique complet.</div>
      </div>

      <div class="composer">
        <textarea id="composerText" placeholder="Écrire un message…"></textarea>
        <button class="send" type="button" id="sendBtn">Envoyer</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== BASE ===== */
const DATA_KEY = "cm_conciergerie_data_v1";

function uid(prefix){
  return (prefix||"x") + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}
function loadData(){
  try{
    const raw = localStorage.getItem(DATA_KEY);
    if(raw) return JSON.parse(raw);
  }catch(e){}
  return null;
}
function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)); }
function ensureData(){
  const existing = loadData();
  if(existing) return existing;
  const seeded = { homes:[], events:[], services:[], threads:[], icalSources:[], kits:[], requests:[] };
  saveData(seeded);
  return seeded;
}
const app = ensureData();
app.homes = Array.isArray(app.homes) ? app.homes : [];
app.events = Array.isArray(app.events) ? app.events : [];
app.services = Array.isArray(app.services) ? app.services : [];
app.threads = Array.isArray(app.threads) ? app.threads : [];
app.icalSources = Array.isArray(app.icalSources) ? app.icalSources : [];
app.requests = Array.isArray(app.requests) ? app.requests : [];



/* ===== SEED minimal si aucune conversation ===== */
(function seedThreadsIfNeeded(){
  if(app.threads.length) return;
  if(!app.homes.length){
    // pas de logements => on seed quand même une discussion générique
    app.threads.push({
      id: uid("t"),
      owner: "Propriétaire",
      homeId: null,
      homeLabel: "Logement",
      last: "Bienvenue dans la messagerie.",
      lastAt: Date.now(),
      unread: 0,
      flags: { paymentDue:false },
      messages: [
        { id: uid("m"), from:"them", text:"Bienvenue dans la messagerie.", at: Date.now() }
      ]
    });
  }else{
    const h = app.homes[0];
    app.threads.push({
      id: uid("t"),
      owner: h.owner || "Propriétaire",
      homeId: h.id,
      homeLabel: `${h.name || "Logement"} • ${h.city || ""}`.trim(),
      last: "Bienvenue dans la messagerie.",
      lastAt: Date.now(),
      unread: 0,
      flags: { paymentDue:false },
      messages: [
        { id: uid("m"), from:"them", text:"Bienvenue dans la messagerie.", at: Date.now() }
      ]
    });
  }
  saveData(app);
})();

/* ===== ELEMENTS ===== */
const threadListEl = document.getElementById("threadList");
const threadSearchEl = document.getElementById("threadSearch");
const chatTitleEl = document.getElementById("chatTitle");
const chatMetaEl = document.getElementById("chatMeta");
const msgsEl = document.getElementById("msgs");
const bannerZoneEl = document.getElementById("bannerZone");
const composerEl = document.getElementById("composerText");

const newThreadBtn = document.getElementById("newThreadBtn");
const sendBtn = document.getElementById("sendBtn");
const createPrestaBtn = document.getElementById("createPrestaBtn");
const goPaymentsBtn = document.getElementById("goPaymentsBtn");
const goHomeBtn = document.getElementById("goHomeBtn");

let activeThreadId = null;

/* ===== UTIL ===== */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function truncate(str, n){
  const s = String(str ?? "");
  return (s.length > n) ? s.slice(0, n-1) + "…" : s;
}
function fmtTime(ts){
  try{
    const d = new Date(ts);
    return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
  }catch(e){
    return "—";
  }
}

/* ===== RENDER THREADS ===== */
function renderThreads(){
  const q = (threadSearchEl.value || "").toLowerCase().trim();
  threadListEl.innerHTML = "";

  const threads = app.threads.slice().sort((a,b)=>(b.lastAt||0)-(a.lastAt||0));
  const filtered = !q ? threads : threads.filter(t => {
    const hay = `${t.owner||""} ${t.homeLabel||""} ${t.last||""}`.toLowerCase();
    return hay.includes(q);
  });

  if(!filtered.length){
    const empty = document.createElement("div");
    empty.className = "small-note";
    empty.textContent = "Aucune conversation.";
    threadListEl.appendChild(empty);
    return;
  }

  filtered.forEach(t => {
    const div = document.createElement("div");
    div.className = "thread" + (t.id === activeThreadId ? " active" : "");
    div.onclick = () => openThread(t.id);

    div.innerHTML = `
      <div class="thread-top">
        <div>
          <div class="thread-title">${escapeHtml(t.owner || "Propriétaire")} • ${escapeHtml(t.homeLabel || "Logement")}</div>
          <div class="thread-sub">${escapeHtml(truncate(t.last || "", 56))}</div>
        </div>
        <div class="thread-right">
          <div>${fmtTime(t.lastAt || Date.now())}</div>
          ${t.unread ? `<div class="pill-unread">${t.unread}</div>` : ``}
        </div>
      </div>
    `;
    threadListEl.appendChild(div);
  });
}

/* ===== OPEN THREAD ===== */
function openThread(id){
  activeThreadId = id;
  const t = app.threads.find(x => x.id === id);
  if(!t) return;

  t.unread = 0;
  saveData(app);

  chatTitleEl.textContent = `${t.owner || "Propriétaire"} • ${t.homeLabel || "Logement"}`;
  chatMetaEl.textContent = t.homeId ? `Lié au logement • ${t.homeLabel}` : `Conversation générale`;

  renderBanner(t);
  renderMessages(t);
  renderThreads();

  setTimeout(() => { msgsEl.scrollTop = msgsEl.scrollHeight; }, 0);
}

/* ===== BANNER ===== */
function renderBanner(t){
  bannerZoneEl.innerHTML = "";
  if(!t.flags || !t.flags.paymentDue) return;

  const b = document.createElement("div");
  b.className = "banner";
  b.innerHTML = `
    <div>
      <strong>Paiement requis avant intervention</strong>
      <small>Ce fil est marqué “paiement dû”. Tu peux lever le blocage dans Paiements.</small>
    </div>
    <a href="paiements.html">Voir paiements</a>
  `;
  bannerZoneEl.appendChild(b);
}

/* ===== MESSAGES ===== */
function renderMessages(t){
  msgsEl.innerHTML = "";
  const msgs = Array.isArray(t.messages) ? t.messages : [];

  if(!msgs.length){
    const note = document.createElement("div");
    note.className = "small-note";
    note.textContent = "Aucun message.";
    msgsEl.appendChild(note);
    return;
  }

  msgs.forEach(m => {
    const div = document.createElement("div");
    div.className = "msg " + (m.from === "me" ? "me" : "them");
    div.innerHTML = `
      <div>${escapeHtml(m.text || "")}</div>
      <div class="meta">
        <span>${m.from === "me" ? "Conciergerie" : "Propriétaire"}</span>
        <span>${fmtTime(m.at || Date.now())}</span>
      </div>
    `;
    msgsEl.appendChild(div);
  });
}

/* ===== SEND MESSAGE ===== */
function sendMessage(){
  const t = app.threads.find(x => x.id === activeThreadId);
  const text = (composerEl.value || "").trim();

  if(!t){
    alert("Choisis une conversation à gauche.");
    return;
  }
  if(!text) return;

  t.messages = Array.isArray(t.messages) ? t.messages : [];
  t.messages.push({ id: uid("m"), from:"me", text, at: Date.now() });
  t.last = text;
  t.lastAt = Date.now();

  composerEl.value = "";
  saveData(app);

  renderMessages(t);
  renderThreads();
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

/* ===== NEW THREAD ===== */
function newThread(){
  if(!app.homes.length){
    alert("Ajoute d’abord un logement (Logements) pour créer une conversation liée à un proprio.");
    location.href = "logements.html";
    return;
  }

  const list = app.homes.map((h,i)=>`${i+1}. ${h.name} (${h.city}) — ${h.owner}`).join("\n");
  const pickStr = prompt("Choisis un logement (numéro) :\n\n" + list);
  if(!pickStr) return;
  const idx = Number(pickStr) - 1;
  const chosen = app.homes[idx];
  if(!chosen){ alert("Numéro invalide."); return; }

  const owner = prompt("Nom du propriétaire (édition possible plus tard) :", chosen.owner || "Propriétaire");
  if(!owner) return;

  const thread = {
    id: uid("t"),
    owner: String(owner).trim(),
    homeId: chosen.id,
    homeLabel: `${chosen.name || "Logement"} • ${chosen.city || ""}`.trim(),
    last: "Conversation créée.",
    lastAt: Date.now(),
    unread: 0,
    flags: { paymentDue:false },
    messages: [
      { id: uid("m"), from:"me", text:"Conversation créée.", at: Date.now() }
    ]
  };

  app.threads.unshift(thread);
  saveData(app);

  openThread(thread.id);
}

/* ===== ACTIONS ===== */
createPrestaBtn.addEventListener("click", ()=>{
  const t = app.threads.find(x => x.id === activeThreadId);
  if(t && t.homeId){
    location.href = "planning.html?homeId=" + encodeURIComponent(t.homeId);
  }else{
    location.href = "planning.html";
  }
});

goPaymentsBtn.addEventListener("click", ()=>{ location.href = "paiements.html"; });

goHomeBtn.addEventListener("click", ()=>{
  const t = app.threads.find(x => x.id === activeThreadId);
  if(t && t.homeId){
    // on renvoie vers le planning filtré, c’est le plus utile en V1
    location.href = "planning.html?homeId=" + encodeURIComponent(t.homeId);
  }else{
    location.href = "logements.html";
  }
});

/* ===== EVENTS ===== */
threadSearchEl.addEventListener("input", renderThreads);
newThreadBtn.addEventListener("click", newThread);
sendBtn.addEventListener("click", sendMessage);
composerEl.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

/* INIT */
renderThreads();
// ouvre automatiquement la première conversation
if(app.threads.length){
  openThread(app.threads[0].id);
}
</script>

</body>
</html>
